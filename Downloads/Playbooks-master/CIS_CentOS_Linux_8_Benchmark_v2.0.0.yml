---
# =============================================================================
# ANSIBLE PLAYBOOK — CIS 8 Benchmark RHEL
# Controles:
#   1.1.1.1 Ensure mounting of cramfs filesystems is disabled (Automated)
#   1.2.1   Ensure GPG keys are configured (Manual)
#   1.2.2   Ensure gpgcheck is globally activated (Automated)
#   1.2.3   Ensure package manager repositories are configured (Manual)
#   1.3.1   Ensure AIDE is installed (Automated)
#   1.3.2   Ensure filesystem integrity is regularly checked (Automated)
#   1.4.1   Ensure bootloader password is set (Automated)
#   1.4.2   Ensure permissions on bootloader config are configured (Automated)
#   1.4.3   Ensure authentication is required when booting into rescue mode (Automated)
# Profile   : Level 1 - Server | Level 1 - Workstation
# =============================================================================
#
# Ejecución:
#   ansible-playbook -i inventory playbook.yml
#   ansible-playbook -i inventory playbook.yml --tags cis_1.3.1
#   ansible-playbook -i inventory playbook.yml --skip-tags manual
#
# =============================================================================

- name: "CIS 8 Benchmark RHEL | Level 1 - Server | Level 1 - Workstation"
  hosts: all
  become: true
  gather_facts: true

  tasks:

    # -------------------------------------------------------------------------
    # 1.1.1.1 — Ensure mounting of cramfs filesystems is disabled
    # -------------------------------------------------------------------------
    - name: "1.1.1.1 | L1 | Ensure mounting of cramfs filesystems is disabled"
      block:
        - name: "1.1.1.1 | ROM | Configure cramfs module disablement"
          ansible.builtin.copy:
            dest: /etc/modprobe.d/cramfs.conf
            content: |
              install cramfs /bin/false
              blacklist cramfs
            owner: root
            group: root
            mode: '0644'

        - name: "1.1.1.1 | ROM | Unload cramfs module if currently loaded"
          community.general.modprobe:
            name: cramfs
            state: absent
          failed_when: false

      tags:
        - cis_1.1.1.1
        - level1_server
        - level1_workstation
        - filesystems

    # -------------------------------------------------------------------------
    # 1.2.1 — Ensure GPG keys are configured (Manual)
    # Nota: Control manual — se audita pero no se puede remediar automáticamente
    # ya que las GPG keys dependen de la política de cada sitio/organización.
    # -------------------------------------------------------------------------
    - name: "1.2.1 | L1 | Ensure GPG keys are configured"
      block:
        - name: "1.2.1 | AUDIT | List GPG keys configured in repositories"
          ansible.builtin.shell: |
            grep -r gpgkey /etc/yum.repos.d/* /etc/dnf/dnf.conf 2>/dev/null || true
          register: cis_1_2_1_gpgkey_repos
          changed_when: false
          check_mode: false

        - name: "1.2.1 | AUDIT | List currently installed GPG public keys"
          ansible.builtin.shell: |
            for RPM_PACKAGE in $(rpm -q gpg-pubkey 2>/dev/null); do
              echo "RPM: ${RPM_PACKAGE}"
              rpm -q --queryformat "Packager: %{PACKAGER}\nSummary: %{SUMMARY}\nKey ID: %{VERSION}\n\n" \
                "${RPM_PACKAGE}"
            done
          register: cis_1_2_1_installed_keys
          changed_when: false
          check_mode: false

        - name: "1.2.1 | AUDIT | Display GPG audit results"
          ansible.builtin.debug:
            msg:
              - "=== GPG Keys en repositorios ==="
              - "{{ cis_1_2_1_gpgkey_repos.stdout_lines }}"
              - "=== GPG Keys instaladas ==="
              - "{{ cis_1_2_1_installed_keys.stdout_lines }}"

      tags:
        - cis_1.2.1
        - level1_server
        - level1_workstation
        - gpg
        - manual
        - audit_only

    # -------------------------------------------------------------------------
    # 1.2.2 — Ensure gpgcheck is globally activated (Automated)
    # -------------------------------------------------------------------------
    - name: "1.2.2 | L1 | Ensure gpgcheck is globally activated"
      block:
        - name: "1.2.2 | ROM | Ensure gpgcheck=1 in /etc/dnf/dnf.conf"
          ansible.builtin.lineinfile:
            path: /etc/dnf/dnf.conf
            regexp: '^gpgcheck\s*='
            line: 'gpgcheck=1'
            state: present
            backup: true

        - name: "1.2.2 | ROM | Find all .repo files in /etc/yum.repos.d/"
          ansible.builtin.find:
            paths: /etc/yum.repos.d/
            patterns: "*.repo"
          register: cis_1_2_2_repo_files

        - name: "1.2.2 | ROM | Ensure gpgcheck=1 in all .repo files"
          ansible.builtin.lineinfile:
            path: "{{ item.path }}"
            regexp: '^gpgcheck\s*='
            line: 'gpgcheck=1'
            state: present
            backup: true
          loop: "{{ cis_1_2_2_repo_files.files }}"
          loop_control:
            label: "{{ item.path }}"

      tags:
        - cis_1.2.2
        - level1_server
        - level1_workstation
        - gpg
        - package_manager

    # -------------------------------------------------------------------------
    # 1.2.3 — Ensure package manager repositories are configured (Manual)
    # Nota: Control manual — se audita el estado actual de los repositorios
    # pero la configuración depende de la política de cada organización.
    # -------------------------------------------------------------------------
    - name: "1.2.3 | L1 | Ensure package manager repositories are configured"
      block:
        - name: "1.2.3 | AUDIT | List currently configured repositories"
          ansible.builtin.command: dnf repolist
          register: cis_1_2_3_repolist
          changed_when: false
          check_mode: false

        - name: "1.2.3 | AUDIT | Display repository list"
          ansible.builtin.debug:
            msg:
              - "=== Repositorios configurados ==="
              - "{{ cis_1_2_3_repolist.stdout_lines }}"
              - "ACCIÓN REQUERIDA: Verificar manualmente que los repositorios"
              - "listados sean correctos y estén alineados con la política del sitio."

      tags:
        - cis_1.2.3
        - level1_server
        - level1_workstation
        - package_manager
        - manual
        - audit_only

    # -------------------------------------------------------------------------
    # 1.3.1 — Ensure AIDE is installed
    # -------------------------------------------------------------------------
    - name: "1.3.1 | L1 | Ensure AIDE is installed"
      block:
        - name: "1.3.1 | ROM | Install AIDE package"
          ansible.builtin.dnf:
            name: aide
            state: present

        - name: "1.3.1 | ROM | Check if AIDE database already exists"
          ansible.builtin.stat:
            path: /var/lib/aide/aide.db.gz
          register: cis_1_3_1_aide_db

        - name: "1.3.1 | ROM | Initialize AIDE database (first run)"
          ansible.builtin.command: aide --init
          args:
            creates: /var/lib/aide/aide.db.new.gz
          when: not cis_1_3_1_aide_db.stat.exists
          register: cis_1_3_1_aide_init
          changed_when: cis_1_3_1_aide_init.rc == 0

        - name: "1.3.1 | ROM | Activate AIDE database"
          ansible.builtin.command:
            cmd: mv /var/lib/aide/aide.db.new.gz /var/lib/aide/aide.db.gz
          args:
            removes: /var/lib/aide/aide.db.new.gz
          when:
            - not cis_1_3_1_aide_db.stat.exists
            - cis_1_3_1_aide_init is defined
            - cis_1_3_1_aide_init.changed

      tags:
        - cis_1.3.1
        - level1_server
        - level1_workstation
        - aide
        - integrity

    # -------------------------------------------------------------------------
    # 1.3.2 — Ensure filesystem integrity is regularly checked
    # -------------------------------------------------------------------------
    - name: "1.3.2 | L1 | Ensure filesystem integrity is regularly checked"
      block:
        - name: "1.3.2 | ROM | Create aidecheck systemd service unit"
          ansible.builtin.copy:
            dest: /etc/systemd/system/aidecheck.service
            content: |
              [Unit]
              Description=Aide Check

              [Service]
              Type=simple
              ExecStart=/usr/sbin/aide --check

              [Install]
              WantedBy=multi-user.target
            owner: root
            group: root
            mode: '0644'

        - name: "1.3.2 | ROM | Create aidecheck systemd timer unit"
          ansible.builtin.copy:
            dest: /etc/systemd/system/aidecheck.timer
            content: |
              [Unit]
              Description=Aide check every day at 5AM

              [Timer]
              OnCalendar=*-*-* 05:00:00
              Unit=aidecheck.service

              [Install]
              WantedBy=multi-user.target
            owner: root
            group: root
            mode: '0644'

        - name: "1.3.2 | ROM | Reload systemd daemon"
          ansible.builtin.systemd:
            daemon_reload: true

        - name: "1.3.2 | ROM | Enable aidecheck.service"
          ansible.builtin.systemd:
            name: aidecheck.service
            enabled: true

        - name: "1.3.2 | ROM | Enable and start aidecheck.timer"
          ansible.builtin.systemd:
            name: aidecheck.timer
            enabled: true
            state: started

      tags:
        - cis_1.3.2
        - level1_server
        - level1_workstation
        - aide
        - integrity

    - name: "1.4.1 | L1 | Ensure bootloader password is set"
      block:
        - name: "1.4.1 | ROM | Deploy GRUB2 superuser and password via user.cfg"
          ansible.builtin.copy:
            dest: /boot/grub2/user.cfg
            content: |
              GRUB2_PASSWORD={{ grub2_password_hash }}
            owner: root
            group: root
            mode: '0600'
          when: grub2_password_hash is defined

        - name: "1.4.1 | ROM | Rebuild grub2 configuration"
          ansible.builtin.shell: |
            grub2-mkconfig -o "$(dirname "$(find /boot -type f \( -name 'grubenv' \
            -o -name 'grub.conf' -o -name 'grub.cfg' \) \
            -exec grep -Pl '^\h*(kernelopts=|linux|kernel)' {} \;)")/grub.cfg"
          changed_when: true
          when: grub2_password_hash is defined

        - name: "1.4.1 | WARN | Advertencia si grub2_password_hash no está definido"
          ansible.builtin.debug:
            msg:
              - "ADVERTENCIA: La variable 'grub2_password_hash' no está definida."
              - "Defínala en el vault de Ansible con el hash generado por grub2-mkpasswd-pbkdf2."
              - "Ejemplo: grub2_password_hash: grub.pbkdf2.sha512.10000.<hash>"
          when: grub2_password_hash is not defined

      tags:
        - cis_1.4.1
        - level1_server
        - level1_workstation
        - bootloader


    - name: "1.4.2 | L1 | Ensure permissions on bootloader config are configured"
      block:
        - name: "1.4.2 | ROM | Find bootloader config files"
          ansible.builtin.find:
            paths: /boot/grub2/
            patterns:
              - "grub.cfg"
              - "grubenv"
              - "user.cfg"
          register: cis_1_4_2_grub_files

        - name: "1.4.2 | ROM | Set root ownership on bootloader config files"
          ansible.builtin.file:
            path: "{{ item.path }}"
            owner: root
            group: root
            mode: '0600'
          loop: "{{ cis_1_4_2_grub_files.files }}"
          loop_control:
            label: "{{ item.path }}"

      tags:
        - cis_1.4.2
        - level1_server
        - level1_workstation
        - bootloader

  
    - name: "1.4.3 | L1 | Ensure authentication is required when booting into rescue mode"
      block:
        - name: "1.4.3 | ROM | Create systemd drop-in directory for rescue.service"
          ansible.builtin.file:
            path: /etc/systemd/system/rescue.service.d
            state: directory
            owner: root
            group: root
            mode: '0755'

        - name: "1.4.3 | ROM | Deploy rescue mode authentication drop-in config"
          ansible.builtin.copy:
            dest: /etc/systemd/system/rescue.service.d/00-require-auth.conf
            content: |
              [Service]
              ExecStart=-/usr/lib/systemd/systemd-sulogin-shell rescue
            owner: root
            group: root
            mode: '0644'
          notify: Reload systemd daemon

      tags:
        - cis_1.4.3
        - level1_server
        - level1_workstation
        - bootloader
        - rescue_mode

    - name: "1.5.1 | L1 | Ensure core dump storage is disabled"
      block:
        - name: "1.5.1 | ROM | Configure Storage=none in coredump.conf"
          ansible.builtin.lineinfile:
            path: /etc/systemd/coredump.conf
            regexp: '^#?Storage='
            line: 'Storage=none'
            state: present
            backup: true

      tags:
        - cis_1.5.1
        - level1_server
        - level1_workstation
        - coredump

    - name: "1.5.2 | L1 | Ensure core dump backtraces are disabled"
      block:
        - name: "1.5.2 | ROM | Configure ProcessSizeMax=0 in coredump.conf"
          ansible.builtin.lineinfile:
            path: /etc/systemd/coredump.conf
            regexp: '^#?ProcessSizeMax='
            line: 'ProcessSizeMax=0'
            state: present
            backup: true

      tags:
        - cis_1.5.2
        - level1_server
        - level1_workstation
        - coredump

    - name: "1.5.3 | L1 | Ensure ASLR is enabled"
      block:
        - name: "1.5.3 | ROM | Set kernel.randomize_va_space to 2"
          ansible.posix.sysctl:
            name: kernel.randomize_va_space
            value: '2'
            state: present
            reload: true
            sysctl_set: true
            sysctl_file: /etc/sysctl.d/60-kernel_sysctl.conf

      tags:
        - cis_1.5.3
        - level1_server
        - level1_workstation
        - sysctl
        - aslr


    - name: "1.6.1.1 | L1 | Ensure SELinux is installed"
      block:
        - name: "1.6.1.1 | ROM | Install libselinux package"
          ansible.builtin.dnf:
            name: libselinux
            state: present

      tags:
        - cis_1.6.1.1
        - level1_server
        - level1_workstation
        - selinux

    - name: "1.6.1.7 | L1 | Ensure SETroubleshoot is not installed"
      block:
        - name: "1.6.1.7 | ROM | Remove setroubleshoot package"
          ansible.builtin.dnf:
            name: setroubleshoot
            state: absent

      tags:
        - cis_1.6.1.7
        - level1_server
        - services

    - name: "1.6.1.8 | L1 | Ensure mcstrans is not installed"
      block:
        - name: "1.6.1.8 | ROM | Remove mcstrans package"
          ansible.builtin.dnf:
            name: mcstrans
            state: absent

      tags:
        - cis_1.6.1.8
        - level1_server
        - level1_workstation
        - services

    - name: "1.7.1 | L1 | Ensure message of the day is configured properly"
      block:
        - name: "1.7.1 | ROM | Set secure /etc/motd content"
          ansible.builtin.copy:
            dest: /etc/motd
            content: "{{ cis_1_7_1_motd_content | default('AUTHORIZED USE ONLY. All activity may be monitored and reported.') }}"
            owner: root
            group: root
            mode: '0644'

        - name: "1.7.1 | ROM | Remove system information tokens from /etc/motd"
          ansible.builtin.replace:
            path: /etc/motd
            regexp: '(\\v|\\r|\\m|\\s)'
            replace: ''

      tags:
        - cis_1.7.1
        - level1_server
        - level1_workstation
        - banner


    - name: "1.7.2 | L1 | Ensure local login warning banner is configured"
      block:
        - name: "1.7.2 | ROM | Set secure /etc/issue content"
          ansible.builtin.copy:
            dest: /etc/issue
            content: "{{ cis_1_7_banner_content | default('Authorized uses only. All activity may be monitored and reported.\n') }}"
            owner: root
            group: root
            mode: '0644'

      tags:
        - cis_1.7.2
        - level1_server
        - level1_workstation
        - banner

    - name: "1.7.3 | L1 | Ensure remote login warning banner is configured"
      block:
        - name: "1.7.3 | ROM | Set secure /etc/issue.net content"
          ansible.builtin.copy:
            dest: /etc/issue.net
            content: "{{ cis_1_7_banner_content | default('Authorized uses only. All activity may be monitored and reported.\n') }}"
            owner: root
            group: root
            mode: '0644'

      tags:
        - cis_1.7.3
        - level1_server
        - level1_workstation
        - banner

    - name: "1.7.4-1.7.6 | L1 | Ensure permissions on login banners"
      block:
        - name: "1.7.4-1.7.6 | ROM | Set ownership and permissions on banner files"
          ansible.builtin.file:
            path: "{{ item }}"
            owner: root
            group: root
            mode: '0644'
            state: file
          loop:
            - /etc/motd
            - /etc/issue
            - /etc/issue.net
          ignore_errors: true 

        - name: "1.7.4-1.7.6 | ROM | Remove system information tokens from all banners"
          ansible.builtin.replace:
            path: "{{ item }}"
            regexp: '(\\v|\\r|\\m|\\s)'
            replace: ''
          loop:
            - /etc/motd
            - /etc/issue
            - /etc/issue.net
          ignore_errors: true

      tags:
        - cis_1.7.4
        - cis_1.7.5
        - cis_1.7.6
        - level1_server
        - level1_workstation
        - banner
        - permissions

    - name: "1.8.4 | L1 | Ensure XDMCP is not enabled"
      block:
        - name: "1.8.4 | ROM | Disable Enable=true in /etc/gdm/custom.conf"
          ansible.builtin.lineinfile:
            path: /etc/gdm/custom.conf
            regexp: '^\s*Enable\s*=\s*true'
            state: absent
            backup: true

      tags:
        - cis_1.8.4
        - level1_server
        - level1_workstation
        - gdm

    - name: "1.8.5 | L1/L2 | Ensure automatic mounting of removable media is disabled"
      block:
        - name: "1.8.5 | ROM | Create dconf profile directory"
          ansible.builtin.file:
            path: /etc/dconf/db/local.d
            state: directory
            owner: root
            group: root
            mode: '0755'

        - name: "1.8.5 | ROM | Deploy dconf media-automount configuration"
          ansible.builtin.copy:
            dest: /etc/dconf/db/local.d/00-media-automount
            content: |
              [org/gnome/desktop/media-handling]
              automount=false
              automount-open=false
            owner: root
            group: root
            mode: '0644'
          register: cis_1_8_5_dconf_config

        - name: "1.8.5 | ROM | Update dconf database"
          ansible.builtin.command: dconf update
          when: cis_1_8_5_dconf_config.changed

      tags:
        - cis_1.8.5
        - level1_server
        - level2_workstation
        - gnome
        - media

    - name: "1.10 | L1 | Ensure system-wide crypto policy is not legacy"
      block:
        - name: "1.10 | AUDIT | Check current crypto policy"
          ansible.builtin.command: update-crypto-policies --show
          register: cis_1_10_current_policy
          changed_when: false
          check_mode: false

        - name: "1.10 | ROM | Set crypto policy to DEFAULT if LEGACY is detected"
          ansible.builtin.command: update-crypto-policies --set DEFAULT
          when: "'LEGACY' in cis_1_10_current_policy.stdout"
          notify: Update crypto policies

      tags:
        - cis_1.10
        - level1_server
        - level1_workstation
        - crypto_policy

      
    - name: "2.1.1 | L1 | Ensure chrony is installed"
      block:
        - name: "2.1.1 | ROM | Install chrony package"
          ansible.builtin.dnf:
            name: chrony
            state: present

      tags:
        - cis_2.1.1
        - level1_server
        - level1_workstation
        - chrony
        - ntp

    - name: "2.1.2 | L1 | Ensure chrony is configured"
      block:
        - name: "2.1.2 | ROM | Configure NTP servers in /etc/chrony.conf"
          ansible.builtin.lineinfile:
            path: /etc/chrony.conf
            regexp: '^(server|pool)'
            state: absent
          when: cis_chrony_servers is defined

        - name: "2.1.2 | ROM | Add site-specific NTP servers"
          ansible.builtin.lineinfile:
            path: /etc/chrony.conf
            line: "server {{ item }} iburst"
            state: present
          loop: "{{ cis_chrony_servers | default(['2.rhel.pool.ntp.org']) }}"
          notify: Restart chronyd

        - name: "2.1.2 | ROM | Ensure chronyd runs as user 'chrony'"
          ansible.builtin.lineinfile:
            path: /etc/sysconfig/chronyd
            regexp: '^OPTIONS='
            line: 'OPTIONS="-u chrony"'
            state: present
          notify: Restart chronyd

        - name: "2.1.2 | ROM | Ensure chronyd is enabled and started"
          ansible.builtin.systemd:
            name: chronyd
            enabled: true
            state: started

      tags:
        - cis_2.1.2
        - level1_server
        - level1_workstation
        - chrony
        - ntp


    - name: "2.2.2 | L1 | Ensure X Windows Server is not installed (Servers Only)"
      block:
        - name: "2.2.2 | ROM | Remove xorg-x11-server-common package"
          ansible.builtin.dnf:
            name: xorg-x11-server-common
            state: absent

      when: "'servers' in group_names"
      tags:
        - cis_2.2.2
        - level1_server
        - services

    - name: "2.2.17 | L1 | Ensure MTA is configured for local-only mode"
      block:
        - name: "2.2.17 | ROM | Configure Postfix to listen only on loopback"
          ansible.builtin.lineinfile:
            path: /etc/postfix/main.cf
            regexp: '^\s*inet_interfaces\s*='
            line: 'inet_interfaces = loopback-only'
            state: present
            backup: true
          notify: Restart postfix

      tags:
        - cis_2.2.17
        - level1_server
        - level1_workstation
        - postfix
        - mail

    - name: "2.3.1 | L1 | Ensure NIS Client is not installed"
      block:
        - name: "2.3.1 | ROM | Remove ypbind package"
          ansible.builtin.dnf:
            name: ypbind
            state: absent

      tags:
        - cis_2.3.1
        - level1_server
        - level1_workstation
        - services
        - nis

    - name: "2.3.2-2.3.6 | L1 | Ensure insecure service clients are removed"
      block:
        - name: "2.3.2-2.3.6 | ROM | Remove legacy network clients"
          ansible.builtin.dnf:
            name:
              - rsh
              - talk
              - telnet
              - openldap-clients
              - tftp
            state: absent

      tags:
        - cis_2.3.2
        - cis_2.3.3
        - cis_2.3.4
        - cis_2.3.5
        - cis_2.3.6
        - level1_server
        - level1_workstation
        - services
        - clients


    - name: "3.2.1 | L1 | Ensure IP forwarding is disabled"
      block:
        - name: "3.2.1 | ROM | Disable IPv4 forwarding"
          ansible.posix.sysctl:
            name: net.ipv4.ip_forward
            value: '0'
            state: present
            reload: true
            sysctl_set: true
            sysctl_file: /etc/sysctl.d/60-netipv4_sysctl.conf

        - name: "3.2.1 | ROM | Disable IPv6 forwarding (if enabled)"
          ansible.posix.sysctl:
            name: net.ipv6.conf.all.forwarding
            value: '0'
            state: present
            reload: true
            sysctl_set: true
            sysctl_file: /etc/sysctl.d/60-netipv6_sysctl.conf
          when: ansible_all_ipv6_addresses | length > 0

      tags:
        - cis_3.2.1
        - level1_server
        - level1_workstation
        - sysctl
        - network


    - name: "3.2.2 | L1 | Ensure packet redirect sending is disabled"
      block:
        - name: "3.2.2 | ROM | Disable ICMP redirect sending (all/default)"
          ansible.posix.sysctl:
            name: "{{ item }}"
            value: '0'
            state: present
            reload: true
            sysctl_set: true
            sysctl_file: /etc/sysctl.d/60-netipv4_sysctl.conf
          loop:
            - net.ipv4.conf.all.send_redirects
            - net.ipv4.conf.default.send_redirects

        - name: "3.2.2 | ROM | Flush routing table"
          ansible.posix.sysctl:
            name: net.ipv4.route.flush
            value: '1'
            sysctl_set: true
            state: present
            reload: true

      tags:
        - cis_3.2.2
        - level1_server
        - level1_workstation
        - sysctl
        - network 
      


    - name: "3.3 | L1 | Network Parameter Hardening"
      block:
        - name: "3.3 | ROM | Configure IPv4 kernel parameters"
          ansible.posix.sysctl:
            name: "{{ item.name }}"
            value: "{{ item.value }}"
            state: present
            reload: true
            sysctl_set: true
            sysctl_file: /etc/sysctl.d/60-netipv4_sysctl.conf
          loop:
      
            - { name: 'net.ipv4.conf.all.accept_source_route', value: '0' }
            - { name: 'net.ipv4.conf.default.accept_source_route', value: '0' }

            - { name: 'net.ipv4.conf.all.accept_redirects', value: '0' }
            - { name: 'net.ipv4.conf.default.accept_redirects', value: '0' }

            - { name: 'net.ipv4.conf.all.secure_redirects', value: '0' }
            - { name: 'net.ipv4.conf.default.secure_redirects', value: '0' }

            - { name: 'net.ipv4.conf.all.log_martians', value: '1' }
            - { name: 'net.ipv4.conf.default.log_martians', value: '1' }

            - { name: 'net.ipv4.icmp_echo_ignore_broadcasts', value: '1' }

            - { name: 'net.ipv4.icmp_ignore_bogus_error_responses', value: '1' }

        - name: "3.3 | ROM | Configure IPv6 kernel parameters"
          ansible.posix.sysctl:
            name: "{{ item.name }}"
            value: "{{ item.value }}"
            state: present
            reload: true
            sysctl_set: true
            sysctl_file: /etc/sysctl.d/60-netipv6_sysctl.conf
          loop:

            - { name: 'net.ipv6.conf.all.accept_source_route', value: '0' }
            - { name: 'net.ipv6.conf.default.accept_source_route', value: '0' }

            - { name: 'net.ipv6.conf.all.accept_redirects', value: '0' }
            - { name: 'net.ipv6.conf.default.accept_redirects', value: '0' }
          when: ansible_all_ipv6_addresses | length > 0

        - name: "3.3 | ROM | Final routing table flush"
          ansible.posix.sysctl:
            name: net.ipv4.route.flush
            value: '1'
            sysctl_set: true
            state: present
            reload: true
          

      tags:
        - cis_3.3
        - level1_server
        - level1_workstation
        - sysctl
        - network_security


    - name: "3.3.7-3.3.9 | L1 | Advanced Network Security Parameters"
      block:
        - name: "3.3.7-3.3.8 | ROM | Configure IPv4 Anti-Spoofing and DoS protection"
          ansible.posix.sysctl:
            name: "{{ item.name }}"
            value: "{{ item.value }}"
            state: present
            reload: true
            sysctl_set: true
            sysctl_file: /etc/sysctl.d/60-netipv4_sysctl.conf
          loop:
            # 3.3.7 Ensure Reverse Path Filtering is enabled
            - { name: 'net.ipv4.conf.all.rp_filter', value: '1' }
            - { name: 'net.ipv4.conf.default.rp_filter', value: '1' }
            # 3.3.8 Ensure TCP SYN Cookies is enabled
            - { name: 'net.ipv4.tcp_syncookies', value: '1' }

        - name: "3.3.9 | ROM | Disable IPv6 Router Advertisements"
          ansible.posix.sysctl:
            name: "{{ item.name }}"
            value: '0'
            state: present
            reload: true
            sysctl_set: true
            sysctl_file: /etc/sysctl.d/60-netipv6_sysctl.conf
          loop:
            - net.ipv6.conf.all.accept_ra
            - net.ipv6.conf.default.accept_ra
          when: ansible_all_ipv6_addresses | length > 0

        - name: "3.3.7-3.3.9 | ROM | Flush routing table"
          ansible.posix.sysctl:
            name: net.ipv4.route.flush
            value: '1'
            sysctl_set: true
            state: present
            reload: true

        

      tags:
        - cis_3.3.7
        - cis_3.3.8
        - cis_3.3.9
        - level1_server
        - level1_workstation
        - sysctl
        - network_security

  handlers:
    - name: Reload systemd daemon
      ansible.builtin.systemd:
        daemon_reload: true

    - name: Update crypto policies
      ansible.builtin.command: update-crypto-policies