---
# Playbook para deshabilitar filesystems innecesarios
# CIS Red Hat Enterprise Linux 6 Benchmark
#
# Level 1 - Server y Workstation


- name: Deshabilitar filesystems innecesarios (cramfs, freevxfs, jffs2, hfs, hfsplus, squashfs, udf, USB storage)
  hosts: all
  become: yes
  
  vars:
    filesystems_to_disable:
      - cramfs
      - freevxfs
      - jffs2
      - hfs
      - hfsplus
      - squashfs
      - udf
    usb_modules_to_disable:
      - usb-storage
    cron_allow_file: /etc/cron.allow
    cron_deny_file: /etc/cron.deny
    at_allow_file: /etc/at.allow
    at_deny_file: /etc/at.deny
    authorized_cron_users:
      - root
    authorized_at_users:
      - root
    authorized_su_users:
      - root
    cis_apply_security_updates: false
    cis_6_2_10_remediate: false
    cis_6_2_11_remediate: false


  tasks:
    - name: Crear directorio /etc/modprobe.d si no existe
      file:
        path: /etc/modprobe.d
        state: directory
        mode: '0755'
        owner: root
        group: root


    - name: Crear archivos de configuracion para deshabilitar filesystems
      copy:
        dest: "/etc/modprobe.d/{{ item }}.conf"
        content: |
          # Deshabilitar {{ item }} segun CIS Benchmark
          install {{ item }} /bin/true
        owner: root
        group: root
        mode: '0644'
      loop: "{{ filesystems_to_disable }}"
      register: fs_config


    - name: Verificar si los modulos estan cargados
      shell: "lsmod | grep -w {{ item }}"
      loop: "{{ filesystems_to_disable }}"
      register: fs_loaded
      failed_when: false
      changed_when: false


    - name: Descargar modulos que estan cargados
      modprobe:
        name: "{{ item.item }}"
        state: absent
      loop: "{{ fs_loaded.results }}"
      when: item.stdout != ""
      ignore_errors: yes


    - name: Verificar que los modulos no se pueden cargar
      command: "modprobe -n -v {{ item }}"
      loop: "{{ filesystems_to_disable }}"
      register: fs_check
      changed_when: false


    - name: Mostrar resultados de verificacion
      debug:
        msg: 
          - "Filesystem: {{ item.item }}"
          - "Estado: {{ item.stdout }}"
      loop: "{{ fs_check.results }}"


    - name: Verificacion final - Confirmar que los modulos no estan en lsmod
      shell: "lsmod | grep -w {{ item }}"
      loop: "{{ filesystems_to_disable }}"
      register: final_check
      failed_when: final_check.stdout != ""
      changed_when: false
    
    - name: Crear archivo de configuracion para deshabilitar USB storage
      copy:
        dest: /etc/modprobe.d/usb_storage.conf
        content: |
          # Deshabilitar USB storage segun la CIS Benchmark 1.1.23
          install usb-storage /bin/true
        owner: root
      group: root 
      mode: '0644'
    
    - name: Verificar si el modulo usb-storage esta cargando 
      shell: "lsmod | grep -w usb-storage"
      register: usb_loaded
      failed_when: false
      changed_when: false
    
    - name: Descargar modulo usb-storage si esta cargando
      modprobe:
        name: usb-storage
        state: absent
      when: usb_loaded.item.stdout != ""
      ignore_errors: yes


   - name: Verificar que usb-storage no se puede cargar
      command: "modprobe -n -v usb-storage"
      register: usb_check
      changed_when: false


    - name: Mostrar resultados de verificacion de USB storage
      debug:
        msg:
          - "Modulo: usb-storage"
          - "Estado esperado: install /bin/true"
          - "Salida real {{ usb_check.item.stdout }}"


    - name: Verificacion final - confirmar que usb-storage no esta en lsmod
      shell: "lsmod | grep -w usb-storage"
      register: usb_final_check
      failed_when: usb_final_check.item.stdout != ""
      changed_when: false
    
    - name: CIS 1.5.3 - Comentar configuraciones incorrectas de ASLR en /etc/sysctl.conf
      replace:
        path: /etc/sysctl.conf
        regexp: '^\s*kernel\.randomize_va_space\s*=\s*([0-1]|[3-9]|[1-9][0-9]+)'
        replace: '# \g<0>'
      register: sysctl_conf_aslr 
    
    - name: CIS 1.5.3 - Comentar la configuracio incorrectas de ASLR en /etc/sysctl.d/*
      replace:
        path: "{{ item.path }}"
        regexp: '^\s*kernel\.randomize_va_space\s*=\s*([0-1]|[3-9]|[1-9][0-9]+)'
        replace: '# \g<0>'
        loop: "{{ sysctl_d_files.files  }}"
        when: sysctl_d_files.matched > 0
        register: sysctl_d_aslr


    - name: CIS 1.5.3 - Configurar ASLR en /etc/sysctl.d/99-cis-aslr.conf
      sysctl:
        name: kernel.randomize_va_space
        value: '2'
        sysctl_file: /etc/sysctl.d/99-cis-aslr.conf
        state: present
        reload: yes
      register: aslr_config


    - name: CIS 1.5.3 - Aplicar configuracion de ASLR inmediatamente
      command: sysctl -w kernel.randomize_va_space=2
      when: aslr_config.changed


    - name: CIS 1.5.3 - Verificar configuracion actual de ASLR
      command: sysctl kernel.randomize_va_space
      register: aslr_current
      changed_when: false


    - name: CIS 1.5.3 - Verificar que no existan configuraciones incorrectas de ASLR
      shell: |
        grep -Es "^\s*kernel\.randomize_va_space\s*=\s*([0-1]|[3-9]|[1-9][0-9]+)" /etc/sysctl.conf /etc/sysctl.d/* 2>/dev/null || true
      register: aslr_incorrect
      changed_when: false


    - name: CIS 1.5.3 - Mostrar resultado de verificacion de ASLR
      debug:
        msg:
          - "Valor actual de ASLR: {{ aslr_current.stdout }}"
          - "Configuraciones incorrectas encontradas: {{ 'No' if aslr_incorrect.stdout == '' else 'Si - Revisar manualmente' }}"


    - name: CIS 1.5.4 - Verificar si prelink esta instalado
      command: rpm -q prelink
      register: prelink_check
      failed_when: false
      changed_when: false


    - name: CIS 1.5.4 - Mostrar estado de prelink
      debug:
        msg: "Estado de prelink: {{ prelink_check.stdout }}"


    - name: CIS 1.5.4 - Restaurar binarios a estado normal (si prelink esta instalado)
      command: prelink -ua
      when: prelink_check.rc == 0
      register: prelink_restore
      failed_when: false
      ignore_errors: yes


    - name: CIS 1.5.4 - Desinstalar prelink (yum/dnf)
      yum:
        name: prelink
        state: absent
      when:
        - prelink_check.rc == 0
        - ansible_pkg_mgr in ['yum', 'dnf']
      register: prelink_removed_yum


    - name: CIS 1.5.4 - Desinstalar prelink (apt)
      apt:
        name: prelink
        state: absent
        purge: yes
      when:
        - prelink_check.rc == 0
        - ansible_pkg_mgr == 'apt'
      register: prelink_removed_apt


    - name: CIS 1.5.4 - Verificar que prelink fue desinstalado
      command: rpm -q prelink
      register: prelink_final_check
      failed_when: prelink_final_check.rc == 0
      changed_when: false
      when: ansible_pkg_mgr in ['yum', 'dnf']


    - name: CIS 1.5.4 - Verificar que prelink fue desinstalado (Debian/Ubuntu)
      command: dpkg -l prelink
      register: prelink_final_check_deb
      failed_when: prelink_final_check_deb.rc == 0
      changed_when: false
      when: ansible_pkg_mgr == 'apt'


    - name: CIS 1.5.4 - Mostrar resultado final de prelink
      debug:
        msg: "Prelink ha sido {{ 'desinstalado correctamente' if (prelink_removed_yum.changed | default(false)) or (prelink_removed_apt.changed | default(false)) else 'no estaba instalado' }}"
    
    - name: 1.6.1.4 - verificar el estado actual del SELinux
      command: getenforce
      register: selinux_current
      changed_when: false
      failed_when: false


    - name: CIS 1.6.1.4 - Fallar si SELinux esta deshabilitado en runtime
      fail:
        msg: "SELinux esta DESHABILITADO. Esto no cumple CIS 1.6.1.4 y requiere intervencion manual."
      when: selinux_current.stdout == "Disabled"
    
    - name: CIS 1.6.1.4 - Configurar SELinux en /etc/selinux/config
      replace:
        path: /etc/selinux/config
        regexp: '^\s*SELINUX=.*'
        replace: "SELINUX={{ selinux_desired_state }}"
      register: selinux_config_file


    - name: CIS 1.6.1.4 - Asegurar que SELINUXTYPE esta definido
      lineinfile:
        path: /etc/selinux/config
        regexp: '^SELINUXTYPE='
        line: 'SELINUXTYPE=targeted'
        state: present


    - name: CIS 1.6.1.4 - Aplicar modo SELinux en runtime (enforcing)
      command: setenforce 1
      when:
        - selinux_desired_state == "enforcing"
        - selinux_current.stdout != "Enforcing"
      failed_when: false


    - name: CIS 1.6.1.4 - Aplicar modo SELinux en runtime (permissive)
      command: setenforce 0
      when:
        - selinux_desired_state == "permissive"
        - selinux_current.stdout != "Permissive"
      failed_when: false


    - name: CIS 1.6.1.4 - Verificar modo final de SELinux
      command: getenforce
      register: selinux_final
      changed_when: false


    - name: CIS 1.6.1.4 - Mostrar resultado de SELinux
      debug:
        msg:
          - "SELinux modo anterior: {{ selinux_current.stdout }}"
          - "SELinux modo configurado: {{ selinux_desired_state }}"
          - "SELinux modo final: {{ selinux_final.stdout }}"
    
    - name: CIS 1.9 - Verificar actualizaciones de seguridad disponibles (yum/dnf)
      command: "{{ ansible_pkg_mgr }} check-update --security"
      register: security_updates
      changed_when: false
      failed_when: false
      when: ansible_pkg_mgr in ['yum', 'dnf']


    - name: CIS 1.9 - Mostrar actualizaciones de seguridad pendientes
      debug:
        msg:
          - "Actualizaciones de seguridad pendientes:"
          - "{{ security_updates.stdout_lines | default(['No hay actualizaciones pendientes']) }}"
      when: ansible_pkg_mgr in ['yum', 'dnf']


    - name: CIS 1.9 - Aplicar actualizaciones de seguridad (yum)
      yum:
        name: '*'
        state: latest
        security: yes
      when:
        - cis_apply_security_updates | bool
        - ansible_pkg_mgr == 'yum'
      register: yum_security_update


    - name: CIS 1.9 - Aplicar actualizaciones de seguridad (dnf)
      dnf:
        name: '*'
        state: latest
        security: yes
      when:
        - cis_apply_security_updates | bool
        - ansible_pkg_mgr == 'dnf'
      register: dnf_security_update


    - name: CIS 1.9 - Verificar nuevamente actualizaciones de seguridad
      command: "{{ ansible_pkg_mgr }} check-update --security"
      register: security_updates_final
      changed_when: false
      failed_when: false
      when: ansible_pkg_mgr in ['yum', 'dnf']


    - name: CIS 1.9 - Resultado final de parches de seguridad
      debug:
        msg:
          - "Remediacion automatica aplicada: {{ cis_apply_security_updates }}"
          - "Actualizaciones pendientes despues de la ejecucion:"
          - "{{ security_updates_final.stdout_lines | default(['Sistema actualizado']) }}"
    
    - name: CIS 2.2.2 - Verificar si X11 Server esta instalado
      shell: rpm -qa xorg-x11-server*
      register: x11_check
      changed_when: false
      failed_when: false
      when: ansible_pkg_mgr in ['yum', 'dnf']


    - name: CIS 2.2.2 - Mostrar paquetes X11 encontrados
      debug:
        msg:
          - "Paquetes X11 Server instalados:"
          - "{{ x11_check.stdout_lines if x11_check.stdout_lines | length > 0 else ['Ninguno'] }}"
      when: ansible_pkg_mgr in ['yum', 'dnf']


    - name: CIS 2.2.2 - Eliminar X11 Server components (yum/dnf)
      yum:
        name: "xorg-x11-server*"
        state: absent
      when:
        - ansible_pkg_mgr in ['yum', 'dnf']
        - x11_check.stdout_lines | length > 0
      register: x11_removed


    - name: CIS 2.2.2 - Verificar si X11 Server esta instalado (Debian/Ubuntu)
      shell: dpkg -l | grep -E "xserver-xorg|xorg"
      register: x11_check_deb
      changed_when: false
      failed_when: false
      when: ansible_pkg_mgr == 'apt'


    - name: CIS 2.2.2 - Eliminar X11 Server components (apt)
      apt:
        name:
          - xserver-xorg*
          - xserver-common
        state: absent
        purge: yes
      when:
        - ansible_pkg_mgr == 'apt'
        - x11_check_deb.rc == 0
      register: x11_removed_apt


    - name: CIS 2.2.2 - Verificacion final X11 (RHEL/CentOS)
      shell: rpm -qa xorg-x11-server*
      register: x11_final_check
      changed_when: false
      failed_when: x11_final_check.stdout_lines | length > 0
      when: ansible_pkg_mgr in ['yum', 'dnf']


    - name: CIS 2.2.2 - Verificacion final X11 (Debian/Ubuntu)
      shell: dpkg -l | grep -E "xserver-xorg|xserver-common"
      register: x11_final_check_deb
      changed_when: false
      failed_when: x11_final_check_deb.rc == 0
      when: ansible_pkg_mgr == 'apt'


    - name: CIS 2.2.2 - Mostrar resultado final
      debug:
        msg: "X11 Server components han sido {{ 'eliminados correctamente' if (x11_removed.changed | default(false)) or (x11_removed_apt.changed | default(false)) else 'no estaban instalados' }}"


    - name: CIS 2.2.3 - Verificar si Avahi Server esta instalado (RHEL/CentOS)
      command: rpm -q avahi
      register: avahi_check
      changed_when: false
      failed_when: false
      when: ansible_pkg_mgr in ['yum', 'dnf']


    - name: CIS 2.2.3 - Verificar si Avahi Server esta instalado (Debian/Ubuntu)
      command: dpkg -l avahi-daemon
      register: avahi_check_deb
      changed_when: false
      failed_when: false
      when: ansible_pkg_mgr == 'apt'


    - name: CIS 2.2.3 - Mostrar estado de Avahi
      debug:
        msg:
          - "Estado de Avahi Server:"
          - "{{ avahi_check.stdout if ansible_pkg_mgr in ['yum', 'dnf'] else avahi_check_deb.stdout }}"


    - name: CIS 2.2.3 - Detener servicio Avahi si esta corriendo (RHEL/CentOS)
      systemd:
        name: avahi-daemon
        state: stopped
        enabled: no
      when:
        - ansible_pkg_mgr in ['yum', 'dnf']
        - avahi_check.rc == 0
      failed_when: false
      ignore_errors: yes


    - name: CIS 2.2.3 - Detener servicio Avahi si esta corriendo (Debian/Ubuntu)
      systemd:
        name: avahi-daemon
        state: stopped
        enabled: no
      when:
        - ansible_pkg_mgr == 'apt'
        - avahi_check_deb.rc == 0
      failed_when: false
      ignore_errors: yes


    - name: CIS 2.2.3 - Eliminar Avahi Server (yum/dnf)
      yum:
        name: avahi
        state: absent
      when:
        - ansible_pkg_mgr in ['yum', 'dnf']
        - avahi_check.rc == 0
      register: avahi_removed


    - name: CIS 2.2.3 - Eliminar Avahi Server (apt)
      apt:
        name:
          - avahi-daemon
          - avahi-autoipd
        state: absent
        purge: yes
      when:
        - ansible_pkg_mgr == 'apt'
        - avahi_check_deb.rc == 0
      register: avahi_removed_apt


    - name: CIS 2.2.3 - Verificacion final Avahi (RHEL/CentOS)
      command: rpm -q avahi
      register: avahi_final_check
      changed_when: false
      failed_when: avahi_final_check.rc == 0
      when: ansible_pkg_mgr in ['yum', 'dnf']


    - name: CIS 2.2.3 - Verificacion final Avahi (Debian/Ubuntu)
      command: dpkg -l avahi-daemon
      register: avahi_final_check_deb
      changed_when: false
      failed_when: avahi_final_check_deb.rc == 0
      when: ansible_pkg_mgr == 'apt'


    - name: CIS 2.2.3 - Mostrar resultado final
      debug:
        msg: "Avahi Server ha sido {{ 'eliminado correctamente' if (avahi_removed.changed | default(false)) or (avahi_removed_apt.changed | default(false)) else 'no estaba instalado' }}"


    - name: CIS 2.2.4 - Verificar si CUPS esta instalado (RHEL/CentOS)
      command: rpm -q cups
      register: cups_check
      changed_when: false
      failed_when: false
      when: ansible_pkg_mgr in ['yum', 'dnf']


    - name: CIS 2.2.4 - Verificar si CUPS esta instalado (Debian/Ubuntu)
      command: dpkg -l cups
      register: cups_check_deb
      changed_when: false
      failed_when: false
      when: ansible_pkg_mgr == 'apt'


    - name: CIS 2.2.4 - Mostrar estado de CUPS
      debug:
        msg:
          - "Estado de CUPS (Common Unix Print System):"
          - "{{ cups_check.stdout if ansible_pkg_mgr in ['yum', 'dnf'] else cups_check_deb.stdout }}"


    - name: CIS 2.2.4 - Detener servicio CUPS si esta corriendo (RHEL/CentOS)
      systemd:
        name: cups
        state: stopped
        enabled: no
      when:
        - ansible_pkg_mgr in ['yum', 'dnf']
        - cups_check.rc == 0
      failed_when: false
      ignore_errors: yes


    - name: CIS 2.2.4 - Detener servicio CUPS si esta corriendo (Debian/Ubuntu)
      systemd:
        name: cups
        state: stopped
        enabled: no
      when:
        - ansible_pkg_mgr == 'apt'
        - cups_check_deb.rc == 0
      failed_when: false
      ignore_errors: yes


    - name: CIS 2.2.4 - Eliminar CUPS (yum/dnf)
      yum:
        name: cups
        state: absent
      when:
        - ansible_pkg_mgr in ['yum', 'dnf']
        - cups_check.rc == 0
      register: cups_removed


    - name: CIS 2.2.4 - Eliminar CUPS (apt)
      apt:
        name:
          - cups
          - cups-client
          - cups-common
        state: absent
        purge: yes
      when:
        - ansible_pkg_mgr == 'apt'
        - cups_check_deb.rc == 0
      register: cups_removed_apt


    - name: CIS 2.2.4 - Verificacion final CUPS (RHEL/CentOS)
      command: rpm -q cups
      register: cups_final_check
      changed_when: false
      failed_when: cups_final_check.rc == 0
      when: ansible_pkg_mgr in ['yum', 'dnf']


    - name: CIS 2.2.4 - Verificacion final CUPS (Debian/Ubuntu)
      command: dpkg -l cups
      register: cups_final_check_deb
      changed_when: false
      failed_when: cups_final_check_deb.rc == 0
      when: ansible_pkg_mgr == 'apt'


    - name: CIS 2.2.4 - Mostrar resultado final
      debug:
        msg: 
          - "CUPS ha sido {{ 'eliminado correctamente' if (cups_removed.changed | default(false)) or (cups_removed_apt.changed | default(false)) else 'no estaba instalado' }}"
          - "NOTA: La eliminacion de CUPS previene la impresion desde este sistema"


    - name: CIS 2.2.5 - Verificar si DHCP Server esta instalado (RHEL/CentOS)
      command: rpm -q dhcp
      register: dhcp_check
      changed_when: false
      failed_when: false
      when: ansible_pkg_mgr in ['yum', 'dnf']


    - name: CIS 2.2.5 - Verificar si DHCP Server esta instalado (Debian/Ubuntu)
      command: dpkg -l isc-dhcp-server
      register: dhcp_check_deb
      changed_when: false
      failed_when: false
      when: ansible_pkg_mgr == 'apt'


    - name: CIS 2.2.5 - Mostrar estado de DHCP Server
      debug:
        msg:
          - "Estado de DHCP Server:"
          - "{{ dhcp_check.stdout if ansible_pkg_mgr in ['yum', 'dnf'] else dhcp_check_deb.stdout }}"


    - name: CIS 2.2.5 - Detener servicio DHCP si esta corriendo (RHEL/CentOS)
      systemd:
        name: dhcpd
        state: stopped
        enabled: no
      when:
        - ansible_pkg_mgr in ['yum', 'dnf']
        - dhcp_check.rc == 0
      failed_when: false
      ignore_errors: yes


    - name: CIS 2.2.5 - Detener servicio DHCP si esta corriendo (Debian/Ubuntu)
      systemd:
        name: isc-dhcp-server
        state: stopped
        enabled: no
      when:
        - ansible_pkg_mgr == 'apt'
        - dhcp_check_deb.rc == 0
      failed_when: false
      ignore_errors: yes


    - name: CIS 2.2.5 - Eliminar DHCP Server (yum/dnf)
      yum:
        name: dhcp
        state: absent
      when:
        - ansible_pkg_mgr in ['yum', 'dnf']
        - dhcp_check.rc == 0
      register: dhcp_removed


    - name: CIS 2.2.5 - Eliminar DHCP Server (apt)
      apt:
        name:
          - isc-dhcp-server
          - isc-dhcp-common
        state: absent
        purge: yes
      when:
        - ansible_pkg_mgr == 'apt'
        - dhcp_check_deb.rc == 0
      register: dhcp_removed_apt


    - name: CIS 2.2.5 - Verificacion final DHCP Server (RHEL/CentOS)
      command: rpm -q dhcp
      register: dhcp_final_check
      changed_when: false
      failed_when: dhcp_final_check.rc == 0
      when: ansible_pkg_mgr in ['yum', 'dnf']


    - name: CIS 2.2.5 - Verificacion final DHCP Server (Debian/Ubuntu)
      command: dpkg -l isc-dhcp-server
      register: dhcp_final_check_deb
      changed_when: false
      failed_when: dhcp_final_check_deb.rc == 0
      when: ansible_pkg_mgr == 'apt'


    - name: CIS 2.2.5 - Mostrar resultado final
      debug:
        msg: 
          - "DHCP Server ha sido {{ 'eliminado correctamente' if (dhcp_removed.changed | default(false)) or (dhcp_removed_apt.changed | default(false)) else 'no estaba instalado' }}"
          - "NOTA: Solo eliminar si el sistema NO actua como servidor DHCP"


    - name: CIS 2.2.6 - Verificar si LDAP Server esta instalado (RHEL/CentOS)
      command: rpm -q openldap-servers
      register: ldap_check
      changed_when: false
      failed_when: false
      when: ansible_pkg_mgr in ['yum', 'dnf']


    - name: CIS 2.2.6 - Verificar si LDAP Server esta instalado (Debian/Ubuntu)
      command: dpkg -l slapd
      register: ldap_check_deb
      changed_when: false
      failed_when: false
      when: ansible_pkg_mgr == 'apt'


    - name: CIS 2.2.6 - Mostrar estado de LDAP Server
      debug:
        msg:
          - "Estado de LDAP Server (OpenLDAP):"
          - "{{ ldap_check.stdout if ansible_pkg_mgr in ['yum', 'dnf'] else ldap_check_deb.stdout }}"


    - name: CIS 2.2.6 - Detener servicio LDAP si esta corriendo (RHEL/CentOS)
      systemd:
        name: slapd
        state: stopped
        enabled: no
      when:
        - ansible_pkg_mgr in ['yum', 'dnf']
        - ldap_check.rc == 0
      failed_when: false
      ignore_errors: yes


    - name: CIS 2.2.6 - Detener servicio LDAP si esta corriendo (Debian/Ubuntu)
      systemd:
        name: slapd
        state: stopped
        enabled: no
      when:
        - ansible_pkg_mgr == 'apt'
        - ldap_check_deb.rc == 0
      failed_when: false
      ignore_errors: yes


    - name: CIS 2.2.6 - Eliminar LDAP Server (yum/dnf)
      yum:
        name: openldap-servers
        state: absent
      when:
        - ansible_pkg_mgr in ['yum', 'dnf']
        - ldap_check.rc == 0
      register: ldap_removed


    - name: CIS 2.2.6 - Eliminar LDAP Server (apt)
      apt:
        name:
          - slapd
          - ldap-utils
        state: absent
        purge: yes
      when:
        - ansible_pkg_mgr == 'apt'
        - ldap_check_deb.rc == 0
      register: ldap_removed_apt


    - name: CIS 2.2.6 - Verificacion final LDAP Server (RHEL/CentOS)
      command: rpm -q openldap-servers
      register: ldap_final_check
      changed_when: false
      failed_when: ldap_final_check.rc == 0
      when: ansible_pkg_mgr in ['yum', 'dnf']


    - name: CIS 2.2.6 - Verificacion final LDAP Server (Debian/Ubuntu)
      command: dpkg -l slapd
      register: ldap_final_check_deb
      changed_when: false
      failed_when: ldap_final_check_deb.rc == 0
      when: ansible_pkg_mgr == 'apt'


    - name: CIS 2.2.6 - Mostrar resultado final
      debug:
        msg: 
          - "LDAP Server ha sido {{ 'eliminado correctamente' if (ldap_removed.changed | default(false)) or (ldap_removed_apt.changed | default(false)) else 'no estaba instalado' }}"
          - "NOTA: Solo eliminar si el sistema NO actua como servidor LDAP"


    - name: CIS 2.2.7 - Verificar si DNS Server esta instalado (RHEL/CentOS)
      command: rpm -q bind
      register: dns_check
      changed_when: false
      failed_when: false
      when: ansible_pkg_mgr in ['yum', 'dnf']


    - name: CIS 2.2.7 - Verificar si DNS Server esta instalado (Debian/Ubuntu)
      command: dpkg -l bind9
      register: dns_check_deb
      changed_when: false
      failed_when: false
      when: ansible_pkg_mgr == 'apt'


    - name: CIS 2.2.7 - Mostrar estado de DNS Server
      debug:
        msg:
          - "Estado de DNS Server (BIND):"
          - "{{ dns_check.stdout if ansible_pkg_mgr in ['yum', 'dnf'] else dns_check_deb.stdout }}"


    - name: CIS 2.2.7 - Detener servicio DNS si esta corriendo (RHEL/CentOS)
      systemd:
        name: named
        state: stopped
        enabled: no
      when:
        - ansible_pkg_mgr in ['yum', 'dnf']
        - dns_check.rc == 0
      failed_when: false
      ignore_errors: yes


    - name: CIS 2.2.7 - Detener servicio DNS si esta corriendo (Debian/Ubuntu)
      systemd:
        name: bind9
        state: stopped
        enabled: no
      when:
        - ansible_pkg_mgr == 'apt'
        - dns_check_deb.rc == 0
      failed_when: false
      ignore_errors: yes


    - name: CIS 2.2.7 - Eliminar DNS Server (yum/dnf)
      yum:
        name: bind
        state: absent
      when:
        - ansible_pkg_mgr in ['yum', 'dnf']
        - dns_check.rc == 0
      register: dns_removed


    - name: CIS 2.2.7 - Eliminar DNS Server (apt)
      apt:
        name:
          - bind9
          - bind9utils
          - bind9-doc
        state: absent
        purge: yes
      when:
        - ansible_pkg_mgr == 'apt'
        - dns_check_deb.rc == 0
      register: dns_removed_apt


    - name: CIS 2.2.7 - Verificacion final DNS Server (RHEL/CentOS)
      command: rpm -q bind
      register: dns_final_check
      changed_when: false
      failed_when: dns_final_check.rc == 0
      when: ansible_pkg_mgr in ['yum', 'dnf']


    - name: CIS 2.2.7 - Verificacion final DNS Server (Debian/Ubuntu)
      command: dpkg -l bind9
      register: dns_final_check_deb
      changed_when: false
      failed_when: dns_final_check_deb.rc == 0
      when: ansible_pkg_mgr == 'apt'


    - name: CIS 2.2.7 - Mostrar resultado final
      debug:
        msg: 
          - "DNS Server (BIND) ha sido {{ 'eliminado correctamente' if (dns_removed.changed | default(false)) or (dns_removed_apt.changed | default(false)) else 'no estaba instalado' }}"
          - "NOTA: Solo eliminar si el sistema NO actua como servidor DNS autorizado"


    - name: CIS 2.2.8 - Verificar si FTP Server (vsftpd) esta instalado (RHEL/CentOS)
      command: rpm -q vsftpd
      register: ftp_check
      changed_when: false
      failed_when: false
      when: ansible_pkg_mgr in ['yum', 'dnf']


    - name: CIS 2.2.8 - Verificar si FTP Server (vsftpd) esta instalado (Debian/Ubuntu)
      command: dpkg -l vsftpd
      register: ftp_check_deb
      changed_when: false
      failed_when: false
      when: ansible_pkg_mgr == 'apt'


    - name: CIS 2.2.8 - Detener servicio FTP si esta corriendo
      systemd:
        name: vsftpd
        state: stopped
        enabled: no
      when:
        - (ansible_pkg_mgr in ['yum', 'dnf'] and ftp_check.rc == 0) or
          (ansible_pkg_mgr == 'apt' and ftp_check_deb.rc == 0)
      failed_when: false
      ignore_errors: yes


    - name: CIS 2.2.8 - Eliminar FTP Server
      package:
        name: vsftpd
        state: absent
      register: ftp_removed


    - name: CIS 2.2.9 - Verificar si HTTP Server esta instalado (RHEL/CentOS)
      command: rpm -q httpd
      register: http_check
      changed_when: false
      failed_when: false
      when: ansible_pkg_mgr in ['yum', 'dnf']


    - name: CIS 2.2.9 - Verificar si HTTP Server esta instalado (Debian/Ubuntu)
      command: dpkg -l apache2
      register: http_check_deb
      changed_when: false
      failed_when: false
      when: ansible_pkg_mgr == 'apt'


    - name: CIS 2.2.9 - Detener servicio HTTP si esta corriendo
      systemd:
        name: "{{ 'httpd' if ansible_pkg_mgr in ['yum','dnf'] else 'apache2' }}"
        state: stopped
        enabled: no
      when:
        - (ansible_pkg_mgr in ['yum', 'dnf'] and http_check.rc == 0) or
          (ansible_pkg_mgr == 'apt' and http_check_deb.rc == 0)
      failed_when: false
      ignore_errors: yes


    - name: CIS 2.2.9 - Eliminar HTTP Server
      package:
        name: "{{ 'httpd' if ansible_pkg_mgr in ['yum','dnf'] else 'apache2' }}"
        state: absent
      register: http_removed


    - name: CIS 2.2.10 - Verificar si IMAP/POP3 Server (dovecot) esta instalado (RHEL/CentOS)
      command: rpm -q dovecot
      register: mail_check
      changed_when: false
      failed_when: false
      when: ansible_pkg_mgr in ['yum', 'dnf']


    - name: CIS 2.2.10 - Verificar si IMAP/POP3 Server esta instalado (Debian/Ubuntu)
      command: dpkg -l dovecot-core
      register: mail_check_deb
      changed_when: false
      failed_when: false
      when: ansible_pkg_mgr == 'apt'


    - name: CIS 2.2.10 - Detener servicio IMAP/POP3
      systemd:
        name: dovecot
        state: stopped
        enabled: no
      when:
        - (ansible_pkg_mgr in ['yum', 'dnf'] and mail_check.rc == 0) or
          (ansible_pkg_mgr == 'apt' and mail_check_deb.rc == 0)
      failed_when: false
      ignore_errors: yes


    - name: CIS 2.2.10 - Eliminar IMAP/POP3 Server
      package:
        name: dovecot
        state: absent
      register: mail_removed


    - name: CIS 2.2.11 - Verificar si Samba esta instalado (RHEL/CentOS)
      command: rpm -q samba
      register: samba_check
      changed_when: false
      failed_when: false
      when: ansible_pkg_mgr in ['yum', 'dnf']


    - name: CIS 2.2.11 - Verificar si Samba esta instalado (Debian/Ubuntu)
      command: dpkg -l samba
      register: samba_check_deb
      changed_when: false
      failed_when: false
      when: ansible_pkg_mgr == 'apt'


    - name: CIS 2.2.11 - Detener servicio Samba si esta corriendo
      systemd:
        name: smb
        state: stopped
        enabled: no
      when:
        - (ansible_pkg_mgr in ['yum','dnf'] and samba_check.rc == 0) or
          (ansible_pkg_mgr == 'apt' and samba_check_deb.rc == 0)
      failed_when: false
      ignore_errors: yes


    - name: CIS 2.2.11 - Eliminar Samba (yum/dnf)
      yum:
        name: samba
        state: absent
      when:
        - ansible_pkg_mgr in ['yum','dnf']
        - samba_check.rc == 0
      register: samba_removed


    - name: CIS 2.2.11 - Eliminar Samba (apt)
      apt:
        name: samba
        state: absent
        purge: yes
      when:
        - ansible_pkg_mgr == 'apt'
        - samba_check_deb.rc == 0
      register: samba_removed_apt


    - name: CIS 2.2.11 - Verificacion final Samba (RHEL/CentOS)
      command: rpm -q samba
      register: samba_final_check
      changed_when: false
      failed_when: samba_final_check.rc == 0
      when: ansible_pkg_mgr in ['yum','dnf']


    - name: CIS 2.2.12 - Verificar si HTTP Proxy (Squid) esta instalado (RHEL/CentOS)
      command: rpm -q squid
      register: squid_check
      changed_when: false
      failed_when: false
      when: ansible_pkg_mgr in ['yum','dnf']


    - name: CIS 2.2.12 - Verificar si HTTP Proxy (Squid) esta instalado (Debian/Ubuntu)
      command: dpkg -l squid
      register: squid_check_deb
      changed_when: false
      failed_when: false
      when: ansible_pkg_mgr == 'apt'


    - name: CIS 2.2.12 - Detener servicio Squid si esta corriendo
      systemd:
        name: squid
        state: stopped
        enabled: no
      when:
        - (ansible_pkg_mgr in ['yum','dnf'] and squid_check.rc == 0) or
          (ansible_pkg_mgr == 'apt' and squid_check_deb.rc == 0)
      failed_when: false
      ignore_errors: yes


    - name: CIS 2.2.12 - Eliminar HTTP Proxy Server (Squid)
      package:
        name: squid
        state: absent
      register: squid_removed


    - name: CIS 2.2.13 - Verificar si SNMP Server (net-snmp) esta instalado (RHEL/CentOS)
      command: rpm -q net-snmp
      register: snmp_check
      changed_when: false
      failed_when: false
      when: ansible_pkg_mgr in ['yum', 'dnf']


    - name: CIS 2.2.13 - Verificar si SNMP Server esta instalado (Debian/Ubuntu)
      command: dpkg -l snmpd
      register: snmp_check_deb
      changed_when: false
      failed_when: false
      when: ansible_pkg_mgr == 'apt'


    - name: CIS 2.2.13 - Detener servicio SNMP si esta corriendo
      systemd:
        name: snmpd
        state: stopped
        enabled: no
      when:
        - (ansible_pkg_mgr in ['yum', 'dnf'] and snmp_check.rc == 0) or
          (ansible_pkg_mgr == 'apt' and snmp_check_deb.rc == 0)
      failed_when: false
      ignore_errors: yes


    - name: CIS 2.2.13 - Eliminar SNMP Server (yum/dnf)
      yum:
        name: net-snmp
        state: absent
      when:
        - ansible_pkg_mgr in ['yum', 'dnf']
        - snmp_check.rc == 0
      register: snmp_removed


    - name: CIS 2.2.13 - Eliminar SNMP Server (apt)
      apt:
        name:
          - snmpd
          - snmp
        state: absent
        purge: yes
      when:
        - ansible_pkg_mgr == 'apt'
        - snmp_check_deb.rc == 0
      register: snmp_removed_apt


    - name: CIS 2.2.13 - Mostrar resultado
      debug:
        msg: 
          - "SNMP Server ha sido {{ 'eliminado correctamente' if (snmp_removed.changed | default(false)) or (snmp_removed_apt.changed | default(false)) else 'no estaba instalado' }}"
          - "NOTA: SNMPv1/v2 transmiten datos en texto claro sin cifrado"


    - name: CIS 2.2.14 - Verificar si NIS Server (ypserv) esta instalado (RHEL/CentOS)
      command: rpm -q ypserv
      register: nis_check
      changed_when: false
      failed_when: false
      when: ansible_pkg_mgr in ['yum', 'dnf']


    - name: CIS 2.2.14 - Verificar si NIS Server esta instalado (Debian/Ubuntu)
      command: dpkg -l nis
      register: nis_check_deb
      changed_when: false
      failed_when: false
      when: ansible_pkg_mgr == 'apt'


    - name: CIS 2.2.14 - Detener servicio NIS si esta corriendo
      systemd:
        name: ypserv
        state: stopped
        enabled: no
      when:
        - (ansible_pkg_mgr in ['yum', 'dnf'] and nis_check.rc == 0) or
          (ansible_pkg_mgr == 'apt' and nis_check_deb.rc == 0)
      failed_when: false
      ignore_errors: yes


    - name: CIS 2.2.14 - Eliminar NIS Server (yum/dnf)
      yum:
        name: ypserv
        state: absent
      when:
        - ansible_pkg_mgr in ['yum', 'dnf']
        - nis_check.rc == 0
      register: nis_removed


    - name: CIS 2.2.14 - Eliminar NIS Server (apt)
      apt:
        name: nis
        state: absent
        purge: yes
      when:
        - ansible_pkg_mgr == 'apt'
        - nis_check_deb.rc == 0
      register: nis_removed_apt


    - name: CIS 2.2.14 - Mostrar resultado
      debug:
        msg: 
          - "NIS Server ha sido {{ 'eliminado correctamente' if (nis_removed.changed | default(false)) or (nis_removed_apt.changed | default(false)) else 'no estaba instalado' }}"
          - "NOTA: NIS es inherentemente inseguro, reemplazado por LDAP"


    - name: CIS 2.2.15 - Verificar si Telnet Server esta instalado (RHEL/CentOS)
      command: rpm -q telnet-server
      register: telnet_check
      changed_when: false
      failed_when: false
      when: ansible_pkg_mgr in ['yum', 'dnf']


    - name: CIS 2.2.15 - Verificar si Telnet Server esta instalado (Debian/Ubuntu)
      command: dpkg -l telnetd
      register: telnet_check_deb
      changed_when: false
      failed_when: false
      when: ansible_pkg_mgr == 'apt'


    - name: CIS 2.2.15 - Detener servicio Telnet si esta corriendo
      systemd:
        name: telnet
        state: stopped
        enabled: no
      when:
        - (ansible_pkg_mgr in ['yum', 'dnf'] and telnet_check.rc == 0) or
          (ansible_pkg_mgr == 'apt' and telnet_check_deb.rc == 0)
      failed_when: false
      ignore_errors: yes


    - name: CIS 2.2.15 - Eliminar Telnet Server (yum/dnf)
      yum:
        name: telnet-server
        state: absent
      when:
        - ansible_pkg_mgr in ['yum', 'dnf']
        - telnet_check.rc == 0
      register: telnet_removed


    - name: CIS 2.2.15 - Eliminar Telnet Server (apt)
      apt:
        name: telnetd
        state: absent
        purge: yes
      when:
        - ansible_pkg_mgr == 'apt'
        - telnet_check_deb.rc == 0
      register: telnet_removed_apt


    - name: CIS 2.2.15 - Mostrar resultado
      debug:
        msg: 
          - "Telnet Server ha sido {{ 'eliminado correctamente' if (telnet_removed.changed | default(false)) or (telnet_removed_apt.changed | default(false)) else 'no estaba instalado' }}"
          - "NOTA: Telnet no esta cifrado, usar SSH en su lugar"


    - name: CIS 2.2.16 - Verificar si NFS Server (nfs-utils) esta instalado (RHEL/CentOS)
      command: rpm -q nfs-utils
      register: nfs_check
      changed_when: false
      failed_when: false
      when: ansible_pkg_mgr in ['yum', 'dnf']


    - name: CIS 2.2.16 - Verificar si NFS Server esta instalado (Debian/Ubuntu)
      command: dpkg -l nfs-kernel-server
      register: nfs_check_deb
      changed_when: false
      failed_when: false
      when: ansible_pkg_mgr == 'apt'


    - name: CIS 2.2.16 - Detener y deshabilitar servicio NFS si esta corriendo
      systemd:
        name: nfs-server
        state: stopped
        enabled: no
        masked: yes
      when:
        - (ansible_pkg_mgr in ['yum', 'dnf'] and nfs_check.rc == 0) or
          (ansible_pkg_mgr == 'apt' and nfs_check_deb.rc == 0)
      failed_when: false
      ignore_errors: yes


    - name: CIS 2.2.16 - Eliminar NFS Server (yum/dnf) - solo si no es dependencia
      yum:
        name: nfs-utils
        state: absent
      when:
        - ansible_pkg_mgr in ['yum', 'dnf']
        - nfs_check.rc == 0
      register: nfs_removed
      failed_when: false
      ignore_errors: yes


    - name: CIS 2.2.16 - Eliminar NFS Server (apt)
      apt:
        name: nfs-kernel-server
        state: absent
        purge: yes
      when:
        - ansible_pkg_mgr == 'apt'
        - nfs_check_deb.rc == 0
      register: nfs_removed_apt


    - name: CIS 2.2.16 - Mostrar resultado
      debug:
        msg: 
          - "NFS Server ha sido {{ 'detenido/deshabilitado' if (nfs_removed.changed | default(false)) or (nfs_removed_apt.changed | default(false)) else 'procesado' }}"
          - "NOTA: Si nfs-utils es dependencia de libvirt, el servicio nfs-server queda deshabilitado"


    - name: CIS 2.2.17 - Verificar si rpcbind esta instalado (RHEL/CentOS)
      command: rpm -q rpcbind
      register: rpcbind_check
      changed_when: false
      failed_when: false
      when: ansible_pkg_mgr in ['yum', 'dnf']


    - name: CIS 2.2.17 - Verificar si rpcbind esta instalado (Debian/Ubuntu)
      command: dpkg -l rpcbind
      register: rpcbind_check_deb
      changed_when: false
      failed_when: false
      when: ansible_pkg_mgr == 'apt'


    - name: CIS 2.2.17 - Detener y deshabilitar servicio rpcbind
      systemd:
        name: rpcbind
        state: stopped
        enabled: no
        masked: yes
      when:
        - (ansible_pkg_mgr in ['yum', 'dnf'] and rpcbind_check.rc == 0) or
          (ansible_pkg_mgr == 'apt' and rpcbind_check_deb.rc == 0)
      failed_when: false
      ignore_errors: yes


    - name: CIS 2.2.17 - Eliminar rpcbind (yum/dnf) - solo si no es dependencia
      yum:
        name: rpcbind
        state: absent
      when:
        - ansible_pkg_mgr in ['yum', 'dnf']
        - rpcbind_check.rc == 0
      register: rpcbind_removed
      failed_when: false
      ignore_errors: yes


    - name: CIS 2.2.17 - Eliminar rpcbind (apt)
      apt:
        name: rpcbind
        state: absent
        purge: yes
      when:
        - ansible_pkg_mgr == 'apt'
        - rpcbind_check_deb.rc == 0
      register: rpcbind_removed_apt


    - name: CIS 2.2.17 - Mostrar resultado
      debug:
        msg: 
          - "rpcbind ha sido {{ 'detenido/deshabilitado' if (rpcbind_removed.changed | default(false)) or (rpcbind_removed_apt.changed | default(false)) else 'procesado' }}"
          - "NOTA: rpcbind puede ser usado en ataques DDoS (amplificacion 7x-28x)"


    - name: CIS 2.2.18 - Verificar configuracion de MTA (Mail Transfer Agent)
      shell: ss -lntu | grep -E ':25\s' | grep -E -v '\s(127.0.0.1|\[?::1\]?):25\s'
      register: mta_check
      changed_when: false
      failed_when: false


    - name: CIS 2.2.18 - Mostrar estado actual del MTA
      debug:
        msg:
          - "Verificacion MTA en puerto 25:"
          - "{{ 'MTA escuchando en interfaces no-loopback - REQUIERE CORRECCION' if mta_check.stdout != '' else 'MTA configurado correctamente (solo loopback)' }}"


    - name: CIS 2.2.18 - Verificar si Postfix esta instalado
      command: "{{ 'rpm -q postfix' if ansible_pkg_mgr in ['yum','dnf'] else 'dpkg -l postfix' }}"
      register: postfix_check
      changed_when: false
      failed_when: false


    - name: CIS 2.2.18 - Configurar Postfix para modo local-only
      lineinfile:
        path: /etc/postfix/main.cf
        regexp: '^inet_interfaces\s*='
        line: 'inet_interfaces = loopback-only'
        state: present
        create: no
      when:
        - postfix_check.rc == 0
        - mta_check.stdout != ''
      register: postfix_config


    - name: CIS 2.2.18 - Reiniciar Postfix para aplicar cambios
      systemd:
        name: postfix
        state: restarted
      when:
        - postfix_config.changed
      failed_when: false
      ignore_errors: yes


    - name: CIS 2.2.18 - Verificar configuracion final del MTA
      shell: ss -lntu | grep -E ':25\s' | grep -E -v '\s(127.0.0.1|\[?::1\]?):25\s'
      register: mta_final_check
      changed_when: false
      failed_when: mta_final_check.stdout != ''


    - name: CIS 2.2.18 - Mostrar resultado final
      debug:
        msg: 
          - "Configuracion MTA completada"
          - "Estado: {{ 'CORRECTO - Solo escucha en loopback' if mta_final_check.stdout == '' else 'ADVERTENCIA - Revisar configuracion manual' }}"
    
    - name: CIS 3.2.2 - Buscar archivos sysctl.d para verificar send_redirects
      find:
        paths: /etc/sysctl.d
        patterns: "*.conf"
      register: sysctl_d_files_redirects


    - name: CIS 3.2.2 - Comentar configuraciones incorrectas de send_redirects all en /etc/sysctl.conf
      replace:
        path: /etc/sysctl.conf
        regexp: '^\s*net\.ipv4\.conf\.all\.send_redirects\s*=\s*1'
        replace: '# \g<0>'
      register: sysctl_conf_redirects_all


    - name: CIS 3.2.2 - Comentar configuraciones incorrectas de send_redirects default en /etc/sysctl.conf
      replace:
        path: /etc/sysctl.conf
        regexp: '^\s*net\.ipv4\.conf\.default\.send_redirects\s*=\s*1'
        replace: '# \g<0>'
      register: sysctl_conf_redirects_default


    - name: CIS 3.2.2 - Comentar configuraciones incorrectas de send_redirects all en /etc/sysctl.d/*
      replace:
        path: "{{ item.path }}"
        regexp: '^\s*net\.ipv4\.conf\.all\.send_redirects\s*=\s*1'
        replace: '# \g<0>'
      loop: "{{ sysctl_d_files_redirects.files }}"
      when: sysctl_d_files_redirects.matched > 0
      register: sysctl_d_redirects_all


    - name: CIS 3.2.2 - Comentar configuraciones incorrectas de send_redirects default en /etc/sysctl.d/*
      replace:
        path: "{{ item.path }}"
        regexp: '^\s*net\.ipv4\.conf\.default\.send_redirects\s*=\s*1'
        replace: '# \g<0>'
      loop: "{{ sysctl_d_files_redirects.files }}"
      when: sysctl_d_files_redirects.matched > 0
      register: sysctl_d_redirects_default


    - name: CIS 3.2.2 - Configurar send_redirects en /etc/sysctl.d/99-cis-network.conf
      sysctl:
        name: "{{ item.name }}"
        value: "{{ item.value }}"
        sysctl_file: /etc/sysctl.d/99-cis-network.conf
        state: present
        reload: yes
      loop:
        - { name: 'net.ipv4.conf.all.send_redirects', value: '0' }
        - { name: 'net.ipv4.conf.default.send_redirects', value: '0' }
      register: send_redirects_config


    - name: CIS 3.2.2 - Aplicar configuracion de send_redirects inmediatamente
      command: "{{ item }}"
      loop:
        - sysctl -w net.ipv4.conf.all.send_redirects=0
        - sysctl -w net.ipv4.conf.default.send_redirects=0
        - sysctl -w net.ipv4.route.flush=1
      when: send_redirects_config.changed


    - name: CIS 3.2.2 - Verificar configuracion actual de send_redirects
      command: "{{ item }}"
      loop:
        - sysctl net.ipv4.conf.all.send_redirects
        - sysctl net.ipv4.conf.default.send_redirects
      register: send_redirects_current
      changed_when: false


    - name: CIS 3.2.2 - Verificar que no existan configuraciones incorrectas de send_redirects
      shell: |
        grep -Es "^\s*net\.ipv4\.conf\.(all|default)\.send_redirects\s*=\s*1" /etc/sysctl.conf /etc/sysctl.d/*.conf 2>/dev/null || true
      register: send_redirects_incorrect
      changed_when: false


    - name: CIS 3.2.2 - Mostrar resultado de verificacion de send_redirects
      debug:
        msg:
          - "Valores actuales de send_redirects:"
          - "{{ send_redirects_current.results | map(attribute='stdout') | list }}"
          - "Configuraciones incorrectas encontradas: {{ 'No' if send_redirects_incorrect.stdout == '' else 'Si - Revisar manualmente' }}"
          - "ICMP Redirects deshabilitados - previene manipulacion de tablas de enrutamiento"




    - name: CIS 3.3.1 - Verificar si IPv6 esta habilitado
      shell: |
        if [ -f /proc/sys/net/ipv6/conf/all/disable_ipv6 ]; then
          cat /proc/sys/net/ipv6/conf/all/disable_ipv6
        else
          echo "1"
        fi
      register: ipv6_status
      changed_when: false


    - name: CIS 3.3.1 - Comentar configuraciones incorrectas de accept_source_route IPv4 en /etc/sysctl.conf
      replace:
        path: /etc/sysctl.conf
        regexp: '^\s*net\.ipv4\.conf\.(all|default)\.accept_source_route\s*=\s*1'
        replace: '# \g<0>'
      register: sysctl_conf_source_route_ipv4


    - name: CIS 3.3.1 - Comentar configuraciones incorrectas de accept_source_route IPv4 en /etc/sysctl.d/*
      replace:
        path: "{{ item.path }}"
        regexp: '^\s*net\.ipv4\.conf\.(all|default)\.accept_source_route\s*=\s*1'
        replace: '# \g<0>'
      loop: "{{ sysctl_d_files_redirects.files }}"
      when: sysctl_d_files_redirects.matched > 0


    - name: CIS 3.3.1 - Configurar accept_source_route IPv4 en /etc/sysctl.d/99-cis-network.conf
      sysctl:
        name: "{{ item.name }}"
        value: "{{ item.value }}"
        sysctl_file: /etc/sysctl.d/99-cis-network.conf
        state: present
        reload: yes
      loop:
        - { name: 'net.ipv4.conf.all.accept_source_route', value: '0' }
        - { name: 'net.ipv4.conf.default.accept_source_route', value: '0' }
      register: accept_source_route_ipv4_config


    - name: CIS 3.3.1 - Aplicar configuracion de accept_source_route IPv4 inmediatamente
      command: "{{ item }}"
      loop:
        - sysctl -w net.ipv4.conf.all.accept_source_route=0
        - sysctl -w net.ipv4.conf.default.accept_source_route=0
        - sysctl -w net.ipv4.route.flush=1
      when: accept_source_route_ipv4_config.changed


    - name: CIS 3.3.1 - Comentar configuraciones incorrectas de accept_source_route IPv6 en /etc/sysctl.conf
      replace:
        path: /etc/sysctl.conf
        regexp: '^\s*net\.ipv6\.conf\.(all|default)\.accept_source_route\s*=\s*1'
        replace: '# \g<0>'
      when: ipv6_status.stdout == "0"


    - name: CIS 3.3.1 - Comentar configuraciones incorrectas de accept_source_route IPv6 en /etc/sysctl.d/*
      replace:
        path: "{{ item.path }}"
        regexp: '^\s*net\.ipv6\.conf\.(all|default)\.accept_source_route\s*=\s*1'
        replace: '# \g<0>'
      loop: "{{ sysctl_d_files_redirects.files }}"
      when: 
        - sysctl_d_files_redirects.matched > 0
        - ipv6_status.stdout == "0"


    - name: CIS 3.3.1 - Configurar accept_source_route IPv6 en /etc/sysctl.d/99-cis-network.conf
      sysctl:
        name: "{{ item.name }}"
        value: "{{ item.value }}"
        sysctl_file: /etc/sysctl.d/99-cis-network.conf
        state: present
        reload: yes
      loop:
        - { name: 'net.ipv6.conf.all.accept_source_route', value: '0' }
        - { name: 'net.ipv6.conf.default.accept_source_route', value: '0' }
      when: ipv6_status.stdout == "0"
      register: accept_source_route_ipv6_config


    - name: CIS 3.3.1 - Aplicar configuracion de accept_source_route IPv6 inmediatamente
      command: "{{ item }}"
      loop:
        - sysctl -w net.ipv6.conf.all.accept_source_route=0
        - sysctl -w net.ipv6.conf.default.accept_source_route=0
        - sysctl -w net.ipv6.route.flush=1
      when: 
        - ipv6_status.stdout == "0"
        - accept_source_route_ipv6_config.changed


    - name: CIS 3.3.1 - Mostrar resultado
      debug:
        msg:
          - "Source routed packets deshabilitados"
          - "IPv6 estado: {{ 'Habilitado - Configurado' if ipv6_status.stdout == '0' else 'Deshabilitado - Omitido' }}"
    
    - name: CIS 3.3.2 - Comentar configuraciones incorrectas de accept_redirects IPV4 en /etc/sysctl.conf
      replace:
        path: /etc/sysctl.conf
        regexp: '^\s*net\.ipv4\.conf\.(all|default)\.accept_redirects\s*=\s*1'
        replace: '# \g<0>'
    
    - name: CIS 3.3.2 - Comentar configuraciones incorrectas de accept_redirects IPv4 en /etc/sysctl.d/*
      replace:
        path: "{{ item.path }}"
        regexp: '^\s*net\.ipv4\.conf\.(all|default)\.accept_redirects\s*=\s*1'
        replace: '# \g<0>'
      loop: "{{ sysctl_d_files_redirects.files }}"
      when: sysctl_d_files_redirects.matched > 0


    - name: CIS 3.3.2 - Configurar accept_redirects IPv4 en /etc/sysctl.d/99-cis-network.conf
      sysctl:
        name: "{{ item.name }}"
        value: "{{ item.value }}"
        sysctl_file: /etc/sysctl.d/99-cis-network.conf
        state: present
        reload: yes
      loop:
        - { name: 'net.ipv4.conf.all.accept_redirects', value: '0' }
        - { name: 'net.ipv4.conf.default.accept_redirects', value: '0' }
      register: accept_redirects_ipv4_config


    - name: CIS 3.3.2 - Aplicar configuracion de accept_redirects IPv4 inmediatamente
      command: "{{ item }}"
      loop:
        - sysctl -w net.ipv4.conf.all.accept_redirects=0
        - sysctl -w net.ipv4.conf.default.accept_redirects=0
        - sysctl -w net.ipv4.route.flush=1
      when: accept_redirects_ipv4_config.changed


    - name: CIS 3.3.2 - Comentar configuraciones incorrectas de accept_redirects IPv6 en /etc/sysctl.conf
      replace:
        path: /etc/sysctl.conf
        regexp: '^\s*net\.ipv6\.conf\.(all|default)\.accept_redirects\s*=\s*1'
        replace: '# \g<0>'
      when: ipv6_status.stdout == "0"


    - name: CIS 3.3.2 - Comentar configuraciones incorrectas de accept_redirects IPv6 en /etc/sysctl.d/*
      replace:
        path: "{{ item.path }}"
        regexp: '^\s*net\.ipv6\.conf\.(all|default)\.accept_redirects\s*=\s*1'
        replace: '# \g<0>'
      loop: "{{ sysctl_d_files_redirects.files }}"
      when: 
        - sysctl_d_files_redirects.matched > 0
        - ipv6_status.stdout == "0"


    - name: CIS 3.3.2 - Configurar accept_redirects IPv6 en /etc/sysctl.d/99-cis-network.conf
      sysctl:
        name: "{{ item.name }}"
        value: "{{ item.value }}"
        sysctl_file: /etc/sysctl.d/99-cis-network.conf
        state: present
        reload: yes
      loop:
        - { name: 'net.ipv6.conf.all.accept_redirects', value: '0' }
        - { name: 'net.ipv6.conf.default.accept_redirects', value: '0' }
      when: ipv6_status.stdout == "0"
      register: accept_redirects_ipv6_config


    - name: CIS 3.3.2 - Aplicar configuracion de accept_redirects IPv6 inmediatamente
      command: "{{ item }}"
      loop:
        - sysctl -w net.ipv6.conf.all.accept_redirects=0
        - sysctl -w net.ipv6.conf.default.accept_redirects=0
        - sysctl -w net.ipv6.route.flush=1
      when: 
        - ipv6_status.stdout == "0"
        - accept_redirects_ipv6_config.changed


    - name: CIS 3.3.2 - Mostrar resultado
      debug:
        msg:
          - "ICMP redirects NO aceptados - previene actualizaciones maliciosas de rutas"
          - "IPv6 estado: {{ 'Habilitado - Configurado' if ipv6_status.stdout == '0' else 'Deshabilitado - Omitido' }}"
    
    - name: CIS 3.3.4 - Comentar configuraciones incorrectas de log_martians en /etc/sysctl.conf
      replace:
        path: /etc/sysctl.conf
        regexp: '^\s*net\.ipv4\.conf\.(all|default)\.log_martians\s*=\s*0'
        replace: '# \g<0>'


    - name: CIS 3.3.4 - Comentar configuraciones incorrectas de log_martians en /etc/sysctl.d/*
      replace:
        path: "{{ item.path }}"
        regexp: '^\s*net\.ipv4\.conf\.(all|default)\.log_martians\s*=\s*0'
        replace: '# \g<0>'
      loop: "{{ sysctl_d_files_redirects.files }}"
      when: sysctl_d_files_redirects.matched > 0


    - name: CIS 3.3.4 - Configurar log_martians en /etc/sysctl.d/99-cis-network.conf
      sysctl:
        name: "{{ item.name }}"
        value: "{{ item.value }}"
        sysctl_file: /etc/sysctl.d/99-cis-network.conf
        state: present
        reload: yes
      loop:
        - { name: 'net.ipv4.conf.all.log_martians', value: '1' }
        - { name: 'net.ipv4.conf.default.log_martians', value: '1' }
      register: log_martians_config


    - name: CIS 3.3.4 - Aplicar configuracion de log_martians inmediatamente
      command: "{{ item }}"
      loop:
        - sysctl -w net.ipv4.conf.all.log_martians=1
        - sysctl -w net.ipv4.conf.default.log_martians=1
        - sysctl -w net.ipv4.route.flush=1
      when: log_martians_config.changed


    - name: CIS 3.3.4 - Verificar configuracion actual de log_martians
      command: "{{ item }}"
      loop:
        - sysctl net.ipv4.conf.all.log_martians
        - sysctl net.ipv4.conf.default.log_martians
      register: log_martians_current
      changed_when: false


    - name: CIS 3.3.4 - Verificar que no existan configuraciones incorrectas de log_martians
      shell: |
        grep -Es "^\s*net\.ipv4\.conf\.(all|default)\.log_martians\s*=\s*0" /etc/sysctl.conf /etc/sysctl.d/*.conf 2>/dev/null || true
      register: log_martians_incorrect
      changed_when: false


    - name: CIS 3.3.4 - Mostrar resultado
      debug:
        msg:
          - "Log de paquetes sospechosos (martians) HABILITADO"
          - "{{ log_martians_current.results | map(attribute='stdout') | list }}"
          - "Configuraciones incorrectas: {{ 'No' if log_martians_incorrect.stdout == '' else 'Si - Revisar manualmente' }}"
          - "Los paquetes con direcciones no enrutables se registraran en kernel log"


    - name: CIS 3.3.5 - Comentar configuraciones incorrectas de icmp_echo_ignore_broadcasts en /etc/sysctl.conf
      replace:
        path: /etc/sysctl.conf
        regexp: '^\s*net\.ipv4\.icmp_echo_ignore_broadcasts\s*=\s*0'
        replace: '# \g<0>'


    - name: CIS 3.3.5 - Comentar configuraciones incorrectas de icmp_echo_ignore_broadcasts en /etc/sysctl.d/*
      replace:
        path: "{{ item.path }}"
        regexp: '^\s*net\.ipv4\.icmp_echo_ignore_broadcasts\s*=\s*0'
        replace: '# \g<0>'
      loop: "{{ sysctl_d_files_redirects.files }}"
      when: sysctl_d_files_redirects.matched > 0


    - name: CIS 3.3.5 - Configurar icmp_echo_ignore_broadcasts en /etc/sysctl.d/99-cis-network.conf
      sysctl:
        name: net.ipv4.icmp_echo_ignore_broadcasts
        value: '1'
        sysctl_file: /etc/sysctl.d/99-cis-network.conf
        state: present
        reload: yes
      register: icmp_broadcast_config


    - name: CIS 3.3.5 - Aplicar configuracion de icmp_echo_ignore_broadcasts inmediatamente
      command: "{{ item }}"
      loop:
        - sysctl -w net.ipv4.icmp_echo_ignore_broadcasts=1
        - sysctl -w net.ipv4.route.flush=1
      when: icmp_broadcast_config.changed


    - name: CIS 3.3.5 - Verificar configuracion actual de icmp_echo_ignore_broadcasts
      command: sysctl net.ipv4.icmp_echo_ignore_broadcasts
      register: icmp_broadcast_current
      changed_when: false


    - name: CIS 3.3.5 - Verificar que no existan configuraciones incorrectas
      shell: |
        grep -Es "^\s*net\.ipv4\.icmp_echo_ignore_broadcasts\s*=\s*0" /etc/sysctl.conf /etc/sysctl.d/*.conf 2>/dev/null || true
      register: icmp_broadcast_incorrect
      changed_when: false


    - name: CIS 3.3.5 - Mostrar resultado
      debug:
        msg:
          - "Broadcast ICMP requests IGNORADOS"
          - "{{ icmp_broadcast_current.stdout }}"
          - "Configuraciones incorrectas: {{ 'No' if icmp_broadcast_incorrect.stdout == '' else 'Si - Revisar manualmente' }}"
          - "Proteccion contra ataques Smurf habilitada"


    - name: CIS 3.3.7 - Comentar configuraciones incorrectas de rp_filter en /etc/sysctl.conf
      replace:
        path: /etc/sysctl.conf
        regexp: '^\s*net\.ipv4\.conf\.(all|default)\.rp_filter\s*=\s*0'
        replace: '# \g<0>'


    - name: CIS 3.3.7 - Comentar configuraciones incorrectas de rp_filter en /etc/sysctl.d/*
      replace:
        path: "{{ item.path }}"
        regexp: '^\s*net\.ipv4\.conf\.(all|default)\.rp_filter\s*=\s*0'
        replace: '# \g<0>'
      loop: "{{ sysctl_d_files_redirects.files }}"
      when: sysctl_d_files_redirects.matched > 0


    - name: CIS 3.3.7 - Configurar Reverse Path Filtering en /etc/sysctl.d/99-cis-network.conf
      sysctl:
        name: "{{ item.name }}"
        value: "{{ item.value }}"
        sysctl_file: /etc/sysctl.d/99-cis-network.conf
        state: present
        reload: yes
      loop:
        - { name: 'net.ipv4.conf.all.rp_filter', value: '1' }
        - { name: 'net.ipv4.conf.default.rp_filter', value: '1' }
      register: rp_filter_config


    - name: CIS 3.3.7 - Aplicar configuracion de rp_filter inmediatamente
      command: "{{ item }}"
      loop:
        - sysctl -w net.ipv4.conf.all.rp_filter=1
        - sysctl -w net.ipv4.conf.default.rp_filter=1
        - sysctl -w net.ipv4.route.flush=1
      when: rp_filter_config.changed


    - name: CIS 3.3.7 - Verificar configuracion actual de rp_filter
      command: "{{ item }}"
      loop:
        - sysctl net.ipv4.conf.all.rp_filter
        - sysctl net.ipv4.conf.default.rp_filter
      register: rp_filter_current
      changed_when: false


    - name: CIS 3.3.7 - Verificar que no existan configuraciones incorrectas de rp_filter
      shell: |
        grep -Es "^\s*net\.ipv4\.conf\.(all|default)\.rp_filter\s*=\s*0" /etc/sysctl.conf /etc/sysctl.d/*.conf 2>/dev/null || true
      register: rp_filter_incorrect
      changed_when: false


    - name: CIS 3.3.7 - Mostrar resultado
      debug:
        msg:
          - "Reverse Path Filtering HABILITADO"
          - "{{ rp_filter_current.results | map(attribute='stdout') | list }}"
          - "Configuraciones incorrectas: {{ 'No' if rp_filter_incorrect.stdout == '' else 'Si - Revisar manualmente' }}"
          - "Proteccion contra IP spoofing mediante validacion de ruta de retorno"
          - "ADVERTENCIA: Incompatible con enrutamiento asimetrico (BGP, OSPF)"


    - name: CIS 3.3.8 - Comentar configuraciones incorrectas de tcp_syncookies en /etc/sysctl.conf
      replace:
        path: /etc/sysctl.conf
        regexp: '^\s*net\.ipv4\.tcp_syncookies\s*=\s*0'
        replace: '# \g<0>'


    - name: CIS 3.3.8 - Comentar configuraciones incorrectas de tcp_syncookies en /etc/sysctl.d/*
      replace:
        path: "{{ item.path }}"
        regexp: '^\s*net\.ipv4\.tcp_syncookies\s*=\s*0'
        replace: '# \g<0>'
      loop: "{{ sysctl_d_files_redirects.files }}"
      when: sysctl_d_files_redirects.matched > 0


    - name: CIS 3.3.8 - Configurar TCP SYN Cookies en /etc/sysctl.d/99-cis-network.conf
      sysctl:
        name: net.ipv4.tcp_syncookies
        value: '1'
        sysctl_file: /etc/sysctl.d/99-cis-network.conf
        state: present
        reload: yes
      register: tcp_syncookies_config


    - name: CIS 3.3.8 - Aplicar configuracion de tcp_syncookies inmediatamente
      command: "{{ item }}"
      loop:
        - sysctl -w net.ipv4.tcp_syncookies=1
        - sysctl -w net.ipv4.route.flush=1
      when: tcp_syncookies_config.changed


    - name: CIS 3.3.8 - Verificar configuracion actual de tcp_syncookies
      command: sysctl net.ipv4.tcp_syncookies
      register: tcp_syncookies_current
      changed_when: false


    - name: CIS 3.3.8 - Verificar que no existan configuraciones incorrectas de tcp_syncookies
      shell: |
        grep -Es "^\s*net\.ipv4\.tcp_syncookies\s*=\s*0" /etc/sysctl.conf /etc/sysctl.d/*.conf 2>/dev/null || true
      register: tcp_syncookies_incorrect
      changed_when: false


    - name: CIS 3.3.8 - Verificar estado de la cola SYN
      shell: |
        netstat -an | grep -c "SYN_RECV" || echo "0"
      register: syn_queue_status
      changed_when: false
      failed_when: false


    - name: CIS 3.3.8 - Mostrar resultado
      debug:
        msg:
          - "TCP SYN Cookies HABILITADO"
          - "{{ tcp_syncookies_current.stdout }}"
          - "Configuraciones incorrectas: {{ 'No' if tcp_syncookies_incorrect.stdout == '' else 'Si - Revisar manualmente' }}"
          - "Conexiones SYN_RECV actuales: {{ syn_queue_status.stdout }}"
          - "Proteccion contra ataques SYN Flood habilitada"
          - "Sistema puede aceptar conexiones legitimas incluso bajo ataque DoS"


    - name: CIS 5.1.8 - Ensure cron is restricted to authorized users (Automated)
      command: echo "CIS 5.1.8 - Ensure cron is restricted to authorized users"
      register: cis_5_1_8_marker
      changed_when: false


    - name: CIS 5.1.8 - Verificar si cron esta instalado 
          command: which cron 
          register: cron_installed 
          changed_when: false
          failed_when: false


    - name: CIS 5.1.8 - Verificar estado actual del /etc/cron.deny
      stat:
        path: "{{ cron_deny_file }}"
      register: cron_deny_stat


    - name: CIS 5.1.8 - Verificar estado actual del /etc/cron.allow
      stat:
        path: "{{ cron_allow_file }}"
      register: cron_allow_stat


    - name: CIS 5.1.8 - Estado antes de remediar
      debug:
        msg:
          - "Estado de cron en el sistema:"
          - "  Cron instalado: {{ 'Si' if cron_installed.rc == 0 else 'No' }}"
          - "  /etc/cron.deny existe: {{ 'Si' if cron_deny_stat.stat.exists else 'No' }}"
          - "  /etc/cron.allow existe: {{ 'Si' if cron_allow_stat.stat.exists else 'No' }}"
      when: cron_installed.rc == 0 


    - name: CIS 5.1.8 - Hacer un backup de /etc/cron.deny si existe
      copy:
            src: "{{ cron_deny_file }}"
            dest: "{{ cron_deny_file }}.backup.{{ ansible_date_time.epoch }}"
            remote_src: yes 
          when: 
            - cron_installed.rc == 0 
            - cron_deny_stat.stat.exists


    - name: CIS 5.1.8 - Hacer backup de /etc/cron.allow si existe
          copy:
            src: "{{ cron_allow_file }}"
            dest: "{{ cron_allow_file }}.backup.{{ ansible_date_time.epoch }}"
            remote_src: yes
          when: 
            - cron_installed.rc == 0
            - cron_allow_stat.stat.exists


    - name: CIS 5.1.8 - Eliminar /etc/cron.deny 
          file:
            path: "{{ cron_deny_file }}"
            state: absent
          when: cron_installed.rc == 0 


    - name: CIS 5.1.8 - Crear /etc/cron.allow si no existe
          file:
            path: "{{ cron_allow_file }}"
            state: touch
            modification_time: preserve
            access_time: preserve
          when: cron_installed.rc == 0 
        
    - name: CIS 5.1.8 - Configurar permisos de /etc/cron.allow
          file: 
            path: "{{ cron_allow_file }}"
            owner: root
            group: root
            mode: '0600'
          when: cron_installed.rc == 0


    - name: CIS 5.1.8 - Agregar usuarios autorizados a /etc/cron.allow
          lineinfile:
            path: "{{ cron_allow_file }}"
            line: "{{ item }}"
            create: yes
            owner: root
            group: root
            mode: '0600'
          loop: "{{ authorized_cron_users }}"
          when:
            - cron_installed.rc == 0
            - authorized_cron_users is defined
            - authorized_cron_users | length > 0


    - name: CIS 5.1.8 - Verificar usuarios autorizados de cron
          lineinfile:
            path: "{{ cron_allow_file }}"
            line: "{{ item }}"
            create: yes
            owner: root
            group: root
            mode: '0600'
          loop: "{{ authorized_cron_users }}"
          when:
            - cron_installed.rc == 0
            - authorized_cron_users is defined
            - authorized_cron_users | length > 0 


    - name: CIS 5.1.8 - Verificar permisos finales de /etc/cron.allow
          stat:
            path: "{{ cron_allow_file }}"
          register: cron_allow_final
          when: cron_installed.rc == 0


    - name: CIS 5.1.8 - Verificar que /etc/cron.deny no existe
          stat:
            path: "{{ cron_deny_file }}"
          register: cron_deny_final
          when: cron_installed.rc == 0


    - name: CIS 5.1.8 - Listar contenido de /etc/cron.allow
          command: cat {{ cron_allow_file }}
          register: cron_allow_content
          changed_when: false
          when: cron_installed.rc == 0


    - name: CIS 5.1.8 - Verificar trabajos cron existentes
          shell: |
            echo "=== Crontabs del sistema ==="
            ls -la /etc/cron.* 2>/dev/null | grep -v total || echo "No hay archivos cron del sistema"
            echo ""
            echo "=== Crontabs de usuarios ==="
            ls -la /var/spool/cron/crontabs/ 2>/dev/null || ls -la /var/spool/cron/ 2>/dev/null || echo "No hay crontabs de usuarios"
          register: existing_cron_jobs
          changed_when: false
          failed_when: false
          when: cron_installed.rc == 0


        - name: CIS 5.1.8 - Mostrar resultado final
      debug:
        msg:
          - "========================================="
          - "CIS 5.1.8 - Cron restringido a usuarios autorizados"
          - "========================================="
          - "Estado: {{ 'COMPLETADO' if cron_installed.rc == 0 else 'OMITIDO - Cron no instalado' }}"
          - ""
          - "Configuracin aplicada:"
          - "  /etc/cron.deny: {{ 'ELIMINADO' if not cron_deny_final.stat.exists else 'EXISTE (ERROR)' }}"
          - "  /etc/cron.allow: {{ 'CREADO' if cron_allow_final.stat.exists else 'NO EXISTE (ERROR)' }}"
          - ""
          - "Permisos de /etc/cron.allow:"
          - "  Propietario: {{ cron_allow_final.stat.pw_name | default('N/A') }}"
          - "  Grupo: {{ cron_allow_final.stat.gr_name | default('N/A') }}"
          - "  Permisos: {{ cron_allow_final.stat.mode | default('N/A') }}"
          - "  Esperado: root:root 0600"
          - ""
          - "Usuarios autorizados en /etc/cron.allow:"
          - "{{ cron_allow_content.stdout_lines | default(['Ninguno configurado']) }}"
          - ""
          - "========================================="
          - "IMPORTANTE:"
          - "- Solo los usuarios listados en /etc/cron.allow pueden usar crontab"
          - "- Los jobs de cron existentes seguirn ejecutndose"
          - "- /etc/cron.allow solo controla el acceso al comando crontab"
          - "- Los jobs pueden ejecutarse como cualquier usuario (via crontab -u)"
          - "========================================="


    - name: CIS 5.1.8 - Mostrar trabajos cron existentes
      debug:
        msg: "{{ existing_cron_jobs.stdout_lines }}"
      when: 
        - cron_installed.rc == 0
        - existing_cron_jobs.stdout is defined


    - name: CIS 5.1.8 - Advertencia si cron no est instalado
      debug:
        msg:
          - "========================================="
          - "AVISO: Cron no est instalado en este sistema"
          - "No se requiere accin"
          - "========================================="
      when: cron_installed.rc != 0


    - name: CIS 5.1.8 - Validacin final
      assert:
        that:
          - not cron_deny_final.stat.exists
          - cron_allow_final.stat.exists
          - cron_allow_final.stat.pw_name == 'root'
          - cron_allow_final.stat.gr_name == 'root'
          - cron_allow_final.stat.mode == '0600'
        fail_msg: "CIS 5.1.8 - La configuracin de cron no cumple con los requisitos"
        success_msg: "CIS 5.1.8 - La configuracin de cron cumple con todos los requisitos"
      when: cron_installed.rc == 0


    - name: CIS 5.1.8 - Resumen de remediacin
      debug:
        msg:
          - "========================================="
          - "CIS 5.1.8 Completado"
          - "========================================="
          - "Acciones realizadas:"
          - "  1.  /etc/cron.deny eliminado"
          - "  2.  /etc/cron.allow creado"
          - "  3.  Permisos configurados (root:root 0600)"
          - "  4.  Usuarios autorizados agregados"
          - ""
          - "Seguridad mejorada:"
          - "  - Control de acceso basado en lista blanca (allow)"
          - "  - Solo usuarios autorizados pueden programar cron jobs"
          - "  - Previene programacin no autorizada de tareas"
          - ""
          - "Prximos pasos:"
          - "  - Revisar y actualizar lista de usuarios autorizados"
          - "  - Auditar cron jobs existentes"
          - "  - Monitorear intentos de acceso no autorizado"
          - "========================================="


    - name: CIS 5.1.9 - Verificar si at esta instalado
        command: which at 
        register: at_installed
        changed_when: false
        failed_when: false


      - name: CIS 5.1.9 - verificar PAQUETE AT (Debian/Ubuntu)
        command: dpkg -l at
        register: at_package_deb
        changed_when: false
        failed_when: false
        when: ansible_os_family == "Debian"


      - name: CIS 5.1.9 - Verificar paquete at (RHEL/CentOS)
        command: rpm -q at
        register: at_package_rhel
        changed_when: false
        failed_when: false
        when: ansible_os_family == "RedHat"


      - name: CIS 5.1.9 - Verificar estado actual de /etc/at.deny
        stat:
          path: /etc/at.deny
        register: at_deny_stat


      - name: CIS 5.1.9 - Mostrar estado antes de remediar
        debug:
          msg:
          - "========================================="
          - "CIS 5.1.9 - Estado de at en el sistema"
          - "========================================="
          - "  Comando at disponible: {{ 'Si' if at_installed.rc == 0 else 'No' }}"
          - "  Paquete at instalado: {{ 'Si' if (at_package_deb.rc == 0 or at_package_rhel.rc == 0) else 'No/No verificable' }}"
          - "  /etc/at.deny existe: {{ 'Si' if at_deny_stat.stat.exists else 'No' }}"
          - "  /etc/at.allow existe: {{ 'Si' if at_allow_stat.stat.exists else 'No' }}"
        when: at_installed.rc == 0        


      - name: CIS 5.1.9 - Verificar estado actual de /etc/at.allow
        stat:
          path: /etc/at.allow
        register: at_allow_stat


      - name: CIS 5.1.9 - Hacer backup de /etc/at.deny si existe
        copy:
          src: /etc/at.deny
          dest: "/etc/at.deny.backup.{{ ansible_date_time.epoch }}"
          remote_src: yes
        when:
          - at_installed.rc == 0
          - at_deny_stat.stat.exists


      - name: CIS 5.1.9 - Hacer backup de /etc/at.allow si existe
        copy:
          src: /etc/at.allow
          dest: "/etc/at.allow.backup.{{ ansible_date_time.epoch }}"
          remote_src: yes
        when:
          - at_installed.rc == 0
          - at_allow_stat.stat.exists


      - name: CIS 5.1.9 - Eliminar /etc/at.deny
        file:
          path: /etc/at.deny
          state: absent
        when: at_installed.rc == 0


      - name: CIS 5.1.9 - Crear /etc/at.allow si no existe
        file:
          path: /etc/at.allow
          state: touch
          modification_time: preserve
          access_time: preserve
        when: at_installed.rc == 0


      - name: CIS 5.1.9 - Configurar permisos de /etc/at.allow (0600)
        file:
          path: /etc/at.allow
          owner: root
          group: root
          mode: '0600'
        when: at_installed.rc == 0


      - name: CIS 5.1.9 - Agregar usuarios autorizados a /etc/at.allow
        lineinfile:
          path: /etc/at.allow
          line: "{{ item }}"
          create: yes
          owner: root
          group: root
          mode: '0600'
        loop: "{{ authorized_at_users }}"
        when:
          - at_installed.rc == 0
          - authorized_at_users is defined
          - authorized_at_users | length > 0


      - name: CIS 5.1.9 - Verificar permisos finales de /etc/at.allow
        stat:
          path: /etc/at.allow
        register: at_allow_final
        when: at_installed.rc == 0


      - name: CIS 5.1.9 - Verificar que /etc/at.deny no existe
        stat:
          path: /etc/at.deny
        register: at_deny_final
        when: at_installed.rc == 0


      - name: CIS 5.1.9 - Listar contenido de /etc/at.allow
        command: cat /etc/at.allow
        register: at_allow_content
        changed_when: false
        when: at_installed.rc == 0


    - name: CIS 5.1.9 - Verificar trabajos at existentes
      shell: |
        echo "=== Trabajos at pendientes ==="
        atq 2>/dev/null || echo "No hay trabajos at pendientes o atd no est corriendo"
        echo ""
        echo "=== Estado del servicio atd ==="
        systemctl status atd 2>/dev/null | grep -E "(Active|Loaded)" || service atd status 2>/dev/null || echo "Servicio atd no encontrado"
      register: existing_at_jobs
      changed_when: false
      failed_when: false
      when: at_installed.rc == 0


    - name: CIS 5.1.9 - Mostrar resultado final
      debug:
        msg:
          - "========================================="
          - "CIS 5.1.9 - at restringido a usuarios autorizados"
          - "========================================="
          - "Estado: {{ 'COMPLETADO' if at_installed.rc == 0 else 'OMITIDO - at no instalado' }}"
          - ""
          - "Configuracin aplicada:"
          - "  /etc/at.deny: {{ 'ELIMINADO' if not at_deny_final.stat.exists else 'EXISTE (ERROR)' }}"
          - "  /etc/at.allow: {{ 'CREADO' if at_allow_final.stat.exists else 'NO EXISTE (ERROR)' }}"
          - ""
          - "Permisos de /etc/at.allow:"
          - "  Propietario: {{ at_allow_final.stat.pw_name | default('N/A') }}"
          - "  Grupo: {{ at_allow_final.stat.gr_name | default('N/A') }}"
          - "  Permisos: {{ at_allow_final.stat.mode | default('N/A') }}"
          - "  Esperado: root:root 0600"
          - ""
          - "Usuarios autorizados en /etc/at.allow:"
          - "{{ at_allow_content.stdout_lines | default(['Ninguno configurado']) }}"
          - ""
          - "========================================="
          - "IMPORTANTE:"
          - "- Solo los usuarios listados en /etc/at.allow pueden usar at"
          - "- Los jobs at existentes seguirn ejecutndose"
          - "- /etc/at.allow solo controla el acceso al comando at"
          - "- Los jobs pueden ejecutarse como cualquier usuario (via at -u)"
          - "========================================="
      when: at_installed.rc == 0


    - name: CIS 5.1.9 - Mostrar trabajos at existentes
      debug:
        msg: "{{ existing_at_jobs.stdout_lines }}"
      when: 
        - at_installed.rc == 0
        - existing_at_jobs.stdout is defined


    - name: CIS 5.1.9 - Advertencia si at no est instalado
      debug:
        msg:
          - "========================================="
          - "AVISO: at no est instalado en este sistema"
          - "No se requiere accin"
          - "========================================="
      when: at_installed.rc != 0


    - name: CIS 5.1.9 - Validacin final
      assert:
        that:
          - not at_deny_final.stat.exists
          - at_allow_final.stat.exists
          - at_allow_final.stat.pw_name == 'root'
          - at_allow_final.stat.gr_name == 'root'
          - at_allow_final.stat.mode == '0600'
        fail_msg: "CIS 5.1.9 - La configuracin de at no cumple con los requisitos"
        success_msg: "CIS 5.1.9 - La configuracin de at cumple con todos los requisitos"
      when: at_installed.rc == 0
    
    - name: CIS 5.5.2 - Obtener UID_MIN de /etc/login.defs
      shell: awk '/^\s*UID_MIN/{print $2}' /etc/login.defs
      register: uid_min 
      changed_when: false


    - name: CIS 5.5.2 - Obtener ruta de nologin
      command: which nologin
      register: nologin_path
      changed_when: false
      failed_when: false
    
    - name: CIS 5.5.2 - Establecer ruta de nologin por defecto si no existe
      set_fact:
        nologin_shell: "{{ nologin_path.stdout if nologin_path.rc == 0 else '/usr/sbin/nologin' }}"


    - name: CIS 5.5.2 - Auditar cuentas de sistema con shell vlido
      shell: |
        awk -F: '($1!="root" && $1!="sync" && $1!="shutdown" && $1!="halt" && 
        $1!~/^\+/ && $3<{{ uid_min.stdout }} && 
        $7!="{{ nologin_shell }}" && $7!="/bin/false" && $7!="/usr/bin/false") {print $1":"$3":"$7}' /etc/passwd
      register: system_accounts_with_shell
      changed_when: false
    
    - name: CIS 5.5.2 - Auditar cuentas de sistema sin bloqueo
      shell: |
        awk -F: '($1!="root" && $1!~/^\+/ && $3<{{ uid_min.stdout }}) {print $1}' /etc/passwd | \
        xargs -I '{}' passwd -S '{}' 2>/dev/null | \
        awk '($2!="L" && $2!="LK") {print $1":"$2}'
      register: system_accounts_unlocked
      changed_when: false
      failed_when: false


    - name: CIS 5.5.2 - Crear backup de /etc/passwd antes de modificar
      copy:
        src: /etc/passwd
        dest: "/etc/passwd.backup.{{ ansible_date_time.epoch }}"
        remote_src: yes


    - name: CIS 5.5.2 - Crear backup de /etc/shadow antes de modificar
      copy:
        src: /etc/shadow
        dest: "/etc/shadow.backup.{{ ansible_date_time.epoch }}"
        remote_src: yes


    - name: CIS 5.5.2 - Mostrar cuentas de sistema antes de remediar
      debug:
        msg:
          - "========================================="
          - "CIS 5.5.2 - Auditora de cuentas de sistema"
          - "========================================="
          - "UID_MIN del sistema: {{ uid_min.stdout }}"
          - "Shell nologin: {{ nologin_shell }}"
          - ""
          - "Cuentas de sistema con shell vlido ({{ system_accounts_with_shell.stdout_lines | length }}):"
          - "{{ system_accounts_with_shell.stdout_lines if system_accounts_with_shell.stdout_lines | length > 0 else ['  Ninguna'] }}"
          - ""
          - "Cuentas de sistema sin bloqueo ({{ system_accounts_unlocked.stdout_lines | length }}):"
          - "{{ system_accounts_unlocked.stdout_lines if system_accounts_unlocked.stdout_lines | length > 0 else ['  Ninguna'] }}"
          - ""
          - "Backups creados:"
          - "  - /etc/passwd.backup.{{ ansible_date_time.epoch }}"
          - "  - /etc/shadow.backup.{{ ansible_date_time.epoch }}"
          - "========================================="


      - name: CIS 5.5.2 - Establecer nologin shell para cuentas de sistema
        shell: |
          awk -F: '($1!="root" && $1!="sync" && $1!="shutdown" && $1!="halt" && 
          $1!~/^\+/ && $3<{{ uid_min.stdout }} && 
          $7!="{{ nologin_shell }}" && $7!="/bin/false" && $7!="/usr/bin/false") {print $1}' /etc/passwd | \
          while read -r user; do 
            usermod -s "{{ nologin_shell }}" "$user"
            echo "$user"
          done
        register: shell_changed
        changed_when: shell_changed.stdout != ""
      - name: CIS 5.5.2 - Bloquear cuentas de sistema
        shell: |
          awk -F: '($1!="root" && $1!~/^\+/ && $3<{{ uid_min.stdout }}) {print $1}' /etc/passwd | \
          xargs -I '{}' passwd -S '{}' 2>/dev/null | \
          awk '($2!="L" && $2!="LK") {print $1}' | \
          while read -r user; do 
            usermod -L "$user"
            echo "$user"
          done
        register: accounts_locked
        changed_when: accounts_locked.stdout != ""


      - name: CIS 5.5.2 - Verificar cuentas de sistema despus de remediar
        shell: |
          awk -F: '($1!="root" && $1!="sync" && $1!="shutdown" && $1!="halt" && 
          $1!~/^\+/ && $3<{{ uid_min.stdout }} && 
          $7!="{{ nologin_shell }}" && $7!="/bin/false" && $7!="/usr/bin/false") {print $1":"$3":"$7}' /etc/passwd
        register: remaining_shell_accounts
        changed_when: false


      - name: CIS 5.5.2 - Verificar cuentas sin bloqueo despus de remediar
        shell: |
          awk -F: '($1!="root" && $1!~/^\+/ && $3<{{ uid_min.stdout }}) {print $1}' /etc/passwd | \
          xargs -I '{}' passwd -S '{}' 2>/dev/null | \
          awk '($2!="L" && $2!="LK") {print $1":"$2}'
        register: remaining_unlocked_accounts
        changed_when: false
        failed_when: false


      - name: CIS 5.5.2 - Listar todas las cuentas de sistema y su estado
        shell: |
          echo "Usuario:UID:Shell:Estado_Password"
          awk -F: '($1!="root" && $1!~/^\+/ && $3<{{ uid_min.stdout }}) {print $1":"$3":"$7}' /etc/passwd | \
          while IFS=: read -r user uid shell; do
            status=$(passwd -S "$user" 2>/dev/null | awk '{print $2}')
            echo "$user:$uid:$shell:$status"
          done
        register: all_system_accounts_status
        changed_when: false


      - name: CIS 5.5.2 - Mostrar resultado de la remediacin
        debug:
          msg:
            - "========================================="
            - "CIS 5.5.2 - Resultado de la remediacin"
            - "========================================="
            - ""
            - "Cuentas modificadas (shell cambiado a nologin):"
            - "{{ shell_changed.stdout_lines if shell_changed.stdout != '' else ['  Ninguna - Ya estaban configuradas correctamente'] }}"
            - ""
            - "Cuentas bloqueadas:"
            - "{{ accounts_locked.stdout_lines if accounts_locked.stdout != '' else ['  Ninguna - Ya estaban bloqueadas'] }}"
            - ""
            - "Verificacin post-remediacin:"
            - "  Cuentas con shell vlido restantes: {{ remaining_shell_accounts.stdout_lines | length }}"
            - "  {{ remaining_shell_accounts.stdout_lines if remaining_shell_accounts.stdout_lines | length > 0 else ['   Ninguna'] }}"
            - ""
            - "  Cuentas sin bloqueo restantes: {{ remaining_unlocked_accounts.stdout_lines | length }}"
            - "  {{ remaining_unlocked_accounts.stdout_lines if remaining_unlocked_accounts.stdout_lines | length > 0 else ['   Ninguna'] }}"
            - "========================================="


      - name: CIS 5.5.2 - Mostrar estado completo de cuentas de sistema
        debug:
          msg: "{{ all_system_accounts_status.stdout_lines }}"


      - name: CIS 5.5.2 - Validacin final
        assert:
          that:
            - remaining_shell_accounts.stdout_lines | length == 0
            - remaining_unlocked_accounts.stdout_lines | length == 0
          fail_msg: |
            CIS 5.5.2 - FALLO: An existen cuentas de sistema sin asegurar
            Cuentas con shell vlido: {{ remaining_shell_accounts.stdout_lines | length }}
            Cuentas sin bloqueo: {{ remaining_unlocked_accounts.stdout_lines | length }}
          success_msg: "CIS 5.5.2 - XITO: Todas las cuentas de sistema estn aseguradas"


      - name: CIS 5.7 - Verificar si pam_whell esta configurado en /etc/pam.d/su
        command: grep -E '^\s*auth\s+required\s+pam_wheel.so\s+use_uid' /etc/pam.d/su
        register: pam_whell_check
        changed_when: false
        failed_when: false


      - name: CIS 5.7 - Verificar existencia del grupo wheel 
        command: getent group wheel
        changed_when: false
        failed_when: false


      - name: CIS 5.7 - Verificar existencia del grupo wheel
        command: getent group wheel
        register: wheel_group_check
        changed_when: false
        failed_when: false
      
      - name: CIS 5.7 - Crear backup de /etc/pam.d/su antes de modificar
        copy:
          src: /etc/pam.d/su
          dest: "/etc/pam.d/su.backup.{{ ansible_date_time.epoch }}"
          remote_src: yes
        when: pam_wheel_check.rc != 0
      
      - name: CIS 5.7 - Asegurar que pam_wheel.so est configurado en /etc/pam.d/su
        lineinfile:
           path: /etc/pam.d/su
           line: "auth required pam_wheel.so use_uid"
           state: present
           insertafter: '^#?auth'
           create: no
        when: pam_wheel_check.rc != 0


      - name: CIS 5.7 - Asegurar que el grupo wheel existe
        group:
          name: "{{ item }}"
          groups: wheel
          append: yes
        loop: "{{ authorized_su_users }}"
        when:
          - authorized_su_users is defined
          - authorized_su_users | length > 0


      - name: CIS 5.7 - Verificar usuarios del grupo wheel
        command: getent group wheel
        register: wheel_group_final
        changed_when: false


      - name: CIS 5.7 - Validacin final
        assert:
          that: 
            - "'pam_wheel.so' in lookup('file', '/etc/pam.d/su')"
            - wheel_group_final.stdout is search("wheel:")
          fail_msg: "CIS 5.7 - FALLO: El acceso a su no est restringido correctamente"
          success_msg: "CIS 5.7 - XITO: El acceso a su est restringido al grupo wheel"


      - name: CIS 5.7 - Mostrar resultado final
        debug:
          msg:
            - "========================================="
            - "CIS 5.7 - Restriccin del comando su"
            - "========================================="
            - "pam_wheel configurado: {{ 'SI' if pam_wheel_check.rc == 0 else 'APLICADO' }}"
            - "Grupo wheel: {{ wheel_group_final.stdout }}"
            - ""
            - "IMPORTANTE:"
            - "- Solo usuarios del grupo wheel pueden usar su"
            - "- Se recomienda usar sudo para control y auditora"
            - "========================================="
            
      - name: CIS 6.1.10 - Obtener puntos de montaje locales
        shell: df --local -P | awk 'NR!=1 {print $6}'
        register: local_mounts
        changed_when: false


      - name: CIS 6.1.10 - Buscar archivos world-writable en FS locales
        shell: |
          for mount in {{ local_mounts.stdout_lines | join(' ') }}; do
            find "$mount" -xdev -type f -perm -0002 2>/dev/null
          done
        register: world_writable_files
        changed_when: false
        failed_when: false




      - name: CIS 6.1.10 - Mostrar archivos world-writable encontrados
      debug:
        msg:
          - "========================================="
          - "CIS 6.1.10 - Archivos world-writable"
          - "========================================="
          - "{{ world_writable_files.stdout_lines if world_writable_files.stdout_lines | length > 0 else [' Ninguno encontrado'] }}"
          - "========================================="


    - name: CIS 6.1.10 - Remover permiso write para others (chmod o-w)
      file:
        path: "{{ item }}"
        mode: o-w
      loop: "{{ world_writable_files.stdout_lines }}"
      when:
        - cis_6_1_10_remediate | bool
        - world_writable_files.stdout_lines | length > 0


    - name: CIS 6.1.10 - Re-verificar archivos world-writable despus de remediar
      shell: |
        for mount in {{ local_mounts.stdout_lines | join(' ') }}; do
          find "$mount" -xdev -type f -perm -0002 2>/dev/null
        done
      register: world_writable_files_final
      changed_when: false
      failed_when: false
      when: cis_6_1_10_remediate | bool


    - name: CIS 6.1.10 - Validacin final
      assert:
        that:
          - world_writable_files.stdout_lines | length == 0 or (cis_6_1_10_remediate | bool and world_writable_files_final.stdout_lines | length == 0)
        fail_msg: "CIS 6.1.10 - FALLO: Existen archivos world-writable en el sistema"
        success_msg: "CIS 6.1.10 - XITO: No existen archivos world-writable"
       
    - name: CIS 6.2.7 - Auditar la integridad del PATH de root
         shell: | 
           issues=0
           if echo "$PATH" | grep -q "::"; then
             echo "Empty directory (::) in PATH"
             issues=1
           fi


           if echo "$PATH" | grep -q ":$"; then
             echo "Trailing ':' in PATH"
             issues=1
           fi 


           for dir in $(echo "$PATH" | tr ":" " "); do
             if [ -d "$dir" ]; then
                stat=$(ls -ldH "$dir")
                owner=$(echo "$stat" | awk '{print $3}')
                perms=$(echo "$stat" | awk '{print $1}')
                
                [ "$dir" = "." ] && echo "PATH contains current working directory (.)" && issues=1
                [ "$owner" != "root" ] && echo "$dir is not owned by root" && issues=1
                [ "${perms:5:1}" != "-" ] && echo "$dir is group writable" && issues=1
                [ "${perms:8:1}" != "-" ] && echo "$dir is world writable" && issues=1
              else 
                echo "$dir is not a directory"
                issues=1
              fi
            done


            exit $issues
          register: root_path_audit
          changed_when: false
          failed_when: false


    - name: CIS 6.2.7 - Mostrar resultado del PATH de root
      debug:
           msg:
             - "========================================="
             - "CIS 6.2.7 - Root PATH Integrity"
             - "========================================="
             - "{{ root_path_audit.stdout_lines if root_path_audit.stdout_lines | length > 0 else [' PATH de root es seguro'] }}"
             - "========================================="


    - name: CIS 6.2.8 - Crear home directories faltantes
      shell: |
           awk -F: '($1!~/(halt|sync|shutdown|nfsnobody)/ &&
           $7!~/^(\/usr)?\/sbin\/nologin/ &&
           $7!~/(\/usr)?\/bin\/false/) { print $1 " " $6 }' /etc/passwd |
           while read -r user dir; do
             if [ ! -d "$dir" ]; then
               echo "Creando home para $user en $dir"
               mkdir -p "$dir"
               chmod -p "$dir"
               chmod g-w,o-wrx "$dir"
               chown "$user" "$dir"
              fi
            done
          register: home_dirs_created
          changed_when: home_dirs_created.stdout != ""


    - name: CIS 6.2.8 - Mostrar homes creados
      debug:
           msg: "{{ home_dirs_created.stdout_lines if home_dirs_created.stdout != '' else [' Todos los home directories existen'] }}"
       
    - name: CIS 6.2.9 - Asegurar ownership correcto de home directories
      shell: |
           awk -F: '($1!~/(halt|sync|shutdown)/ &&
           $7!~/^(\/usr)?\/sbin\/nologin/ &&
           $7!~/(\/usr)?\/bin\/false/) { print $1 " " $6 }' /etc/passwd |  
           while read -r user dir; do
             if [ ! -d "$dir" ]; then
               echo "Home no existe para $user, creando $dir"
               mkdir -p "$dir"
               chmod g-w,o-rwx "$dir"
               chown "$user" "$dir"
             else
               owner=$(stat -L -c "%U" "$dir")
               if [ "$owner" != "$user" ]; then
                 echo "Corrigiendo ownership de $dir (era $owner)"
                 chmod g-w,o-rwx "$dir"
                 chown "$user" "$dir"
               fi
              fi
            done
          register: home_ownership_fixed 
          changed_when: home_ownership_fixed.stdout != ""


    - name: CIS 6.2.9 - Mostrar cambios de ownership
      debug:
           msg: "{{ home_ownership_fixed.stdout_lines if home_ownership_fixed.stdout != '' else [' Ownership de home directories correcto'] }}"


    - name: CIS 6.2.10 - Auditar permisos de home directories
      shell: |
           awk -F: '($1!~/(halt|sync|shutdown)/ &&
           $7!~/^(\/usr)?\/sbin\/nologin/ &&
           $7!~/(\/usr)?\/bin\/false/) { print $1 " " $6 }' /etc/passwd |
           while read -r user dir; do
             if [ ! -d "$dir" ]; then
               echo "User \"$user\" home directory \"$dir\" does not exist"
             else
               perm=$(stat -L -c "%A %a" "$dir")
               sym=$(echo "$perm" | awk '{print $1}')
               num=$(echo "$perm" | awk '{print $2}')


               
               if [ "${sym:5:1}" != "-" ] || \
                  [ "${sym:5:1}" != "-" ] || \
                  [ "${sym:5:1}" != "-" ] || \
                  [ "${sym:9:1}" != "-" ]; then
                 echo "User \"$user\" home \"$dir\" has permissions \"$num\""
               fi 
             fi 
           done 
         register: home_perm_audit
         changed_when: false
         failed_when: false




    - name: CIS 6.2.10 - Mostrar permisos inseguros detectados
      debug:
           msg:
             - "========================================="
             - "CIS 6.2.10 - Permisos de home directories"
             - "========================================="
             - "{{ home_perm_audit.stdout_lines if home_perm_audit.stdout_lines | length > 0 else [' Todos los home directories cumplen (<=750)'] }}"
             - "========================================="


    - name: CIS 6.2.10 - Remediar permisos de home directories a 750
      file:
           path: "{{ item.split('\"')[3] }}"
           mode: "0750"
         loop: "{{ home_perm_audit.stdout_lines }}"
         when:
           - cis_6_1_10_remediate | bool
           - home_perm_audit.stdout_lines | length > 0


    - name: CIS 6.2.10 - Re-verificar permisos despues de remediar
      shell: |
           awk -F: '($1!~/(halt|sync|shutdown)/ &&
           $7!~/^(\/usr)?\/sbin\/nologin/ &&
           $7!~/(\/usr)?\/bin\/false/) { print $6 }' /etc/passwd |
           while read -r dir; do
             if [ -d "$dir" ]; then
               stat -L -c "%a %n" "$dir"
             fi 
           done
          register: home_perm_final
          changed_when: false
          when: cis_6_2_10_remediate | bool


    - name: CIS 6.2.10 - Validacin final
      assert:
           that:
             - home_perm_audit.stdout_lines | length > 0
               or 
               (cis_6_2_10_remediate | bool)
           fail_msg: "CIS 6.2.10 - FALLO: Existen home directories con permisos inseguros"
           success_msg: "CIS 6.2.10 - XITO: Permisos de home directories cumplen con <= 750"
    
    
      - name: CIS 6.2.11 - Auditar permisos de dot files de usuarios
        shell: |
          awk -F: '($1!~/(halt|sync|shutdown)/ &&
          $7!~/^(\/usr)?\/sbin\/nologin/ &&
          $7!~/(\/usr)?\/bin\/false/) { print $1 " " $6 }' /etc/passwd |
          while read -r user dir; do
            if [ -d "$dir" ]; then
              for file in "$dir"/.*; do
                if [ -f "$file" ] && [ ! -h "$file" ]; then
                  perm=$(stat -L -c "%A" "$file")
                  if [ "${perm:5:1}" != "-" ] || [ "${perm:8:1}" != "-" ]; then
                    echo "User \"$user\" dot file \"$file\" has permissions \"$perm\""
                  fi 
                fi 
              done
            fi 
          done 
        register: dotfiles_audit
        changed_when: false
        failed_when: false
      
      - name: CIS 6.2.11 - Mostrar dot files con permisos inseguros
        debug:
          msg:
            - "========================================="
            - "CIS 6.2.11 - Dot files con permisos inseguros"
            - "========================================="
            - "{{ dotfiles_audit.stdout_lines if dotfiles_audit.stdout_lines | length > 0 else [' Todos los dot files cumplen'] }}"
            - "========================================="


    - name: CIS 6.2.11 - Remediar permisos de dot files (chmod go-w)
      file:
           path: "{{ item.split('\"')[3] }}"
           mode: "u=rwX,go=rX"
         loop: "{{ dotfiles_audit.stdout_lines }}"
         when:
           - cis_6_2_11_remediate | bool
           - dotfiles_audit.stdout_lines | length > 0


    - name: CIS 6.2.11 - Re-verificar dot files despus de remediar
      shell: |
           awk -F: '($1!~/(halt|sync|shutdown)/ &&
           $7!~/^(\/usr)?\/sbin\/nologin/ &&
           $7!~/(\/usr)?\/bin\/false/) { print $6 }' /etc/passwd |
           while read -r dir; do
             if [ -d "$dir" ]; then
               find "$dir"/.* -maxdepth 0 -type f ! -perm -0020 ! -perm -0002 2>/dev/null
              fi 
            done 
          register: dotfiles_final
          changed_when: false 
          when: cis_6_2_11_remediate | bool


    - name: CIS 6.2.11 - Validacin final
      assert:
           that:
             - dotfiles_audit.stdout_lines
               or 
               (cis_6_2_11_remediate | bool)
           fail_msg: "CIS 6.2.11 - FALLO: Existen dot files con permisos inseguros"
           success_msg: "CIS 6.2.11 - XITO: Dot files cumplen permisos seguros"


    - name: 6.2.12 | Check for .forward files in users home directories
      ansible.builtin.shell: |
           awk -F: '($1!~/(root|halt|sync|shutdown)/ &&
           $7!~/^(\/usr)?\/sbin\/nologin(\/)?$/ &&
           $7!~/(\/usr)?\/bin\/false(\/)?$/) { print $1 " " $6 }' /etc/passwd | \
           while read -r user dir; do
             if [ -d "$dir" ]; then
               file="$dir/.forward"
               if [ ! -h "$file" ] && [ -f "$file" ]; then
                 echo "User: \"$user\" file: \"$file\" exists"
               fi
              fi 
            done 
register: forward_files_check
          changed_when: false
          failed_when: false


    - name: 6.2.12 | Report .forward files found (if any)
      ansible.builtin.debug:
        msg: "{{ forward_files_check.stdout_lines }}"
      when: forward_files_check.stdout != ""


    - name: 6.2.13 | Check for .netrc files and permissions
      ansible.builtin.shell: |
           awk -F: '($1!~/(halt|sync|shutdown)/ &&
           $7!~/^(\/usr)?\/sbin\/nologin(\/)?$/ &&
           $7!~/(\/usr)?\/bin\/false(\/)?$/) { print $1 " " $6 }' /etc/passwd | \
           while read -r user dir; do
             if [ -d "$dir" ]; then
               file="$dir/.netrc"
               if [ ! -h "$file" ] && [ -f "$file" ]; then
                 perm=$(stat -L -c "%a" "$file")
                 if stat -L -c "%A" "$file" | cut -c4-10 | grep -Eq '[^-]+'; then
                   echo "FAILED: User: \"$user\" file: \"$file\" exists with permissions: \"$perm\""
                 else 
                   echo "WARNING: User: \"$user\" file: \"$file\" exists with permissions: \"$perm\""
                 fi 
                fi 
               fi 
            done
          register: netrc_files
          changed_when: false
       
    - name: 6.2.13 | Fail if insecure .netrc files exist
      ansible.builtin.fail:
           msg: "{{ netrc_files.stdout_lines }}"
         when: netrc_files.stdout is search('FAILED:')
        
    - name: 6.2.13 | Report .netrc files with secure permissions (warning only)
      ansible.builtin.debug:
           msg: "{{ netrc_files.stdout_lines }}"
         when:
           - netrc_files.stdout != ""
           - netrc_files.stdout is not search('FAILED:')


    - name: 6.2.16 | Check for duplicate UIDs
      ansible.builtin.shell: |
           cut -f3 -d":" /etc/passwd | sort -n | uniq -c | awk '$1 > 1 {print}'
         register: duplicate_uids
         changed_when: false
         failed_when: duplicate_uids.stdout != ""
      
    - name: 6.2.16 | Report duplicate UIDs (if any)
      ansible.builtin.debug:
           msg: "Duplicate UIDs detected: {{ duplicate_uids.stdout }}"
         when: duplicate_uids.stdout != ""




    - name: 6.2.17 | Check for duplicate GIDs
      ansible.builtin.shell: |
           cut -d: -f3 /etc/group | sort -n | uniq -c | awk '$1 > 1 {print}'
         register: duplicate_gids
         changed_when: false
         failed_when: duplicate_gids.stdout != ""
       
    - name: 6.2.17 | Report duplicate GIDs (if any)
      ansible.builtin.debug:
           msg: "Duplicate GIDs detected: {{ duplicate_gids.stdout }}"
         when: duplicate_gids.stdout != ""


    - name: 6.2.18 | Check for duplicate user names
      ansible.builtin.shell: |
           cut -d: -f1 /etc/passwd | sort | uniq -d
         register: duplicate_usernames
         changed_when: false
         failed_when: duplicate_usernames.stdout != ""


    - name: 6.2.18 | Report duplicate user names (if any)
      ansible.builtin.debug:
           msg: "Duplicate user names detected in /etc/passwd: {{ duplicate_usernames.stdout_lines }}"
         when: duplicate_usernames.stdout != ""
       
    - name: 6.2.19 | Check for duplicate group names
      ansible.builtin.shell: |
           cut -d: -f1 /etc/group | sort | uniq -d 
         register: duplicate_groupnames
         changed_when: false
         failed_when: duplicate_groupnames.stdout != ""
      
    - name: 6.2.19 | Report duplicate group names (if any)
      ansible.builtin.debug:
           msg: "Duplicate group names detected in /etc/group: {{ duplicate_groupnames.stdout_lines }}"
         when: duplicate_groupnames.stdout != ""


       


    - name: 6.2.15 | Ensure all groups in /etc/passwd exist in /etc/group (Automated)
      shell: |
        awk -F: '{print $4}' /etc/passwd | sort -u | while read -r gid; do
          if [ -n "$gid" ]; then
            if ! grep -q "^[^:]*:[^:]*:${gid}:" /etc/group; then
              echo "GID $gid from /etc/passwd not found in /etc/group"
            fi
          fi
        done
      register: missing_groups
      changed_when: false
      failed_when: false


    - name: 6.2.15 | Report missing groups (if any)
      debug:
        msg:
          - "========================================="
          - "CIS 6.2.15 - Verificacin de grupos"
          - "========================================="
          - "{{ missing_groups.stdout_lines if missing_groups.stdout_lines | length > 0 else [' Todos los grupos de /etc/passwd existen en /etc/group'] }}"
          - "========================================="


    - name: 6.2.15 | Fail if missing groups detected
      fail:
        msg: "FALLO: Existen GIDs en /etc/passwd que no estn en /etc/group"
      when:
        - missing_groups.stdout_lines is defined
        - missing_groups.stdout_lines | length > 0


    - name: Resumen de Remediacin - CIS Benchmark RHEL 6
      debug:
        msg:
          - ""
          - ""
          - "                                                                           "
          - "         RESUMEN DE REMEDIACIN - CIS BENCHMARK RHEL 6                    "
          - "                                                                           "
          - ""
          - ""
          - ""
          - " SECCIN 1: CONFIGURACIN DE FILESYSTEMS Y KERNEL                         "
          - ""
          - ""
          - "   1.1.1 - Filesystems innecesarios deshabilitados:"
          - "       cramfs, freevxfs, jffs2, hfs, hfsplus, squashfs, udf"
          - "   1.1.23 - USB Storage deshabilitado (Automated)"
          - "   1.5.3 - ASLR (Address Space Layout Randomization) habilitado"
          - "   1.5.4 - Prelink deshabilitado (Automated)"
          - "   1.6.1.4 - SELinux en modo enforcing/permissive (Automated)"
          - "   1.9 - Parches de seguridad aplicados (Automated)"
          - ""
          - ""
          - " SECCIN 2: CONFIGURACIN DE SERVICIOS INNECESARIOS                      "
          - ""
          - ""
          - "   2.2.2 - X11 Server deshabilitado"
          - "   2.2.3 - Avahi Server deshabilitado"
          - "   2.2.4 - CUPS deshabilitado"
          - "   2.2.5 - DHCP Server deshabilitado"
          - "   2.2.6 - LDAP Server deshabilitado"
          - "   2.2.7 - DNS Server (BIND) deshabilitado"
          - "   2.2.8 - FTP Server (vsftpd) deshabilitado"
          - "   2.2.9 - HTTP Server (Apache) deshabilitado"
          - "   2.2.10 - IMAP/POP3 Server (Dovecot) deshabilitado"
          - "   2.2.11 - Samba deshabilitado"
          - "   2.2.12 - HTTP Proxy (Squid) deshabilitado"
          - "   2.2.13 - SNMP Server deshabilitado"
          - "   2.2.14 - NIS Server deshabilitado"
          - "   2.2.15 - Telnet Server deshabilitado"
          - "   2.2.16 - NFS Server deshabilitado"
          - "   2.2.17 - rpcbind deshabilitado"
          - "   2.2.18 - MTA configurado solo en loopback"
          - ""
          - ""
          - " SECCIN 3: CONFIGURACIN Y PROTECCIN DE RED                            "
          - ""
          - ""
          - "   3.2.2 - IP Forwarding y Send Redirects deshabilitados"
          - "   3.3.1 - Source Routed Packets deshabilitados"
          - "   3.3.2 - ICMP Redirects deshabilitados"
          - "   3.3.4 - Log de Martians (paquetes sospechosos) habilitado"
          - "   3.3.5 - ICMP Broadcasts ignorados (proteccin Smurf)"
          - "   3.3.7 - Reverse Path Filtering habilitado (anti-spoofing)"
          - "   3.3.8 - TCP SYN Cookies habilitados (anti-SYN Flood)"
          - ""
          - ""
          - " SECCIN 5: CONTROL DE ACCESO Y AUTENTICACIN                            "
          - ""
          - ""
          - "   5.1.8 - Acceso a cron restringido a usuarios autorizados"
          - "   5.1.9 - Acceso a 'at' restringido a usuarios autorizados"
          - "   5.5.2 - Cuentas del sistema aseguradas (sin shell, bloqueadas)"
          - "   5.7 - Acceso a 'su' restringido al grupo wheel"
          - ""
          - ""
          - " SECCIN 6: AUDITORA Y CONTROL DE ACCESO A ARCHIVOS                    "
          - ""
          - ""
          - "   6.1.10 - Auditora y remediacin de archivos world-writable"
          - "   6.2.7 - Integridad del PATH de root verificada"
          - "   6.2.8-11 - Home directories y dot files validados"
          - "   6.2.12-13 - Archivos .forward y .netrc auditados"
          - "   6.2.15 - Validacin de GIDs en /etc/group vs /etc/passwd"
          - "   6.2.16-19 - Validacin de UIDs y GIDs nicos"
          - ""
          - ""
          - "                           RESUMEN EJECUTIVO                              "
          - ""
          - "                                                                           "
          - "  Remediaciones Aplicadas: 40+                                            "
          - "  Estndar: CIS Benchmark Red Hat Enterprise Linux 6                      "
          - "  Estado:  COMPLETADO                                                    "
          - "                                                                           "
          - "  PRXIMOS PASOS:                                                         "
          - "  1. Revisar logs de ejecucin para validar completitud                   "
          - "  2. Verificar servicios crticos funcionando correctamente               "
          - "  3. Ejecutar OpenSCAP para validacin independiente                      "
          - "  4. Implementar monitoreo continuo de cumplimiento                       "
          - "  5. Documentar cualquier desviacin y excepciones                        "
          - "                                                                           "
          - ""
          - ""