--- 
# Playbook de remediaciones CIS BENCHMARK
#  Oracle Solaris 11 Benchmark v1.1.4
# CIS 
# 

- name: CIS 2.12 - Deshabilitar Servicio telnet
  hosts: all
  become: yes
  gather_facts: yes

  vars:
    telnet_service: "svc:/network/telnet"
    cis_control: "2.12"
    cis_level: "Level 1"
    audit_log: "/var/log/cis_remediation.log"

  tasks:

    - name:  Inicio de Remediación CIS 2.12
      debug:
        msg:
          - ""
          - "╔═══════════════════════════════════════════════════════════════════════════╗"
          - "║                                                                           ║"          
          - "║         INICIANDO REMEDIACIÓN CIS BENCHMARK SOLARIS 11                   ║"
          - "║         Control 2.12: Deshabilitar Servicio Telnet                       ║"
          - "║                                                                           ║"
          - "╚═══════════════════════════════════════════════════════════════════════════╝"
          - ""

    - name: Auditoria- Verificar estado actual del servicio telnet
      shell: "svcs -Ho state {{ telnet_service }} 2>/dev/null || echo 'not_installed'"
      register: telnet_status_before
      changed_when: false
      ignore_errors: yes

    - name: Auditoria - registrar estado inicial
      lineinfile:
        path: "{{ audit_log }}"
        line: "[{{ ansible_date_time.iso8601 }}] CIS {{ cis_control }} - Estado PRE: {{ telnet_status_before.stdout }}"
        create: yes
      when: telnet_status_before.stdout != "not_installed"

    - name: remediacion - Deshabilitar servicio telnet
      shell: "svcadm disable {{ telnet_service }}"
      register: disable_result
      when:
        - telnet_status_before.stdout != "not_installed"
        - telnet_status_before.stdout != "disabled"
      ignore_errors: yes

    - name: remediacion - Notificacion de cambio 
      debug:
        msg:
          - "______________________________________________________"
          - "║REMEDIACION EJECUTADA                               ║"
          - "______________________________________________________"
      when:
        - disable_result is defined
        - disable_result.changed 
    
    - name: remediacion - Servicio ya estaba Deshabilitado 
      debug:
        msg:
          - "_____________________________________________________"
          - "║ESTADO CONFORMADO                                  ║"
          - "_____________________________________________________"
      
      when: telnet_status_before.stdout == "disabled"


    - name: Remediacion - servicio no instalado
      debug:
        msg:
          - "_____________________________________________________"
          - "║ESTADO CONFORMADO                                  ║"
          - "_____________________________________________________"
      
      when: telnet_status_before.stdout == "not_installed"

    - name: Validación - Verificar estado final del servicio
      shell: "svcs -Ho state {{ telnet_service }} 2>/dev/null || echo 'not_installed'"
      register: telnet_status_after
      changed_when: false
      ignore_errors: yes
    
    - name: Validacion - Confirmar desahabilitador 
      assert:
        that:
          - telnet_status_after.stdout == "disabled" or telnet_status_after.stdout == "not_installed"
        fail_msg: "ERROR: El servicio Telnet no pudo ser deshabilitado correctamente"

    - name: Validacion - registrar estado final 
      lineinfile:
        path: "{{ audit_log }}"
        line: "[{{ ansible_date_time.iso8601 }}] CIS {{ cis_control }} - Estado POST: {{ telnet_status_after.stdout }} - CONFORME"
        create: yes
    
    - name: Seguridad - Verificar que no hay conexiones Telnet activas
      shell: "netstat -an | grep ':23 ' | grep LISTEN || echo 'none'"
      register: telnet_connections
      changed_when: false
      ignore_errors: yes
    
    - name: Seguridad - Alertar si hay conexiones en el puerto 23
      debug:
        msg:
          - " ADVERTENCIA: Se detectaron posibles conexiones en puerto 23"
          - "  Detalles: {{ telnet_connections.stdout }}"
      when: 
        - telnet_connections.stdout != "none"
        - telnet_connections.stdout != ""      


    - name: Inicio de Remediación CIS 3.1
      debug:
        msg:
          - ""
          - "╔═══════════════════════════════════════════════════════════════════════════╗"
          - "║                                                                           ║"          
          - "║         Control 3.1: Deshabilitar Respuesta a Broadcast ICMP Echo        ║"
          - "║                                                                           ║"
          - "╚═══════════════════════════════════════════════════════════════════════════╝"
          - ""

    - name: CIS 3.1 - Auditoría - Verificar configuración actual (current)
      shell: "ipadm show-prop -p _respond_to_echo_broadcast -co current ip 2>/dev/null || echo 'error'"
      register: icmp_broadcast_current
      changed_when: false
      ignore_errors: yes

    - name: CIS 3.1 - Auditoría - Verificar configuración persistente
      shell: "ipadm show-prop -p _respond_to_echo_broadcast -co persistent ip 2>/dev/null || echo 'error'"
      register: icmp_broadcast_persistent
      changed_when: false
      ignore_errors: yes

    - name: CIS 3.1 - Auditoría - Mostrar estado actual
      debug:
        msg:
          - "┌─────────────────────────────────────────────────────────────────────────┐"
          - "│ AUDITORÍA PRE-REMEDIACIÓN - CIS 3.1                                     │"
          - "└─────────────────────────────────────────────────────────────────────────┘"
          - ""
          - "  Configuración actual:      {{ icmp_broadcast_current.stdout }}"
          - "  Configuración persistente: {{ icmp_broadcast_persistent.stdout }}"
          - "  Valor esperado:            0 (deshabilitado)"
          - ""

    - name: CIS 3.1 - Auditoría - Registrar estado inicial
      lineinfile:
        path: "{{ audit_log }}"
        line: "[{{ ansible_date_time.iso8601 }}] CIS 3.1 - Estado PRE: current={{ icmp_broadcast_current.stdout }}, persistent={{ icmp_broadcast_persistent.stdout }}"
        create: yes

    - name: CIS 3.1 - Remediación - Deshabilitar respuesta a broadcast ICMP echo
      shell: "ipadm set-prop -p _respond_to_echo_broadcast=0 ip"
      register: icmp_broadcast_result
      when: icmp_broadcast_current.stdout != "0" or icmp_broadcast_persistent.stdout != "0"
      ignore_errors: yes

    - name: CIS 3.1 - Remediación - Notificación de cambio
      debug:
        msg:
          - "┌─────────────────────────────────────────────────────────────────────────┐"
          - "│ REMEDIACIÓN EJECUTADA - CIS 3.1                                          │"
          - "└─────────────────────────────────────────────────────────────────────────┘"
          - ""
          - "   Respuesta a broadcast ICMP echo deshabilitada"
          - "   Comando ejecutado: ipadm set-prop -p _respond_to_echo_broadcast=0 ip"
          - ""
      when:
        - icmp_broadcast_result is defined
        - icmp_broadcast_result.rc is defined
        - icmp_broadcast_result.rc == 0

    - name: CIS 3.1 - Remediación - Configuración ya conforme
      debug:
        msg:
          - "┌─────────────────────────────────────────────────────────────────────────┐"
          - "│ ESTADO CONFORME - CIS 3.1                                                │"
          - "└─────────────────────────────────────────────────────────────────────────┘"
          - ""
          - "   La respuesta a broadcast ICMP echo ya estaba deshabilitada"
          - ""
      when: icmp_broadcast_current.stdout == "0" and icmp_broadcast_persistent.stdout == "0"

    - name: CIS 3.1 - Validación - Verificar configuración final (current)
      shell: "ipadm show-prop -p _respond_to_echo_broadcast -co current ip"
      register: icmp_broadcast_after_current
      changed_when: false
      ignore_errors: yes

    - name: CIS 3.1 - Validación - Verificar configuración final (persistent)
      shell: "ipadm show-prop -p _respond_to_echo_broadcast -co persistent ip"
      register: icmp_broadcast_after_persistent
      changed_when: false
      ignore_errors: yes

    - name: CIS 3.1 - Validación - Confirmar configuración
      assert:
        that:
          - icmp_broadcast_after_current.stdout == "0"
          - icmp_broadcast_after_persistent.stdout == "0"
        fail_msg: "ERROR: La configuración de broadcast ICMP echo no está correcta"
        success_msg: " Validación exitosa: Respuesta a broadcast ICMP echo deshabilitada"

    - name: CIS 3.1 - Validación - Registrar estado final
      lineinfile:
        path: "{{ audit_log }}"
        line: "[{{ ansible_date_time.iso8601 }}] CIS 3.1 - Estado POST: current={{ icmp_broadcast_after_current.stdout }}, persistent={{ icmp_broadcast_after_persistent.stdout }} - CONFORME"
        create: yes


    - name: Inicio de Remediación CIS 3.2
      debug:
        msg:
          - ""
          - "╔═══════════════════════════════════════════════════════════════════════════╗"
          - "║                                                                           ║"          
          - "║         Control 3.2: Deshabilitar Respuesta a ICMP Netmask Broadcast     ║"
          - "║                                                                           ║"
          - "╚═══════════════════════════════════════════════════════════════════════════╝"
          - ""

    - name: CIS 3.2 - Auditoría - Verificar configuración actual (current)
      shell: "ipadm show-prop -p _respond_to_address_mask_broadcast -co current ip 2>/dev/null || echo 'error'"
      register: netmask_broadcast_current
      changed_when: false
      ignore_errors: yes

    - name: CIS 3.2 - Auditoría - Verificar configuración persistente
      shell: "ipadm show-prop -p _respond_to_address_mask_broadcast -co persistent ip 2>/dev/null || echo 'error'"
      register: netmask_broadcast_persistent
      changed_when: false
      ignore_errors: yes

    - name: CIS 3.2 - Auditoría - Mostrar estado actual
      debug:
        msg:
          - "┌─────────────────────────────────────────────────────────────────────────┐"
          - "│ AUDITORÍA PRE-REMEDIACIÓN - CIS 3.2                                     │"
          - "└─────────────────────────────────────────────────────────────────────────┘"
          - ""
          - "  Configuración actual:      {{ netmask_broadcast_current.stdout }}"
          - "  Configuración persistente: {{ netmask_broadcast_persistent.stdout }}"
          - "  Valor esperado:            0 (deshabilitado)"
          - ""

    - name: CIS 3.2 - Auditoría - Registrar estado inicial
      lineinfile:
        path: "{{ audit_log }}"
        line: "[{{ ansible_date_time.iso8601 }}] CIS 3.2 - Estado PRE: current={{ netmask_broadcast_current.stdout }}, persistent={{ netmask_broadcast_persistent.stdout }}"
        create: yes

    - name: CIS 3.2 - Remediación - Deshabilitar respuesta a netmask broadcast
      shell: "ipadm set-prop -p _respond_to_address_mask_broadcast=0 ip"
      register: netmask_broadcast_result
      when: netmask_broadcast_current.stdout != "0" or netmask_broadcast_persistent.stdout != "0"
      ignore_errors: yes

    - name: CIS 3.2 - Remediación - Notificación de cambio
      debug:
        msg:
          - "┌─────────────────────────────────────────────────────────────────────────┐"
          - "│ REMEDIACIÓN EJECUTADA - CIS 3.2                                          │"
          - "└─────────────────────────────────────────────────────────────────────────┘"
          - ""
          - "  Respuesta a ICMP netmask broadcast deshabilitada"
          - "   Comando ejecutado: ipadm set-prop -p _respond_to_address_mask_broadcast=0 ip"
          - ""
      when:
        - netmask_broadcast_result is defined
        - netmask_broadcast_result.rc is defined
        - netmask_broadcast_result.rc == 0

    - name: CIS 3.2 - Remediación - Configuración ya conforme
      debug:
        msg:
          - "┌─────────────────────────────────────────────────────────────────────────┐"
          - "│ ESTADO CONFORME - CIS 3.2                                                │"
          - "└─────────────────────────────────────────────────────────────────────────┘"
          - ""
          - "  La respuesta a ICMP netmask broadcast ya estaba deshabilitada"
          - ""
      when: netmask_broadcast_current.stdout == "0" and netmask_broadcast_persistent.stdout == "0"

    - name: CIS 3.2 - Validación - Verificar configuración final (current)
      shell: "ipadm show-prop -p _respond_to_address_mask_broadcast -co current ip"
      register: netmask_broadcast_after_current
      changed_when: false
      ignore_errors: yes

    - name: CIS 3.2 - Validación - Verificar configuración final (persistent)
      shell: "ipadm show-prop -p _respond_to_address_mask_broadcast -co persistent ip"
      register: netmask_broadcast_after_persistent
      changed_when: false
      ignore_errors: yes

    - name: CIS 3.2 - Validación - Confirmar configuración
      assert:
        that:
          - netmask_broadcast_after_current.stdout == "0"
          - netmask_broadcast_after_persistent.stdout == "0"
        fail_msg: "ERROR: La configuración de netmask broadcast no está correcta"
        success_msg: " Validación exitosa: Respuesta a ICMP netmask broadcast deshabilitada"

    - name: CIS 3.2 - Validación - Registrar estado final
      lineinfile:
        path: "{{ audit_log }}"
        line: "[{{ ansible_date_time.iso8601 }}] CIS 3.2 - Estado POST: current={{ netmask_broadcast_after_current.stdout }}, persistent={{ netmask_broadcast_after_persistent.stdout }} - CONFORME"
        create: yes
  

    - name: Inicio de Remediación CIS 3.3
      debug:
        msg:
          - ""
          - "╔═══════════════════════════════════════════════════════════════════════════╗"
          - "║                                                                           ║"          
          - "║         Control 3.3: Habilitar Generación Fuerte de Secuencias TCP       ║"
          - "║                                                                           ║"
          - "╚═══════════════════════════════════════════════════════════════════════════╝"
          - ""

    - name: CIS 3.3 - Auditoría - Verificar TCP_STRONG_ISS en archivo inetinit
      shell: "grep '^TCP_STRONG_ISS=' {{ inetinit_file }} 2>/dev/null || echo 'not_found'"
      register: tcp_strong_iss_file
      changed_when: false
      ignore_errors: yes

    - name: CIS 3.3 - Auditoría - Verificar configuración TCP en sistema
      shell: "ipadm show-prop -p _strong_iss -co current tcp 2>/dev/null || echo 'error'"
      register: tcp_strong_iss_current
      changed_when: false
      ignore_errors: yes

    - name: CIS 3.3 - Auditoría - Mostrar estado actual
      debug:
        msg:
          - "┌─────────────────────────────────────────────────────────────────────────┐"
          - "│ AUDITORÍA PRE-REMEDIACIÓN - CIS 3.3                                     │"
          - "└─────────────────────────────────────────────────────────────────────────┘"
          - ""
          - "  Archivo inetinit:      {{ tcp_strong_iss_file.stdout }}"
          - "  Sistema actual:        {{ tcp_strong_iss_current.stdout }}"
          - "  Valor esperado:        TCP_STRONG_ISS=2 (RFC 1948)"
          - ""

    - name: CIS 3.3 - Auditoría - Registrar estado inicial
      lineinfile:
        path: "{{ audit_log }}"
        line: "[{{ ansible_date_time.iso8601 }}] CIS 3.3 - Estado PRE: file={{ tcp_strong_iss_file.stdout }}, current={{ tcp_strong_iss_current.stdout }}"
        create: yes

    - name: CIS 3.3 - Remediación - Crear backup del archivo inetinit
      copy:
        src: "{{ inetinit_file }}"
        dest: "{{ inetinit_file }}.backup.{{ ansible_date_time.epoch }}"
        remote_src: yes
      when: tcp_strong_iss_file.stdout != "TCP_STRONG_ISS=2"
      ignore_errors: yes

    - name: CIS 3.3 - Remediación - Actualizar TCP_STRONG_ISS en archivo inetinit
      shell: |
        cd /etc/default
        awk '/TCP_STRONG_ISS=/ { $1 = "TCP_STRONG_ISS=2" }; { print }' inetinit > inetinit.CIS
        mv inetinit.CIS inetinit
      register: tcp_file_result
      when: tcp_strong_iss_file.stdout != "TCP_STRONG_ISS=2"
      ignore_errors: yes

    - name: CIS 3.3 - Remediación - Configurar TCP_STRONG_ISS en sistema activo
      shell: "ipadm set-prop -p _strong_iss=2 tcp"
      register: tcp_system_result
      when: tcp_strong_iss_current.stdout != "2"
      ignore_errors: yes

    - name: CIS 3.3 - Remediación - Notificación de cambio
      debug:
        msg:
          - "┌─────────────────────────────────────────────────────────────────────────┐"
          - "│ REMEDIACIÓN EJECUTADA - CIS 3.3                                          │"
          - "└─────────────────────────────────────────────────────────────────────────┘"
          - ""
          - "   TCP_STRONG_ISS configurado a 2 (RFC 1948)"
          - "   Protección contra secuestro de sesiones TCP mejorada"
          - ""
      when: 
        - (tcp_file_result is defined and tcp_file_result.rc is defined and tcp_file_result.rc == 0) or
          (tcp_system_result is defined and tcp_system_result.rc is defined and tcp_system_result.rc == 0)

    - name: CIS 3.3 - Validación - Verificar configuración final en archivo
      shell: "grep '^TCP_STRONG_ISS=' {{ inetinit_file }}"
      register: tcp_strong_iss_after_file
      changed_when: false
      ignore_errors: yes

    - name: CIS 3.3 - Validación - Verificar configuración final en sistema
      shell: "ipadm show-prop -p _strong_iss -co current tcp"
      register: tcp_strong_iss_after_system
      changed_when: false
      ignore_errors: yes

    - name: CIS 3.3 - Validación - Confirmar configuración
      assert:
        that:
          - tcp_strong_iss_after_file.stdout == "TCP_STRONG_ISS=2"
          - tcp_strong_iss_after_system.stdout == "2"
        fail_msg: "ERROR: TCP_STRONG_ISS no está correctamente configurado"
        success_msg: " Validación exitosa: TCP_STRONG_ISS=2 (RFC 1948)"

    - name: CIS 3.3 - Validación - Registrar estado final
      lineinfile:
        path: "{{ audit_log }}"
        line: "[{{ ansible_date_time.iso8601 }}] CIS 3.3 - Estado POST: file={{ tcp_strong_iss_after_file.stdout }}, system={{ tcp_strong_iss_after_system.stdout }} - CONFORME"
        create: yes

    - name: Inicio de Remediacion CIS 3.4
      debug:
        msg:
          - ""
          - "╔═══════════════════════════════════════════════════════════════════════════╗"
          - "║                                                                           ║"          
          - "║         Control 3.4: Deshabilitar Respuesta a ICMP Timestamp Broadcast   ║"
          - "║                                                                           ║"
          - "╚═══════════════════════════════════════════════════════════════════════════╝"
          - ""
    
    - name: CIS 3.4 - Auditoria - Verificar configuracion actual
      shell: "ipadm show-prop -p _respond_to_timestamp_broadcast -co current ip 2>/dev/null || echo 'error'"
      register: timestamp_broadcast_persistent
      changed_when: false
      ignore_errors: yes 
    
    - name: CIS 3.4 - Auditoria - Verificar configuración persistente
      shell: "ipadm show-prop -p _respond_to_timestamp_broadcast -co persistent ip 2>/dev/null || echo 'error'"
      register: timestamp_broadcast_persistent
      changed_when: false
      ignore_errors: yes
    
    - name: CIS 3.4 - Auditoria - Registrar estado inicial
      lineinfile:
        path: "{{ audit_log }}"
        line: "[{{ ansible_date_time.iso8601 }}] CIS 3.4 - Estado PRE: current={{ timestamp_broadcast_current.stdout }}, persistent={{ timestamp_broadcast_persistent.stdout }}"
        create: yes
    
    - name: CIS 3.4 - Remediacion - desahabilitador respuesta a Timestamp broadcast
      shell: "ipadm set-prop -p _respond_to_timestamp_broadcast=0 ip"
      register: timestamp_broadcast_result
      when: timestamp_broadcast_current.stdout != "0" or timestamp_broadcast_persistent.stdout != "0"
      ignore_errors: yes

    - name: CIS 3.4 - Remediación - Notificación de cambio
      debug:
        msg:
          - "┌─────────────────────────────────────────────────────────────────────────┐"
          - "│ REMEDIACIÓN EJECUTADA - CIS 3.4                                          │"
          - "└─────────────────────────────────────────────────────────────────────────┘"
          - ""
          - "   Respuesta a ICMP timestamp broadcast deshabilitada"
          - ""
      when:
        - timestamp_broadcast_result is defined
        - timestamp_broadcast_result.rc is defined
        - timestamp_broadcast_result.rc == 0

    - name: CIS 3.4 - Validación - Registrar estado final
      lineinfile:
        path: "{{ audit_log }}"
        line: "[{{ ansible_date_time.iso8601 }}] CIS 3.4 - Estado POST: CONFORME"
        create: yes

    - name: Inicio de Remediación CIS 3.5
      debug:
        msg:
          - ""
          - "╔═══════════════════════════════════════════════════════════════════════════╗"
          - "║                                                                           ║"          
          - "║         Control 3.5: Deshabilitar Reenvío de Paquetes Source-Routed      ║"
          - "║                                                                           ║"
          - "╚═══════════════════════════════════════════════════════════════════════════╝"
          - ""

    - name: CIS 3.5 - Auditoría - Verificar configuración IPv4 actual
      shell: "ipadm show-prop -p _forward_src_routed -co current ipv4 2>/dev/null || echo 'error'"
      register: ipv4_forward_current
      changed_when: false
      ignore_errors: yes

    - name: CIS 3.5 - Auditoría - Verificar configuración IPv4 persistente
      shell: "ipadm show-prop -p _forward_src_routed -co persistent ipv4 2>/dev/null || echo 'error'"
      register: ipv4_forward_persistent
      changed_when: false
      ignore_errors: yes

    - name: CIS 3.5 - Auditoría - Verificar configuración IPv6 actual
      shell: "ipadm show-prop -p _forward_src_routed -co current ipv6 2>/dev/null || echo 'error'"
      register: ipv6_forward_current
      changed_when: false
      ignore_errors: yes

    - name: CIS 3.5 - Auditoría - Verificar configuración IPv6 persistente
      shell: "ipadm show-prop -p _forward_src_routed -co persistent ipv6 2>/dev/null || echo 'error'"
      register: ipv6_forward_persistent
      changed_when: false
      ignore_errors: yes

    - name: CIS 3.5 - Auditoría - Mostrar estado actual
      debug:
        msg:
          - "┌─────────────────────────────────────────────────────────────────────────┐"
          - "│ AUDITORÍA PRE-REMEDIACIÓN - CIS 3.5                                     │"
          - "└─────────────────────────────────────────────────────────────────────────┘"
          - ""
          - "  IPv4 actual:      {{ ipv4_forward_current.stdout }}"
          - "  IPv4 persistente: {{ ipv4_forward_persistent.stdout }}"
          - "  IPv6 actual:      {{ ipv6_forward_current.stdout }}"
          - "  IPv6 persistente: {{ ipv6_forward_persistent.stdout }}"
          - "  Valor esperado:   0 (deshabilitado)"
          - ""

    - name: CIS 3.5 - Auditoría - Registrar estado inicial
      lineinfile:
        path: "{{ audit_log }}"
        line: "[{{ ansible_date_time.iso8601 }}] CIS 3.5 - Estado PRE: ipv4_current={{ ipv4_forward_current.stdout }}, ipv6_current={{ ipv6_forward_current.stdout }}"
        create: yes

    - name: CIS 3.5 - Remediación - Deshabilitar source routing para IPv4
      shell: "ipadm set-prop -p _forward_src_routed=0 ipv4"
      register: ipv4_forward_result
      when: ipv4_forward_current.stdout != "0" or ipv4_forward_persistent.stdout != "0"
      ignore_errors: yes

    - name: CIS 3.5 - Remediación - Deshabilitar source routing para IPv6
      shell: "ipadm set-prop -p _forward_src_routed=0 ipv6"
      register: ipv6_forward_result
      when: ipv6_forward_current.stdout != "0" or ipv6_forward_persistent.stdout != "0"
      ignore_errors: yes

    - name: CIS 3.5 - Remediación - Notificación de cambio
      debug:
        msg:
          - "┌─────────────────────────────────────────────────────────────────────────┐"
          - "│ REMEDIACIÓN EJECUTADA - CIS 3.5                                          │"
          - "└─────────────────────────────────────────────────────────────────────────┘"
          - ""
          - "   Source routing deshabilitado para IPv4 e IPv6"
          - "   Protección contra ataques de spoofing mejorada"
          - ""
      when: 
        - (ipv4_forward_result is defined and ipv4_forward_result.rc is defined and ipv4_forward_result.rc == 0) or
          (ipv6_forward_result is defined and ipv6_forward_result.rc is defined and ipv6_forward_result.rc == 0)

    - name: CIS 3.5 - Validación - Verificar configuración final IPv4
      shell: "ipadm show-prop -p _forward_src_routed -co current ipv4 && ipadm show-prop -p _forward_src_routed -co persistent ipv4"
      register: ipv4_forward_after
      changed_when: false
      ignore_errors: yes

    - name: CIS 3.5 - Validación - Verificar configuración final IPv6
      shell: "ipadm show-prop -p _forward_src_routed -co current ipv6 && ipadm show-prop -p _forward_src_routed -co persistent ipv6"
      register: ipv6_forward_after
      changed_when: false
      ignore_errors: yes

    - name: CIS 3.5 - Validación - Registrar estado final
      lineinfile:
        path: "{{ audit_log }}"
        line: "[{{ ansible_date_time.iso8601 }}] CIS 3.5 - Estado POST: CONFORME (IPv4 y IPv6)"
        create: yes
    
    - name: Inicio de remediacion CIS 3.6
      debug:
        msg:
          - ""
          - "╔═══════════════════════════════════════════════════════════════════════════╗"
          - "║                                                                           ║"          
          - "║         Control 3.6: Deshabilitar Reenvío Directed Broadcast             ║"
          - "║                                                                           ║"
          - "╚═══════════════════════════════════════════════════════════════════════════╝"
          - ""

    - name: CIS 3.6 - Auditoría - Verificar configuración actual
      shell: "ipadm show-prop -p _forward_directed_broadcasts -co current ip 2>/dev/null || echo 'error'"
      register: directed_broadcast_current
      changed_when: false
      ignore_errors: yes

    - name: CIS 3.6 - Auditoría - Verificar configuración persistente
      shell: "ipadm show-prop -p _forward_directed_broadcasts -co persistent ip 2>/dev/null || echo 'error'"
      register: directed_broadcast_persistent
      changed_when: false
      ignore_errors: yes

    - name: CIS 3.6 - Auditoría - Registrar estado inicial
      lineinfile:
        path: "{{ audit_log }}"
        line: "[{{ ansible_date_time.iso8601 }}] CIS 3.6 - Estado PRE: current={{ directed_broadcast_current.stdout }}, persistent={{ directed_broadcast_persistent.stdout }}"
        create: yes

    - name: CIS 3.6 - Remediación - Deshabilitar directed broadcast forwarding
      shell: "ipadm set-prop -p _forward_directed_broadcasts=0 ip"
      register: directed_broadcast_result
      when: directed_broadcast_current.stdout != "0" or directed_broadcast_persistent.stdout != "0"
      ignore_errors: yes

    - name: CIS 3.6 - Remediación - Notificación de cambio
      debug:
        msg:
          - "┌─────────────────────────────────────────────────────────────────────────┐"
          - "│ REMEDIACIÓN EJECUTADA - CIS 3.6                                          │"
          - "└─────────────────────────────────────────────────────────────────────────┘"
          - ""
          - "   Directed broadcast forwarding deshabilitado"
          - "   Protección contra ataques DoS mejorada"
          - ""
      when:
        - directed_broadcast_result is defined
        - directed_broadcast_result.rc is defined
        - directed_broadcast_result.rc == 0

    - name: CIS 3.6 - Validación - Registrar estado final
      lineinfile:
        path: "{{ audit_log }}"
        line: "[{{ ansible_date_time.iso8601 }}] CIS 3.6 - Estado POST: CONFORME"
        create: yes


    - name: Inicio de Remediación CIS 3.7
      debug:
        msg:
          - ""
          - "╔═══════════════════════════════════════════════════════════════════════════╗"
          - "║                                                                           ║"          
          - "║         Control 3.7: Habilitar Protección de Stack                       ║"
          - "║                                                                           ║"
          - "╚═══════════════════════════════════════════════════════════════════════════╝"
          - ""

    - name: CIS 3.7 - Auditoría - Verificar estado actual de protección de stack
      shell: "sxadm status -po extension,status,configuration nxheap,nxstack 2>/dev/null || echo 'error'"
      register: stack_protection_before
      changed_when: false
      ignore_errors: yes

    - name: CIS 3.7 - Auditoría - Mostrar estado actual
      debug:
        msg:
          - "┌─────────────────────────────────────────────────────────────────────────┐"
          - "│ AUDITORÍA PRE-REMEDIACIÓN - CIS 3.7                                     │"
          - "└─────────────────────────────────────────────────────────────────────────┘"
          - ""
          - "  Estado actual de protección de stack:"
          - "  {{ stack_protection_before.stdout_lines | default(['No disponible']) | join('\n  ') }}"
          - ""
          - "  Estado esperado:"
          - "  nxheap:enabled.tagged-files:default.default"
          - "  nxstack:enabled.all:default.default"
          - ""

    - name: CIS 3.7 - Auditoría - Registrar estado inicial
      lineinfile:
        path: "{{ audit_log }}"
        line: "[{{ ansible_date_time.iso8601 }}] CIS 3.7 - Estado PRE: {{ stack_protection_before.stdout }}"
        create: yes

    - name: CIS 3.7 - Remediación - Eliminar customizaciones de nxheap
      shell: "sxadm delcust nxheap"
      register: nxheap_result
      when: stack_protection_before.stdout is defined and 'enabled' not in stack_protection_before.stdout
      ignore_errors: yes

    - name: CIS 3.7 - Remediación - Eliminar customizaciones de nxstack
      shell: "sxadm delcust nxstack"
      register: nxstack_result
      when: stack_protection_before.stdout is defined and 'enabled' not in stack_protection_before.stdout
      ignore_errors: yes

    - name: CIS 3.7 - Remediación - Notificación de cambio
      debug:
        msg:
          - "┌─────────────────────────────────────────────────────────────────────────┐"
          - "│ REMEDIACIÓN EJECUTADA - CIS 3.7                                          │"
          - "└─────────────────────────────────────────────────────────────────────────┘"
          - ""
          - "   Protección de stack (nxheap) habilitada"
          - "   Protección de stack (nxstack) habilitada"
          - "   Protección contra buffer overflow mejorada"
          - ""
      when: 
        - (nxheap_result is defined and nxheap_result.rc is defined and nxheap_result.rc == 0) or
          (nxstack_result is defined and nxstack_result.rc is defined and nxstack_result.rc == 0)

    - name: CIS 3.7 - Remediación - Configuración ya conforme
      debug:
        msg:
          - "┌─────────────────────────────────────────────────────────────────────────┐"
          - "│ ESTADO CONFORME - CIS 3.7                                                │"
          - "└─────────────────────────────────────────────────────────────────────────┘"
          - ""
          - "   La protección de stack ya estaba habilitada"
          - ""
      when: stack_protection_before.stdout is defined and 'enabled' in stack_protection_before.stdout

    - name: CIS 3.7 - Validación - Verificar estado final de protección de stack
      shell: "sxadm status -po extension,status,configuration nxheap,nxstack"
      register: stack_protection_after
      changed_when: false
      ignore_errors: yes

    - name: CIS 3.7 - Validación - Confirmar configuración
      assert:
        that:
          - "'enabled' in stack_protection_after.stdout"
          - "'nxheap' in stack_protection_after.stdout"
          - "'nxstack' in stack_protection_after.stdout"
        fail_msg: "ERROR: La protección de stack no está correctamente habilitada"
        success_msg: " Validación exitosa: Protección de stack habilitada (nxheap y nxstack)"

    - name: CIS 3.7 - Validación - Registrar estado final
      lineinfile:
        path: "{{ audit_log }}"
        line: "[{{ ansible_date_time.iso8601 }}] CIS 3.7 - Estado POST: {{ stack_protection_after.stdout }} - CONFORME"
        create: yes

    - name: Inicio de Remediación CIS 3.8
      debug:
        msg:
          - ""
          - "╔═══════════════════════════════════════════════════════════════════════════╗"
          - "║ Control 3.8: Restrict Core Dumps to Protected Directory                   ║"
          - "╚═══════════════════════════════════════════════════════════════════════════╝"


    - name: CIS 3.8 - Auditoría - Verificar directorio de core dumps
      shell: "ls -ld /var/share/cores 2>/dev/null || echo 'not_exists'"
      register: core_dir_status
      changed_when: false


    - name: CIS 3.8 - Remediación - Crear directorio si no existe
      shell: "mkdir -p /var/share/cores"
      when: core_dir_status.stdout == "not_exists"


    - name: CIS 3.8 - Remediación - Ajustar permisos del directorio
      shell: "chmod 700 /var/share/cores"


    - name: CIS 3.8 - Remediación - Configurar coreadm
      shell: >
      coreadm -g /var/share/cores/core_%n_%f_%u_%g_%t_%p
      -e log -e global -e global-setid
      -d process -d proc-setid
      ignore_errors: yes


    - name: CIS 3.8 - Validación - Registrar estado final
      lineinfile:
      path: "{{ audit_log }}"
      line: "[{{ ansible_date_time.iso8601 }}] CIS 3.8 - Core dumps restringidos a /var/share/cores - CONFORME"
      create: yes


    - name: Inicio de Remediación CIS 3.9
      debug:
        msg:
          - ""
          - "╔═══════════════════════════════════════════════════════════════════════════╗"
          - "║ Control 3.9: Disable ICMP Timestamp Responses                             ║"
          - "╚═══════════════════════════════════════════════════════════════════════════╝"


    - name: CIS 3.9 - Remediación
        shell: "ipadm set-prop -p _respond_to_timestamp=0 ip"


    - name: CIS 3.9 - Validación
      shell: "ipadm show-prop -p _respond_to_timestamp -co persistent ip"
      register: timestamp_status
      changed_when: false


    - name: CIS 3.9 - Assert
      assert:
        that:
          - timestamp_status.stdout == "0"
        success_msg: " ICMP timestamp deshabilitado"
        fail_msg: "✗ ICMP timestamp sigue habilitado"

    - name: Inicio de Remediación CIS 3.10
      debug:
        msg:
          - ""
          - "╔═══════════════════════════════════════════════════════════════════════════╗"
          - "║ Control 3.10: Disable Multicast Echo Requests                             ║"
          - "╚═══════════════════════════════════════════════════════════════════════════╝"


    - name: CIS 3.10 - Remediación IPv4
      shell: "ipadm set-prop -p _respond_to_echo_multicast=0 ipv4"


    - name: CIS 3.10 - Remediación IPv6
      shell: "ipadm set-prop -p _respond_to_echo_multicast=0 ipv6"


    - name: CIS 3.10 - Registro
      lineinfile:
        path: "{{ audit_log }}"
        line: "[{{ ansible_date_time.iso8601 }}] CIS 3.10 - Multicast echo IPv4/IPv6 deshabilitado - CONFORME"
        create: yes

    - name: Inicio de Remediación CIS 3.11
      debug:
        msg:
          - ""
          - "╔═══════════════════════════════════════════════════════════════════════════╗"
          - "║ Control 3.11: Ignore ICMP Redirect Messages                               ║"
          - "╚═══════════════════════════════════════════════════════════════════════════╝"


    - name: CIS 3.11 - Remediación IPv4
      shell: "ipadm set-prop -p _ignore_redirect=1 ipv4"


    - name: CIS 3.11 - Remediación IPv6
      shell: "ipadm set-prop -p _ignore_redirect=1 ipv6"

    - name: Inicio de Remediación CIS 3.12
      debug:
        msg:
          - ""
          - "╔═══════════════════════════════════════════════════════════════════════════╗"
          - "║ Control 3.12: Set Strict Multihoming                                      ║"
          - "╚═══════════════════════════════════════════════════════════════════════════╝"


    - name: CIS 3.12 - Remediación IPv4
      shell: "ipadm set-prop -p _strict_dst_multihoming=1 ipv4"


    - name: CIS 3.12 - Remediación IPv6
      shell: "ipadm set-prop -p _strict_dst_multihoming=1 ipv6"

    - name: Inicio de Remediación CIS 3.13
      debug:
        msg:
          - ""
          - "╔═══════════════════════════════════════════════════════════════════════════╗"
          - "║ Control 3.13: Disable Sending ICMP Redirect Messages                      ║"
          - "╚═══════════════════════════════════════════════════════════════════════════╝"


   - name: CIS 3.13 - Remediación IPv4
     shell: "ipadm set-prop -p send_redirects=off ipv4"


   - name: CIS 3.13 - Remediación IPv6
     shell: "ipadm set-prop -p send_redirects=off ipv6"


   - name: CIS 3.13 - Registro final
     lineinfile:
       path: "{{ audit_log }}"
       line: "[{{ ansible_date_time.iso8601 }}] CIS 3.13 - ICMP redirects deshabilitados IPv4/IPv6 - CONFORME"
       create: yes

    - name: Inicio de Remediación CIS 3.14
      debug:
        msg:
          - ""
          - "╔═══════════════════════════════════════════════════════════════════════════╗"
          - "║ Control 3.14: Disable TCP Reverse IP Source Routing                       ║"
          - "╚═══════════════════════════════════════════════════════════════════════════╝"


    - name: CIS 3.14 - Deshabilitar TCP Reverse IP Source Routing
      shell: "ipadm set-prop -p _rev_src_routes=0 tcp"


    - name: CIS 3.14 - Registro final
      lineinfile:
        path: "{{ audit_log }}"
        line: "[{{ ansible_date_time.iso8601 }}] CIS 3.14 - TCP Reverse IP Source Routing deshabilitado - CONFORME"
        create: yes
    
    - name: Inicio de Remediación CIS 3.15
      debug:
        msg:
          - ""
          - "╔═══════════════════════════════════════════════════════════════════════════╗"
          - "║ Control 3.15: Set Max Half-open TCP Connections (4096)                    ║"
          - "╚═══════════════════════════════════════════════════════════════════════════╝"


    - name: CIS 3.15 - Configurar máximo de conexiones TCP semiabiertas
      shell: "ipadm set-prop -p _conn_req_max_q0=4096 tcp"


    - name: CIS 3.15 - Registro final
      lineinfile:
        path: "{{ audit_log }}"
        line: "[{{ ansible_date_time.iso8601 }}] CIS 3.15 - Máx conexiones TCP semiabiertas configuradas (4096) - CONFORME"
        create: yes

    - name: Inicio de Remediación CIS 3.16
      debug:
        msg:
          - ""
          - "╔═══════════════════════════════════════════════════════════════════════════╗"
          - "║ Control 3.16: Set Max Incoming TCP Connections (1024)                     ║"
          - "╚═══════════════════════════════════════════════════════════════════════════╝"


    - name: CIS 3.16 - Configurar máximo de conexiones TCP entrantes
      shell: "ipadm set-prop -p _conn_req_max_q=1024 tcp"


    - name: CIS 3.16 - Registro final
      lineinfile:
        path: "{{ audit_log }}"
        line: "[{{ ansible_date_time.iso8601 }}] CIS 3.16 - Máx conexiones TCP entrantes configuradas (1024) - CONFORME"
        create: yes

    - name: Inicio de Remediación CIS 3.17
      debug:
       msg:
         - ""
         - "╔═══════════════════════════════════════════════════════════════════════════╗"
         - "║        Control 3.17: Disable Network Routing IPv4 / IPv6                 ║"
         - "╚═══════════════════════════════════════════════════════════════════════════╝"

    - name: CIS 3.17 - Deshabilitar routing IPv4
      shell: "routeadm -d ipv4-forwarding -d ipv4-routing"

    - name: CIS 3.17 - Deshabilitar routing IPv6
      shell: "routeadm -d ipv6-forwarding -d ipv6-routing"

    - name: CIS 3.17 - Aplicar cambios al sistema
      shell: "routeadm -u"

    - name: CIS 3.17 - Registro final
      lineinfile:
        path: "{{ audit_log }}"
        line: "[{{ ansible_date_time.iso8601 }}] CIS 3.17 - Network routing IPv4/IPv6 deshabilitado - CONFORME"
        create: yes

    - name: Inicio de Remediación CIS 4.1
      debug:
        msg:
          - ""
          - "╔═══════════════════════════════════════════════════════════════════════════╗"
          - "║ Control 4.1: Create CIS Audit Class                                       ║"
          - "╚═══════════════════════════════════════════════════════════════════════════╝"


    - name: CIS 4.1 - Crear clase de auditoría CIS
      lineinfile:
        path: /etc/security/audit_class
        line: "0x0100000000000000:cis:CIS Solaris Benchmark"
        insertbefore: EOF
        state: present


    - name: CIS 4.1 - Registro final
      lineinfile:
        path: "{{ audit_log }}"
        line: "[{{ ansible_date_time.iso8601 }}] CIS 4.1 - Clase de auditoría CIS creada - CONFORME"
        create: yes

    - name: Inicio de Remediación CIS 4.2
      debug:
        msg:
          - ""
          - "╔═══════════════════════════════════════════════════════════════════════════╗"
          - "║ Control 4.2: Audit Incoming Network Connections                           ║"
          - "╚═══════════════════════════════════════════════════════════════════════════╝"


    - name: CIS 4.2 - Asignar eventos de red a clase CIS
      shell: |
        awk 'BEGIN{FS=":"; OFS=":"}
        {if ($2 ~ /AUE_ACCEPT|AUE_CONNECT|AUE_SOCKACCEPT|AUE_SOCKCONNECT|AUE_inetd_connect/)
        $4=$4",cis";} {print}' /etc/security/audit_event > /etc/security/audit_event.CIS
        && cp /etc/security/audit_event.CIS /etc/security/audit_event


    - name: CIS 4.2 - Registro final
      lineinfile:
        path: "{{ audit_log }}"
        line: "[{{ ansible_date_time.iso8601 }}] CIS 4.2 - Auditoría de conexiones entrantes habilitada - CONFORME"
        create: yes

    - name: Inicio de Remediación CIS 4.3
      debug:
        msg:
          - ""
          - "╔═══════════════════════════════════════════════════════════════════════════╗"
          - "║ Control 4.3: Audit File Metadata Modifications                            ║"
          - "╚═══════════════════════════════════════════════════════════════════════════╝"
    
    - name: CIS 4.3 - Asignar  eventos de metada a la clase CIS
      shell: | 
        awk 'BEGIN{FS=":"; OFS=":"}
        {if ($2 ~ /AUE_CHMOD|AUE_CHOWN|AUE_FCHOWN|AUE_FCHMOD|AUE_LCHOWN|AUE_ACLSET|AUE_FACLSET/)
        $4=$4",cis";} {print}' /etc/security/audit_event > /etc/security/audit_event.CIS
        && cp /etc/security/audit_event.CIS /etc/security/audit_event
    
    - name: CIS 4.3 - Registro final
      lineinfile:
        path: "{{ audit_log }}"
        line: "[{{ ansible_date_time.iso8601 }}] CIS 4.3 - Auditoría de metadata de archivos habilitada - CONFORME"
        create: yes


    - name: Inicio de Remediación CIS 4.4
      debug:
        msg:
          - ""
          - "╔═══════════════════════════════════════════════════════════════════════════╗"
          - "║ Control 4.4: Audit Process and Privilege Events                           ║"
          - "╚═══════════════════════════════════════════════════════════════════════════╝"


    - name: CIS 4.4 - Asignar eventos de privilegios a clase CIS
      shell: |
        awk 'BEGIN{FS=":"; OFS=":"}
        {if ($2 ~ /AUE_CHROOT|AUE_SETREUID|AUE_SETREGID|AUE_FCHROOT|AUE_PFEXEC|AUE_SETUID|AUE_NICE|AUE_SETGID|AUE_PRIOCNTLSYS|AUE_SETEGID|AUE_SETEUID|AUE_SETPPRIV|AUE_SETSID|AUE_SETPGID/)
        $4=$4",cis";} {print}' /etc/security/audit_event > /etc/security/audit_event.CIS
        && cp /etc/security/audit_event.CIS /etc/security/audit_event


    - name: CIS 4.4 - Registro final
      lineinfile:
        path: "{{ audit_log }}"
        line: "[{{ ansible_date_time.iso8601 }}] CIS 4.4 - Auditoría de procesos y privilegios habilitada - CONFORME"
        create: yes
    
    - name: Inicio de Remediación CIS 4.5
      debug:
        msg:
          - ""
          - "╔═══════════════════════════════════════════════════════════════════════════╗"
          - "║ Control 4.5: Configure Solaris Auditing                                   ║"
          - "╚═══════════════════════════════════════════════════════════════════════════╝"


    - name: CIS 4.5 - Configurar auditoría Solaris
      shell: |
        auditconfig -conf
        auditconfig -setflags lo,ad,ft,ex,cis
        auditconfig -setnaflags lo
        auditconfig -setpolicy cnt,argv,zonename
        auditconfig -setplugin audit_binfile active p_minfree=1
        audit -s
        rolemod -K audit_flags=lo,ad,ft,ex,cis:no root
        chown root:root /var/share/audit
        chmod 750 /var/share/audit


    - name: CIS 4.5 - Rotación diaria de auditoría
      cron:
        name: "Rotate audit logs daily"
        user: root
        minute: "0"
        hour: "0"
        job: "/usr/sbin/audit -n"


    - name: CIS 4.5 - Registro final
      lineinfile:
        path: "{{ audit_log }}"
        line: "[{{ ansible_date_time.iso8601 }}] CIS 4.5 - Auditoría Solaris configurada completamente - CONFORME"
        create: yes
    
     - name: Inicio de Remediación CIS 5.1
       debug:
        msg:
          - ""
          - "╔═══════════════════════════════════════════════════════════════════════════╗"
          - "║ Control 4.5: Set Sticky Bit on World Writable Directories                 ║"
          - "╚═══════════════════════════════════════════════════════════════════════════╝"

    - name: CIS 5.1 - Buscar directorios world-writable sin stky Bit
      shell: | 
        find / \( -fstype nfs -o -fstype cachefs -o -fstype autofs -o -fstype ctfs \
        -o -fstype mntfs -o -fstype objfs -o -fstype proc \) -prune -o \
        -type d -perm -0002 ! -perm -1000 -print
      register: cis_51_dirs
      changed_when: false

    - name: CIS 5.1 - Registo final
      lineinfile:
        path: "{{ audit_log }}"
        line: "[{{ ansible_date_time.iso8601 }}] CIS 5.1 - Sticky bit aplicado a directorios world-writable - CONFORME"
        create: yes

   - name: Inicio de Remediación CIS 5.1
     debug:
        msg:
          - ""
          - "╔═══════════════════════════════════════════════════════════════════════════╗"
          - "║ Control 6.1: Disable Login on Serial Ports                                ║"
          - "╚═══════════════════════════════════════════════════════════════════════════╝"

   - name: CIS 6.1 - desahabilitar login en tema 
     shell: "svcadm disable svc:/system/console-login:terma"
     ignore_errors: true 
   
   - name: CIS 6.1 - desahabilitar login en termb 
     shell: "svcadm disable svc:/system/console-login:termb"
     ignore_errors: true

   
   - name: CIS 6.1 - Registro final
     lineinfile:
       path: "{{ audit_log }}"
       line: "[{{ ansible_date_time.iso8601 }}] CIS 6.1 - Login por puertos seriales deshabilitado - CONFORME"
       create: yes

    - name: Inicio de Remediación CIS 6.3
      debug:
        msg:
          - ""
          - "╔═══════════════════════════════════════════════════════════════════════════╗"
          - "║ Control 6.3: Restrict at/cron to Authorized Users ║"
          - "╚═══════════════════════════════════════════════════════════════════════════╝"


      - name: CIS 6.3 - Respaldar archivos deny si existen
        shell: |
          [ -f /etc/cron.deny ] && mv /etc/cron.deny /etc/cron.deny.cis || true
          [ -f /etc/at.deny ] && mv /etc/at.deny /etc/at.deny.cis || true


    - name: CIS 6.3 - Configurar cron.allow solo para root
      copy:
      dest: /etc/cron.allow
      content: "root\n"
      owner: root
      group: root
      mode: "0400"


    - name: CIS 6.3 - Configurar at.allow vacío
      file:
      path: /etc/at.allow
      state: touch
      owner: root
      group: root
      mode: "0400"


    - name: CIS 6.3 - Registro final
      lineinfile:
        path: "{{ audit_log }}"
        line: "[{{ ansible_date_time.iso8601 }}] CIS 6.3 - Acceso a at/cron restringido a usuarios autorizados - CONFORME"
        create: yes
    
    
    - name: Inicio de Remediación CIS 6.6
      debug:
        msg:
          - ""
          - "╔═══════════════════════════════════════════════════════════════════════════╗"
          - "║ Control 6.6: Configurar Delay entre Intentos de Login Fallido ║"
          - "╚═══════════════════════════════════════════════════════════════════════════╝"
  
  

    - name: CIS 6.6 - Auditoría - Verificar SLEEPTIME actual
      shell: "grep '^SLEEPTIME=' /etc/default/login 2>/dev/null || echo 'not_found'"
      register: sleeptime_before
      changed_when: false
      ignore_errors: yes

    - name: CIS 6.6 - Auditoría - Mostrar estado actual
      debug:
        msg:
          - "┌─────────────────────────────────────────────────────────────────────────┐"
          - "│ AUDITORÍA PRE-REMEDIACIÓN - CIS 6.6                                     │"
          - "└─────────────────────────────────────────────────────────────────────────┘"
          - ""
          - "  Configuración actual: {{ sleeptime_before.stdout }}"
          - "  Valor esperado:       SLEEPTIME=4"
          - "  Nota: Si está comentado, el valor por defecto es 4 (conforme)"
          - ""

    - name: CIS 6.6 - Auditoría - Registrar estado inicial
      lineinfile:
        path: "{{ audit_log }}"
        line: "[{{ ansible_date_time.iso8601 }}] CIS 6.6 - Estado PRE: {{ sleeptime_before.stdout }}"
        create: yes

    - name: CIS 6.6 - Remediación - Crear backup del archivo login
      copy:
        src: /etc/default/login
        dest: /etc/default/login.backup.{{ ansible_date_time.epoch }}
        remote_src: yes
      when: sleeptime_before.stdout != "SLEEPTIME=4"
      ignore_errors: yes

    - name: CIS 6.6 - Remediación - Configurar SLEEPTIME=4
      shell: |
        cd /etc/default
        awk '/SLEEPTIME=/ { $1 = "SLEEPTIME=4" } { print }' login > login.CIS
        mv login.CIS login
      register: sleeptime_result
      when: sleeptime_before.stdout != "SLEEPTIME=4" and sleeptime_before.stdout != "not_found"
      ignore_errors: yes

    - name: CIS 6.6 - Remediación - Notificación de cambio
      debug:
        msg:
          - "┌─────────────────────────────────────────────────────────────────────────┐"
          - "│ REMEDIACIÓN EJECUTADA - CIS 6.6                                          │"
          - "└─────────────────────────────────────────────────────────────────────────┘"
          - ""
          - "   SLEEPTIME configurado a 4 segundos"
          - "   Protección contra ataques de fuerza bruta mejorada"
          - "   Delay entre intentos de login fallidos establecido"
          - ""
      when:
        - sleeptime_result is defined
        - sleeptime_result.rc is defined
        - sleeptime_result.rc == 0

    - name: CIS 6.6 - Remediación - Configuración ya conforme
      debug:
        msg:
          - "┌─────────────────────────────────────────────────────────────────────────┐"
          - "│ ESTADO CONFORME - CIS 6.6                                                │"
          - "└─────────────────────────────────────────────────────────────────────────┘"
          - ""
          - "   SLEEPTIME ya está configurado correctamente (4 segundos)"
          - ""
      when: sleeptime_before.stdout == "SLEEPTIME=4"

    - name: CIS 6.6 - Remediación - Valor por defecto (comentado)
      debug:
        msg:
          - "┌─────────────────────────────────────────────────────────────────────────┐"
          - "│ ESTADO CONFORME - CIS 6.6                                                │"
          - "└─────────────────────────────────────────────────────────────────────────┘"
          - ""
          - "   SLEEPTIME no está definido (usa valor por defecto: 4 segundos)"
          - "   Estado conforme con CIS Benchmark"
          - ""
      when: sleeptime_before.stdout == "not_found"

    - name: CIS 6.6 - Validación - Verificar configuración final
      shell: "grep '^SLEEPTIME=' /etc/default/login || echo 'default_4'"
      register: sleeptime_after
      changed_when: false
      ignore_errors: yes

    - name: CIS 6.6 - Validación - Confirmar configuración
      assert:
        that:
          - sleeptime_after.stdout == "SLEEPTIME=4" or sleeptime_after.stdout == "default_4"
        fail_msg: "ERROR: SLEEPTIME no está correctamente configurado"
        success_msg: " Validación exitosa: SLEEPTIME configurado a 4 segundos"

    - name: CIS 6.6 - Validación - Registrar estado final
      lineinfile:
        path: "{{ audit_log }}"
        line: "[{{ ansible_date_time.iso8601 }}] CIS 6.6 - Estado POST: {{ sleeptime_after.stdout }} - CONFORME"
        create: yes

    - name: Inicio de Remediación CIS 6.7
      debug:
        msg:
          - ""
          - "╔═══════════════════════════════════════════════════════════════════════════╗"
          - "║                                                                           ║"          
          - "║         Control 6.7: Deshabilitar Autenticación Rhost para SSH           ║"
          - "║                                                                           ║"
          - "╚═══════════════════════════════════════════════════════════════════════════╝"
          - ""

    - name: CIS 6.7 - Auditoría - Verificar IgnoreRhosts actual
      shell: "grep '^IgnoreRhosts' /etc/ssh/sshd_config 2>/dev/null || echo 'not_found'"
      register: ignorerhosts_before
      changed_when: false
      ignore_errors: yes

    - name: CIS 6.7 - Auditoría - Mostrar estado actual
      debug:
        msg:
          - "┌─────────────────────────────────────────────────────────────────────────┐"
          - "│ AUDITORÍA PRE-REMEDIACIÓN - CIS 6.7                                     │"
          - "└─────────────────────────────────────────────────────────────────────────┘"
          - ""
          - "  Configuración actual: {{ ignorerhosts_before.stdout }}"
          - "  Valor esperado:       IgnoreRhosts yes"
          - "  Nota: Si no existe, el valor por defecto es 'yes' (conforme)"
          - ""

    - name: CIS 6.7 - Auditoría - Registrar estado inicial
      lineinfile:
        path: "{{ audit_log }}"
        line: "[{{ ansible_date_time.iso8601 }}] CIS 6.7 - Estado PRE: {{ ignorerhosts_before.stdout }}"
        create: yes

    - name: CIS 6.7 - Remediación - Crear backup de sshd_config
      copy:
        src: /etc/ssh/sshd_config
        dest: /etc/ssh/sshd_config.backup.{{ ansible_date_time.epoch }}
        remote_src: yes
      when: 
        - ignorerhosts_before.stdout != "not_found"
        - "'IgnoreRhosts yes' not in ignorerhosts_before.stdout"
      ignore_errors: yes

    - name: CIS 6.7 - Remediación - Configurar IgnoreRhosts yes
      shell: |
        awk '/^IgnoreRhosts/ { $2 = "yes" } { print }' /etc/ssh/sshd_config > /etc/ssh/sshd_config.CIS
        mv /etc/ssh/sshd_config.CIS /etc/ssh/sshd_config
      register: ignorerhosts_result
      when: 
        - ignorerhosts_before.stdout != "not_found"
        - "'IgnoreRhosts yes' not in ignorerhosts_before.stdout"
      ignore_errors: yes

    - name: CIS 6.7 - Remediación - Reiniciar servicio SSH
      shell: "svcadm restart svc:/network/ssh"
      when:
        - ignorerhosts_result is defined
        - ignorerhosts_result.changed
      ignore_errors: yes

    - name: CIS 6.7 - Remediación - Notificación de cambio
      debug:
        msg:
          - "┌─────────────────────────────────────────────────────────────────────────┐"
          - "│ REMEDIACIÓN EJECUTADA - CIS 6.7                                          │"
          - "└─────────────────────────────────────────────────────────────────────────┘"
          - ""
          - "   IgnoreRhosts configurado a 'yes'"
          - "   Autenticación basada en .rhosts/.shosts deshabilitada"
          - "   Servicio SSH reiniciado"
          - "   Se requiere autenticación por contraseña/clave SSH"
          - ""
      when:
        - ignorerhosts_result is defined
        - ignorerhosts_result.rc is defined
        - ignorerhosts_result.rc == 0

    - name: CIS 6.7 - Remediación - Configuración ya conforme (explícita)
      debug:
        msg:
          - "┌─────────────────────────────────────────────────────────────────────────┐"
          - "│ ESTADO CONFORME - CIS 6.7                                                │"
          - "└─────────────────────────────────────────────────────────────────────────┘"
          - ""
          - "   IgnoreRhosts ya está configurado correctamente (yes)"
          - ""
      when: 
        - ignorerhosts_before.stdout != "not_found"
        - "'IgnoreRhosts yes' in ignorerhosts_before.stdout"

    - name: CIS 6.7 - Remediación - Valor por defecto (no definido)
      debug:
        msg:
          - "┌─────────────────────────────────────────────────────────────────────────┐"
          - "│ ESTADO CONFORME - CIS 6.7                                                │"
          - "└─────────────────────────────────────────────────────────────────────────┘"
          - ""
          - "   IgnoreRhosts no está definido (usa valor por defecto: yes)"
          - "   Estado conforme con CIS Benchmark"
          - ""
      when: ignorerhosts_before.stdout == "not_found"

    - name: CIS 6.7 - Validación - Verificar configuración final
      shell: "grep '^IgnoreRhosts' /etc/ssh/sshd_config || echo 'default_yes'"
      register: ignorerhosts_after
      changed_when: false
      ignore_errors: yes

    - name: CIS 6.7 - Validación - Verificar servicio SSH activo
      shell: "svcs -Ho state svc:/network/ssh"
      register: ssh_service_status
      changed_when: false
      ignore_errors: yes

    - name: CIS 6.7 - Validación - Confirmar configuración
      assert:
        that:
          - ignorerhosts_after.stdout == "IgnoreRhosts yes" or ignorerhosts_after.stdout == "default_yes"
          - ssh_service_status.stdout == "online"
        fail_msg: "ERROR: IgnoreRhosts no está correctamente configurado o SSH no está activo"
        success_msg: " Validación exitosa: IgnoreRhosts=yes y SSH activo"

    - name: CIS 6.7 - Validación - Registrar estado final
      lineinfile:
        path: "{{ audit_log }}"
        line: "[{{ ansible_date_time.iso8601 }}] CIS 6.7 - Estado POST: {{ ignorerhosts_after.stdout }}, SSH: {{ ssh_service_status.stdout }} - CONFORME"
        create: yes

    - name: Inicio de Remediación CIS 6.9
      debug:
        msg:
          - ""
          - "╔═══════════════════════════════════════════════════════════════════════════╗"
          - "║                                                                           ║"          
          - "║         Control 6.9: Deshabilitar Root Login para SSH                    ║"
          - "║                                                                           ║"
          - "╚═══════════════════════════════════════════════════════════════════════════╝"
          - ""

    - name: CIS 6.9 - Auditoría - Verificar PermitRootLogin actual
      shell: "grep '^PermitRootLogin' /etc/ssh/sshd_config 2>/dev/null || echo 'not_found'"
      register: permitrootlogin_before
      changed_when: false
      ignore_errors: yes

    - name: CIS 6.9 - Auditoría - Mostrar estado actual
      debug:
        msg:
          - "┌─────────────────────────────────────────────────────────────────────────┐"
          - "│ AUDITORÍA PRE-REMEDIACIÓN - CIS 6.9                                     │"
          - "└─────────────────────────────────────────────────────────────────────────┘"
          - ""
          - "  Configuración actual: {{ permitrootlogin_before.stdout }}"
          - "  Valor esperado:       PermitRootLogin no"
          - ""

    - name: CIS 6.9 - Auditoría - Registrar estado inicial
      lineinfile:
        path: "{{ audit_log }}"
        line: "[{{ ansible_date_time.iso8601 }}] CIS 6.9 - Estado PRE: {{ permitrootlogin_before.stdout }}"
        create: yes

    - name: CIS 6.9 - Remediación - Crear backup de sshd_config
      copy:
        src: /etc/ssh/sshd_config
        dest: /etc/ssh/sshd_config.backup.69.{{ ansible_date_time.epoch }}
        remote_src: yes
      when: 
        - permitrootlogin_before.stdout != "not_found"
        - "'PermitRootLogin no' not in permitrootlogin_before.stdout"
      ignore_errors: yes

    - name: CIS 6.9 - Remediación - Configurar PermitRootLogin no
      shell: |
        awk '/^PermitRootLogin/ { $2 = "no" } { print }' /etc/ssh/sshd_config > /etc/ssh/sshd_config.CIS
        mv /etc/ssh/sshd_config.CIS /etc/ssh/sshd_config
      register: permitrootlogin_result
      when: 
        - permitrootlogin_before.stdout != "not_found"
        - "'PermitRootLogin no' not in permitrootlogin_before.stdout"
      ignore_errors: yes

    - name: CIS 6.9 - Remediación - Reiniciar servicio SSH
      shell: "svcadm restart svc:/network/ssh"
      when:
        - permitrootlogin_result is defined
        - permitrootlogin_result.changed
      ignore_errors: yes

    - name: CIS 6.9 - Remediación - Notificación de cambio
      debug:
        msg:
          - "┌─────────────────────────────────────────────────────────────────────────┐"
          - "│ REMEDIACIÓN EJECUTADA - CIS 6.9                                          │"
          - "└─────────────────────────────────────────────────────────────────────────┘"
          - ""
          - "   PermitRootLogin configurado a 'no'"
          - "   Login directo de root via SSH deshabilitado"
          - "   Servicio SSH reiniciado"
          - "   Acceso root solo mediante su/sudo desde usuarios normales"
          - ""
      when:
        - permitrootlogin_result is defined
        - permitrootlogin_result.rc is defined
        - permitrootlogin_result.rc == 0

    - name: CIS 6.9 - Validación - Verificar configuración final
      shell: "grep '^PermitRootLogin' /etc/ssh/sshd_config"
      register: permitrootlogin_after
      changed_when: false
      ignore_errors: yes

    - name: CIS 6.9 - Validación - Confirmar configuración
      assert:
        that:
          - "'PermitRootLogin no' in permitrootlogin_after.stdout"
        fail_msg: "ERROR: PermitRootLogin no está correctamente configurado"
        success_msg: " Validación exitosa: PermitRootLogin no"

    - name: CIS 6.9 - Validación - Registrar estado final
      lineinfile:
        path: "{{ audit_log }}"
        line: "[{{ ansible_date_time.iso8601 }}] CIS 6.9 - Estado POST: {{ permitrootlogin_after.stdout }} - CONFORME"
        create: yes



    - name:  Inicio de Remediación CIS 6.10
      debug:
        msg:
          - ""
          - "╔═══════════════════════════════════════════════════════════════════════════╗"
          - "║                                                                           ║"          
          - "║         Control 6.10: Deshabilitar Autenticación Host-based              ║"
          - "║                                                                           ║"
          - "╚═══════════════════════════════════════════════════════════════════════════╝"
          - ""

    - name: CIS 6.10 - Auditoría - Verificar pam_rhosts_auth en /etc/pam.conf
      shell: "grep 'pam_rhosts_auth' /etc/pam.conf 2>/dev/null | grep -v '^#' || echo 'none'"
      register: pam_rhosts_conf
      changed_when: false
      ignore_errors: yes

    - name: CIS 6.10 - Auditoría - Verificar pam_rhosts_auth en /etc/pam.d/
      shell: "grep 'pam_rhosts_auth' /etc/pam.d/* 2>/dev/null | grep -v '^#' || echo 'none'"
      register: pam_rhosts_pamd
      changed_when: false
      ignore_errors: yes

    - name: CIS 6.10 - Auditoría - Mostrar estado actual
      debug:
        msg:
          - "┌─────────────────────────────────────────────────────────────────────────┐"
          - "│ AUDITORÍA PRE-REMEDIACIÓN - CIS 6.10                                    │"
          - "└─────────────────────────────────────────────────────────────────────────┘"
          - ""
          - "  Líneas activas en /etc/pam.conf:  {{ pam_rhosts_conf.stdout }}"
          - "  Líneas activas en /etc/pam.d/*:   {{ pam_rhosts_pamd.stdout }}"
          - "  Estado esperado: Todas las líneas comentadas o eliminadas"
          - ""

    - name: CIS 6.10 - Auditoría - Registrar estado inicial
      lineinfile:
        path: "{{ audit_log }}"
        line: "[{{ ansible_date_time.iso8601 }}] CIS 6.10 - Estado PRE: pam.conf={{ pam_rhosts_conf.stdout }}, pam.d={{ pam_rhosts_pamd.stdout }}"
        create: yes

    - name: CIS 6.10 - Remediación - Comentar líneas pam_rhosts_auth en /etc/pam.conf
      shell: |
        if [ -f /etc/pam.conf ]; then
          cp /etc/pam.conf /etc/pam.conf.backup.{{ ansible_date_time.epoch }}
          sed -i 's/^\([^#].*pam_rhosts_auth.*\)/#\1/' /etc/pam.conf
        fi
      register: pam_conf_result
      when: pam_rhosts_conf.stdout != "none"
      ignore_errors: yes

    - name: CIS 6.10 - Remediación - Buscar y comentar en archivos /etc/pam.d/
      shell: |
        for file in /etc/pam.d/*; do
          if [ -f "$file" ] && grep -q '^[^#].*pam_rhosts_auth' "$file" 2>/dev/null; then
            cp "$file" "$file.backup.{{ ansible_date_time.epoch }}"
            sed -i 's/^\([^#].*pam_rhosts_auth.*\)/#\1/' "$file"
          fi
        done
      register: pam_pamd_result
      when: pam_rhosts_pamd.stdout != "none"
      ignore_errors: yes

    - name: CIS 6.10 - Remediación - Notificación de cambio
      debug:
        msg:
          - "┌─────────────────────────────────────────────────────────────────────────┐"
          - "│ REMEDIACIÓN EJECUTADA - CIS 6.10                                         │"
          - "└─────────────────────────────────────────────────────────────────────────┘"
          - ""
          - "   Líneas pam_rhosts_auth comentadas"
          - "   Autenticación basada en .rhosts deshabilitada"
          - "   Archivos de configuración respaldados"
          - ""
      when: pam_conf_result is defined or pam_pamd_result is defined

    - name: CIS 6.10 - Remediación - Ya conforme
      debug:
        msg:
          - "┌─────────────────────────────────────────────────────────────────────────┐"
          - "│ ESTADO CONFORME - CIS 6.10                                               │"
          - "└─────────────────────────────────────────────────────────────────────────┘"
          - ""
          - "   No se encontraron líneas pam_rhosts_auth activas"
          - ""
      when: pam_rhosts_conf.stdout == "none" and pam_rhosts_pamd.stdout == "none"

    - name: CIS 6.10 - Validación - Registrar estado final
      lineinfile:
        path: "{{ audit_log }}"
        line: "[{{ ansible_date_time.iso8601 }}] CIS 6.10 - Estado POST: CONFORME - pam_rhosts_auth deshabilitado"
        create: yes

    - name: Inicio de Remediación CIS 6.12
      debug:
        msg:
          - ""
          - "╔═══════════════════════════════════════════════════════════════════════════╗"
          - "║                                                                           ║"          
          - "║         Control 6.12: Limitar Intentos Consecutivos de Login SSH         ║"
          - "║                                                                           ║"
          - "╚═══════════════════════════════════════════════════════════════════════════╝"
          - ""

    - name: CIS 6.12 - Auditoría - Verificar MaxAuthTries actual
      shell: "grep '^MaxAuthTries' /etc/ssh/sshd_config 2>/dev/null || echo 'not_found'"
      register: maxauthtries_before
      changed_when: false
      ignore_errors: yes

    - name: CIS 6.12 - Auditoría - Mostrar estado actual
      debug:
        msg:
          - "┌─────────────────────────────────────────────────────────────────────────┐"
          - "│ AUDITORÍA PRE-REMEDIACIÓN - CIS 6.12                                    │"
          - "└─────────────────────────────────────────────────────────────────────────┘"
          - ""
          - "  Configuración actual: {{ maxauthtries_before.stdout }}"
          - "  Valor esperado:       MaxAuthTries 6"
          - "  Nota: Si está comentado, el valor por defecto es 6 (conforme)"
          - ""

    - name: CIS 6.12 - Auditoría - Registrar estado inicial
      lineinfile:
        path: "{{ audit_log }}"
        line: "[{{ ansible_date_time.iso8601 }}] CIS 6.12 - Estado PRE: {{ maxauthtries_before.stdout }}"
        create: yes

    - name: CIS 6.12 - Remediación - Crear backup de sshd_config
      copy:
        src: /etc/ssh/sshd_config
        dest: /etc/ssh/sshd_config.backup.612.{{ ansible_date_time.epoch }}
        remote_src: yes
      when: 
        - maxauthtries_before.stdout != "not_found"
        - maxauthtries_before.stdout != "MaxAuthTries 6"
      ignore_errors: yes

    - name: CIS 6.12 - Remediación - Configurar MaxAuthTries 6
      shell: |
        awk '/MaxAuthTries/ { $1 = "MaxAuthTries"; $2 = "6" } { print }' /etc/ssh/sshd_config > /etc/ssh/sshd_config.CIS
        mv /etc/ssh/sshd_config.CIS /etc/ssh/sshd_config
      register: maxauthtries_result
      when: 
        - maxauthtries_before.stdout != "not_found"
        - maxauthtries_before.stdout != "MaxAuthTries 6"
      ignore_errors: yes

    - name: CIS 6.12 - Remediación - Reiniciar servicio SSH
      shell: "svcadm restart svc:/network/ssh"
      when:
        - maxauthtries_result is defined
        - maxauthtries_result.changed
      ignore_errors: yes

    - name: CIS 6.12 - Remediación - Notificación de cambio
      debug:
        msg:
          - "┌─────────────────────────────────────────────────────────────────────────┐"
          - "│ REMEDIACIÓN EJECUTADA - CIS 6.12                                         │"
          - "└─────────────────────────────────────────────────────────────────────────┘"
          - ""
          - "   MaxAuthTries configurado a 6"
          - "   Límite de intentos de autenticación establecido"
          - "   Servicio SSH reiniciado"
          - "   Protección contra ataques de fuerza bruta mejorada"
          - ""
      when:
        - maxauthtries_result is defined
        - maxauthtries_result.rc is defined
        - maxauthtries_result.rc == 0

    - name: CIS 6.12 - Validación - Verificar configuración final
      shell: "grep '^MaxAuthTries' /etc/ssh/sshd_config || echo 'default_6'"
      register: maxauthtries_after
      changed_when: false
      ignore_errors: yes

    - name: CIS 6.12 - Validación - Confirmar configuración
      assert:
        that:
          - maxauthtries_after.stdout == "MaxAuthTries 6" or maxauthtries_after.stdout == "default_6"
        fail_msg: "ERROR: MaxAuthTries no está correctamente configurado"
        success_msg: " Validación exitosa: MaxAuthTries configurado a 6"

    - name: CIS 6.12 - Validación - Registrar estado final
      lineinfile:
        path: "{{ audit_log }}"
        line: "[{{ ansible_date_time.iso8601 }}] CIS 6.12 - Estado POST: {{ maxauthtries_after.stdout }} - CONFORME"
        create: yes

    - name:  Inicio de Remediación CIS 6.16
      debug:
        msg:
          - ""
          - "╔═══════════════════════════════════════════════════════════════════════════╗"
          - "║                                                                           ║"          
          - "║         Control 6.16: Restringir Root Login a Consola del Sistema        ║"
          - "║                                                                           ║"
          - "╚═══════════════════════════════════════════════════════════════════════════╝"
          - ""

    - name: CIS 6.16 - Auditoría - Verificar CONSOLE actual
      shell: "grep '^CONSOLE=/dev/console' /etc/default/login 2>/dev/null || echo 'not_found'"
      register: console_before
      changed_when: false
      ignore_errors: yes

    - name: CIS 6.16 - Auditoría - Mostrar estado actual
      debug:
        msg:
          - "┌─────────────────────────────────────────────────────────────────────────┐"
          - "│ AUDITORÍA PRE-REMEDIACIÓN - CIS 6.16                                    │"
          - "└─────────────────────────────────────────────────────────────────────────┘"
          - ""
          - "  Configuración actual: {{ console_before.stdout }}"
          - "  Valor esperado:       CONSOLE=/dev/console"
          - ""

    - name: CIS 6.16 - Auditoría - Registrar estado inicial
      lineinfile:
        path: "{{ audit_log }}"
        line: "[{{ ansible_date_time.iso8601 }}] CIS 6.16 - Estado PRE: {{ console_before.stdout }}"
        create: yes

    - name: CIS 6.16 - Remediación - Crear backup del archivo login
      copy:
        src: /etc/default/login
        dest: /etc/default/login.backup.616.{{ ansible_date_time.epoch }}
        remote_src: yes
      when: console_before.stdout != "CONSOLE=/dev/console"
      ignore_errors: yes

    - name: CIS 6.16 - Remediación - Configurar CONSOLE=/dev/console
      shell: |
        cd /etc/default
        awk '/CONSOLE=/ { print "CONSOLE=/dev/console"; next }; { print }' login > login.CIS
        mv login.CIS login
      register: console_result
      when: console_before.stdout != "CONSOLE=/dev/console"
      ignore_errors: yes

    - name: CIS 6.16 - Remediación - Notificación de cambio
      debug:
        msg:
          - "┌─────────────────────────────────────────────────────────────────────────┐"
          - "│ REMEDIACIÓN EJECUTADA - CIS 6.16                                         │"
          - "└─────────────────────────────────────────────────────────────────────────┘"
          - ""
          - "   CONSOLE configurado a /dev/console"
          - "   Root login restringido solo a consola del sistema"
          - "   Acceso root trazable y controlado"
          - ""
      when:
        - console_result is defined
        - console_result.rc is defined
        - console_result.rc == 0

    - name: CIS 6.16 - Validación - Verificar configuración final
      shell: "grep '^CONSOLE=/dev/console' /etc/default/login"
      register: console_after
      changed_when: false
      ignore_errors: yes

    - name: CIS 6.16 - Validación - Confirmar configuración
      assert:
        that:
          - console_after.stdout == "CONSOLE=/dev/console"
        fail_msg: "ERROR: CONSOLE no está correctamente configurado"
        success_msg: " Validación exitosa: CONSOLE=/dev/console"

    - name: CIS 6.16 - Validación - Registrar estado final
      lineinfile:
        path: "{{ audit_log }}"
        line: "[{{ ansible_date_time.iso8601 }}] CIS 6.16 - Estado POST: {{ console_after.stdout }} - CONFORME"
        create: yes

    - name:  Inicio de Remediación CIS 6.17
      debug:
        msg:
          - ""
          - "╔═══════════════════════════════════════════════════════════════════════════╗"
          - "║                                                                           ║"          
          - "║         Control 6.17: Configurar Límite de Reintentos (Account Lockout)  ║"
          - "║                                                                           ║"
          - "╚═══════════════════════════════════════════════════════════════════════════╝"
          - ""

    - name: CIS 6.17 - Auditoría - Verificar RETRIES en /etc/default/login
      shell: "grep '^RETRIES=' /etc/default/login 2>/dev/null || echo 'not_found'"
      register: retries_before
      changed_when: false
      ignore_errors: yes

    - name: CIS 6.17 - Auditoría - Verificar LOCK_AFTER_RETRIES en policy.conf
      shell: "grep '^LOCK_AFTER_RETRIES=' /etc/security/policy.conf 2>/dev/null || echo 'not_found'"
      register: lock_after_retries_before
      changed_when: false
      ignore_errors: yes

    - name: CIS 6.17 - Auditoría - Mostrar estado actual
      debug:
        msg:
          - "┌─────────────────────────────────────────────────────────────────────────┐"
          - "│ AUDITORÍA PRE-REMEDIACIÓN - CIS 6.17                                    │"
          - "└─────────────────────────────────────────────────────────────────────────┘"
          - ""
          - "  RETRIES actual:            {{ retries_before.stdout }}"
          - "  LOCK_AFTER_RETRIES actual: {{ lock_after_retries_before.stdout }}"
          - "  Valores esperados:         RETRIES=3, LOCK_AFTER_RETRIES=YES"
          - ""

    - name: CIS 6.17 - Auditoría - Registrar estado inicial
      lineinfile:
        path: "{{ audit_log }}"
        line: "[{{ ansible_date_time.iso8601 }}] CIS 6.17 - Estado PRE: RETRIES={{ retries_before.stdout }}, LOCK={{ lock_after_retries_before.stdout }}"
        create: yes

    - name: CIS 6.17 - Remediación - Crear backup de /etc/default/login
      copy:
        src: /etc/default/login
        dest: /etc/default/login.backup.617.{{ ansible_date_time.epoch }}
        remote_src: yes
      when: retries_before.stdout != "RETRIES=3"
      ignore_errors: yes

    - name: CIS 6.17 - Remediación - Configurar RETRIES=3
      shell: |
        cd /etc/default
        awk '/RETRIES=/ { $1 = "RETRIES=3" } { print }' login > login.CIS
        mv login.CIS login
      register: retries_result
      when: retries_before.stdout != "RETRIES=3"
      ignore_errors: yes

    - name: CIS 6.17 - Remediación - Crear backup de policy.conf
      copy:
        src: /etc/security/policy.conf
        dest: /etc/security/policy.conf.backup.{{ ansible_date_time.epoch }}
        remote_src: yes
      when: lock_after_retries_before.stdout != "LOCK_AFTER_RETRIES=YES"
      ignore_errors: yes

    - name: CIS 6.17 - Remediación - Configurar LOCK_AFTER_RETRIES=YES
      shell: |
        cd /etc/security
        awk '/LOCK_AFTER_RETRIES=/ { $1 = "LOCK_AFTER_RETRIES=YES" } { print }' policy.conf > policy.conf.CIS
        mv policy.conf.CIS policy.conf
      register: lock_result
      when: lock_after_retries_before.stdout != "LOCK_AFTER_RETRIES=YES"
      ignore_errors: yes

    - name: CIS 6.17 - Remediación - Reiniciar name-service cache
      shell: "svcadm restart svc:/system/name-service/cache"
      when: retries_result is defined or lock_result is defined
      ignore_errors: yes

    - name: CIS 6.17 - Remediación - Notificación de cambio
      debug:
        msg:
          - "┌─────────────────────────────────────────────────────────────────────────┐"
          - "│ REMEDIACIÓN EJECUTADA - CIS 6.17                                         │"
          - "└─────────────────────────────────────────────────────────────────────────┘"
          - ""
          - "   RETRIES configurado a 3"
          - "   LOCK_AFTER_RETRIES configurado a YES"
          - "   Bloqueo automático de cuentas habilitado tras 3 intentos fallidos"
          - "   Name-service cache reiniciado"
          - "   NOTA: Root está exento por defecto (lock_after_retries=no)"
          - ""
      when: retries_result is defined or lock_result is defined

    - name: CIS 6.17 - Validación - Verificar RETRIES final
      shell: "grep '^RETRIES=' /etc/default/login"
      register: retries_after
      changed_when: false
      ignore_errors: yes

    - name: CIS 6.17 - Validación - Verificar LOCK_AFTER_RETRIES final
      shell: "grep '^LOCK_AFTER_RETRIES=' /etc/security/policy.conf"
      register: lock_after_retries_after
      changed_when: false
      ignore_errors: yes

    - name: CIS 6.17 - Validación - Confirmar configuración
      assert:
        that:
          - retries_after.stdout == "RETRIES=3"
          - lock_after_retries_after.stdout == "LOCK_AFTER_RETRIES=YES"
        fail_msg: "ERROR: Configuración de account lockout no está correcta"
        success_msg: " Validación exitosa: RETRIES=3 y LOCK_AFTER_RETRIES=YES"

    - name: CIS 6.17 - Validación - Registrar estado final
      lineinfile:
        path: "{{ audit_log }}"
        line: "[{{ ansible_date_time.iso8601 }}] CIS 6.17 - Estado POST: RETRIES={{ retries_after.stdout }}, LOCK={{ lock_after_retries_after.stdout }} - CONFORME"
        create: yes

     - name:  Inicio de Remediación CIS 7.1
      debug:
        msg:
          - ""
          - "╔═══════════════════════════════════════════════════════════════════════════╗"
          - "║                                                                           ║"          
          - "║ Control 6.17: Set Password Expiration Parameters on Active    (Automated) ║"
          - "║                                                                           ║"
          - "╚═══════════════════════════════════════════════════════════════════════════╝"
          - ""

    - name: CIS 7.1 - Auditoria - Verificacion de cuetnas activas con configuracion no conforme
      shell: "logins -ox | awk -F: '( $1 != \"root\" && $8 != \"LK\" && $8 != \"NL\" && ( $10 < 7 || $11 > 91 || $12 < 7 )) { print }'"
      register: non_compliant_accounts
      changed_when: false
      ignore_errors: yes


    - name: CIS 7.1 - Verificar configuraciones WEEKS en /etc/default/passwd
      shell: "grep 'WEEKS=' /etc/default/passwd | sort -u"
      register: weeks_config_before
      changed_when: false
      ignore_errors: false
    
    - name: CIS 7.1 - Auditoria-mostrar Estado actual
      debug:
        msg:
          - "┌─────────────────────────────────────────────────────────────────────────┐"
          - "│ AUDITORÍA PRE-REMEDIACIÓN - CIS 7.1                                     │"
          - "└─────────────────────────────────────────────────────────────────────────┘"
          - ""
          - "  Cuentas no conformes detectadas:"
          - "  {{ non_compliant_accounts.stdout_lines | default(['  Ninguna']) | join('\n  ') }}"
          - ""
          - "  Configuración actual de /etc/default/passwd:"
          - "  {{ weeks_config_before.stdout_lines | default(['  No configurado']) | join('\n  ') }}"
          - ""
          - "  Valores esperados:"
          - "    MAXWEEKS=13  (91 días máximo entre cambios)"
          - "    MINWEEKS=1   (7 días mínimo entre cambios)"
          - "    WARNWEEKS=4  (28 días de advertencia antes de expiración)"
          - ""      


    - name: CIS 7.1 - Registrar estado inicial 
      lineinfile:
        path: "{{ audit_log }}"
        line: "[{{ ansible_date_time.iso8601 }}] CIS 7.1 - Estado PRE: Cuentas no conformes={{ non_compliant_accounts.stdout_lines | length | default(0) }}"
        create: yes

    - name: CIS 7.1 - Remediación - Crear script de actualización de cuentas
      shell: |
        logins -ox | awk -F: '($1 == "root" || $8 == "LK" || $8 == "NL") { next } ; 
        { cmd = "passwd" } ; 
        ($11 < 91) { cmd = cmd " -x 91" } 
        ($10 < 7) { cmd = cmd " -n 7" } 
        ($12 < 28) { cmd = cmd " -w 28" } 
        (cmd != "passwd") { print cmd " " $1 }' > /etc/CISupd_accounts
      register: create_script_result
      when: non_compliant_accounts.stdout != ""
      ignore_errors: yes

    - name: CIS 7.1 - Remediación - Ejecutar actualización de cuentas
      shell: "/sbin/sh /etc/CISupd_accounts"
      register: update_accounts_result
      when: 
        - create_script_result is defined
        - create_script_result.rc is defined
        - create_script_result.rc == 0
      ignore_errors: yes

    - name: CIS 7.1 - Remediación - Eliminar script temporal
      file:
        path: /etc/CISupd_accounts
        state: absent
      when: create_script_result is defined
      ignore_errors: yes

    - name: CIS 7.1 - Remediación - Crear backup de /etc/default/passwd
      copy:
        src: /etc/default/passwd
        dest: /etc/default/passwd.backup.71.{{ ansible_date_time.epoch }}
        remote_src: yes
      ignore_errors: yes

    - name: CIS 7.1 - Remediación - Actualizar /etc/default/passwd
      shell: |
        cd /etc/default
        cp passwd passwd.orig
        grep -v WEEKS passwd > passwd.CIS
        cat << 'EODefaults' >> passwd.CIS
        MAXWEEKS=13
        MINWEEKS=1
        WARNWEEKS=4
        EODefaults
        mv passwd.CIS passwd
      register: passwd_config_result
      ignore_errors: yes

    - name: CIS 7.1 - Remediación - Notificación de cambio
      debug:
        msg:
          - "┌─────────────────────────────────────────────────────────────────────────┐"
          - "│ REMEDIACIÓN EJECUTADA - CIS 7.1                                          │"
          - "└─────────────────────────────────────────────────────────────────────────┘"
          - ""
          - "   Cuentas activas actualizadas con nuevos parámetros de expiración"
          - "   MAXWEEKS=13 (máximo 91 días entre cambios de contraseña)"
          - "   MINWEEKS=1 (mínimo 7 días entre cambios de contraseña)"
          - "   WARNWEEKS=4 (28 días de advertencia antes de expiración)"
          - "   Configuración aplicada en /etc/default/passwd"
          - "   Cuenta root excluida de estos cambios (manejo especial)"
          - ""
      when:
        - passwd_config_result is defined
        - passwd_config_result.rc is defined
        - passwd_config_result.rc == 0

    - name: CIS 7.1 - Remediación - Ya conforme
      debug:
        msg:
          - "┌─────────────────────────────────────────────────────────────────────────┐"
          - "│ ESTADO CONFORME - CIS 7.1                                                │"
          - "└─────────────────────────────────────────────────────────────────────────┘"
          - ""
          - "   No se encontraron cuentas activas que requieran actualización"
          - "   Todas las cuentas ya cumplen con los parámetros de expiración"
          - ""
      when: non_compliant_accounts.stdout == ""

    - name: CIS 7.1 - Validación - Verificar cuentas después de remediación
      shell: "logins -ox | awk -F: '( $1 != \"root\" && $8 != \"LK\" && $8 != \"NL\" && ( $10 < 7 || $11 > 91 || $12 < 7 )) { print }'"
      register: non_compliant_accounts_after
      changed_when: false
      ignore_errors: yes

    - name: CIS 7.1 - Validación - Verificar configuración WEEKS final
      shell: "grep 'WEEKS=' /etc/default/passwd | sort -u"
      register: weeks_config_after
      changed_when: false
      ignore_errors: yes

    - name: CIS 7.1 - Validación - Confirmar configuración
      assert:
        that:
          - non_compliant_accounts_after.stdout == ""
          - "'MAXWEEKS=13' in weeks_config_after.stdout"
          - "'MINWEEKS=1' in weeks_config_after.stdout"
          - "'WARNWEEKS=4' in weeks_config_after.stdout"
        fail_msg: "ERROR: Parámetros de expiración de contraseñas no están correctamente configurados"
        success_msg: " Validación exitosa: Parámetros de expiración conformes (MAXWEEKS=13, MINWEEKS=1, WARNWEEKS=4)"

    - name: CIS 7.1 - Validación - Mostrar resultado final
      debug:
        msg:
          - "┌─────────────────────────────────────────────────────────────────────────┐"
          - "│ VALIDACIÓN FINAL - CIS 7.1                                               │"
          - "└─────────────────────────────────────────────────────────────────────────┘"
          - ""
          - "  Estado de cuentas: {{ 'CONFORME - Sin cuentas no conformes' if non_compliant_accounts_after.stdout == '' else 'NO CONFORME - Revisar cuentas' }}"
          - "  Configuración /etc/default/passwd:"
          - "  {{ weeks_config_after.stdout_lines | join('\n  ') }}"
          - ""

    - name: CIS 7.1 - Validación - Registrar estado final
      lineinfile:
        path: "{{ audit_log }}"
        line: "[{{ ansible_date_time.iso8601 }}] CIS 7.1 - Estado POST: CONFORME - MAXWEEKS=13, MINWEEKS=1, WARNWEEKS=4, Cuentas actualizadas={{ non_compliant_accounts.stdout_lines | length | default(0) }}"
        create: yes

    - name:  Inicio de Remediación CIS 7.2
      debug:
        msg:
          - ""
          - "╔═══════════════════════════════════════════════════════════════════════════╗"
          - "║                                                                           ║"          
          - "║ Control 7.2: set Strong Password Creation Policies                        ║"
          - "║                                                                           ║"
          - "╚═══════════════════════════════════════════════════════════════════════════╝"
          - ""

    - name: CIS 7.2 - Auditoria - Verificar PASSLENGTH
      shell: "grep '^PASSLENGTH=' /etc/default/passwd 2>/dev/null || echo 'not_found'"
      register: passlength_before
      changed_when: false
      ignore_errors: yes
    
    - name: CIS 7.2 - Auditoria - Verificar NAMECHECK
      shell: "grep '^NAMECHECK=' /etc/default/passwd 2>/dev/null || echo '^not_found' "
      register: namecheck_before
      changed_when: false
      ignore_errors: yes

    - name: CIS 7.2 - Auditoria - Verificar HISTORY
      shell: "grep '^HISTORY=' /etc/default/passwd 2>/dev/null || echo 'not_found'"
      register: history_before
      changed_when: false
      ignore_errors: yes
  
   - name: CIS 7.2 - Auditoria - verificar MINDIFF
     shell: "grep '^MINDIFF=' /etc/default/passwd 2>/dev/null || echo 'not_found'"
     register: mindiff_before
     changed_when: false
     ignore_errors: yes

   - name: CIS 7.2 - Auditoria -Verificar MINUPPER
     shell: "grep '^MINUPPER=' /etc/default/passwd 2>/dev/null || echo 'not_found'"
     register: minupper_before
     changed_when: false 
     ignore_false: yes 

   - name: CIS 7.2 -Auditoria - Verificar MINLOWER
     shell: "grep '^MINLOWER=' /etc/default/passwd 2>/dev/null || echo 'not_found'"
     register: minlower_before
     changed_when: false
     ignore_false: yes
   

   - name: CIS 7.2 - Auditoría - Verificar MINSPECIAL
     shell: "grep '^MINSPECIAL=' /etc/default/passwd 2>/dev/null || echo 'not_found'"
     register: minspecial_before
     changed_when: false
     ignore_errors: yes

   - name: CIS 7.2 - Auditoría - Verificar MINDIGIT
     shell: "grep '^MINDIGIT=' /etc/default/passwd 2>/dev/null || echo 'not_found'"
     register: mindigit_before
     changed_when: false
     ignore_errors: yes

   - name: CIS 7.2 - Auditoría - Verificar MAXREPEATS
     shell: "grep '^MAXREPEATS=' /etc/default/passwd 2>/dev/null || echo 'not_found'"
     register: maxrepeats_before
     changed_when: false
     ignore_errors: yes

    - name: CIS 7.2 - Auditoría - Verificar WHITESPACE
      shell: "grep '^WHITESPACE=' /etc/default/passwd 2>/dev/null || echo 'not_found'"
      register: whitespace_before
      changed_when: false
      ignore_errors: yes

    - name: CIS 7.2 - Auditoría - Verificar DICTIONDBDIR
      shell: "grep '^DICTIONDBDIR=' /etc/default/passwd 2>/dev/null || echo 'not_found'"
      register: dictiondbdir_before
      changed_when: false
      ignore_errors: yes

    - name: CIS 7.2 - Auditoría - Verificar DICTIONLIST
      shell: "grep '^DICTIONLIST=' /etc/default/passwd 2>/dev/null || echo 'not_found'"
      register: dictionlist_before
      changed_when: false
      ignore_errors: yes

   - name: CIS 7.2 - Auditoría - Registrar estado inicial
     lineinfile:
       path: "{{ audit_log }}"
       line: "[{{ ansible_date_time.iso8601 }}] CIS 7.2 - Estado PRE: PASSLENGTH={{ passlength_before.stdout }}, HISTORY={{ history_before.stdout }}"
       create: yes

   - name: CIS 7.2 - Remediación - Crear backup de /etc/default/passwd
     copy:
      src: /etc/default/passwd
      dest: /etc/default/passwd.backup.72.{{ ansible_date_time.epoch }}
      remote_src: yes
      ignore_errors: yes

   - name: CIS 7.2 - Remediación - Aplicar políticas de contraseñas fuertes
     shell: |
       cd /etc/default
       awk '/PASSLENGTH=/ { $1 = "PASSLENGTH=14" };
       /NAMECHECK=/ { $1 = "NAMECHECK=YES" };
       /HISTORY=/ { $1 = "HISTORY=10" };
       /MINDIFF=/ { $1 = "MINDIFF=3" };
       /MINUPPER=/ { $1 = "MINUPPER=1" };
       /MINLOWER=/ { $1 = "MINLOWER=1" };
       /MINSPECIAL=/ { $1 = "MINSPECIAL=1" };
       /MINDIGIT=/ { $1 = "MINDIGIT=1" };
       /MAXREPEATS=/ { $1 = "MAXREPEATS=1" };
       /WHITESPACE=/ { $1 = "WHITESPACE=YES" };
       /DICTIONDBDIR=/ { $1 = "DICTIONDBDIR=/var/passwd" };
       /DICTIONLIST=/ { $1 = "DICTIONLIST=/usr/share/lib/dict/words" };
       { print }' passwd > passwd.CIS
       mv passwd.CIS passwd
      register: password_policy_result
      ignore_errors: yes

   - name: CIS 7.2 -  Validacion . verificar PASSLENGTH final
     shell: "grep '^PASSLENGTH=' /etc/default/passwd"
     register: passlength_after
     changed_when: false
     ignore_errors: yes

   - name: CIS 7.2 - Validacion verificar NAMECHECK final 
     shell: "grep '^NAMECHECK=' /etc/default/passwd"
     register: namecheck_after
     changed_when: false
     ignore_errors: yes
   
   - name: CIS 7.2 - validacion - verificar HISTORY final 
     shell: "grep '^HISTORY=' /etc/default/passwd"
     register: history_after
     changed_when: false
     ignore_errors: yes
    
   - name: CIS 7.2 - Validacion - verifcar MINDIFF final 
     shell: "grep '^MINDIFF=' /etc/default/passwd"
     register: mindiff_after
     changed_when: false 
     ignore_errors: yes
  
   - name: CIS 7.2 - Validacion - verificar MINUPPER final 
     shell: "grep '^MINUPPER=' /etc/default/passwd"
     register: minupper_after
     changed_when: false
     ignore_errors: yes
  
   - name: CIS 7.2 Validacion - verificar MINLOWER final 
     shell: "grep '^MINLOWER=' /etc/default/passwd"
     register: minlower_after
     changed_when: false
     ignore_errors: yes
    
   - name: CIS 7.2 Validacion - verificar MINSPECIAL final 
     shell: "grep '^MINSPECIAL=' /etc/default/passwd"
     register: minspecial_after
     changed_when: false
     ignore_errors: yes
  
   - name: CIS 7.2 Validacion - verificar MINDIGIT final 
     shell: "grep '^MINDIGIT=' /etc/default/passwd"
     register: mindigit_after
     changed_when: false
     ignore_errors: yes

   - name: CIS 7.2 Validacion - verifcar MAXREPEATS FINAL
     shell: "grep '^MINDIGIT=' /etc/default/passwd"
     register: maxrepeats_after
     changed_when: false
     ignore_errors: yes

   - name: CIS 7.2 Validacion . verificar WHITESPACE final 
     shell:  "grep '^WHITESPACE=' /etc/default/passwd"
     register: whitespace_after
     changed_when: false
     ignore_errors: yes

   - name: CIS 7.2 Validacion - verifcar DICTIONDBDIR final 
     shell: "grep  '^WHITESPACE=' /etc/default/passwd"
     register: dictiondbdir_after
     changed_when: false
     ignore_errors: false

   - name: CIS 7.2 Validacion - verifcar dictionlist
     shell: "grep '^DICTIONLIST=' /etc/default/passwd"
     register: dictionlist_after
     changed_when: false
     ignore_errors: false

   - name: CIS 7.2 - Validación - Confirmar configuración
     assert:
        that:
          - passlength_after.stdout == "PASSLENGTH=14"
          - namecheck_after.stdout == "NAMECHECK=YES"
          - history_after.stdout == "HISTORY=10"
          - mindiff_after.stdout == "MINDIFF=3"
          - minupper_after.stdout == "MINUPPER=1"
          - minlower_after.stdout == "MINLOWER=1"
          - minspecial_after.stdout == "MINSPECIAL=1"
          - mindigit_after.stdout == "MINDIGIT=1"
          - maxrepeats_after.stdout == "MAXREPEATS=1"
          - whitespace_after.stdout == "WHITESPACE=YES"
          - dictiondbdir_after.stdout == "DICTIONDBDIR=/var/passwd"
          - dictionlist_after.stdout == "DICTIONLIST=/usr/share/lib/dict/words"
        fail_msg: "ERROR: Políticas de contraseñas no están correctamente configuradas"
        success_msg: " Validación exitosa: Todas las políticas de contraseñas fuertes aplicadas"


   - name: CIS 7.2 - Validación - Registrar estado final
    lineinfile:
      path: "{{ audit_log }}"
      line: "[{{ ansible_date_time.iso8601 }}] CIS 7.2 - Estado POST: CONFORME - Políticas de contraseñas fuertes aplicadas (PASSLENGTH=14, HISTORY=10, etc.)"
      create: yes

   - name: Inicio de Remediación CIS 7.3
      debug:
        msg:
          - ""
          - "╔═══════════════════════════════════════════════════════════════════════════╗"
          - "║                                                                           ║"          
          - "║ Control 7.3: Set Default umask for Users                                 ║"
          - "║                                                                           ║"
          - "╚═══════════════════════════════════════════════════════════════════════════╝"
          - ""

  - name: CIS 7.3 - Auditoría - Verificar UMASK actual
    shell: "grep '^UMASK=' /etc/default/login 2>/dev/null || echo 'not_found'"
    register: umask_before
    changed_when: false
    ignore_errors: yes

  - name: CIS 7.3 - Auditoría - Verificar UMASK comentado
    shell: "grep '^#UMASK=' /etc/default/login 2>/dev/null || echo 'not_found'"
    register: umask_commented_before
    changed_when: false
    ignore_errors: yes

  - name: CIS 7.3 - Auditoría - Mostrar estado actual
     debug:
       msg:
       - "┌─────────────────────────────────────────────────────────────────────────┐"
       - "│ AUDITORÍA PRE-REMEDIACIÓN - CIS 7.3                                     │"
       - "└─────────────────────────────────────────────────────────────────────────┘"
       - ""
       - "  Configuración actual:"
       - "  UMASK activo:    {{ umask_before.stdout }}"
       - "  UMASK comentado: {{ umask_commented_before.stdout }}"
       - ""
       - "  Valor esperado: UMASK=027"
       - ""
       - "  Significado de UMASK=027:"
       - "  - Propietario: rwx (lectura, escritura, ejecución)"
       - "  - Grupo: r-x (lectura, ejecución)"
       - "  - Otros: --- (sin permisos)"
       - ""

  - name: CIS 7.3 - Auditoría - Registrar estado inicial
    lineinfile:
      path: "{{ audit_log }}"
      line: "[{{ ansible_date_time.iso8601 }}] CIS 7.3 - Estado PRE: {{ umask_before.stdout }}"
      create: yes

  - name: CIS 7.3 - Remediación - Crear backup de /etc/default/login
    copy:
      src: /etc/default/login
      dest: /etc/default/login.backup.73.{{ ansible_date_time.epoch }}
      remote_src: yes
    when: umask_before.stdout != "UMASK=027"
    ignore_errors: yes

    - name: CIS 7.3 - Remediación - Configurar UMASK=027
      shell: |
        cd /etc/default
        awk '/#UMASK=/ { $1 = "UMASK=027" } { print }' login > login.CIS
        mv login.CIS login
      register: umask_result
      when: umask_before.stdout != "UMASK=027"
      ignore_errors: yes

    - name: CIS 7.3 - Remediación - Notificación de cambio
      debug:
        msg:
          - "┌─────────────────────────────────────────────────────────────────────────┐"
          - "│ REMEDIACIÓN EJECUTADA - CIS 7.3                                          │"
          - "└─────────────────────────────────────────────────────────────────────────┘"
          - ""
          - "   UMASK configurado a 027"
          - "   Archivos nuevos: Propietario (rw-), Grupo (r--), Otros (---)"
          - "   Directorios nuevos: Propietario (rwx), Grupo (r-x), Otros (---)"
          - "   Seguridad de permisos por defecto mejorada"
          - ""
          - "   Los usuarios pueden modificar permisos con chmod según necesidad"
          - ""
      when:
        - umask_result is defined
        - umask_result.rc is defined
        - umask_result.rc == 0

    - name: CIS 7.3 - Remediación - Ya conforme
      debug:
        msg:
          - "┌─────────────────────────────────────────────────────────────────────────┐"
          - "│ ESTADO CONFORME - CIS 7.3                                                │"
          - "└─────────────────────────────────────────────────────────────────────────┘"
          - ""
          - "   UMASK ya está configurado correctamente a 027"
          - ""
      when: umask_before.stdout == "UMASK=027"

    - name: CIS 7.3 - Validación - Verificar configuración final
      shell: "grep '^UMASK=' /etc/default/login"
      register: umask_after
      changed_when: false
      ignore_errors: yes

    - name: CIS 7.3 - Validación - Confirmar configuración
      assert:
        that:
          - umask_after.stdout == "UMASK=027"
        fail_msg: "ERROR: UMASK no está correctamente configurado"
        success_msg: " Validación exitosa: UMASK=027"

    - name: CIS 7.3 - Validación - Mostrar resultado final
      debug:
        msg:
          - "┌─────────────────────────────────────────────────────────────────────────┐"
          - "│ VALIDACIÓN FINAL - CIS 7.3                                               │"
          - "└─────────────────────────────────────────────────────────────────────────┘"
          - ""
          - "  Configuración: {{ umask_after.stdout }}"
          - "  Estado: CONFORME"
          - ""
          - "  Permisos por defecto aplicados:"
          - "  Archivos nuevos:     640 (rw-r-----)"
          - "  Directorios nuevos:  750 (rwxr-x---)"
          - ""

    - name: CIS 7.3 - Validación - Registrar estado final
      lineinfile:
        path: "{{ audit_log }}"
        line: "[{{ ansible_date_time.iso8601 }}] CIS 7.3 - Estado POST: {{ umask_after.stdout }} - CONFORME"
        create: yes
      
   - name: Inicio de Remediación CIS 7.5
      debug:
        msg:
          - ""
          - "╔═══════════════════════════════════════════════════════════════════════════╗"
          - "║                                                                           ║"          
          - "║ Control 7.5: Set "mesg n" as Default for all Users                        ║"
          - "║                                                                           ║"
          - "╚═══════════════════════════════════════════════════════════════════════════╝"
          - ""

   - name: CIS 7.5 - Validacion el mesg en /etc/profile 
     shell: "grep '^mesg' /etc/profile 2>/dev/null || echo 'not_found"
     register: mesg_profile_before
     changed_when: false
     ignore_errors: yes
  
   - name: CIS 7.5 - Auditoria - mostrar el estado actual
     debug:
       msg: 
         - "┌─────────────────────────────────────────────────────────────────────────┐"
          - "│ AUDITORÍA PRE-REMEDIACIÓN - CIS 7.5                                     │"
          - "└─────────────────────────────────────────────────────────────────────────┘"
          - ""
          - "  Configuración actual:"
          - "  /etc/profile: {{ mesg_profile_before.stdout }}"
          - "  /etc/.login:  {{ mesg_login_before.stdout }}"
          - ""
          - "  Valor esperado: mesg n"
          - ""
          - "  Propósito:"
          - "  - Bloquea comandos write/talk para contactar usuarios en terminales"
          - "  - Fortalece permisos en dispositivos tty de usuarios"
          - "  - Incrementa seguridad con pérdida mínima de funcionalidad"
          - ""
    
    - name: CIS 7.5 - Auditoria - registrar el estado inicial
      lineinfile: 
        path: "{{ audit_log }}"
        line: "[{{ ansible_date_time.iso8601 }}] CIS 7.5 - Estado PRE: profile={{ mesg_profile_before.stdout }}, .login={{ mesg_login_before.stdout }}"
        create: yes

   - name: CIS 7.5 - Remediacion . crear Backup de /etc/profile
     copy:  
       src: /etc/profile
       dest: /etc/profile.backup.75.{{ ansible_date_time.epoch }}
       remote_src: yes
      ignore_errors: yes

   - name: CIS 7.5 - REMEDIACION - Crar un backup de /etc/.login
     copy:
       src: /etc/.login 
       dest: /etc/.login.backup.75.{{ansible_date_time.epoch}}
       remote_src: yes
    when: mesg_login_before.stdout != "not_found" or mesg_login_before.rc == 0
    ignore_errors: yes

    - name: CIS 7.5 REMEACION . Configurar mesg n en en archivos de perfil
      shell: |
        cd / etc 
        for file in profile .loign ; do 
          if grep -q mesg "$file" 2>/dev/null; then
            awk '$1 == "mesg" { $2 = "n" } { print }' "$file" > "$file.CIS"
            mv "$file.CIS " "$file"
          else
            echo "mesg n" >> "$file"
          fi 
        done 
    
   - name: CIS 7.5 - validacion de mesg en /etc/profile final
      shell: "grep '^mesg' /etc/profile"
      register: mesg_profile_after
      changed_when: false
      ignore_errors: yes

   - name: CIS 7.5 - Validacion - verificar mesg en /etc/.login final
     shell: "grep '^mesg' /etc/.login"
     register: mesg_login_after
     changed_when: false
     ignore_errors: yes
   
   - name: CIS 7.5 - VALIDACION - Confirmar configuracion
     assert:
       that:
         - mesg_profile_after.stdout == "mesg n"
         - mesg_login_after.stdout == "mesg n"
       fail_msg: "ERROR: mesg n no esta correctamente configurado en archivos de perfil"
       success_msg: " Validación exitosa: mesg n configurado en /etc/profile y /etc/.login"

   - name: CIS 7.5 - Validacion - registrar estado final
     lineinfile:
       path: "{{ audit_log }}"
       line: "[{{ ansible_date_time.iso8601 }}] CIS 7.5 - Estado POST: profile={{ mesg_profile_after.stdout }}, .login={{ mesg_login_after.stdout }} - CONFORME"
       create: yes
   
    - name: Inicio de Remediación CIS 7.6
      debug:
        msg:
          - ""
          - "╔═══════════════════════════════════════════════════════════════════════════╗"
          - "║                                                                           ║"          
          - "║ Control 7.6: Lock Inactive users account                                  ║"
          - "║                                                                           ║"
          - "╚═══════════════════════════════════════════════════════════════════════════╝"
          - ""

    - name: CIS 7.6 - Auditoria- verificaion configuración global de inactividad
      shell: "useradd -D | xargs -n 1 | grep inactive | awk -F= '{ print $2 }'"
      register: inactive_default_before
      changed_when: false
      ignore_errors: yes

   - name: CIS 7.6 - Auditoría - Obtener lista de usuarios para verificar
     shell: "Logins -ox | awk -F: '($1 != \"root\" && $8 != \"LK\" && $8 != \"NL\") { print $1 }'"
     register: users_to_check
     changed_when: false
     ignore_errors: yes

   - name: CIS 7.6 - Auditoria - Verificar cuentas con inactibidad no conforme
     shell: |
       for user in {{ users_to_check.stdout_lines | join(' ') }}; do
         inactive=$(logins -axo -l "$user" 2>/dev/null | awk -F: '{ print $13 }')
         if [ "$inactive" != "35" ] && [ "$inactive" != "" ]; then
          echo "$user:$inactive"
         fi 
       done
     register: non_compliant_inactive
     changed_when: false 
     ignore_errors: yes 
     when: users_to_check.stdout_lines | length > 0


   - name: CIS 7.6 - Auditoría - Registrar estado inicial
      lineinfile:
        path: "{{ audit_log }}"
        line: "[{{ ansible_date_time.iso8601 }}] CIS 7.6 - Estado PRE: Inactividad global={{ inactive_default_before.stdout | default('not_set') }}"
        create: yes

   - name: CIS 7.6 - Remediación - Configurar inactividad global (useradd -D)
     shell: "useradd -D -f 35"
     register: useradd_default_result
     when: inactive_default_before.stdout != "35"
     ignore_errors: yes

   - name: CIS 7.6 - Remediación - Aplicar inactividad a usuarios existentes
     shell: |
       for user in {{ users_to_check.stdout_lines | join(' ') }}; do
        current_inactive=$(logins -axo -l "$user" 2>/dev/null | awk -F: '{ print $13 }')
        if [ "$current_inactive" != "35" ]; then
          usermod -f 35 "$user" 2>/dev/null && echo "Updated: $user" || echo "Failed: $user"
        fi
      done
     register: usermod_result
     when: 
       - users_to_check.stdout_lines | length > 0
       - non_compliant_inactive is defined
       - non_compliant_inactive.stdout != ""
     ignore_errors: yes

    - name: CIS 7.6 - Remediación - Verificar y aplicar a roles si existen
      shell: |
        roles=$(logins -r 2>/dev/null | awk -F: '{ print $1 }')
        if [ -n "$roles" ]; then
          for role in $roles; do
            current_inactive=$(logins -axo -l "$role" 2>/dev/null | awk -F: '{ print $13 }')
            if [ "$current_inactive" != "35" ]; then
              rolemod -f 35 "$role" 2>/dev/null && echo "Role updated: $role" || echo "Role failed: $role"
            fi
          done
        else
          echo "No roles found"
        fi
      register: rolemod_result
      ignore_errors: yes

    - name: CIS 7.6 - Remediación - Ya conforme
      debug:
        msg:
          - "┌─────────────────────────────────────────────────────────────────────────┐"
          - "│ ESTADO CONFORME - CIS 7.6                                                │"
          - "└─────────────────────────────────────────────────────────────────────────┘"
          - ""
          - "   Configuración global ya está en 35 días de inactividad"
          - "   No se requieren cambios"
          - ""
      when: inactive_default_before.stdout == "35"

    - name: CIS 7.6 - Validación - Verificar configuración global final
      shell: "useradd -D | xargs -n 1 | grep inactive | awk -F= '{ print $2 }'"
      register: inactive_default_after
      changed_when: false
      ignore_errors: yes

    - name: CIS 7.6 - Validación - Verificar usuarios específicos después de remediación
      shell: |
        non_compliant_count=0
        for user in {{ users_to_check.stdout_lines | join(' ') }}; do
          inactive=$(logins -axo -l "$user" 2>/dev/null | awk -F: '{ print $13 }')
          if [ "$inactive" != "35" ] && [ "$inactive" != "" ]; then
            echo "$user:$inactive"
            non_compliant_count=$((non_compliant_count + 1))
          fi
        done
        if [ $non_compliant_count -eq 0 ]; then
          echo "all_compliant"
        fi
      register: inactive_users_after
      changed_when: false
      ignore_errors: yes
      when: users_to_check.stdout_lines | length > 0

    - name: CIS 7.6 - Validación - Confirmar configuración
      assert:
        that:
          - inactive_default_after.stdout == "35"
          - inactive_users_after is not defined or "all_compliant" in inactive_users_after.stdout
        fail_msg: "ERROR: Período de inactividad no está correctamente configurado"
        success_msg: " Validación exitosa: Período de inactividad configurado a 35 días globalmente y en todas las cuentas"

    - name: CIS 7.6 - Validación - Mostrar resultado final
      debug:
        msg:
          - "┌─────────────────────────────────────────────────────────────────────────┐"
          - "│ VALIDACIÓN FINAL - CIS 7.6                                               │"
          - "└─────────────────────────────────────────────────────────────────────────┘"
          - ""
          - "  Configuración global: {{ inactive_default_after.stdout }} días"
          - "  Estado usuarios: {{ 'CONFORME - Todas las cuentas configuradas' if inactive_users_after is not defined or 'all_compliant' in inactive_users_after.stdout else 'REVISAR - Algunas cuentas pendientes' }}"
          - ""
          - "   Nuevas cuentas se crearán con período de inactividad de 35 días"
          - "   Cuentas existentes actualizadas"
          - "   Sistema conforme con directrices DoD"
          - ""

    - name: CIS 7.6 - Validación - Registrar estado final
      lineinfile:
        path: "{{ audit_log }}"
        line: "[{{ ansible_date_time.iso8601 }}] CIS 7.6 - Estado POST: Inactividad global={{ inactive_default_after.stdout }} días - CONFORME"
        create: yes

   - name: CIS 8.1 - Inicio de remediacion
      debug:
        msg: 
          - "┌─────────────────────────────────────────────────────────────────────────┐"
          - "│ CONTROL 8.1 - Create Warninga Login Services                            │"
          - "└─────────────────────────────────────────────────────────────────────────┘"
          - ""

    - name: CIS 8.1 - Auditoria - verifcar contenido actual de /etc/motd
      shell: "cat /etc/motd"
      register: motd_content_before
      changed_when: false
      ignore_errors: yes
  
   - name: CIS 8.1 - verificar permisos /etc/motd 
     stat: 
       path: /etc/motd
       register: motd_stat_before

   - name: CIS 8.1 - Verificar contenido actual de /etc/issye
     shell: "cat /etc/issue"
     register: issue_content_before
     changed_when: false
     ignore_errors: yes

   - name: CIS 8.1 - Auditoria - registrar estado inicial
     debug:
       msg: 
         - "┌─────────────────────────────────────────────────────────────────────────┐"
         - "│ ESTADO INICIAL - CIS 8.1                                                │" 
         - "└─────────────────────────────────────────────────────────────────────────┘"
         - ""
         - " Archivo /etc/motd:"
         - " Contenido : {{ motd_content_before.stdout | default('vacío') }}"
         - "" 
         - " Archivo /etc/issue:"
         - " Cotenido: {{ issue_content_before.stdout  | default('N/A')}}"
         - ""
         - " Archivo /etc/issue:"
         - " Contenido: {{ issue_content_before.stdout | default('vacío') }}"
         - " Permisos: {{ issue_stat_before.stat.mode | default('N/A') }}"
         - ""
      
    - name: CIS 8.1 - Remediacion . Crear mensaje en /etc/motd 
      copy: 
        content: "Auutorized users only. All activity may be monitored and reported"
        dest: /etc/motd
        owner: root 
        group: root 
        mode: '0644'
      register: motd_updated

    - name: CIS 8.1 - remediacion - Crear mensaje en etc/issue 
      copy: 
        content: "Auutorized users only. All activity may be monitored and reported"
        dest: /etc/issue
        owner: root 
        group: root 
        mode: '0644'
      register: issue_updated 

    - name: CIS 8.1 - Remedeacion - mensaje de cambios aplicados 
      debug: 
        msg: 
          - "┌─────────────────────────────────────────────────────────────────────────┐"
          - "│ REMEDIACIÓN APLICADA - CIS 8.1                                           │"
          - "└─────────────────────────────────────────────────────────────────────────┘"
          - ""
          - "   Banner de login configurado en /etc/motd"
          - "   Banner de login configurado en /etc/issue"
          - "   Permisos establecidos: 644 (rw-r--r--)"
          - "   Propietario: root:root"
          - ""
       when: motd_updated.changed or issue_updated.changed 
   
   - name: CIS 8.1 - Remediacion - Conforme 
     debug: 
       msg: 
          - "┌─────────────────────────────────────────────────────────────────────────┐"
          - "│ ESTADO CONFORME - CIS 8.1                                               │"
          - "└─────────────────────────────────────────────────────────────────────────┘"
          - ""
          - "   Banners de login ya están correctamente configurados"
          - "   No se requieren cambios"
          - ""
      when: not (motd_updated.changed or issue_updated.changed)

  
   - name: CIS 8.1 - Validacion - verificar contenido 
     shell: "cat /etc/motd"
     register: motd_content_after
     changed_when: false

   - name: CIS 8.1 - Validacion - verificar permisos finales de /etc/motd
     shell: "cat /etc/issue "
     register: issue_content_after
     changed_when: false

   - name: CIS 8.1 - Validación - Verificar contenido final de /etc/issue
      shell: "cat /etc/issue"
      register: issue_content_after
      changed_when: false

  
  - name: CIS 8.1 - Validación - Confirmar configuración
      assert:
        that:
          - "'Authorized users only' in motd_content_after.stdout"
          - "'Authorized users only' in issue_content_after.stdout"
          - motd_stat_after.stat.mode == '0644'
          - issue_stat_after.stat.mode == '0644'
          - motd_stat_after.stat.pw_name == 'root'
          - issue_stat_after.stat.pw_name == 'root'
        fail_msg: "ERROR: Banners de login no están correctamente configurados"
        success_msg: " Validación exitosa: Banners de login configurados correctamente"

  - name: CIS 8.1 - Validación - Registrar estado final
      lineinfile:
        path: "{{ audit_log }}"
        line: "[{{ ansible_date_time.iso8601 }}] CIS 8.1 - Estado POST: /etc/motd={{ motd_stat_after.stat.mode }}, /etc/issue={{ issue_stat_after.stat.mode }} - CONFORME"
        create: yes
        
   - name: CIS 8.3 - Inicio de remediación
      debug:
        msg: 
          - "┌─────────────────────────────────────────────────────────────────────────┐"
          - "│ CONTROL 8.3 - Enable Warning Banner for SSH Service                     │"
          - "└─────────────────────────────────────────────────────────────────────────┘"
          - ""

   - name: CIS 8.3 - Auditoría - Verificar configuración actual de Banner SSH
      shell: "grep '^Banner' /etc/ssh/sshd_config"
      register: ssh_banner_before
      changed_when: false
      ignore_errors: yes

   - name: CIS 8.3 - Auditoría - Verificar línea comentada de Banner
      shell: "grep '^#Banner' /etc/ssh/sshd_config"
      register: ssh_banner_commented
      changed_when: false
      ignore_errors: yes

   - name: CIS 8.3 - Auditoría - Registrar estado inicial
     lineinfile:
       path: "{{ audit_log }}"
       line: "[{{ ansible_date_time.iso8601 }}] CIS 8.3 - Estado PRE: Banner SSH={{ ssh_banner_before.stdout | default('No configurado') }}"
       create: yes

   - name: CIS 8.3 - Auditoría - Mostrar estado inicial
     debug:
        msg:
          - "┌─────────────────────────────────────────────────────────────────────────┐"
          - "│ ESTADO INICIAL - CIS 8.3                                                 │"
          - "└─────────────────────────────────────────────────────────────────────────┘"
          - ""
          - "  Configuración actual: {{ ssh_banner_before.stdout | default('No configurado') }}"
          - "  Banner comentado: {{ 'Sí' if ssh_banner_commented.rc == 0 else 'No' }}"
          - ""

    - name: CIS 8.3 - Remediación - Descomentar y configurar Banner en sshd_config
      shell: |
        awk '/^#Banner/ { $1 = "Banner /etc/issue" } /^Banner/ && !/\/etc\/issue/ { $0 = "Banner /etc/issue" } { print }' /etc/ssh/sshd_config > /etc/ssh/sshd_config.CIS
        mv /etc/ssh/sshd_config.CIS /etc/ssh/sshd_config
      when: ssh_banner_before.rc != 0 or 'Banner /etc/issue' not in ssh_banner_before.stdout
      register: ssh_config_updated

    - name: CIS 8.3 - Remediación - Reiniciar servicio SSH
      shell: "svcadm restart svc:/network/ssh"
      when: ssh_config_updated.changed
      register: ssh_restarted

    - name: CIS 8.3 - Remediación - Mensaje de cambios aplicados
      debug:
        msg:
          - "┌─────────────────────────────────────────────────────────────────────────┐"
          - "│ REMEDIACIÓN APLICADA - CIS 8.3                                           │"
          - "└─────────────────────────────────────────────────────────────────────────┘"
          - ""
          - "   Banner SSH configurado a /etc/issue"
          - "   Servicio SSH reiniciado"
          - "   Advertencia legal se mostrará antes de autenticación SSH"
          - ""
      when: ssh_config_updated.changed

    - name: CIS 8.3 - Remediación - Ya conforme
      debug:
        msg:
          - "┌─────────────────────────────────────────────────────────────────────────┐"
          - "│ ESTADO CONFORME - CIS 8.3                                                │"
          - "└─────────────────────────────────────────────────────────────────────────┘"
          - ""
          - "   Banner SSH ya está correctamente configurado"
          - "  No se requieren cambios"
          - ""
      when: not ssh_config_updated.changed

    - name: CIS 8.3 - Validación - Verificar configuración final
      shell: "grep '^Banner' /etc/ssh/sshd_config"
      register: ssh_banner_after
      changed_when: false

    - name: CIS 8.3 - Validación - Confirmar configuración
      assert:
        that:
          - "'Banner /etc/issue' in ssh_banner_after.stdout"
        fail_msg: "ERROR: Banner SSH no está correctamente configurado"
        success_msg: "Validación exitosa: Banner SSH configurado correctamente"

    - name: CIS 8.3 - Validación - Mostrar resultado final
      debug:
        msg:
          - "┌─────────────────────────────────────────────────────────────────────────┐"
          - "│ VALIDACIÓN FINAL - CIS 8.3                                               │"
          - "└─────────────────────────────────────────────────────────────────────────┘"
          - ""
          - "  Configuración: {{ ssh_banner_after.stdout }}"
          - ""
          - "  Usuarios SSH verán advertencia legal antes de login"
          - " Sistema conforme con CIS Benchmark 8.3"
          - ""

    - name: CIS 8.3 - Validación - Registrar estado final
      lineinfile:
        path: "{{ audit_log }}"
        line: "[{{ ansible_date_time.iso8601 }}] CIS 8.3 - Estado POST: {{ ssh_banner_after.stdout }} - CONFORME"
        create: yes
  
   - name: CIS 8.4 - Inicio de remediación
      debug:
        msg: 
          - "┌─────────────────────────────────────────────────────────────────────────┐"
          - "│ CONTROL 8.4 - Enable Warning Banner for GNOME Service                   │"
          - "└─────────────────────────────────────────────────────────────────────────┘"
          - ""

    - name: CIS 8.4 - Auditoría - Verificar si GDM está instalado
      stat:
        path: /etc/gdm/Init/Default
      register: gdm_installed

    - name: CIS 8.4 - Auditoría - Verificar configuración actual de GDM
      shell: "grep 'Security Message' /etc/gdm/Init/Default"
      register: gdm_banner_before
      changed_when: false
      ignore_errors: yes
      when: gdm_installed.stat.exists

    - name: CIS 8.4 - Auditoría - Registrar estado inicial
      lineinfile:
        path: "{{ audit_log }}"
        line: "[{{ ansible_date_time.iso8601 }}] CIS 8.4 - Estado PRE: GDM={{ 'Instalado' if gdm_installed.stat.exists else 'No instalado' }}, Banner={{ 'Configurado' if gdm_banner_before.rc == 0 else 'No configurado' }}"
        create: yes
      when: gdm_installed.stat.exists

    - name: CIS 8.4 - Auditoría - Mostrar estado inicial
      debug:
        msg:
          - "┌─────────────────────────────────────────────────────────────────────────┐"
          - "│ ESTADO INICIAL - CIS 8.4                                                 │"
          - "└─────────────────────────────────────────────────────────────────────────┘"
          - ""
          - "  GDM instalado: {{ 'Sí' if gdm_installed.stat.exists else 'No' }}"
          - "  Banner configurado: {{ 'Sí' if gdm_banner_before.rc == 0 else 'No' }}"
          - ""

    - name: CIS 8.4 - Remediación - Configurar banner en GDM
      lineinfile:
        path: /etc/gdm/Init/Default
        insertbefore: '^exit 0$'
        line: '/usr/bin/zenity --text-info --width=800 --height=300 --title="Security Message" --filename=/etc/issue'
        state: present
      when: 
        - gdm_installed.stat.exists
        - gdm_banner_before.rc != 0
      register: gdm_config_updated

    - name: CIS 8.4 - Remediación - Mensaje de cambios aplicados
      debug:
        msg:
          - "┌─────────────────────────────────────────────────────────────────────────┐"
          - "│ REMEDIACIÓN APLICADA - CIS 8.4                                           │"
          - "└─────────────────────────────────────────────────────────────────────────┘"
          - ""
          - "   Banner GNOME configurado"
          - "   Advertencia legal se mostrará en login gráfico"
          - ""
      when: gdm_config_updated.changed

    - name: CIS 8.4 - Remediación - Ya conforme o no aplicable
      debug:
        msg:
          - "┌─────────────────────────────────────────────────────────────────────────┐"
          - "│ ESTADO - CIS 8.4                                                         │"
          - "└─────────────────────────────────────────────────────────────────────────┘"
          - ""
          - "  {{ ' Banner GNOME ya está configurado' if gdm_installed.stat.exists and gdm_banner_before.rc == 0 else ' GDM no está instalado - Control no aplicable' }}"
          - "  {{ ' No se requieren cambios' if gdm_installed.stat.exists and gdm_banner_before.rc == 0 else '' }}"
          - ""
      when: not gdm_config_updated.changed

    - name: CIS 8.4 - Validación - Verificar configuración final
      shell: "grep 'Security Message' /etc/gdm/Init/Default"
      register: gdm_banner_after
      changed_when: false
      when: gdm_installed.stat.exists

    - name: CIS 8.4 - Validación - Confirmar configuración
      assert:
        that:
          - "'Security Message' in gdm_banner_after.stdout"
          - "'--filename=/etc/issue' in gdm_banner_after.stdout"
        fail_msg: "ERRO: Banner GDM no está correctamente configurado"
        success_msg: "Validación exitosa: Banner GDM configurado correctamente"
      when: gdm_installed.stat.exists

    - name: CIS 8.4 - Validación - Mostrar resultado final
      debug:
        msg:
          - "┌─────────────────────────────────────────────────────────────────────────┐"
          - "│ VALIDACIÓN FINAL - CIS 8.4                                               │"
          - "└─────────────────────────────────────────────────────────────────────────┘"
          - ""
          - "  Estado: {{ 'CONFORME' if gdm_installed.stat.exists else 'NO APLICABLE (GDM no instalado)' }}"
          - "  {{ 'Configuración verificada en /etc/gdm/Init/Default' if gdm_installed.stat.exists else '' }}"
          - ""
          - "  {{ ' Usuarios de login gráfico verán advertencia legal' if gdm_installed.stat.exists else ' Control no aplicable en este sistema' }}"
          - "  {{ ' Sistema conforme con CIS Benchmark 8.4' if gdm_installed.stat.exists else '' }}"
          - ""

    - name: CIS 8.4 - Validación - Registrar estado final
      lineinfile:
        path: "{{ audit_log }}"
        line: "[{{ ansible_date_time.iso8601 }}] CIS 8.4 - Estado POST: {{ 'CONFORME' if gdm_installed.stat.exists else 'NO APLICABLE' }}"
        create: yes

   - name: CIS 8.5 - Inicio de remediación
      debug:
        msg: 
          - "┌─────────────────────────────────────────────────────────────────────────┐"
          - "│ CONTROL 8.5 - Banner Setting for telnet is Null                         │"
          - "└─────────────────────────────────────────────────────────────────────────┘"
          - ""

    - name: CIS 8.5 - Auditoría - Verificar si telnetd existe
      stat:
        path: /etc/default/telnetd
      register: telnetd_exists

    - name: CIS 8.5 - Auditoría - Verificar configuración actual de BANNER
      shell: "grep '^BANNER' /etc/default/telnetd"
      register: telnet_banner_before
      changed_when: false
      ignore_errors: yes
      when: telnetd_exists.stat.exists

    - name: CIS 8.5 - Auditoría - Registrar estado inicial
      lineinfile:
        path: "{{ audit_log }}"
        line: "[{{ ansible_date_time.iso8601 }}] CIS 8.5 - Estado PRE: telnetd={{ 'Existe' if telnetd_exists.stat.exists else 'No existe' }}, BANNER={{ telnet_banner_before.stdout | default('N/A') }}"
        create: yes
      when: telnetd_exists.stat.exists

    - name: CIS 8.5 - Auditoría - Mostrar estado inicial
      debug:
        msg:
          - "┌─────────────────────────────────────────────────────────────────────────┐"
          - "│ ESTADO INICIAL - CIS 8.5                                                 │"
          - "└─────────────────────────────────────────────────────────────────────────┘"
          - ""
          - "  Archivo telnetd: {{ 'Existe' if telnetd_exists.stat.exists else 'No existe' }}"
          - "  {{ 'BANNER actual: ' + telnet_banner_before.stdout if telnetd_exists.stat.exists and telnet_banner_before.rc == 0 else '' }}"
          - ""

    - name: CIS 8.5 - Remediación - Configurar BANNER como null
      shell: |
        cd /etc/default
        awk '/^BANNER=/ { $0 = "BANNER=" }; { print }' telnetd > telnetd.CIS
        mv telnetd.CIS telnetd
      when: 
        - telnetd_exists.stat.exists
        - telnet_banner_before.rc == 0
        - telnet_banner_before.stdout != "BANNER="
      register: telnet_config_updated

    - name: CIS 8.5 - Remediación - Mensaje de cambios aplicados
      debug:
        msg:
          - "┌─────────────────────────────────────────────────────────────────────────┐"
          - "│ REMEDIACIÓN APLICADA - CIS 8.5                                           │"
          - "└─────────────────────────────────────────────────────────────────────────┘"
          - ""
          - "  BANNER de telnet configurado como null"
          - "  Se previene divulgación de información del sistema"
          - "  Considerar deshabilitar telnet completamente (usar SSH)"
          - ""
      when: telnet_config_updated.changed

    - name: CIS 8.5 - Remediación - Ya conforme o no aplicable
      debug:
        msg:
          - "┌─────────────────────────────────────────────────────────────────────────┐"
          - "│ ESTADO - CIS 8.5                                                         │"
          - "└─────────────────────────────────────────────────────────────────────────┘"
          - ""
          - "  {{ ' BANNER de telnet ya está configurado como null' if telnetd_exists.stat.exists and telnet_banner_before.stdout == 'BANNER=' else ' telnetd no está configurado - Control no aplicable' }}"
          - "  {{ ' No se requieren cambios' if telnetd_exists.stat.exists and telnet_banner_before.stdout == 'BANNER=' else '' }}"
          - ""
      when: not telnet_config_updated.changed

    - name: CIS 8.5 - Validación - Verificar configuración final
      shell: "grep '^BANNER' /etc/default/telnetd"
      register: telnet_banner_after
      changed_when: false
      when: telnetd_exists.stat.exists

    - name: CIS 8.5 - Validación - Confirmar configuración
      assert:
        that:
          - "telnet_banner_after.stdout == 'BANNER='"
        fail_msg: "ERROR: BANNER de telnet no está correctamente configurado como null"
        success_msg: "Validación exitosa: BANNER de telnet es null"
      when: telnetd_exists.stat.exists

    - name: CIS 8.5 - Validación - Mostrar resultado final
      debug:
        msg:
          - "┌─────────────────────────────────────────────────────────────────────────┐"
          - "│ VALIDACIÓN FINAL - CIS 8.5                                               │"
          - "└─────────────────────────────────────────────────────────────────────────┘"
          - ""
          - "  Estado: {{ 'CONFORME' if telnetd_exists.stat.exists else 'NO APLICABLE (telnetd no existe)' }}"
          - "  {{ 'Configuración: ' + telnet_banner_after.stdout if telnetd_exists.stat.exists else '' }}"
          - ""
          - "  {{ ' BANNER de telnet no divulga información del sistema' if telnetd_exists.stat.exists else ' Control no aplicable en este sistema' }}"
          - "  {{ ' Recomendación: Considere deshabilitar telnet y usar SSH' if telnetd_exists.stat.exists else '' }}"
          - "  {{ 'Sistema conforme con CIS Benchmark 8.5' if telnetd_exists.stat.exists else '' }}"
          - ""

    - name: CIS 8.5 - Validación - Registrar estado final
      lineinfile:
        path: "{{ audit_log }}"
        line: "[{{ ansible_date_time.iso8601 }}] CIS 8.5 - Estado POST: {{ 'BANNER=null - CONFORME' if telnetd_exists.stat.exists else 'NO APLICABLE' }}"
        create: yes

   - name: CIS 9.2 - Inicio de remediación
      debug:
        msg: 
          - "┌─────────────────────────────────────────────────────────────────────────┐"
          - "│ CONTROL 9.2 - Check for Duplicate User Names                            │"
          - "└─────────────────────────────────────────────────────────────────────────┘"
          - ""

    - name: CIS 9.2 - Auditoría - Verificar nombres de usuario duplicados
      shell: |
        getent passwd | cut -f1 -d":" | sort -n | uniq -c | while read x; do
          [ -z "${x}" ] && break
          set - $x
          if [ $1 -gt 1 ]; then
            gids=$(getent passwd | nawk -F: '($1 == n) { print $3 }' n=$2 | xargs)
            echo "Duplicate User Name ($2): ${gids}"
          fi
        done
      register: duplicate_users
      changed_when: false
      ignore_errors: yes

    - name: CIS 9.2 - Auditoría - Registrar estado inicial
      lineinfile:
        path: "{{ audit_log }}"
        line: "[{{ ansible_date_time.iso8601 }}] CIS 9.2 - Estado PRE: Usuarios duplicados={{ 'Encontrados' if duplicate_users.stdout != '' else 'Ninguno' }}"
        create: yes

    - name: CIS 9.2 - Auditoría - Mostrar estado inicial
      debug:
        msg:
          - "┌─────────────────────────────────────────────────────────────────────────┐"
          - "│ ESTADO INICIAL - CIS 9.2                                                 │"
          - "└─────────────────────────────────────────────────────────────────────────┘"
          - ""
          - "  Usuarios duplicados encontrados:"
          - "{{ '    ' + duplicate_users.stdout if duplicate_users.stdout != '' else '     Ninguno' }}"
          - ""

    - name: CIS 9.2 - Análisis - Control manual requerido
      debug:
        msg:
          - "┌─────────────────────────────────────────────────────────────────────────┐"
          - "│ ACCIÓN REQUERIDA - CIS 9.2                                               │"
          - "└─────────────────────────────────────────────────────────────────────────┘"
          - ""
          - "  USUARIOS DUPLICADOS DETECTADOS:"
          - "{{ duplicate_users.stdout_lines | map('regex_replace', '^', '    ') | list }}"
          - ""
          - "  ACCIÓN MANUAL REQUERIDA:"
          - "    1. Revisar cada usuario duplicado con su propietario"
          - "    2. Determinar cuál UID debe mantenerse"
          - "    3. Renombrar o eliminar usuarios según política del sitio"
          - "    4. Verificar acceso a archivos y permisos después del cambio"
          - ""
          - "  Este control requiere intervención manual y no puede ser"
          - "    automatizado debido al riesgo de pérdida de acceso a datos"
          - ""
      when: duplicate_users.stdout != ""

    - name: CIS 9.2 - Validación - Sistema conforme
      debug:
        msg:
          - "┌─────────────────────────────────────────────────────────────────────────┐"
          - "│ ESTADO CONFORME - CIS 9.2                                                │"
          - "└─────────────────────────────────────────────────────────────────────────┘"
          - ""
          - "   No se encontraron nombres de usuario duplicados"
          - "   Sistema conforme con CIS Benchmark 9.2"
          - ""
      when: duplicate_users.stdout == ""

    - name: CIS 9.2 - Validación - Registrar estado final
      lineinfile:
        path: "{{ audit_log }}"
        line: "[{{ ansible_date_time.iso8601 }}] CIS 9.2 - Estado POST: {{ 'CONFORME - Sin duplicados' if duplicate_users.stdout == '' else 'REVISIÓN MANUAL REQUERIDA' }}"
        create: yes


    - name: CIS 9.3 - Inicio de remediación
      debug:
        msg: 
          - "┌─────────────────────────────────────────────────────────────────────────┐"
          - "│ CONTROL 9.3 - Check That Defined Home Directories Exist                 │"
          - "└─────────────────────────────────────────────────────────────────────────┘"
          - ""

    - name: CIS 9.3 - Auditoría - Verificar directorios home inexistentes
      shell: |
        logins -xo | while read line; do
          user=$(echo ${line} | awk -F: '{ print $1 }')
          home=$(echo ${line} | awk -F: '{ print $6 }')
          if [ ! -d "${home}" ]; then
            echo "${user}:${home}"
          fi
        done
      register: missing_homes
      changed_when: false
      ignore_errors: yes

    - name: CIS 9.3 - Auditoría - Filtrar usuarios del sistema esperados
      set_fact:
        missing_homes_filtered: "{{ missing_homes.stdout_lines | select('match', '^(?!uucp|nuucp).*') | list }}"
      when: missing_homes.stdout != ""

    - name: CIS 9.3 - Auditoría - Registrar estado inicial
      lineinfile:
        path: "{{ audit_log }}"
        line: "[{{ ansible_date_time.iso8601 }}] CIS 9.3 - Estado PRE: Directorios home faltantes={{ missing_homes_filtered | default([]) | length }}"
        create: yes

    - name: CIS 9.3 - Auditoría - Mostrar estado inicial
      debug:
        msg:
          - "┌─────────────────────────────────────────────────────────────────────────┐"
          - "│ ESTADO INICIAL - CIS 9.3                                                 │"
          - "└─────────────────────────────────────────────────────────────────────────┘"
          - ""
          - "  Usuarios sin directorio home (excluyendo uucp/nuucp):"
          - "{{ missing_homes_filtered | default([]) | map('regex_replace', '^', '    ') | list if missing_homes_filtered | default([]) | length > 0 else ['     Todos los directorios home existen'] }}"
          - ""

    - name: CIS 9.3 - Análisis - Control manual requerido
      debug:
        msg:
          - "┌─────────────────────────────────────────────────────────────────────────┐"
          - "│ ACCIÓN REQUERIDA - CIS 9.3                                               │"
          - "└─────────────────────────────────────────────────────────────────────────┘"
          - ""
          - "  USUARIOS SIN DIRECTORIO HOME:"
          - "{{ missing_homes_filtered | map('regex_replace', '^', '    ') | list }}"
          - ""
          - "  ACCIÓN MANUAL REQUERIDA:"
          - "    1. Contactar a cada usuario afectado"
          - "    2. Determinar si el directorio debe crearse o si el usuario"
          - "       debe ser actualizado con la ruta correcta"
          - "    3. Crear directorios faltantes con permisos apropiados:"
          - "       # mkdir -p /export/home/[username]"
          - "       # chown [username]:[group] /export/home/[username]"
          - "       # chmod 750 /export/home/[username]"
          - "    4. O actualizar /etc/passwd con la ruta correcta"
          - ""
          - "   Nota: uucp y nuucp no requieren directorio home por diseño"
          - ""
      when: missing_homes_filtered | default([]) | length > 0

    - name: CIS 9.3 - Validación - Sistema conforme
      debug:
        msg:
          - "┌─────────────────────────────────────────────────────────────────────────┐"
          - "│ ESTADO CONFORME - CIS 9.3                                                │"
          - "└─────────────────────────────────────────────────────────────────────────┘"
          - ""
          - "   Todos los directorios home definidos existen"
          - "   Sistema conforme con CIS Benchmark 9.3"
          - ""
      when: missing_homes_filtered | default([]) | length == 0

    - name: CIS 9.3 - Validación - Registrar estado final
      lineinfile:
        path: "{{ audit_log }}"
        line: "[{{ ansible_date_time.iso8601 }}] CIS 9.3 - Estado POST: {{ 'CONFORME - Todos los homes existen' if missing_homes_filtered | default([]) | length == 0 else 'REVISIÓN MANUAL REQUERIDA' }}"
        create: yes

   

    - name: CIS 9.4 - Inicio de remediación
      debug:
        msg: 
          - "┌─────────────────────────────────────────────────────────────────────────┐"
          - "│ CONTROL 9.4 - Verify System Account Default Passwords                   │"
          - "└─────────────────────────────────────────────────────────────────────────┘"
          - ""

    - name: CIS 9.4 - Auditoría - Verificar cuentas del sistema no bloqueadas
      shell: |
        for user in $(logins -s | awk '{ print $1 }'); do
          if [ "${user}" != "root" ]; then
            stat=$(passwd -s ${user} 2>/dev/null | awk '{ print $2 }')
            if [ "${stat}" != "LK" ] && [ "${stat}" != "NL" ]; then
              echo "Account ${user} is not locked or non-login (Status: ${stat})"
            fi
          fi
        done
      register: unlocked_system_accounts
      changed_when: false
      ignore_errors: yes

    - name: CIS 9.4 - Auditoría - Registrar estado inicial
      lineinfile:
        path: "{{ audit_log }}"
        line: "[{{ ansible_date_time.iso8601 }}] CIS 9.4 - Estado PRE: Cuentas sistema desbloqueadas={{ 'Encontradas' if unlocked_system_accounts.stdout != '' else 'Ninguna' }}"
        create: yes

    - name: CIS 9.4 - Auditoría - Mostrar estado inicial
      debug:
        msg:
          - "┌─────────────────────────────────────────────────────────────────────────┐"
          - "│ ESTADO INICIAL - CIS 9.4                                                 │"
          - "└─────────────────────────────────────────────────────────────────────────┘"
          - ""
          - "  Cuentas del sistema sin bloquear/non-login:"
          - "{{ unlocked_system_accounts.stdout_lines | map('regex_replace', '^', '    ') | list if unlocked_system_accounts.stdout != '' else ['     Todas las cuentas del sistema están bloqueadas o non-login'] }}"
          - ""

    - name: CIS 9.4 - Remediación - Extraer nombres de cuentas a bloquear
      set_fact:
        accounts_to_lock: "{{ unlocked_system_accounts.stdout_lines | map('regex_search', 'Account (\\S+)', '\\1') | select('string') | map('first') | list }}"
      when: unlocked_system_accounts.stdout != ""

    - name: CIS 9.4 - Remediación - Bloquear cuentas del sistema
      shell: |
        passwd -d {{ item }}
        passwd -l {{ item }}
      loop: "{{ accounts_to_lock }}"
      when: 
        - unlocked_system_accounts.stdout != ""
        - accounts_to_lock is defined
        - accounts_to_lock | length > 0
      register: accounts_locked
      ignore_errors: yes

    - name: CIS 9.4 - Remediación - Mensaje de cambios aplicados
      debug:
        msg:
          - "┌─────────────────────────────────────────────────────────────────────────┐"
          - "│ REMEDIACIÓN APLICADA - CIS 9.4                                           │"
          - "└─────────────────────────────────────────────────────────────────────────┘"
          - ""
          - "   Cuentas del sistema bloqueadas:"
          - "{{ accounts_to_lock | map('regex_replace', '^', '    - ') | list }}"
          - ""
          - "   Las cuentas ahora están en estado LK (Locked)"
          - "   No se puede usar login interactivo con estas cuentas"
          - ""
      when: 
        - accounts_locked is defined
        - accounts_locked.changed

    - name: CIS 9.4 - Remediación - Ya conforme
      debug:
        msg:
          - "┌─────────────────────────────────────────────────────────────────────────┐"
          - "│ ESTADO CONFORME - CIS 9.4                                                │"
          - "└─────────────────────────────────────────────────────────────────────────┘"
          - ""
          - "   Todas las cuentas del sistema están bloqueadas o non-login"
          - "   No se requieren cambios"
          - ""
      when: unlocked_system_accounts.stdout == ""

    - name: CIS 9.4 - Validación - Verificar estado final de cuentas
      shell: |
        for user in $(logins -s | awk '{ print $1 }'); do
          if [ "${user}" != "root" ]; then
            stat=$(passwd -s ${user} 2>/dev/null | awk '{ print $2 }')
            if [ "${stat}" != "LK" ] && [ "${stat}" != "NL" ]; then
              echo "Account ${user} is not locked or non-login (Status: ${stat})"
            fi
          fi
        done
      register: unlocked_system_accounts_after
      changed_when: false
      ignore_errors: yes

    - name: CIS 9.4 - Validación - Confirmar configuración
      assert:
        that:
          - unlocked_system_accounts_after.stdout == ""
        fail_msg: "ERROR: Algunas cuentas del sistema no están bloqueadas o non-login"
        success_msg: " Validación exitosa: Todas las cuentas del sistema están bloqueadas o non-login"

    - name: CIS 9.4 - Validación - Mostrar resultado final
      debug:
        msg:
          - "┌─────────────────────────────────────────────────────────────────────────┐"
          - "│ VALIDACIÓN FINAL - CIS 9.4                                               │"
          - "└─────────────────────────────────────────────────────────────────────────┘"
          - ""
          - "  Estado: CONFORME"
          - ""
          - "   Todas las cuentas del sistema (excepto root) están:"
          - "    - Bloqueadas (LK) o"
          - "    - Configuradas como non-login (NL)"
          - "   Se previene uso interactivo de cuentas del sistema"
          - "   Sistema conforme con CIS Benchmark 9.4"
          - ""

    - name: CIS 9.4 - Validación - Registrar estado final
      lineinfile:
        path: "{{ audit_log }}"
        line: "[{{ ansible_date_time.iso8601 }}] CIS 9.4 - Estado POST: CONFORME - Todas las cuentas del sistema bloqueadas/non-login"
        create: yes

    - name: CIS 9.5 - Inicio de remediación
      debug:
        msg: 
          - "┌─────────────────────────────────────────────────────────────────────────┐"
          - "│ CONTROL 9.5 - Verify System File Permissions (Manual)                   │"
          - "└─────────────────────────────────────────────────────────────────────────┘"
          - ""

    - name: CIS 9.5 - Auditoría - Ejecutar pkg verify (puede tardar varios minutos)
      shell: "pkg verify 2>&1"
      register: pkg_verify_output
      changed_when: false
      ignore_errors: yes
      async: 600
      poll: 10

    - name: CIS 9.5 - Auditoría - Contar errores encontrados
      set_fact:
        pkg_errors_count: "{{ pkg_verify_output.stdout_lines | select('search', 'ERROR|WARN') | list | length }}"
      when: pkg_verify_output.stdout != ""

    - name: CIS 9.5 - Auditoría - Registrar estado inicial
      lineinfile:
        path: "{{ audit_log }}"
        line: "[{{ ansible_date_time.iso8601 }}] CIS 9.5 - Estado PRE: pkg verify encontró {{ pkg_errors_count | default(0) }} errores/advertencias"
        create: yes

    - name: CIS 9.5 - Auditoría - Mostrar estado inicial
      debug:
        msg:
          - "┌─────────────────────────────────────────────────────────────────────────┐"
          - "│ ESTADO INICIAL - CIS 9.5                                                 │"
          - "└─────────────────────────────────────────────────────────────────────────┘"
          - ""
          - "  Resultado de 'pkg verify':"
          - "    Errores/Advertencias encontrados: {{ pkg_errors_count | default(0) }}"
          - ""
          - "{{ '  Primeros 20 errores:' if pkg_errors_count | default(0) | int > 0 else '   No se encontraron errores' }}"
          - "{{ pkg_verify_output.stdout_lines | select('search', 'ERROR|WARN') | list | slice(20) | map('regex_replace', '^', '    ') | list if pkg_errors_count | default(0) | int > 0 else [] }}"
          - "{{ '  ... (ver log completo en ' + audit_log + ')' if pkg_errors_count | default(0) | int > 20 else '' }}"
          - ""

    - name: CIS 9.5 - Auditoría - Guardar salida completa en archivo
      copy:
        content: "{{ pkg_verify_output.stdout }}"
        dest: "/var/tmp/pkg_verify_output_{{ ansible_date_time.epoch }}.txt"
      when: pkg_errors_count | default(0) | int > 0

    - name: CIS 9.5 - Análisis - Control manual requerido
      debug:
        msg:
          - "┌─────────────────────────────────────────────────────────────────────────┐"
          - "│ ACCIÓN REQUERIDA - CIS 9.5                                               │"
          - "└─────────────────────────────────────────────────────────────────────────┘"
          - ""
          - "  ERRORES DE VERIFICACIÓN DETECTADOS: {{ pkg_errors_count }}"
          - ""
          - "  REVISIÓN MANUAL REQUERIDA:"
          - "    1. Revisar el archivo completo:"
          - "       /var/tmp/pkg_verify_output_{{ ansible_date_time.epoch }}.txt"
          - ""
          - "    2. Identificar si los errores son:"
          - "       - Cambios legítimos del benchmark CIS (ej: permisos de cron)"
          - "       - Modificaciones autorizadas del sistema"
          - "       - Problemas de seguridad que requieren corrección"
          - ""
          - "    3. Para corregir errores específicos:"
          - "       # pkg fix <nombre_paquete>"
          - ""
          - "    4. Para corregir todos (¡PRECAUCIÓN!):"
          - "       # pkg fix"
          - "       Nota: Esto puede revertir cambios de seguridad del benchmark"
          - ""
          - "  NO ejecute 'pkg fix' automáticamente - puede revertir"
          - "    configuraciones de seguridad implementadas anteriormente"
          - ""
          - "   Algunos errores esperados por cambios del benchmark CIS:"
          - "    - Ownership de archivos cron"
          - "    - Permisos de archivos de configuración modificados"
          - "    - Servicios deshabilitados"
          - ""
      when: pkg_errors_count | default(0) | int > 0

    - name: CIS 9.5 - Validación - Sistema conforme
      debug:
        msg:
          - "┌─────────────────────────────────────────────────────────────────────────┐"
          - "│ ESTADO CONFORME - CIS 9.5                                                │"
          - "└─────────────────────────────────────────────────────────────────────────┘"
          - ""
          - "   'pkg verify' no encontró errores"
          - "   Todos los archivos del sistema tienen permisos correctos"
          - "   Sistema conforme con CIS Benchmark 9.5"
          - ""
      when: pkg_errors_count | default(0) | int == 0

    - name: CIS 9.5 - Validación - Registrar estado final
      lineinfile:
        path: "{{ audit_log }}"
        line: "[{{ ansible_date_time.iso8601 }}] CIS 9.5 - Estado POST: {{ 'CONFORME - No hay errores' if pkg_errors_count | default(0) | int == 0 else 'REVISIÓN MANUAL REQUERIDA - ' + (pkg_errors_count | string) + ' errores encontrados' }}"
        create: yes

    - name: CIS 9.5 - Validación - Resumen final
      debug:
        msg:
          - "┌─────────────────────────────────────────────────────────────────────────┐"
          - "│ RESUMEN - CIS 9.5                                                        │"
          - "└─────────────────────────────────────────────────────────────────────────┘"
          - ""
          - "  Total de verificaciones: pkg verify completado"
          - "  Errores encontrados: {{ pkg_errors_count | default(0) }}"
          - "  Estado: {{ 'CONFORME' if pkg_errors_count | default(0) | int == 0 else 'REQUIERE REVISIÓN MANUAL' }}"
          - ""
          - "{{ '  Salida completa guardada en:' if pkg_errors_count | default(0) | int > 0 else '' }}"
          - "{{ '  /var/tmp/pkg_verify_output_' + ansible_date_time.epoch + '.txt' if pkg_errors_count | default(0) | int > 0 else '' }}"
          - ""

   - name: CIS 9.6 - Inicio de remediación
      debug:
        msg: 
          - "┌─────────────────────────────────────────────────────────────────────────┐"
          - "│ CONTROL 9.6 - Ensure Password Fields are Not Empty                      │"
          - "└─────────────────────────────────────────────────────────────────────────┘"
          - ""

    - name: CIS 9.6 - Auditoría - Verificar cuentas sin contraseña
      shell: "logins -p"
      register: empty_password_accounts
      changed_when: false
      ignore_errors: yes

    - name: CIS 9.6 - Auditoría - Registrar estado inicial
      lineinfile:
        path: "{{ audit_log }}"
        line: "[{{ ansible_date_time.iso8601 }}] CIS 9.6 - Estado PRE: Cuentas sin contraseña={{ 'Encontradas' if empty_password_accounts.stdout != '' else 'Ninguna' }}"
        create: yes

    - name: CIS 9.6 - Auditoría - Mostrar estado inicial
      debug:
        msg:
          - "┌─────────────────────────────────────────────────────────────────────────┐"
          - "│ ESTADO INICIAL - CIS 9.6                                                 │"
          - "└─────────────────────────────────────────────────────────────────────────┘"
          - ""
          - "  Cuentas sin contraseña encontradas:"
          - "{{ empty_password_accounts.stdout_lines | map('regex_replace', '^', '    ') | list if empty_password_accounts.stdout != '' else ['     Ninguna'] }}"
          - ""

    - name: CIS 9.6 - Remediación - Bloquear cuentas sin contraseña
      shell: "passwd -l {{ item.split()[0] }}"
      loop: "{{ empty_password_accounts.stdout_lines }}"
      when: 
        - empty_password_accounts.stdout != ""
        - item != ""
      register: accounts_locked
      ignore_errors: yes

    - name: CIS 9.6 - Remediación - Mensaje de cambios aplicados
      debug:
        msg:
          - "┌─────────────────────────────────────────────────────────────────────────┐"
          - "│ REMEDIACIÓN APLICADA - CIS 9.6                                           │"
          - "└─────────────────────────────────────────────────────────────────────────┘"
          - ""
          - "   Cuentas sin contraseña bloqueadas:"
          - "{{ empty_password_accounts.stdout_lines | map('regex_replace', '^', '    - ') | list }}"
          - ""
          - "   Las cuentas están ahora bloqueadas y requieren intervención"
          - "    administrativa para establecer contraseñas antes de usar"
          - ""
      when: 
        - accounts_locked is defined
        - accounts_locked.changed

    - name: CIS 9.6 - Remediación - Ya conforme
      debug:
        msg:
          - "┌─────────────────────────────────────────────────────────────────────────┐"
          - "│ ESTADO CONFORME - CIS 9.6                                                │"
          - "└─────────────────────────────────────────────────────────────────────────┘"
          - ""
          - "   No se encontraron cuentas sin contraseña"
          - "   No se requieren cambios"
          - ""
      when: empty_password_accounts.stdout == ""

    - name: CIS 9.6 - Validación - Verificar cuentas sin contraseña después
      shell: "logins -p"
      register: empty_password_accounts_after
      changed_when: false
      ignore_errors: yes

    - name: CIS 9.6 - Validación - Confirmar configuración
      assert:
        that:
          - empty_password_accounts_after.stdout == ""
        fail_msg: "ERROR: Aún existen cuentas sin contraseña"
        success_msg: " Validación exitosa: No hay cuentas sin contraseña"

    - name: CIS 9.6 - Validación - Mostrar resultado final
      debug:
        msg:
          - "┌─────────────────────────────────────────────────────────────────────────┐"
          - "│ VALIDACIÓN FINAL - CIS 9.6                                               │"
          - "└─────────────────────────────────────────────────────────────────────────┘"
          - ""
          - "  Estado: CONFORME"
          - ""
          - "   Todas las cuentas tienen contraseña, están bloqueadas o son non-login"
          - "   Se previene acceso sin autenticación"
          - "   Sistema conforme con CIS Benchmark 9.6"
          - ""

    - name: CIS 9.6 - Validación - Registrar estado final
      lineinfile:
        path: "{{ audit_log }}"
        line: "[{{ ansible_date_time.iso8601 }}] CIS 9.6 - Estado POST: CONFORME - No hay cuentas sin contraseña"
        create: yes


    - name: CIS 9.7 - Inicio de remediación
      debug:
        msg: 
          - "┌─────────────────────────────────────────────────────────────────────────┐"
          - "│ CONTROL 9.7 - Verify No UID 0 Accounts Exist Other than root            │"
          - "└─────────────────────────────────────────────────────────────────────────┘"
          - ""

    - name: CIS 9.7 - Auditoría - Verificar cuentas con UID 0
      shell: "logins -o | awk -F: '($2 == 0) { print $1 }'"
      register: uid_zero_accounts
      changed_when: false
      ignore_errors: yes

    - name: CIS 9.7 - Auditoría - Filtrar solo root
      set_fact:
        non_root_uid_zero: "{{ uid_zero_accounts.stdout_lines | reject('equalto', 'root') | list }}"

    - name: CIS 9.7 - Auditoría - Registrar estado inicial
      lineinfile:
        path: "{{ audit_log }}"
        line: "[{{ ansible_date_time.iso8601 }}] CIS 9.7 - Estado PRE: Cuentas UID 0 adicionales={{ non_root_uid_zero | length }}"
        create: yes

    - name: CIS 9.7 - Auditoría - Mostrar estado inicial
      debug:
        msg:
          - "┌─────────────────────────────────────────────────────────────────────────┐"
          - "│ ESTADO INICIAL - CIS 9.7                                                 │"
          - "└─────────────────────────────────────────────────────────────────────────┘"
          - ""
          - "  Cuentas encontradas con UID 0:"
          - "{{ uid_zero_accounts.stdout_lines | map('regex_replace', '^', '    ') | list }}"
          - ""
          - "  Cuentas adicionales a root con UID 0:"
          - "{{ non_root_uid_zero | map('regex_replace', '^', '     ') | list if non_root_uid_zero | length > 0 else ['     Ninguna'] }}"
          - ""

    - name: CIS 9.7 - Análisis - Control manual requerido
      debug:
        msg:
          - "┌─────────────────────────────────────────────────────────────────────────┐"
          - "│ ACCIÓN REQUERIDA - CIS 9.7                                               │"
          - "└─────────────────────────────────────────────────────────────────────────┘"
          - ""
          - "   CUENTAS ADICIONALES CON UID 0 DETECTADAS:"
          - "{{ non_root_uid_zero | map('regex_replace', '^', '    - ') | list }}"
          - ""
          - "   ACCIÓN MANUAL REQUERIDA:"
          - "    1. Verificar la legitimidad de cada cuenta UID 0"
          - "    2. Determinar si el acceso puede migrarse a RBAC"
          - "    3. Para eliminar cuenta:"
          - "       # userdel [username]"
          - "    4. Para deshabilitar cuenta:"
          - "       # passwd -l [username]"
          - ""
          - "   Recomendación: Use RBAC (Role-Based Access Control) para"
          - "    acceso administrativo granular en lugar de múltiples"
          - "    cuentas con UID 0"
          - ""
          - "   Monitoree configuraciones RBAC en /etc/user_attr"
          - ""
      when: non_root_uid_zero | length > 0

    - name: CIS 9.7 - Validación - Sistema conforme
      debug:
        msg:
          - "┌─────────────────────────────────────────────────────────────────────────┐"
          - "│ ESTADO CONFORME - CIS 9.7                                                │"
          - "└─────────────────────────────────────────────────────────────────────────┘"
          - ""
          - "   Solo la cuenta 'root' tiene UID 0"
          - "   No existen cuentas adicionales con privilegios de superusuario"
          - "   Sistema conforme con CIS Benchmark 9.7"
          - ""
      when: non_root_uid_zero | length == 0

    - name: CIS 9.7 - Validación - Registrar estado final
      lineinfile:
        path: "{{ audit_log }}"
        line: "[{{ ansible_date_time.iso8601 }}] CIS 9.7 - Estado POST: {{ 'CONFORME - Solo root tiene UID 0' if non_root_uid_zero | length == 0 else 'REVISIÓN MANUAL REQUERIDA - ' + (non_root_uid_zero | length | string) + ' cuentas adicionales' }}"
        create: yes

   - name: CIS 9.8 - Inicio de remediación
      debug:
        msg: 
          - "┌─────────────────────────────────────────────────────────────────────────┐"
          - "│ CONTROL 9.8 - Ensure root PATH Integrity                                │"
          - "└─────────────────────────────────────────────────────────────────────────┘"
          - ""

    - name: CIS 9.8 - Auditoría - Verificar directorios vacíos en PATH (::)
      shell: |
        if [ "$(echo $PATH | grep :: )" != "" ]; then
          echo "Empty Directory in PATH (::)"
        fi
      register: path_empty_dir
      changed_when: false
      ignore_errors: yes
      become: yes
      become_user: root

    - name: CIS 9.8 - Auditoría - Verificar trailing colon en PATH
      shell: |
        if [ "$(echo $PATH | grep ':$')" != "" ]; then
          echo "Trailing : in PATH"
        fi
      register: path_trailing_colon
      changed_when: false
      ignore_errors: yes
      become: yes
      become_user: root

    - name: CIS 9.8 - Auditoría - Verificar permisos de directorios en PATH
      shell: |
        #!/usr/bin/bash
        p=$(echo $PATH | sed -e 's/::/:/' -e 's/:$//' -e 's/:/ /g')
        set -- $p
        while [ "$1" != "" ]; do
          if [ "$1" = "." ]; then
            echo "PATH contains ."
            shift
            continue
          fi
          if [ -d $1 ]; then
            dirperm=$(ls -ld $1 | cut -f1 -d" ")
            if [ $(echo $dirperm | cut -c6) != "-" ]; then
              echo "Group Write permission set on directory $1"
            fi
            if [ $(echo $dirperm | cut -c9) != "-" ]; then
              echo "Other Write permission set on directory $1"
            fi
          fi
          shift
        done
      register: path_permissions
      changed_when: false
      ignore_errors: yes
      become: yes
      become_user: root

    - name: CIS 9.8 - Auditoría - Consolidar problemas encontrados
      set_fact:
        path_issues: >-
          {{ [path_empty_dir.stdout, path_trailing_colon.stdout, path_permissions.stdout] 
          | select('string') 
          | select() 
          | list }}

    - name: CIS 9.8 - Auditoría - Registrar estado inicial
      lineinfile:
        path: "{{ audit_log }}"
        line: "[{{ ansible_date_time.iso8601 }}] CIS 9.8 - Estado PRE: Problemas en PATH={{ path_issues | length }}"
        create: yes

    - name: CIS 9.8 - Auditoría - Mostrar estado inicial
      debug:
        msg:
          - "┌─────────────────────────────────────────────────────────────────────────┐"
          - "│ ESTADO INICIAL - CIS 9.8                                                 │"
          - "└─────────────────────────────────────────────────────────────────────────┘"
          - ""
          - "  PATH actual de root: {{ ansible_env.PATH }}"
          - ""
          - "  Problemas detectados en PATH:"
          - "{{ path_issues | map('regex_replace', '^', '     ') | list if path_issues | length > 0 else ['     Ninguno'] }}"
          - ""

    - name: CIS 9.8 - Análisis - Control manual requerido
      debug:
        msg:
          - "┌─────────────────────────────────────────────────────────────────────────┐"
          - "│ ACCIÓN REQUERIDA - CIS 9.8                                               │"
          - "└─────────────────────────────────────────────────────────────────────────┘"
          - ""
          - "   PROBLEMAS DE INTEGRIDAD EN PATH DETECTADOS:"
          - "{{ path_issues | map('regex_replace', '^', '    - ') | list }}"
          - ""
          - "   ACCIÓN MANUAL REQUERIDA:"
          - "    1. Editar archivos de perfil de root:"
          - "       /root/.profile"
          - "       /root/.bashrc (si existe)"
          - "       /.profile"
          - ""
          - "    2. Eliminar problemas detectados:"
          - "       - Quitar '::' (directorios vacíos)"
          - "       - Quitar ':' al final del PATH"
          - "       - Quitar '.' (directorio actual)"
          - "       - Verificar permisos de directorios en PATH"
          - ""
          - "    3. Para corregir permisos de directorios escribibles:"
          - "       # chmod go-w /ruta/directorio"
          - ""
          - "    4. PATH seguro recomendado:"
          - "       PATH=/usr/bin:/usr/sbin:/sbin"
          - ""
          - "   Después de modificar, volver a cargar el perfil:"
          - "    # source /root/.profile"
          - ""
      when: path_issues | length > 0

    - name: CIS 9.8 - Validación - Sistema conforme
      debug:
        msg:
          - "┌─────────────────────────────────────────────────────────────────────────┐"
          - "│ ESTADO CONFORME - CIS 9.8                                                │"
          - "└─────────────────────────────────────────────────────────────────────────┘"
          - ""
          - "   PATH de root no contiene directorios vacíos (::)"
          - "   PATH de root no termina con ':'"
          - "   PATH de root no contiene '.'"
          - "   Directorios en PATH no son escribibles por grupo/otros"
          - "   Sistema conforme con CIS Benchmark 9.8"
          - ""
      when: path_issues | length == 0

    - name: CIS 9.8 - Validación - Registrar estado final
      lineinfile:
        path: "{{ audit_log }}"
        line: "[{{ ansible_date_time.iso8601 }}] CIS 9.8 - Estado POST: {{ 'CONFORME - PATH íntegro' if path_issues | length == 0 else 'REVISIÓN MANUAL REQUERIDA - ' + (path_issues | length | string) + ' problemas' }}"
        create: yes

    - name: CIS 9.9 - Inicio de remediación
      debug:
        msg: 
          - "┌─────────────────────────────────────────────────────────────────────────┐"
          - "│ CONTROL 9.9 - Check Permissions on User Home Directories                │"
          - "└─────────────────────────────────────────────────────────────────────────┘"
          - ""

    - name: CIS 9.9 - Auditoría - Verificar permisos de directorios home
      shell: |
        for dir in $(logins -ox | awk -F: '($8 == "PS") { print $6 }'); do
          if [ -d "${dir}" ]; then
            find ${dir} -type d -prune \( -perm -g+w -o -perm -o+r -o -perm -o+w -o -perm -o+x \) -ls 2>/dev/null
          fi
        done
      register: home_dir_permissions
      changed_when: false
      ignore_errors: yes
      async: 300
      poll: 10

    - name: CIS 9.9 - Auditoría - Registrar estado inicial
      lineinfile:
        path: "{{ audit_log }}"
        line: "[{{ ansible_date_time.iso8601 }}] CIS 9.9 - Estado PRE: Directorios home con permisos incorrectos={{ home_dir_permissions.stdout_lines | length }}"
        create: yes

    - name: CIS 9.9 - Auditoría - Mostrar estado inicial
      debug:
        msg:
          - "┌─────────────────────────────────────────────────────────────────────────┐"
          - "│ ESTADO INICIAL - CIS 9.9                                                 │"
          - "└─────────────────────────────────────────────────────────────────────────┘"
          - ""
          - "  Directorios home con permisos incorrectos:"
          - "{{ home_dir_permissions.stdout_lines[:10] | map('regex_replace', '^', '    ') | list if home_dir_permissions.stdout != '' else ['     Ninguno'] }}"
          - "{{ '    ... (' + ((home_dir_permissions.stdout_lines | length - 10) | string) + ' más)' if home_dir_permissions.stdout_lines | length > 10 else '' }}"
          - ""

    - name: CIS 9.9 - Análisis - Control manual requerido
      debug:
        msg:
          - "┌─────────────────────────────────────────────────────────────────────────┐"
          - "│ ACCIÓN REQUERIDA - CIS 9.9                                               │"
          - "└─────────────────────────────────────────────────────────────────────────┘"
          - ""
          - "   DIRECTORIOS HOME CON PERMISOS INSEGUROS DETECTADOS"
          - ""
          - "  Total de directorios afectados: {{ home_dir_permissions.stdout_lines | length }}"
          - ""
          - "   ACCIÓN MANUAL REQUERIDA:"
          - "    1. Revisar cada directorio home afectado"
          - "    2. Contactar a los usuarios propietarios"
          - "    3. Determinar permisos apropiados según política del sitio"
          - ""
          - "    4. Para corregir permisos (ejemplo):"
          - "       # chmod 750 /export/home/[username]"
          - "       # chmod go-w /export/home/[username]"
          - "       # chmod go-rx /export/home/[username]  # más restrictivo"
          - ""
          - "   Permisos recomendados:"
          - "    - 750 (rwxr-x---): Usuario completo, grupo lectura/ejecución"
          - "    - 700 (rwx------): Solo usuario (más seguro)"
          - ""
          - "   Los usuarios pueden revertir cambios - considere:"
          - "    - Política de seguridad clara"
          - "    - Auditorías periódicas"
          - "    - Capacitación de usuarios"
          - ""
      when: home_dir_permissions.stdout != ""

    - name: CIS 9.9 - Validación - Sistema conforme
      debug:
        msg:
          - "┌─────────────────────────────────────────────────────────────────────────┐"
          - "│ ESTADO CONFORME - CIS 9.9                                                │"
          - "└─────────────────────────────────────────────────────────────────────────┘"
          - ""
          - "   Todos los directorios home tienen permisos seguros"
          - "   No se detectaron directorios escribibles por grupo/otros"
          - "   Sistema conforme con CIS Benchmark 9.9"
          - ""
      when: home_dir_permissions.stdout == ""

    - name: CIS 9.9 - Validación - Registrar estado final
      lineinfile:
        path: "{{ audit_log }}"
        line: "[{{ ansible_date_time.iso8601 }}] CIS 9.9 - Estado POST: {{ 'CONFORME' if home_dir_permissions.stdout == '' else 'REVISIÓN MANUAL REQUERIDA - ' + (home_dir_permissions.stdout_lines | length | string) + ' directorios' }}"
        create: yes

    - name: CIS 9.10 - Inicio de remediación
      debug:
        msg: 
          - "┌─────────────────────────────────────────────────────────────────────────┐"
          - "│ CONTROL 9.10 - Check Permissions on User '.' (Hidden) Files             │"
          - "└─────────────────────────────────────────────────────────────────────────┘"
          - ""
          - "   Nota: Este proceso puede tardar varios minutos en sistemas"
          - "          con gran cantidad de archivos ocultos"
          - ""

    - name: CIS 9.10 - Auditoría - Verificar permisos de archivos ocultos
      shell: |
        for dir in $(logins -ox | awk -F: '($8 == "PS") { print $6 }'); do
          if [ -d "${dir}" ]; then
            find ${dir}/.[A-Za-z0-9]* ! -type l \( -perm -20 -o -perm -02 \) -ls 2>/dev/null
          fi
        done
      register: hidden_files_permissions
      changed_when: false
      ignore_errors: yes
      async: 600
      poll: 15

    - name: CIS 9.10 - Auditoría - Registrar estado inicial
      lineinfile:
        path: "{{ audit_log }}"
        line: "[{{ ansible_date_time.iso8601 }}] CIS 9.10 - Estado PRE: Archivos ocultos con permisos incorrectos={{ hidden_files_permissions.stdout_lines | length }}"
        create: yes

    - name: CIS 9.10 - Auditoría - Mostrar estado inicial
      debug:
        msg:
          - "┌─────────────────────────────────────────────────────────────────────────┐"
          - "│ ESTADO INICIAL - CIS 9.10                                                │"
          - "└─────────────────────────────────────────────────────────────────────────┘"
          - ""
          - "  Archivos ocultos (dot files) con permisos incorrectos:"
          - "{{ hidden_files_permissions.stdout_lines[:15] | map('regex_replace', '^', '    ') | list if hidden_files_permissions.stdout != '' else ['     Ninguno'] }}"
          - "{{ '    ... (' + ((hidden_files_permissions.stdout_lines | length - 15) | string) + ' más)' if hidden_files_permissions.stdout_lines | length > 15 else '' }}"
          - ""

    - name: CIS 9.10 - Análisis - Control manual requerido
      debug:
        msg:
          - "┌─────────────────────────────────────────────────────────────────────────┐"
          - "│ ACCIÓN REQUERIDA - CIS 9.10                                              │"
          - "└─────────────────────────────────────────────────────────────────────────┘"
          - ""
          - "   ARCHIVOS OCULTOS CON PERMISOS INSEGUROS DETECTADOS"
          - ""
          - "  Total de archivos afectados: {{ hidden_files_permissions.stdout_lines | length }}"
          - ""
          - "   ACCIÓN MANUAL REQUERIDA:"
          - "    1. Revisar archivos afectados por usuario"
          - "    2. Contactar a los usuarios propietarios"
          - "    3. Determinar permisos apropiados según política del sitio"
          - ""
          - "    4. Para corregir permisos de archivos de configuración:"
          - "       # chmod go-w /export/home/[user]/.[archivo]"
          - "       # chmod 600 /export/home/[user]/.profile"
          - "       # chmod 600 /export/home/[user]/.bashrc"
          - "       # chmod 600 /export/home/[user]/.ssh/config"
          - ""
          - "   Archivos críticos que deben protegerse:"
          - "    - .profile, .bashrc, .bash_profile (shell configs)"
          - "    - .ssh/* (claves y configuración SSH)"
          - "    - .netrc (credenciales de red)"
          - "    - .pgpass (credenciales PostgreSQL)"
          - ""
          - "   Permisos recomendados para archivos ocultos:"
          - "    - 600 (rw-------): Solo usuario lectura/escritura"
          - "    - 640 (rw-r-----): Usuario r/w, grupo solo lectura"
          - ""
          - "   Los usuarios pueden revertir cambios - considere:"
          - "    - Política de seguridad documentada"
          - "    - Auditorías periódicas automatizadas"
          - "    - Capacitación sobre seguridad de archivos"
          - ""
      when: hidden_files_permissions.stdout != ""

    - name: CIS 9.10 - Validación - Sistema conforme
      debug:
        msg:
          - "┌─────────────────────────────────────────────────────────────────────────┐"
          - "│ ESTADO CONFORME - CIS 9.10                                               │"
          - "└─────────────────────────────────────────────────────────────────────────┘"
          - ""
          - "   Todos los archivos ocultos tienen permisos seguros"
          - "   No se detectaron archivos escribibles por grupo/otros"
          - "   Archivos de configuración de usuarios protegidos"
          - "   Sistema conforme con CIS Benchmark 9.10"
          - ""
      when: hidden_files_permissions.stdout == ""

    - name: CIS 9.10 - Validación - Registrar estado final
      lineinfile:
        path: "{{ audit_log }}"
        line: "[{{ ansible_date_time.iso8601 }}] CIS 9.10 - Estado POST: {{ 'CONFORME' if hidden_files_permissions.stdout == '' else 'REVISIÓN MANUAL REQUERIDA - ' + (hidden_files_permissions.stdout_lines | length | string) + ' archivos' }}"
        create: yes

    - name: CIS 9.10 - Validación - Resumen de archivos críticos
      debug:
        msg:
          - "┌─────────────────────────────────────────────────────────────────────────┐"
          - "│ RESUMEN - CONTROLES 9.9 y 9.10                                          │"
          - "└─────────────────────────────────────────────────────────────────────────┘"
          - ""
          - "  Directorios home revisados: {{ home_dir_permissions.stdout_lines | length if home_dir_permissions.stdout != '' else 0 }}"
          - "  Archivos ocultos revisados: {{ hidden_files_permissions.stdout_lines | length if hidden_files_permissions.stdout != '' else 0 }}"
          - ""
          - "  Estado global: {{ 'CONFORME' if (home_dir_permissions.stdout == '' and hidden_files_permissions.stdout == '') else 'REQUIERE REVISIÓN MANUAL' }}"
          - ""
          - "   Recomendación: Programe auditorías periódicas de permisos"
          - "    de usuario para mantener la conformidad continua"
          - ""

   - name: CIS 9.11 - Inicio de remediación
      debug:
        msg: 
          - "┌─────────────────────────────────────────────────────────────────────────┐"
          - "│ CONTROL 9.11 - Check Permissions on User .netrc Files                   │"
          - "└─────────────────────────────────────────────────────────────────────────┘"
          - ""

    - name: CIS 9.11 - Auditoría - Verificar permisos de archivos .netrc
      shell: |
        for dir in $(logins -ox | awk -F: '($8 == "PS") { print $6 }'); do
          if [ -d "${dir}" ]; then
            find ${dir}/.netrc -type f \( -perm -g+r -o -perm -g+w -o -perm -g+x -o -perm -o+r -o -perm -o+w -o -perm -o+x \) -ls 2>/dev/null
          fi
        done
      register: netrc_permissions
      changed_when: false
      ignore_errors: yes

    - name: CIS 9.11 - Auditoría - Registrar estado inicial
      lineinfile:
        path: "{{ audit_log }}"
        line: "[{{ ansible_date_time.iso8601 }}] CIS 9.11 - Estado PRE: Archivos .netrc inseguros={{ netrc_permissions.stdout_lines | length }}"
        create: yes

    - name: CIS 9.11 - Auditoría - Mostrar estado inicial
      debug:
        msg:
          - "┌─────────────────────────────────────────────────────────────────────────┐"
          - "│ ESTADO INICIAL - CIS 9.11                                                │"
          - "└─────────────────────────────────────────────────────────────────────────┘"
          - ""
          - "  Archivos .netrc con permisos inseguros:"
          - "{{ netrc_permissions.stdout_lines | map('regex_replace', '^', '    ') | list if netrc_permissions.stdout != '' else ['     Ninguno encontrado'] }}"
          - ""

    - name: CIS 9.11 - Análisis - Control manual requerido
      debug:
        msg:
          - "┌─────────────────────────────────────────────────────────────────────────┐"
          - "│ ACCIÓN REQUERIDA - CIS 9.11                                              │"
          - "└─────────────────────────────────────────────────────────────────────────┘"
          - ""
          - "   ARCHIVOS .netrc CON PERMISOS INSEGUROS DETECTADOS"
          - ""
          - "   RIESGO DE SEGURIDAD:"
          - "    - Los archivos .netrc pueden contener contraseñas sin cifrar"
          - "    - Permisos incorrectos exponen credenciales a otros usuarios"
          - "    - Pueden usarse para atacar otros sistemas"
          - ""
          - "   ACCIÓN MANUAL REQUERIDA:"
          - "    1. Contactar a cada usuario afectado"
          - "    2. Revisar contenido de archivos .netrc"
          - "    3. Corregir permisos:"
          - "       # chmod 600 /export/home/[user]/.netrc"
          - ""
          - "    4. Considerar alternativas más seguras:"
          - "       - SSH keys en lugar de .netrc"
          - "       - Credential managers"
          - "       - Eliminar .netrc si no es necesario"
          - ""
          - "   Permisos correctos para .netrc:"
          - "    - 600 (rw-------): OBLIGATORIO"
          - "    - Solo el propietario puede leer/escribir"
          - ""
      when: netrc_permissions.stdout != ""

    - name: CIS 9.11 - Validación - Sistema conforme
      debug:
        msg:
          - "┌─────────────────────────────────────────────────────────────────────────┐"
          - "│ ESTADO CONFORME - CIS 9.11                                               │"
          - "└─────────────────────────────────────────────────────────────────────────┘"
          - ""
          - "   No se encontraron archivos .netrc con permisos inseguros"
          - "   Sistema conforme con CIS Benchmark 9.11"
          - ""
      when: netrc_permissions.stdout == ""

    - name: CIS 9.11 - Validación - Registrar estado final
      lineinfile:
        path: "{{ audit_log }}"
        line: "[{{ ansible_date_time.iso8601 }}] CIS 9.11 - Estado POST: {{ 'CONFORME' if netrc_permissions.stdout == '' else 'REVISIÓN MANUAL REQUERIDA - ' + (netrc_permissions.stdout_lines | length | string) + ' archivos' }}"
        create: yes

    - name: CIS 9.12 - Inicio de remediación
      debug:
        msg: 
          - "┌─────────────────────────────────────────────────────────────────────────┐"
          - "│ CONTROL 9.12 - Check for Presence of User .rhosts Files                 │"
          - "└─────────────────────────────────────────────────────────────────────────┘"
          - ""

    - name: CIS 9.12 - Auditoría - Buscar archivos .rhosts
      shell: |
        for dir in $(logins -ox | awk -F: '($8 == "PS") { print $6 }'); do
          if [ -d "${dir}" ]; then
            find ${dir}/.rhosts -type f -ls 2>/dev/null
          fi
        done
      register: rhosts_files
      changed_when: false
      ignore_errors: yes

    - name: CIS 9.12 - Auditoría - Registrar estado inicial
      lineinfile:
        path: "{{ audit_log }}"
        line: "[{{ ansible_date_time.iso8601 }}] CIS 9.12 - Estado PRE: Archivos .rhosts encontrados={{ rhosts_files.stdout_lines | length }}"
        create: yes

    - name: CIS 9.12 - Auditoría - Mostrar estado inicial
      debug:
        msg:
          - "┌─────────────────────────────────────────────────────────────────────────┐"
          - "│ ESTADO INICIAL - CIS 9.12                                                │"
          - "└─────────────────────────────────────────────────────────────────────────┘"
          - ""
          - "  Archivos .rhosts encontrados:"
          - "{{ rhosts_files.stdout_lines | map('regex_replace', '^', '    ') | list if rhosts_files.stdout != '' else ['     Ninguno'] }}"
          - ""

    - name: CIS 9.12 - Análisis - Control manual requerido
      debug:
        msg:
          - "┌─────────────────────────────────────────────────────────────────────────┐"
          - "│ ACCIÓN REQUERIDA - CIS 9.12                                              │"
          - "└─────────────────────────────────────────────────────────────────────────┘"
          - ""
          - "   ARCHIVOS .rhosts DETECTADOS"
          - ""
          - "  Total de archivos .rhosts: {{ rhosts_files.stdout_lines | length }}"
          - ""
          - "   RIESGO DE SEGURIDAD:"
          - "    - Archivos .rhosts pueden contener información de otros sistemas"
          - "    - Útil para atacantes incluso si .rhosts está deshabilitado en PAM"
          - "    - Mecanismo de autenticación obsoleto e inseguro"
          - ""
          - "   ACCIÓN MANUAL REQUERIDA:"
          - "    1. Contactar a cada usuario afectado"
          - "    2. Revisar contenido de archivos .rhosts"
          - "    3. Determinar si archivos son necesarios"
          - ""
          - "    4. Para eliminar archivos .rhosts:"
          - "       # rm /export/home/[user]/.rhosts"
          - ""
          - "    5. Migrar a métodos seguros:"
          - "       - SSH keys (recomendado)"
          - "       - Kerberos"
          - "       - Certificados"
          - ""
          - "  Nota: Incluso si está deshabilitado en PAM, los archivos"
          - "    .rhosts pueden revelar información sobre la topología de red"
          - ""
      when: rhosts_files.stdout != ""

    - name: CIS 9.12 - Validación - Sistema conforme
      debug:
        msg:
          - "┌─────────────────────────────────────────────────────────────────────────┐"
          - "│ ESTADO CONFORME - CIS 9.12                                               │"
          - "└─────────────────────────────────────────────────────────────────────────┘"
          - ""
          - "   No se encontraron archivos .rhosts"
          - "   Sistema conforme con CIS Benchmark 9.12"
          - ""
      when: rhosts_files.stdout == ""

    - name: CIS 9.12 - Validación - Registrar estado final
      lineinfile:
        path: "{{ audit_log }}"
        line: "[{{ ansible_date_time.iso8601 }}] CIS 9.12 - Estado POST: {{ 'CONFORME' if rhosts_files.stdout == '' else 'REVISIÓN MANUAL REQUERIDA - ' + (rhosts_files.stdout_lines | length | string) + ' archivos' }}"
        create: yes



    - name: CIS 9.13 - Inicio de remediación
      debug:
        msg: 
          - "┌─────────────────────────────────────────────────────────────────────────┐"
          - "│ CONTROL 9.13 - Check Groups in passwd                                   │"
          - "└─────────────────────────────────────────────────────────────────────────┘"
          - ""

    - name: CIS 9.13 - Auditoría - Verificar grupos en passwd sin definir en group
      shell: "logins -xo | awk -F: '($3 == \"\") { print $1 }'"
      register: undefined_groups
      changed_when: false
      ignore_errors: yes

    - name: CIS 9.13 - Auditoría - Registrar estado inicial
      lineinfile:
        path: "{{ audit_log }}"
        line: "[{{ ansible_date_time.iso8601 }}] CIS 9.13 - Estado PRE: Usuarios con grupos no definidos={{ undefined_groups.stdout_lines | length }}"
        create: yes

    - name: CIS 9.13 - Auditoría - Mostrar estado inicial
      debug:
        msg:
          - "┌─────────────────────────────────────────────────────────────────────────┐"
          - "│ ESTADO INICIAL - CIS 9.13                                                │"
          - "└─────────────────────────────────────────────────────────────────────────┘"
          - ""
          - "  Usuarios con grupos definidos en passwd pero no en group:"
          - "{{ undefined_groups.stdout_lines | map('regex_replace', '^', '    ') | list if undefined_groups.stdout != '' else ['     Ninguno'] }}"
          - ""

    - name: CIS 9.13 - Análisis - Control manual requerido
      debug:
        msg:
          - "┌─────────────────────────────────────────────────────────────────────────┐"
          - "│ ACCIÓN REQUERIDA - CIS 9.13                                              │"
          - "└─────────────────────────────────────────────────────────────────────────┘"
          - ""
          - "   GRUPOS NO DEFINIDOS DETECTADOS"
          - ""
          - "  Usuarios afectados:"
          - "{{ undefined_groups.stdout_lines | map('regex_replace', '^', '    - ') | list }}"
          - ""
          - "   RIESGO DE SEGURIDAD:"
          - "    - Permisos de grupo no están correctamente gestionados"
          - "    - Amenaza a la seguridad del sistema"
          - "    - Puede causar problemas de acceso a archivos"
          - ""
          - "   ACCIÓN MANUAL REQUERIDA:"
          - "    1. Para cada usuario, verificar su GID en /etc/passwd:"
          - "       # grep '^[username]:' /etc/passwd"
          - ""
          - "    2. Verificar si el grupo existe en /etc/group:"
          - "       # grep '^.*:.*:[GID]:' /etc/group"
          - ""
          - "    3. Crear el grupo faltante:"
          - "       # groupadd -g [GID] [groupname]"
          - ""
          - "    4. O reasignar usuario a grupo existente:"
          - "       # usermod -g [existing_group] [username]"
          - ""
      when: undefined_groups.stdout != ""

    - name: CIS 9.13 - Validación - Sistema conforme
      debug:
        msg:
          - "┌─────────────────────────────────────────────────────────────────────────┐"
          - "│ ESTADO CONFORME - CIS 9.13                                               │"
          - "└─────────────────────────────────────────────────────────────────────────┘"
          - ""
          - "   Todos los grupos en passwd están definidos en group"
          - "   Sistema conforme con CIS Benchmark 9.13"
          - ""
      when: undefined_groups.stdout == ""

    - name: CIS 9.13 - Validación - Registrar estado final
      lineinfile:
        path: "{{ audit_log }}"
        line: "[{{ ansible_date_time.iso8601 }}] CIS 9.13 - Estado POST: {{ 'CONFORME' if undefined_groups.stdout == '' else 'REVISIÓN MANUAL REQUERIDA - ' + (undefined_groups.stdout_lines | length | string) + ' usuarios' }}"
        create: yes


    - name: CIS 9.14 - Inicio de remediación
      debug:
        msg: 
          - "┌─────────────────────────────────────────────────────────────────────────┐"
          - "│ CONTROL 9.14 - Check That Users Are Assigned Home Directories           │"
          - "└─────────────────────────────────────────────────────────────────────────┘"
          - ""

    - name: CIS 9.14 - Auditoría - Verificar usuarios sin directorio home definido
      shell: |
        logins -xo | while read line; do
          user=$(echo ${line} | awk -F: '{ print $1 }')
          home=$(echo ${line} | awk -F: '{ print $6 }')
          if [ -z "${home}" ]; then
            echo ${user}
          fi
        done
      register: no_home_defined
      changed_when: false
      ignore_errors: yes

    - name: CIS 9.14 - Auditoría - Registrar estado inicial
      lineinfile:
        path: "{{ audit_log }}"
        line: "[{{ ansible_date_time.iso8601 }}] CIS 9.14 - Estado PRE: Usuarios sin home definido={{ no_home_defined.stdout_lines | length }}"
        create: yes

    - name: CIS 9.14 - Auditoría - Mostrar estado inicial
      debug:
        msg:
          - "┌─────────────────────────────────────────────────────────────────────────┐"
          - "│ ESTADO INICIAL - CIS 9.14                                                │"
          - "└─────────────────────────────────────────────────────────────────────────┘"
          - ""
          - "  Usuarios sin directorio home definido en passwd:"
          - "{{ no_home_defined.stdout_lines | map('regex_replace', '^', '    ') | list if no_home_defined.stdout != '' else ['     Todos tienen home definido'] }}"
          - ""

    - name: CIS 9.14 - Análisis - Control manual requerido
      debug:
        msg:
          - "┌─────────────────────────────────────────────────────────────────────────┐"
          - "│ ACCIÓN REQUERIDA - CIS 9.14                                              │"
          - "└─────────────────────────────────────────────────────────────────────────┘"
          - ""
          - "   USUARIOS SIN DIRECTORIO HOME DEFINIDO"
          - ""
          - "  Usuarios afectados:"
          - "{{ no_home_defined.stdout_lines | map('regex_replace', '^', '    - ') | list }}"
          - ""
          - "   CONSECUENCIAS:"
          - "    - Usuario será colocado en / al hacer login"
          - "    - No podrá escribir archivos"
          - "    - Variables de entorno locales no se establecerán"
          - ""
          - "   ACCIÓN MANUAL REQUERIDA:"
          - "    1. Para cada usuario, definir directorio home:"
          - "       # usermod -d /export/home/[username] [username]"
          - ""
          - "    2. Crear el directorio si no existe:"
          - "       # mkdir -p /export/home/[username]"
          - "       # chown [username]:[group] /export/home/[username]"
          - "       # chmod 750 /export/home/[username]"
          - ""
          - "    3. Copiar archivos de configuración base:"
          - "       # cp /etc/skel/.* /export/home/[username]/"
          - "       # chown [username]:[group] /export/home/[username]/.*"
          - ""
      when: no_home_defined.stdout != ""

    - name: CIS 9.14 - Validación - Sistema conforme
      debug:
        msg:
          - "┌─────────────────────────────────────────────────────────────────────────┐"
          - "│ ESTADO CONFORME - CIS 9.14                                               │"
          - "└─────────────────────────────────────────────────────────────────────────┘"
          - ""
          - "   Todos los usuarios tienen directorio home definido"
          - "   Sistema conforme con CIS Benchmark 9.14"
          - ""
      when: no_home_defined.stdout == ""

    - name: CIS 9.14 - Validación - Registrar estado final
      lineinfile:
        path: "{{ audit_log }}"
        line: "[{{ ansible_date_time.iso8601 }}] CIS 9.14 - Estado POST: {{ 'CONFORME' if no_home_defined.stdout == '' else 'REVISIÓN MANUAL REQUERIDA - ' + (no_home_defined.stdout_lines | length | string) + ' usuarios' }}"
        create: yes

    - name: CIS 9.15 - Inicio de remediación
      debug:
        msg: 
          - "┌─────────────────────────────────────────────────────────────────────────┐"
          - "│ CONTROL 9.15 - Check User Home Directory Ownership                      │"
          - "└─────────────────────────────────────────────────────────────────────────┘"
          - ""

    - name: CIS 9.15 - Auditoría - Verificar propiedad de directorios home
      shell: |
        logins -xo | awk -F: '($8 == "PS") { print }' | while read line; do
          user=$(echo ${line} | awk -F: '{ print $1 }')
          home=$(echo ${line} | awk -F: '{ print $6 }')
          if [ -d "${home}" ]; then
            find ${home} -type d -prune ! -user ${user} -ls 2>/dev/null
          fi
        done
      register: wrong_home_ownership
      changed_when: false
      ignore_errors: yes

    - name: CIS 9.15 - Auditoría - Filtrar usuarios del sistema esperados
      set_fact:
        wrong_ownership_filtered: "{{ wrong_home_ownership.stdout_lines | select('match', '^(?!.*uucp|.*nuucp).*') | list }}"
      when: wrong_home_ownership.stdout != ""

    - name: CIS 9.15 - Auditoría - Registrar estado inicial
      lineinfile:
        path: "{{ audit_log }}"
        line: "[{{ ansible_date_time.iso8601 }}] CIS 9.15 - Estado PRE: Directorios home con propietario incorrecto={{ wrong_ownership_filtered | default([]) | length }}"
        create: yes

    - name: CIS 9.15 - Auditoría - Mostrar estado inicial
      debug:
        msg:
          - "┌─────────────────────────────────────────────────────────────────────────┐"
          - "│ ESTADO INICIAL - CIS 9.15                                                │"
          - "└─────────────────────────────────────────────────────────────────────────┘"
          - ""
          - "  Directorios home con propietario incorrecto:"
          - "{{ wrong_ownership_filtered | default([]) | map('regex_replace', '^', '    ') | list if wrong_ownership_filtered | default([]) | length > 0 else ['     Todos correctamente asignados'] }}"
          - ""
          - "  Nota: uucp y nuucp generan errores esperados (homes no existen)"
          - ""

    - name: CIS 9.15 - Análisis - Control manual requerido
      debug:
        msg:
          - "┌─────────────────────────────────────────────────────────────────────────┐"
          - "│ ACCIÓN REQUERIDA - CIS 9.15                                              │"
          - "└─────────────────────────────────────────────────────────────────────────┘"
          - ""
          - "   DIRECTORIOS HOME CON PROPIETARIO INCORRECTO"
          - ""
          - "  Total afectados: {{ wrong_ownership_filtered | length }}"
          - ""
          - "   RIESGO DE SEGURIDAD:"
          - "    - Usuario es responsable de archivos en su home"
          - "    - Usuario debe ser el propietario del directorio"
          - "    - Accountability comprometida"
          - ""
          - "   ACCIÓN MANUAL REQUERIDA:"
          - "    1. Para cada directorio, verificar el usuario correcto"
          - "    2. Corregir la propiedad:"
          - "       # chown [username]:[group] /export/home/[username]"
          - ""
          - "    3. Corregir propiedad recursiva de archivos internos:"
          - "       # chown -R [username]:[group] /export/home/[username]"
          - ""
          - "    4. Verificar que no haya impacto en aplicaciones"
          - ""
      when: wrong_ownership_filtered | default([]) | length > 0

    - name: CIS 9.15 - Validación - Sistema conforme
      debug:
        msg:
          - "┌─────────────────────────────────────────────────────────────────────────┐"
          - "│ ESTADO CONFORME - CIS 9.15                                               │"
          - "└─────────────────────────────────────────────────────────────────────────┘"
          - ""
          - "   Todos los directorios home pertenecen al usuario correcto"
          - "   Sistema conforme con CIS Benchmark 9.15"
          - ""
      when: wrong_ownership_filtered | default([]) | length == 0

    - name: CIS 9.15 - Validación - Registrar estado final
      lineinfile:
        path: "{{ audit_log }}"
        line: "[{{ ansible_date_time.iso8601 }}] CIS 9.15 - Estado POST: {{ 'CONFORME' if wrong_ownership_filtered | default([]) | length == 0 else 'REVISIÓN MANUAL REQUERIDA - ' + (wrong_ownership_filtered | length | string) + ' directorios' }}"
        create: yes

   - name: CIS 9.16 - Inicio de remediación
      debug:
        msg: 
          - "┌─────────────────────────────────────────────────────────────────────────┐"
          - "│ CONTROL 9.16 - Check for Duplicate UIDs                                 │"
          - "└─────────────────────────────────────────────────────────────────────────┘"
          - ""

    - name: CIS 9.16 - Auditoría - Verificar UIDs duplicados
      shell: "logins -d"
      register: duplicate_uids
      changed_when: false
      ignore_errors: yes

    - name: CIS 9.16 - Auditoría - Registrar estado inicial
      lineinfile:
        path: "{{ audit_log }}"
        line: "[{{ ansible_date_time.iso8601 }}] CIS 9.16 - Estado PRE: UIDs duplicados={{ 'Encontrados' if duplicate_uids.stdout != '' else 'Ninguno' }}"
        create: yes

    - name: CIS 9.16 - Auditoría - Mostrar estado inicial
      debug:
        msg:
          - "┌─────────────────────────────────────────────────────────────────────────┐"
          - "│ ESTADO INICIAL - CIS 9.16                                                │"
          - "└─────────────────────────────────────────────────────────────────────────┘"
          - ""
          - "  Usuarios con UIDs duplicados:"
          - "{{ duplicate_uids.stdout_lines | map('regex_replace', '^', '    ') | list if duplicate_uids.stdout != '' else ['     Ninguno'] }}"
          - ""

    - name: CIS 9.16 - Análisis - Control manual requerido
      debug:
        msg:
          - "┌─────────────────────────────────────────────────────────────────────────┐"
          - "│ ACCIÓN REQUERIDA - CIS 9.16                                              │"
          - "└─────────────────────────────────────────────────────────────────────────┘"
          - ""
          - "   UIDs DUPLICADOS DETECTADOS"
          - ""
          - "{{ duplicate_uids.stdout_lines | map('regex_replace', '^', '    ') | list }}"
          - ""
          - "   RIESGO DE SEGURIDAD:"
          - "    - Compromete accountability de usuarios"
          - "    - Usuarios comparten identidad del sistema"
          - "    - Problemas con protecciones de acceso"
          - "    - Archivos pueden tener propietario ambiguo"
          - ""
          - "   ACCIÓN MANUAL REQUERIDA:"
          - "    1. Identificar usuarios que comparten UID"
          - "    2. Determinar cuál usuario debe mantener el UID"
          - "    3. Asignar nuevo UID único al otro usuario:"
          - "       # usermod -u [new_uid] [username]"
          - ""
          - "    4. IMPORTANTE: Actualizar propiedad de archivos:"
          - "       # find / -user [old_uid] -exec chown [new_uid] {} \\;"
          - "       # find / -group [old_gid] -exec chgrp [new_gid] {} \\;"
          - ""
          - "    5. Verificar aplicaciones y servicios afectados"
          - ""
      when: duplicate_uids.stdout != ""

    - name: CIS 9.16 - Validación - Sistema conforme
      debug:
        msg:
          - "┌─────────────────────────────────────────────────────────────────────────┐"
          - "│ ESTADO CONFORME - CIS 9.16                                               │"
          - "└─────────────────────────────────────────────────────────────────────────┘"
          - ""
          - "   No se encontraron UIDs duplicados"
          - "   Todos los usuarios tienen UID único"
          - "   Sistema conforme con CIS Benchmark 9.16"
          - ""
      when: duplicate_uids.stdout == ""

    - name: CIS 9.16 - Validación - Registrar estado final
      lineinfile:
        path: "{{ audit_log }}"
        line: "[{{ ansible_date_time.iso8601 }}] CIS 9.16 - Estado POST: {{ 'CONFORME' if duplicate_uids.stdout == '' else 'REVISIÓN MANUAL REQUERIDA' }}"
        create: yes

    - name: CIS 9.17 - Inicio de remediación
      debug:
        msg: 
          - "┌─────────────────────────────────────────────────────────────────────────┐"
          - "│ CONTROL 9.17 - Check for Duplicate GIDs                                 │"
          - "└─────────────────────────────────────────────────────────────────────────┘"
          - ""

    - name: CIS 9.17 - Auditoría - Verificar GIDs duplicados
      shell: |
        getent group | cut -f3 -d":" | sort -n | uniq -c | while read x; do
          [ -z "${x}" ] && break
          set - $x
          if [ $1 -gt 1 ]; then
            grps=$(getent group | nawk -F: '($3 == n) { print $1 }' n=$2 | xargs)
            echo "Duplicate GID ($2): ${grps}"
          fi
        done
      register: duplicate_gids
      changed_when: false
      ignore_errors: yes

    - name: CIS 9.17 - Auditoría - Registrar estado inicial
      lineinfile:
        path: "{{ audit_log }}"
        line: "[{{ ansible_date_time.iso8601 }}] CIS 9.17 - Estado PRE: GIDs duplicados={{ 'Encontrados' if duplicate_gids.stdout != '' else 'Ninguno' }}"
        create: yes

    - name: CIS 9.17 - Auditoría - Mostrar estado inicial
      debug:
        msg:
          - "┌─────────────────────────────────────────────────────────────────────────┐"
          - "│ ESTADO INICIAL - CIS 9.17                                                │"
          - "└─────────────────────────────────────────────────────────────────────────┘"
          - ""
          - "  Grupos con GIDs duplicados:"
          - "{{ duplicate_gids.stdout_lines | map('regex_replace', '^', '    ') | list if duplicate_gids.stdout != '' else ['     Ninguno'] }}"
          - ""

    - name: CIS 9.17 - Análisis - Control manual requerido
      debug:
        msg:
          - "┌─────────────────────────────────────────────────────────────────────────┐"
          - "│ ACCIÓN REQUERIDA - CIS 9.17                                              │"
          - "└─────────────────────────────────────────────────────────────────────────┘"
          - ""
          - "   GIDs DUPLICADOS DETECTADOS"
          - ""
          - "{{ duplicate_gids.stdout_lines | map('regex_replace', '^', '    ') | list }}"
          - ""
          - "   RIESGO DE SEGURIDAD:"
          - "    - Compromete accountability de grupos"
          - "    - Grupos comparten identidad del sistema"
          - "    - Problemas con protecciones de acceso"
          - ""
          - "   ACCIÓN MANUAL REQUERIDA:"
          - "    1. Identificar grupos que comparten GID"
          - "    2. Contactar a propietarios de cada grupo"
          - "    3. Determinar cuál grupo debe mantener el GID"
          - "    4. Asignar nuevo GID único al otro grupo:"
          - "       # groupmod -g [new_gid] [groupname]"
          - ""
          - "    5. IMPORTANTE: Actualizar propiedad de archivos:"
          - "       # find / -group [old_gid] -exec chgrp [groupname] {} \\;"
          - ""
          - "    6. Verificar que los miembros del grupo mantengan acceso"
          - ""
      when: duplicate_gids.stdout != ""

    - name: CIS 9.17 - Validación - Sistema conforme
      debug:
        msg:
          - "┌─────────────────────────────────────────────────────────────────────────┐"
          - "│ ESTADO CONFORME - CIS 9.17                                               │"
          - "└─────────────────────────────────────────────────────────────────────────┘"
          - ""
          - "   No se encontraron GIDs duplicados"
          - "   Todos los grupos tienen GID único"
          - "   Sistema conforme con CIS Benchmark 9.17"
          - ""
      when: duplicate_gids.stdout == ""

    - name: CIS 9.17 - Validación - Registrar estado final
      lineinfile:
        path: "{{ audit_log }}"
        line: "[{{ ansible_date_time.iso8601 }}] CIS 9.17 - Estado POST: {{ 'CONFORME' if duplicate_gids.stdout == '' else 'REVISIÓN MANUAL REQUERIDA' }}"
        create: yes

    - name: CIS 9.18 - Inicio de remediación
      debug:
        msg: 
          - "┌─────────────────────────────────────────────────────────────────────────┐"
          - "│ CONTROL 9.18 - Check for Duplicate Group Names                          │"
          - "└─────────────────────────────────────────────────────────────────────────┘"
          - ""

    - name: CIS 9.18 - Auditoría - Verificar nombres de grupo duplicados
      shell: |
        getent group | cut -f1 -d":" | sort -n | uniq -c | while read x; do
          [ -z "${x}" ] && break
          set - $x
          if [ $1 -gt 1 ]; then
            gids=$(getent group | nawk -F: '($1 == n) { print $3 }' n=$2 | xargs)
            echo "Duplicate Group Name ($2): ${gids}"
          fi
        done
      register: duplicate_group_names
      changed_when: false
      ignore_errors: yes

    - name: CIS 9.18 - Auditoría - Registrar estado inicial
      lineinfile:
        path: "{{ audit_log }}"
        line: "[{{ ansible_date_time.iso8601 }}] CIS 9.18 - Estado PRE: Nombres de grupo duplicados={{ 'Encontrados' if duplicate_group_names.stdout != '' else 'Ninguno' }}"
        create: yes

    - name: CIS 9.18 - Auditoría - Mostrar estado inicial
      debug:
        msg:
          - "┌─────────────────────────────────────────────────────────────────────────┐"
          - "│ ESTADO INICIAL - CIS 9.18                                                │"
          - "└─────────────────────────────────────────────────────────────────────────┘"
          - ""
          - "  Nombres de grupo duplicados encontrados:"
          - "{{ duplicate_group_names.stdout_lines | map('regex_replace', '^', '    ') | list if duplicate_group_names.stdout != '' else ['     Ninguno'] }}"
          - ""

    - name: CIS 9.18 - Análisis - Control manual requerido
      debug:
        msg:
          - "┌─────────────────────────────────────────────────────────────────────────┐"
          - "│ ACCIÓN REQUERIDA - CIS 9.18                                              │"
          - "└─────────────────────────────────────────────────────────────────────────┘"
          - ""
          - "   NOMBRES DE GRUPO DUPLICADOS DETECTADOS"
          - ""
          - "{{ duplicate_group_names.stdout_lines | map('regex_replace', '^', '    ') | list }}"
          - ""
          - "   RIESGO DE SEGURIDAD:"
          - "    - Grupo usará el primer GID en /etc/group"
          - "    - Efectivamente, el GID es compartido"
          - "    - Problema de seguridad significativo"
          - "    - Acceso a archivos comprometido"
          - ""
          - "   ACCIÓN MANUAL REQUERIDA:"
          - "    1. Identificar grupos con nombres duplicados"
          - "    2. Contactar a propietarios de cada grupo"
          - "    3. Determinar cuál debe mantener el nombre"
          - "    4. Renombrar el grupo duplicado:"
          - "       # groupmod -n [new_groupname] [old_groupname]"
          - ""
          - "    5. Verificar que archivos del grupo mantengan acceso correcto"
          - "    6. Actualizar referencias en aplicaciones y scripts"
          - ""
      when: duplicate_group_names.stdout != ""

    - name: CIS 9.18 - Validación - Sistema conforme
      debug:
        msg:
          - "┌─────────────────────────────────────────────────────────────────────────┐"
          - "│ ESTADO CONFORME - CIS 9.18                                               │"
          - "└─────────────────────────────────────────────────────────────────────────┘"
          - ""
          - "   No se encontraron nombres de grupo duplicados"
          - "   Todos los grupos tienen nombre único"
          - "   Sistema conforme con CIS Benchmark 9.18"
          - ""
      when: duplicate_group_names.stdout == ""

    - name: CIS 9.18 - Validación - Registrar estado final
      lineinfile:
        path: "{{ audit_log }}"
        line: "[{{ ansible_date_time.iso8601 }}] CIS 9.18 - Estado POST: {{ 'CONFORME' if duplicate_group_names.stdout == '' else 'REVISIÓN MANUAL REQUERIDA' }}"
        create: yes

- name: CIS 9.19 - Inicio de remediación
      debug:
        msg: 
          - "┌─────────────────────────────────────────────────────────────────────────┐"
          - "│ CONTROL 9.19 - Check for Presence of User .netrc Files                  │"
          - "└─────────────────────────────────────────────────────────────────────────┘"
          - ""

    - name: CIS 9.19 - Auditoría - Verificar archivos .netrc
      shell: |
        for dir in `logins -ox | awk -F: '($8 == "PS") { print $6 }'`; do
          ls -l ${dir}/.netrc 2>/dev/null
        done
      register: netrc_files
      changed_when: false
      failed_when: false

    - name: CIS 9.19 - Auditoría - Registrar estado inicial
      lineinfile:
        path: "{{ audit_log }}"
        line: "[{{ ansible_date_time.iso8601 }}] CIS 9.19 - Estado PRE: Archivos .netrc encontrados={{ 'SÍ' if netrc_files.stdout != '' else 'NO' }}"
        create: yes

    - name: CIS 9.19 - Auditoría - Mostrar estado inicial
      debug:
        msg:
          - "┌─────────────────────────────────────────────────────────────────────────┐"
          - "│ ESTADO INICIAL - CIS 9.19                                                │"
          - "└─────────────────────────────────────────────────────────────────────────┘"
          - ""
          - "  Archivos .netrc encontrados:"
          - "{{ netrc_files.stdout_lines | map('regex_replace', '^', '    ') | list if netrc_files.stdout != '' else ['     Ninguno'] }}"
          - ""

    - name: CIS 9.19 - Análisis - Control manual requerido
      debug:
        msg:
          - "┌─────────────────────────────────────────────────────────────────────────┐"
          - "│ ACCIÓN REQUERIDA - CIS 9.19                                              │"
          - "└─────────────────────────────────────────────────────────────────────────┘"
          - ""
          - "   ARCHIVOS .NETRC DETECTADOS"
          - ""
          - "{{ netrc_files.stdout_lines | map('regex_replace', '^', '    ') | list }}"
          - ""
          - "   RIESGO DE SEGURIDAD CRÍTICO:"
          - "    - Almacena contraseñas en texto plano"
          - "    - Usado para FTP automático"
          - "    - Alto riesgo de exposición de credenciales"
          - ""
          - "   ACCIÓN MANUAL REQUERIDA:"
          - "    1. Contactar al propietario de cada archivo"
          - "    2. Determinar si el archivo es necesario"
          - "    3. Alternativas recomendadas:"
          - "       - Usar SSH con claves públicas"
          - "       - Usar SFTP en lugar de FTP"
          - "       - Implementar sistema de gestión de credenciales"
          - ""
          - "    4. Si debe mantenerse temporalmente:"
          - "       # chmod 600 ~/.netrc"
          - ""
          - "    5. Mejor práctica: Eliminar el archivo:"
          - "       # rm ~/.netrc"
          - ""
      when: netrc_files.stdout != ""

    - name: CIS 9.19 - Validación - Sistema conforme
      debug:
        msg:
          - "┌─────────────────────────────────────────────────────────────────────────┐"
          - "│ ESTADO CONFORME - CIS 9.19                                               │"
          - "└─────────────────────────────────────────────────────────────────────────┘"
          - ""
          - "   No se encontraron archivos .netrc"
          - "   Sin riesgo de credenciales en texto plano"
          - "   Sistema conforme con CIS Benchmark 9.19"
          - ""
      when: netrc_files.stdout == ""

    - name: CIS 9.19 - Validación - Registrar estado final
      lineinfile:
        path: "{{ audit_log }}"
        line: "[{{ ansible_date_time.iso8601 }}] CIS 9.19 - Estado POST: {{ 'CONFORME' if netrc_files.stdout == '' else 'REVISIÓN MANUAL REQUERIDA' }}"
        create: yes

    - name: CIS 9.20 - Inicio de remediación
      debug:
        msg: 
          - "┌─────────────────────────────────────────────────────────────────────────┐"
          - "│ CONTROL 9.20 - Check for Presence of User .forward Files                │"
          - "└─────────────────────────────────────────────────────────────────────────┘"
          - ""

    - name: CIS 9.20 - Auditoría - Verificar archivos .forward
      shell: |
        for dir in `logins -ox | awk -F: '($8 == "PS") { print $6 }'`; do
          ls -l ${dir}/.forward 2>/dev/null
        done
      register: forward_files
      changed_when: false
      failed_when: false

    - name: CIS 9.20 - Auditoría - Registrar estado inicial
      lineinfile:
        path: "{{ audit_log }}"
        line: "[{{ ansible_date_time.iso8601 }}] CIS 9.20 - Estado PRE: Archivos .forward encontrados={{ 'SÍ' if forward_files.stdout != '' else 'NO' }}"
        create: yes

    - name: CIS 9.20 - Auditoría - Mostrar estado inicial
      debug:
        msg:
          - "┌─────────────────────────────────────────────────────────────────────────┐"
          - "│ ESTADO INICIAL - CIS 9.20                                                │"
          - "└─────────────────────────────────────────────────────────────────────────┘"
          - ""
          - "  Archivos .forward encontrados:"
          - "{{ forward_files.stdout_lines | map('regex_replace', '^', '    ') | list if forward_files.stdout != '' else ['     Ninguno'] }}"
          - ""

    - name: CIS 9.20 - Análisis - Control manual requerido
      debug:
        msg:
          - "┌─────────────────────────────────────────────────────────────────────────┐"
          - "│ ACCIÓN REQUERIDA - CIS 9.20                                              │"
          - "└─────────────────────────────────────────────────────────────────────────┘"
          - ""
          - "   ARCHIVOS .FORWARD DETECTADOS"
          - ""
          - "{{ forward_files.stdout_lines | map('regex_replace', '^', '    ') | list }}"
          - ""
          - "   RIESGOS DE SEGURIDAD:"
          - "    - Datos sensibles pueden salir de la organización"
          - "    - Puede ejecutar comandos no autorizados"
          - "    - Riesgo de fuga de información"
          - "    - Posible vector de ataque"
          - ""
          - "   ACCIÓN MANUAL REQUERIDA:"
          - "    1. Contactar al propietario del archivo"
          - "    2. Verificar contenido del archivo:"
          - "       # cat ~/.forward"
          - ""
          - "    3. Determinar si el reenvío es necesario"
          - "    4. Evaluar según políticas organizacionales"
          - ""
          - "    5. Si no es necesario, eliminar:"
          - "       # rm ~/.forward"
          - ""
          - "    6. Si es necesario, documentar justificación"
          - "    7. Configurar alternativas seguras (alias de correo centralizado)"
          - ""
      when: forward_files.stdout != ""

    - name: CIS 9.20 - Validación - Sistema conforme
      debug:
        msg:
          - "┌─────────────────────────────────────────────────────────────────────────┐"
          - "│ ESTADO CONFORME - CIS 9.20                                               │"
          - "└─────────────────────────────────────────────────────────────────────────┘"
          - ""
          - "   No se encontraron archivos .forward"
          - "   Sin riesgo de reenvío de correo no autorizado"
          - "   Sistema conforme con CIS Benchmark 9.20"
          - ""
      when: forward_files.stdout == ""

    - name: CIS 9.20 - Validación - Registrar estado final
      lineinfile:
        path: "{{ audit_log }}"
        line: "[{{ ansible_date_time.iso8601 }}] CIS 9.20 - Estado POST: {{ 'CONFORME' if forward_files.stdout == '' else 'REVISIÓN MANUAL REQUERIDA' }}"
        create: yes

    - name: CIS 9.21 - Inicio de remediación
      debug:
        msg: 
          - "┌─────────────────────────────────────────────────────────────────────────┐"
          - "│ CONTROL 9.21 - Find World Writable Files (Manual)                       │"
          - "└─────────────────────────────────────────────────────────────────────────┘"
          - ""

    - name: CIS 9.21 - Auditoría - Buscar archivos escribibles por todos (puede tomar tiempo)
      shell: |
        find / \( -fstype nfs -o -fstype cachefs -o -fstype autofs -o -fstype ctfs -o -fstype mntfs -o -fstype objfs -o -fstype proc \) -prune -o -type f -perm -0002 -print 2>/dev/null | head -100
      register: world_writable_files
      changed_when: false
      failed_when: false
      async: 300
      poll: 5

    - name: CIS 9.21 - Auditoría - Registrar estado inicial
      lineinfile:
        path: "{{ audit_log }}"
        line: "[{{ ansible_date_time.iso8601 }}] CIS 9.21 - Estado PRE: Archivos world-writable encontrados={{ 'SÍ' if world_writable_files.stdout != '' else 'NO' }}"
        create: yes

    - name: CIS 9.21 - Auditoría - Mostrar estado inicial
      debug:
        msg:
          - "┌─────────────────────────────────────────────────────────────────────────┐"
          - "│ ESTADO INICIAL - CIS 9.21                                                │"
          - "└─────────────────────────────────────────────────────────────────────────┘"
          - ""
          - "  Archivos world-writable encontrados (primeros 100):"
          - "{{ world_writable_files.stdout_lines | map('regex_replace', '^', '    ') | list if world_writable_files.stdout != '' else ['     Ninguno'] }}"
          - ""

    - name: CIS 9.21 - Análisis - Control manual requerido
      debug:
        msg:
          - "┌─────────────────────────────────────────────────────────────────────────┐"
          - "│ ACCIÓN REQUERIDA - CIS 9.21                                              │"
          - "└─────────────────────────────────────────────────────────────────────────┘"
          - ""
          - "   ARCHIVOS WORLD-WRITABLE DETECTADOS"
          - ""
          - "{{ world_writable_files.stdout_lines | map('regex_replace', '^', '    ') | list }}"
          - ""
          - "   RIESGOS DE SEGURIDAD CRÍTICOS:"
          - "    - Cualquier usuario puede modificar el archivo"
          - "    - Datos pueden ser comprometidos"
          - "    - Posible indicador de script mal escrito"
          - "    - Riesgo de compromiso del sistema"
          - ""
          - "   ACCIÓN MANUAL REQUERIDA:"
          - "    1. Para cada archivo, verificar propietario:"
          - "       # ls -l <filename>"
          - ""
          - "    2. Contactar al propietario del archivo"
          - "    3. Determinar si el permiso es necesario"
          - ""
          - "    4. Remover permiso de escritura para 'others':"
          - "       # chmod o-w <filename>"
          - ""
          - "    5. Verificar funcionalidad después del cambio"
          - "    6. Documentar archivos que requieren justificación"
          - ""
          - "   NOTA: Esta búsqueda puede tomar tiempo considerable"
          - ""
      when: world_writable_files.stdout != ""

    - name: CIS 9.21 - Validación - Sistema conforme
      debug:
        msg:
          - "┌─────────────────────────────────────────────────────────────────────────┐"
          - "│ ESTADO CONFORME - CIS 9.21                                               │"
          - "└─────────────────────────────────────────────────────────────────────────┘"
          - ""
          - "   No se encontraron archivos world-writable"
          - "   Permisos de archivos correctamente configurados"
          - "   Sistema conforme con CIS Benchmark 9.21"
          - ""
      when: world_writable_files.stdout == ""

    - name: CIS 9.21 - Validación - Registrar estado final
      lineinfile:
        path: "{{ audit_log }}"
        line: "[{{ ansible_date_time.iso8601 }}] CIS 9.21 - Estado POST: {{ 'CONFORME' if world_writable_files.stdout == '' else 'REVISIÓN MANUAL REQUERIDA' }}"
        create: yes

    - name: CIS 9.22 - Inicio de remediación
      debug:
        msg: 
          - "┌─────────────────────────────────────────────────────────────────────────┐"
          - "│ CONTROL 9.22 - Find SUID/SGID System Executables (Manual)               │"
          - "└─────────────────────────────────────────────────────────────────────────┘"
          - ""

    - name: CIS 9.22 - Auditoría - Buscar archivos SUID/SGID (puede tomar tiempo)
      shell: |
        find / \( -fstype nfs -o -fstype cachefs -o -fstype autofs -o -fstype ctfs -o -fstype mntfs -o -fstype objfs -o -fstype proc \) -prune -o -type f \( -perm -4000 -o -perm -2000 \) -print 2>/dev/null | head -100
      register: suid_sgid_files
      changed_when: false
      failed_when: false
      async: 300
      poll: 5

    - name: CIS 9.22 - Auditoría - Registrar estado inicial
      lineinfile:
        path: "{{ audit_log }}"
        line: "[{{ ansible_date_time.iso8601 }}] CIS 9.22 - Estado PRE: Archivos SUID/SGID encontrados={{ world_writable_files.stdout_lines | length if suid_sgid_files.stdout != '' else '0' }}"
        create: yes

    - name: CIS 9.22 - Auditoría - Mostrar estado inicial
      debug:
        msg:
          - "┌─────────────────────────────────────────────────────────────────────────┐"
          - "│ ESTADO INICIAL - CIS 9.22                                                │"
          - "└─────────────────────────────────────────────────────────────────────────┘"
          - ""
          - "  Archivos SUID/SGID encontrados (primeros 100):"
          - "{{ suid_sgid_files.stdout_lines | map('regex_replace', '^', '    ') | list if suid_sgid_files.stdout != '' else ['     Ninguno'] }}"
          - ""

    - name: CIS 9.22 - Análisis - Control manual requerido
      debug:
        msg:
          - "┌─────────────────────────────────────────────────────────────────────────┐"
          - "│ ACCIÓN REQUERIDA - CIS 9.22                                              │"
          - "└─────────────────────────────────────────────────────────────────────────┘"
          - ""
          - "   ARCHIVOS SUID/SGID DETECTADOS"
          - ""
          - "{{ suid_sgid_files.stdout_lines | map('regex_replace', '^', '    ') | list }}"
          - ""
          - "   INFORMACIÓN IMPORTANTE:"
          - "    - SUID/SGID son necesarios para ciertas funciones del sistema"
          - "    - Permiten ejecutar con privilegios del propietario"
          - "    - Ejemplos legítimos: passwd, su, sudo"
          - "    - Deben ser revisados y justificados"
          - ""
          - "   ACCIÓN MANUAL REQUERIDA:"
          - "    1. Revisar cada archivo SUID/SGID encontrado"
          - "    2. Verificar si es un binario legítimo del sistema"
          - ""
          - "    3. Para binarios de Solaris, verificar firma digital:"
          - "       # elfsign verify -e /usr/bin/su"
          - ""
          - "    4. Para archivos no autorizados, remover SUID/SGID:"
          - "       # chmod u-s <filename>  # Remover SUID"
          - "       # chmod g-s <filename>  # Remover SGID"
          - ""
          - "    5. Documentar archivos SUID/SGID autorizados"
          - "    6. Establecer proceso de revisión periódica"
          - "    7. Eliminar archivos SUID/SGID no necesarios"
          - ""
          - "   NOTA: Esta búsqueda puede tomar tiempo considerable"
          - ""
      when: suid_sgid_files.stdout != ""

    - name: CIS 9.22 - Validación - Mostrar información
      debug:
        msg:
          - "┌─────────────────────────────────────────────────────────────────────────┐"
          - "│ INFORMACIÓN - CIS 9.22                                                   │"
          - "└─────────────────────────────────────────────────────────────────────────┘"
          - ""
          - "   Archivos SUID/SGID encontrados: {{ suid_sgid_files.stdout_lines | length }}"
          - "   Estos archivos requieren revisión manual"
          - "   Verificar que todos sean legítimos y necesarios"
          - ""

    - name: CIS 9.22 - Validación - Registrar estado final
      lineinfile:
        path: "{{ audit_log }}"
        line: "[{{ ansible_date_time.iso8601 }}] CIS 9.22 - Estado POST: REVISIÓN MANUAL REQUERIDA ({{ suid_sgid_files.stdout_lines | length }} archivos)"
        create: yes

    - name: CIS 9.23 - Inicio de remediación
      debug:
        msg: 
          - "┌─────────────────────────────────────────────────────────────────────────┐"
          - "│ CONTROL 9.23 - Find Un-owned Files and Directories                      │"
          - "└─────────────────────────────────────────────────────────────────────────┘"
          - ""

    - name: CIS 9.23 - Auditoría - Buscar archivos sin propietario (puede tomar tiempo)
      shell: |
        find / \( -fstype nfs -o -fstype cachefs -o -fstype autofs -o -fstype ctfs -o -fstype mntfs -o -fstype objfs -o -fstype proc \) -prune -o \( -nouser -o -nogroup \) -ls 2>/dev/null | head -100
      register: unowned_files
      changed_when: false
      failed_when: false
      async: 300
      poll: 5

    - name: CIS 9.23 - Auditoría - Registrar estado inicial
      lineinfile:
        path: "{{ audit_log }}"
        line: "[{{ ansible_date_time.iso8601 }}] CIS 9.23 - Estado PRE: Archivos sin propietario encontrados={{ 'SÍ' if unowned_files.stdout != '' else 'NO' }}"
        create: yes

    - name: CIS 9.23 - Auditoría - Mostrar estado inicial
      debug:
        msg:
          - "┌─────────────────────────────────────────────────────────────────────────┐"
          - "│ ESTADO INICIAL - CIS 9.23                                                │"
          - "└─────────────────────────────────────────────────────────────────────────┘"
          - ""
          - "  Archivos sin propietario encontrados (primeros 100):"
          - "{{ unowned_files.stdout_lines | map('regex_replace', '^', '    ') | list if unowned_files.stdout != '' else ['     Ninguno'] }}"
          - ""

    - name: CIS 9.23 - Análisis - Control manual requerido
      debug:
        msg:
          - "┌─────────────────────────────────────────────────────────────────────────┐"
          - "│ ACCIÓN REQUERIDA - CIS 9.23                                              │"
          - "└─────────────────────────────────────────────────────────────────────────┘"
          - ""
          - "   ARCHIVOS SIN PROPIETARIO DETECTADOS"
          - ""
          - "{{ unowned_files.stdout_lines | map('regex_replace', '^', '    ') | list }}"
          - ""
          - "   RIESGOS DE SEGURIDAD:"
          - "    - Usuario/grupo UID/GID fue eliminado"
          - "    - Nuevo usuario puede heredar estos archivos"
          - "    - Acceso no intencionado al sistema"
          - "    - Violación de principio de menor privilegio"
          - ""
          - "   ACCIÓN MANUAL REQUERIDA:"
          - "    1. Para cada archivo, determinar propietario original"
          - "    2. Verificar si el archivo es necesario"
          - ""
          - "    3. Si es necesario, asignar nuevo propietario:"
          - "       # chown <user>:<group> <filename>"
          - ""
          - "    4. Si no es necesario, eliminar:"
          - "       # rm <filename>"
          - ""
          - "    5. Investigar causa raíz:"
          - "       - Usuario eliminado sin limpiar archivos"
          - "       - Proceso de desvinculación incompleto"
          - ""
          - "    6. Documentar decisión tomada"
          - ""
          - "   NOTA: Solaris OS se envía con todos archivos apropiadamente owned"
          - "   NOTA: Falsos positivos pueden aparecer en /zones/ (zona global)"
          - ""
      when: unowned_files.stdout != ""

    - name: CIS 9.23 - Validación - Sistema conforme
      debug:
        msg:
          - "┌─────────────────────────────────────────────────────────────────────────┐"
          - "│ ESTADO CONFORME - CIS 9.23                                               │"
          - "└─────────────────────────────────────────────────────────────────────────┘"
          - ""
          - "   No se encontraron archivos sin propietario"
          - "   Todos los archivos tienen UID/GID válidos"
          - "   Sistema conforme con CIS Benchmark 9.23"
          - ""
      when: unowned_files.stdout == ""

    - name: CIS 9.23 - Validación - Registrar estado final
      lineinfile:
        path: "{{ audit_log }}"
        line: "[{{ ansible_date_time.iso8601 }}] CIS 9.23 - Estado POST: {{ 'CONFORME' if unowned_files.stdout == '' else 'REVISIÓN MANUAL REQUERIDA' }}"
        create: yes

    - name: CIS 9.24 - Inicio de remediación
      debug:
        msg: 
          - "┌─────────────────────────────────────────────────────────────────────────┐"
          - "│ CONTROL 9.24 - Find Files with Extended Attributes                      │"
          - "└─────────────────────────────────────────────────────────────────────────┘"
          - ""

    - name: CIS 9.24 - Auditoría - Buscar archivos con atributos extendidos (puede tomar tiempo)
      shell: |
        find / \( -fstype nfs -o -fstype cachefs -o -fstype autofs -o -fstype ctfs -o -fstype mntfs -o -fstype objfs -o -fstype proc \) -prune -o -xattr -ls 2>/dev/null | head -100
      register: xattr_files
      changed_when: false
      failed_when: false
      async: 300
      poll: 5

    - name: CIS 9.24 - Auditoría - Registrar estado inicial
      lineinfile:
        path: "{{ audit_log }}"
        line: "[{{ ansible_date_time.iso8601 }}] CIS 9.24 - Estado PRE: Archivos con atributos extendidos encontrados={{ 'SÍ' if xattr_files.stdout != '' else 'NO' }}"
        create: yes

    - name: CIS 9.24 - Auditoría - Mostrar estado inicial
      debug:
        msg:
          - "┌─────────────────────────────────────────────────────────────────────────┐"
          - "│ ESTADO INICIAL - CIS 9.24                                                │"
          - "└─────────────────────────────────────────────────────────────────────────┘"
          - ""
          - "  Archivos con atributos extendidos encontrados (primeros 100):"
          - "{{ xattr_files.stdout_lines | map('regex_replace', '^', '    ') | list if xattr_files.stdout != '' else ['     Ninguno'] }}"
          - ""

    - name: CIS 9.24 - Análisis - Control manual requerido
      debug:
        msg:
          - "┌─────────────────────────────────────────────────────────────────────────┐"
          - "│ ACCIÓN REQUERIDA - CIS 9.24                                              │"
          - "└─────────────────────────────────────────────────────────────────────────┘"
          - ""
          - "   ARCHIVOS CON ATRIBUTOS EXTENDIDOS DETECTADOS"
          - ""
          - "{{ xattr_files.stdout_lines | map('regex_replace', '^', '    ') | list }}"
          - ""
          - "   RIESGOS DE SEGURIDAD:"
          - "    - Atributos extendidos no son visibles con comandos normales"
          - "    - Atacantes pueden ocultar información en estos atributos"
          - "    - Posible área de ocultamiento de exploits"
          - "    - Raramente usados en operaciones normales"
          - ""
          - "   INFORMACIÓN:"
          - "    - Implementados como archivos en sistema shadow"
          - "    - Requieren argumentos especiales para ver"
          - "    - Solaris OS no envía archivos con atributos extendidos"
          - ""
          - "   ACCIÓN MANUAL REQUERIDA:"
          - "    1. Para cada archivo, verificar atributos extendidos:"
          - "       # ls -@ <filename>"
          - "       # runat <filename> ls -la"
          - ""
          - "    2. Examinar contenido de atributos:"
          - "       # runat <filename> cat <attribute_name>"
          - ""
          - "    3. Determinar si son legítimos y necesarios"
          - "    4. Contactar al propietario del archivo"
          - ""
          - "    5. Si no son necesarios, remover atributos:"
          - "       # runat <filename> rm <attribute_name>"
          - ""
          - "    6. Documentar archivos que requieren justificación"
          - "    7. Investigar origen de atributos sospechosos"
          - ""
          - "   NOTA: Esta búsqueda puede tomar tiempo considerable"
          - ""
      when: xattr_files.stdout != ""

    - name: CIS 9.24 - Validación - Sistema conforme
      debug:
        msg:
          - "┌─────────────────────────────────────────────────────────────────────────┐"
          - "│ ESTADO CONFORME - CIS 9.24                                               │"
          - "└─────────────────────────────────────────────────────────────────────────┘"
          - ""
          - "   No se encontraron archivos con atributos extendidos"
          - "   Sin áreas de ocultamiento potencial"
          - "   Sistema conforme con CIS Benchmark 9.24"
          - ""
      when: xattr_files.stdout == ""

    - name: CIS 9.24 - Validación - Registrar estado final
      lineinfile:
        path: "{{ audit_log }}"
        line: "[{{ ansible_date_time.iso8601 }}] CIS 9.24 - Estado POST: {{ 'CONFORME' if xattr_files.stdout == '' else 'REVISIÓN MANUAL REQUERIDA' }}"
        create: yes
