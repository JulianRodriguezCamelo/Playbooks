---
# =============================================================================
# ANSIBLE PLAYBOOK — CIS Benchmark RHEL
# Controles: 1.2.1 | 1.2.3 | 1.4.1 | 1.4.3 | 1.5.1 | 1.5.3 | 1.5.4
#            1.7.1 | 1.7.6 | 3.2.1 | 3.3.1 | 3.3.8 | 3.4.5
#            5.1.1 | 5.1.2 | 5.2.1 | 5.3.1 | 5.3.3 | 5.3.8 | 5.3.9
#            5.3.12 | 5.3.14 | 5.4.1 | 5.5.5 | 5.7 | 6.1.2
#            6.1.6 | 6.2.1 | 6.2.7 | 5.3.1 | 5.3.3 | 5.3.8
#            5.3.9 | 5.3.12| 5.3.14| 5.4.1 | 5.5.5
# Profile   : Level 1 - Server | Level 1 - Workstation
# =============================================================================
#
# Ejecución:
#   ansible-playbook cis_hardening.yml -i inventario.ini
#   ansible-playbook cis_hardening.yml -i inventario.ini --tags audit
#   ansible-playbook cis_hardening.yml -i inventario.ini --tags "1.5.1,1.5.3"
#
# =============================================================================

- name: "CIS Benchmark | RHEL Hardening — Level 1"
  hosts: all
  become: true
  gather_facts: true

  vars:
    report_path: "/tmp/cis_compliance_report.txt"
    grub_conf_legacy: "/boot/grub/grub.conf"
    grub_conf_efi: "/boot/efi/EFI"

  tasks:

    - name: "AUDIT | 1.2.1 | Obtener lista de repositorios activos"
      ansible.builtin.command: yum repolist
      register: cis_1_2_1_repos
      changed_when: false
      check_mode: false
      tags: ["audit", "1.2.1"]

    - name: "AUDIT | 1.2.1 | Verificar al menos un repositorio habilitado"
      ansible.builtin.assert:
        that:
          - cis_1_2_1_repos.rc == 0
          - cis_1_2_1_repos.stdout | length > 0
        success_msg: "PASS | 1.2.1 | Repositorios configurados correctamente."
        fail_msg: "FAIL | 1.2.1 | Sin repositorios habilitados. Revisar /etc/yum.repos.d/"
      tags: ["audit", "1.2.1"]

    - name: "REMEDIATION | 1.2.1 | Asegurar permisos en directorio de repos"
      ansible.builtin.file:
        path: /etc/yum.repos.d
        state: directory
        owner: root
        group: root
        mode: "0755"
      tags: ["remediation", "1.2.1"]

    - name: "REMEDIATION | 1.2.1 | Limpiar caché de yum"
      ansible.builtin.command: yum clean all
      changed_when: true
      tags: ["remediation", "1.2.1"]


# =============================================================================
# 1.2.3 — Ensure GPG keys are configured (Manual)
# CIS Controls v7: 3.4, 3.5
# =============================================================================

    - name: "AUDIT | 1.2.3 | Listar llaves GPG instaladas"
      ansible.builtin.command: >
        rpm -q gpg-pubkey --qf '%{name}-%{version}-%{release} --> %{summary}\n'
      register: cis_1_2_3_gpg
      changed_when: false
      check_mode: false
      failed_when: false
      tags: ["audit", "1.2.3"]

    - name: "AUDIT | 1.2.3 | Verificar que existan llaves GPG configuradas"
      ansible.builtin.assert:
        that:
          - cis_1_2_3_gpg.rc == 0
          - cis_1_2_3_gpg.stdout | length > 0
        success_msg: "PASS | 1.2.3 | Llaves GPG configuradas correctamente."
        fail_msg: "FAIL | 1.2.3 | No se encontraron llaves GPG. Importar llaves según política del sitio."
      tags: ["audit", "1.2.3"]

    - name: "AUDIT | 1.2.3 | Mostrar llaves GPG encontradas"
      ansible.builtin.debug:
        msg: "{{ cis_1_2_3_gpg.stdout_lines }}"
      tags: ["audit", "1.2.3"]


# =============================================================================
# 1.4.1 — Ensure permissions on bootloader config are configured (Automated)
# CIS Controls v7: 5.1
# =============================================================================

    - name: "AUDIT | 1.4.1 | Detectar ruta del bootloader (EFI o legacy)"
      ansible.builtin.find:
        paths: "{{ grub_conf_efi }}"
        patterns: "grub.conf"
        recurse: true
      register: cis_1_4_1_efi_found
      tags: ["audit", "remediation", "1.4.1"]

    - name: "AUDIT | 1.4.1 | Establecer ruta activa del grub"
      ansible.builtin.set_fact:
        grub_conf_path: >-
          {{ cis_1_4_1_efi_found.files[0].path
             if cis_1_4_1_efi_found.matched > 0
             else grub_conf_legacy }}
      tags: ["audit", "remediation", "1.4.1"]

    - name: "AUDIT | 1.4.1 | Verificar permisos del archivo grub.conf"
      ansible.builtin.stat:
        path: "{{ grub_conf_path }}"
      register: cis_1_4_1_stat
      tags: ["audit", "1.4.1"]

    - name: "AUDIT | 1.4.1 | Validar propietario y permisos (root:root / 0600)"
      ansible.builtin.assert:
        that:
          - cis_1_4_1_stat.stat.exists
          - cis_1_4_1_stat.stat.uid == 0
          - cis_1_4_1_stat.stat.gid == 0
          - cis_1_4_1_stat.stat.mode == "0600"
        success_msg: "PASS | 1.4.1 | Permisos del bootloader correctamente configurados."
        fail_msg: "FAIL | 1.4.1 | Permisos incorrectos en {{ grub_conf_path }}. Se aplicará remediación."
      ignore_errors: true
      tags: ["audit", "1.4.1"]

    - name: "REMEDIATION | 1.4.1 | Asignar propietario root:root al grub.conf"
      ansible.builtin.file:
        path: "{{ grub_conf_path }}"
        owner: root
        group: root
      when: cis_1_4_1_stat.stat.exists
      tags: ["remediation", "1.4.1"]

    - name: "REMEDIATION | 1.4.1 | Establecer permisos 0600 en grub.conf"
      ansible.builtin.file:
        path: "{{ grub_conf_path }}"
        mode: "0600"
      when: cis_1_4_1_stat.stat.exists
      tags: ["remediation", "1.4.1"]


# =============================================================================
# 1.4.3 — Ensure authentication required for single user mode (Automated)
# =============================================================================

    - name: "AUDIT | 1.4.3 | Verificar contraseña configurada para modo usuario único"
      ansible.builtin.shell: |
        grep -Eq '^\s*SINGLE=/sbin/sulogin' /etc/sysconfig/init && echo "PASS" || echo "FAIL"
      register: cis_1_4_3_check
      changed_when: false
      check_mode: false
      tags: ["audit", "1.4.3"]

    - name: "AUDIT | 1.4.3 | Validar resultado"
      ansible.builtin.assert:
        that: cis_1_4_3_check.stdout == "PASS"
        success_msg: "PASS | 1.4.3 | Autenticación requerida en modo usuario único."
        fail_msg: "FAIL | 1.4.3 | Sin autenticación en modo usuario único."
      ignore_errors: true
      tags: ["audit", "1.4.3"]

    - name: "REMEDIATION | 1.4.3 | Configurar sulogin para modo usuario único"
      ansible.builtin.lineinfile:
        path: /etc/sysconfig/init
        regexp: '^\s*SINGLE='
        line: "SINGLE=/sbin/sulogin"
        create: true
        mode: "0644"
      tags: ["remediation", "1.4.3"]


# =============================================================================
# 1.5.1 — Ensure core dumps are restricted (Automated)
# CIS Controls v7: 5.1
# =============================================================================

    - name: "AUDIT | 1.5.1 | Verificar límite hard de core dumps en limits.conf"
      ansible.builtin.shell: |
        grep -rE '^\*\s+hard\s+core\s+0' /etc/security/limits.conf /etc/security/limits.d/* 2>/dev/null \
          && echo "PASS" || echo "FAIL"
      register: cis_1_5_1_limits
      changed_when: false
      check_mode: false
      tags: ["audit", "1.5.1"]

    - name: "AUDIT | 1.5.1 | Verificar fs.suid_dumpable = 0"
      ansible.builtin.command: sysctl fs.suid_dumpable
      register: cis_1_5_1_sysctl
      changed_when: false
      check_mode: false
      tags: ["audit", "1.5.1"]

    - name: "AUDIT | 1.5.1 | Validar restricción de core dumps"
      ansible.builtin.assert:
        that:
          - cis_1_5_1_limits.stdout == "PASS"
          - "'fs.suid_dumpable = 0' in cis_1_5_1_sysctl.stdout"
        success_msg: "PASS | 1.5.1 | Core dumps correctamente restringidos."
        fail_msg: "FAIL | 1.5.1 | Core dumps no restringidos. Se aplicará remediación."
      ignore_errors: true
      tags: ["audit", "1.5.1"]

    - name: "REMEDIATION | 1.5.1 | Establecer límite hard core = 0"
      ansible.builtin.lineinfile:
        path: /etc/security/limits.d/cis.conf
        regexp: '^\*\s+hard\s+core'
        line: "* hard core 0"
        create: true
        mode: "0644"
      tags: ["remediation", "1.5.1"]

    - name: "REMEDIATION | 1.5.1 | Configurar fs.suid_dumpable en sysctl.d"
      ansible.posix.sysctl:
        name: fs.suid_dumpable
        value: "0"
        state: present
        sysctl_file: /etc/sysctl.d/cis.conf
        reload: true
      tags: ["remediation", "1.5.1"]


# =============================================================================
# 1.5.3 — Ensure ASLR is enabled (Automated)
# CIS Controls v7: 8.3
# =============================================================================

    - name: "AUDIT | 1.5.3 | Verificar kernel.randomize_va_space = 2"
      ansible.builtin.command: sysctl kernel.randomize_va_space
      register: cis_1_5_3_aslr
      changed_when: false
      check_mode: false
      tags: ["audit", "1.5.3"]

    - name: "AUDIT | 1.5.3 | Verificar que no existan overrides incorrectos en sysctl"
      ansible.builtin.shell: |
        grep -Es '^\s*kernel\.randomize_va_space\s*=\s*([0-1]|[3-9]|[1-9][0-9]+)' \
          /etc/sysctl.conf /etc/sysctl.d/* 2>/dev/null && echo "OVERRIDE_FOUND" || echo "CLEAN"
      register: cis_1_5_3_override
      changed_when: false
      check_mode: false
      tags: ["audit", "1.5.3"]

    - name: "AUDIT | 1.5.3 | Validar ASLR habilitado"
      ansible.builtin.assert:
        that:
          - "'kernel.randomize_va_space = 2' in cis_1_5_3_aslr.stdout"
          - cis_1_5_3_override.stdout == "CLEAN"
        success_msg: "PASS | 1.5.3 | ASLR habilitado correctamente (valor = 2)."
        fail_msg: "FAIL | 1.5.3 | ASLR no configurado o con override incorrecto."
      ignore_errors: true
      tags: ["audit", "1.5.3"]

    - name: "REMEDIATION | 1.5.3 | Establecer kernel.randomize_va_space = 2"
      ansible.posix.sysctl:
        name: kernel.randomize_va_space
        value: "2"
        state: present
        sysctl_file: /etc/sysctl.d/cis.conf
        reload: true
      tags: ["remediation", "1.5.3"]

    - name: "REMEDIATION | 1.5.3 | Comentar overrides incorrectos en sysctl.conf"
      ansible.builtin.replace:
        path: /etc/sysctl.conf
        regexp: '^\s*(kernel\.randomize_va_space\s*=\s*([0-1]|[3-9]|[1-9][0-9]+))'
        replace: '# \1'
      tags: ["remediation", "1.5.3"]

    - name: "REMEDIATION | 1.5.3 | Comentar overrides incorrectos en sysctl.d"
      ansible.builtin.replace:
        path: "{{ item }}"
        regexp: '^\s*(kernel\.randomize_va_space\s*=\s*([0-1]|[3-9]|[1-9][0-9]+))'
        replace: '# \1'
      with_fileglob:
        - /etc/sysctl.d/*.conf
      tags: ["remediation", "1.5.3"]


# =============================================================================
# 1.5.4 — Ensure prelink is disabled (Automated)
# CIS Controls v7: 14.9
# =============================================================================

    - name: "AUDIT | 1.5.4 | Verificar si prelink está instalado"
      ansible.builtin.command: rpm -q prelink
      register: cis_1_5_4_prelink
      changed_when: false
      check_mode: false
      failed_when: false
      tags: ["audit", "1.5.4"]

    - name: "AUDIT | 1.5.4 | Validar que prelink no esté instalado"
      ansible.builtin.assert:
        that: cis_1_5_4_prelink.rc != 0
        success_msg: "PASS | 1.5.4 | prelink no está instalado."
        fail_msg: "FAIL | 1.5.4 | prelink detectado. Se aplicará remediación."
      ignore_errors: true
      tags: ["audit", "1.5.4"]

    - name: "REMEDIATION | 1.5.4 | Restaurar binarios antes de remover prelink"
      ansible.builtin.command: prelink -ua
      when: cis_1_5_4_prelink.rc == 0
      changed_when: true
      tags: ["remediation", "1.5.4"]

    - name: "REMEDIATION | 1.5.4 | Remover paquete prelink"
      ansible.builtin.yum:
        name: prelink
        state: absent
      tags: ["remediation", "1.5.4"]


# =============================================================================
# 1.7.1 — Ensure message of the day is configured properly (Automated)
# CIS Controls v7: 5.1
# =============================================================================

    - name: "AUDIT | 1.7.1 | Leer contenido actual de /etc/motd"
      ansible.builtin.command: cat /etc/motd
      register: cis_1_7_1_motd
      changed_when: false
      check_mode: false
      failed_when: false
      tags: ["audit", "1.7.1"]

    - name: "AUDIT | 1.7.1 | Verificar ausencia de información del SO en /etc/motd"
      ansible.builtin.shell: |
        grep -E -i '(\\v|\\r|\\m|\\s|Linux)' /etc/motd && echo "FAIL" || echo "PASS"
      register: cis_1_7_1_check
      changed_when: false
      check_mode: false
      failed_when: false
      tags: ["audit", "1.7.1"]

    - name: "AUDIT | 1.7.1 | Validar contenido del motd"
      ansible.builtin.assert:
        that: cis_1_7_1_check.stdout == "PASS"
        success_msg: "PASS | 1.7.1 | /etc/motd no expone información del sistema operativo."
        fail_msg: "FAIL | 1.7.1 | /etc/motd contiene referencias al SO. Se aplicará remediación."
      ignore_errors: true
      tags: ["audit", "1.7.1"]

    - name: "REMEDIATION | 1.7.1 | Configurar /etc/motd con banner institucional"
      ansible.builtin.copy:
        dest: /etc/motd
        owner: root
        group: root
        mode: "0644"
        content: |
          ********************************************************************
          SISTEMA DE USO RESTRINGIDO — ACCESO AUTORIZADO SOLAMENTE
          Este sistema es propiedad de la organización. Todo acceso es
          monitoreado y registrado. El uso no autorizado está prohibido y
          será reportado a las autoridades competentes.
          ********************************************************************
      tags: ["remediation", "1.7.1"]


# =============================================================================
# 1.7.6 — Ensure permissions on /etc/issue.net are configured (Automated)
# CIS Controls v7: 14.6
# =============================================================================

    - name: "AUDIT | 1.7.6 | Verificar permisos de /etc/issue.net"
      ansible.builtin.stat:
        path: /etc/issue.net
      register: cis_1_7_6_stat
      tags: ["audit", "1.7.6"]

    - name: "AUDIT | 1.7.6 | Validar propietario root:root y permisos 0644"
      ansible.builtin.assert:
        that:
          - cis_1_7_6_stat.stat.exists
          - cis_1_7_6_stat.stat.uid == 0
          - cis_1_7_6_stat.stat.gid == 0
          - cis_1_7_6_stat.stat.mode == "0644"
        success_msg: "PASS | 1.7.6 | Permisos de /etc/issue.net correctamente configurados."
        fail_msg: "FAIL | 1.7.6 | Permisos incorrectos en /etc/issue.net. Se aplicará remediación."
      ignore_errors: true
      tags: ["audit", "1.7.6"]

    - name: "REMEDIATION | 1.7.6 | Asignar propietario root:root a /etc/issue.net"
      ansible.builtin.file:
        path: /etc/issue.net
        owner: root
        group: root
      when: cis_1_7_6_stat.stat.exists
      tags: ["remediation", "1.7.6"]

    - name: "REMEDIATION | 1.7.6 | Establecer permisos 0644 en /etc/issue.net"
      ansible.builtin.file:
        path: /etc/issue.net
        mode: "0644"
      when: cis_1_7_6_stat.stat.exists
      tags: ["remediation", "1.7.6"]


# =============================================================================
# 3.2.1 — Ensure IP forwarding is disabled (Automated)
# CIS Controls v7: 9.2
# =============================================================================

    - name: "AUDIT | 3.2.1 | Verificar net.ipv4.ip_forward = 0"
      ansible.builtin.command: sysctl net.ipv4.ip_forward
      register: cis_3_2_1_ipv4_fwd
      changed_when: false
      check_mode: false
      tags: ["audit", "3.2.1"]

    - name: "AUDIT | 3.2.1 | Verificar ausencia de overrides ipv4.ip_forward=1"
      ansible.builtin.shell: |
        grep -E -s '^\s*net\.ipv4\.ip_forward\s*=\s*1' \
          /etc/sysctl.conf /etc/sysctl.d/*.conf /usr/lib/sysctl.d/*.conf /run/sysctl.d/*.conf \
          2>/dev/null && echo "OVERRIDE_FOUND" || echo "CLEAN"
      register: cis_3_2_1_ipv4_override
      changed_when: false
      check_mode: false
      tags: ["audit", "3.2.1"]

    - name: "AUDIT | 3.2.1 | Verificar net.ipv6.conf.all.forwarding = 0 (si IPv6 activo)"
      ansible.builtin.command: sysctl net.ipv6.conf.all.forwarding
      register: cis_3_2_1_ipv6_fwd
      changed_when: false
      check_mode: false
      failed_when: false
      tags: ["audit", "3.2.1"]

    - name: "AUDIT | 3.2.1 | Validar IP forwarding deshabilitado"
      ansible.builtin.assert:
        that:
          - "'net.ipv4.ip_forward = 0' in cis_3_2_1_ipv4_fwd.stdout"
          - cis_3_2_1_ipv4_override.stdout == "CLEAN"
        success_msg: "PASS | 3.2.1 | IP forwarding deshabilitado correctamente."
        fail_msg: "FAIL | 3.2.1 | IP forwarding habilitado o con override. Se aplicará remediación."
      ignore_errors: true
      tags: ["audit", "3.2.1"]

    - name: "REMEDIATION | 3.2.1 | Deshabilitar net.ipv4.ip_forward"
      ansible.posix.sysctl:
        name: net.ipv4.ip_forward
        value: "0"
        state: present
        sysctl_file: /etc/sysctl.d/cis.conf
        reload: true
      tags: ["remediation", "3.2.1"]

    - name: "REMEDIATION | 3.2.1 | Comentar overrides de ipv4.ip_forward en sysctl files"
      ansible.builtin.shell: |
        grep -Els '^\s*net\.ipv4\.ip_forward\s*=\s*1' \
          /etc/sysctl.conf /etc/sysctl.d/*.conf /usr/lib/sysctl.d/*.conf /run/sysctl.d/*.conf \
          2>/dev/null | while read f; do
            sed -ri 's/^\s*(net\.ipv4\.ip_forward\s*)(=)(\s*\S+\b).*$/# *REMOVED* \1/' "$f"
          done
        sysctl -w net.ipv4.ip_forward=0
        sysctl -w net.ipv4.route.flush=1
      changed_when: true
      tags: ["remediation", "3.2.1"]

    - name: "REMEDIATION | 3.2.1 | Deshabilitar net.ipv6.conf.all.forwarding (si IPv6 activo)"
      ansible.posix.sysctl:
        name: net.ipv6.conf.all.forwarding
        value: "0"
        state: present
        sysctl_file: /etc/sysctl.d/cis.conf
        reload: true
      when: cis_3_2_1_ipv6_fwd.rc == 0
      tags: ["remediation", "3.2.1"]

    - name: "REMEDIATION | 3.2.1 | Comentar overrides de ipv6.forwarding en sysctl files"
      ansible.builtin.shell: |
        grep -Els '^\s*net\.ipv6\.conf\.all\.forwarding\s*=\s*1' \
          /etc/sysctl.conf /etc/sysctl.d/*.conf /usr/lib/sysctl.d/*.conf /run/sysctl.d/*.conf \
          2>/dev/null | while read f; do
            sed -ri 's/^\s*(net\.ipv6\.conf\.all\.forwarding\s*)(=)(\s*\S+\b).*$/# *REMOVED* \1/' "$f"
          done
        sysctl -w net.ipv6.conf.all.forwarding=0
        sysctl -w net.ipv6.route.flush=1
      when: cis_3_2_1_ipv6_fwd.rc == 0
      changed_when: true
      tags: ["remediation", "3.2.1"]


# =============================================================================
# 3.3.1 — Ensure source routed packets are not accepted (Automated)
# CIS Controls v7: 9.2
# =============================================================================

    - name: "AUDIT | 3.3.1 | Verificar net.ipv4.conf.all.accept_source_route = 0"
      ansible.builtin.command: sysctl net.ipv4.conf.all.accept_source_route
      register: cis_3_3_1_ipv4_all
      changed_when: false
      check_mode: false
      tags: ["audit", "3.3.1"]

    - name: "AUDIT | 3.3.1 | Verificar net.ipv4.conf.default.accept_source_route = 0"
      ansible.builtin.command: sysctl net.ipv4.conf.default.accept_source_route
      register: cis_3_3_1_ipv4_default
      changed_when: false
      check_mode: false
      tags: ["audit", "3.3.1"]

    - name: "AUDIT | 3.3.1 | Verificar net.ipv6.conf.all.accept_source_route = 0 (si IPv6 activo)"
      ansible.builtin.command: sysctl net.ipv6.conf.all.accept_source_route
      register: cis_3_3_1_ipv6_all
      changed_when: false
      check_mode: false
      failed_when: false
      tags: ["audit", "3.3.1"]

    - name: "AUDIT | 3.3.1 | Verificar net.ipv6.conf.default.accept_source_route = 0 (si IPv6 activo)"
      ansible.builtin.command: sysctl net.ipv6.conf.default.accept_source_route
      register: cis_3_3_1_ipv6_default
      changed_when: false
      check_mode: false
      failed_when: false
      tags: ["audit", "3.3.1"]

    - name: "AUDIT | 3.3.1 | Validar que source routing esté deshabilitado (IPv4)"
      ansible.builtin.assert:
        that:
          - "'net.ipv4.conf.all.accept_source_route = 0' in cis_3_3_1_ipv4_all.stdout"
          - "'net.ipv4.conf.default.accept_source_route = 0' in cis_3_3_1_ipv4_default.stdout"
        success_msg: "PASS | 3.3.1 | Source routing IPv4 deshabilitado correctamente."
        fail_msg: "FAIL | 3.3.1 | Source routing IPv4 habilitado. Se aplicará remediación."
      ignore_errors: true
      tags: ["audit", "3.3.1"]

    - name: "REMEDIATION | 3.3.1 | Deshabilitar accept_source_route IPv4 (all)"
      ansible.posix.sysctl:
        name: net.ipv4.conf.all.accept_source_route
        value: "0"
        state: present
        sysctl_file: /etc/sysctl.d/cis.conf
        reload: true
      tags: ["remediation", "3.3.1"]

    - name: "REMEDIATION | 3.3.1 | Deshabilitar accept_source_route IPv4 (default)"
      ansible.posix.sysctl:
        name: net.ipv4.conf.default.accept_source_route
        value: "0"
        state: present
        sysctl_file: /etc/sysctl.d/cis.conf
        reload: true
      tags: ["remediation", "3.3.1"]

    - name: "REMEDIATION | 3.3.1 | Flush de rutas IPv4"
      ansible.builtin.command: sysctl -w net.ipv4.route.flush=1
      changed_when: true
      tags: ["remediation", "3.3.1"]

    - name: "REMEDIATION | 3.3.1 | Deshabilitar accept_source_route IPv6 (all)"
      ansible.posix.sysctl:
        name: net.ipv6.conf.all.accept_source_route
        value: "0"
        state: present
        sysctl_file: /etc/sysctl.d/cis.conf
        reload: true
      when: cis_3_3_1_ipv6_all.rc == 0
      tags: ["remediation", "3.3.1"]

    - name: "REMEDIATION | 3.3.1 | Deshabilitar accept_source_route IPv6 (default)"
      ansible.posix.sysctl:
        name: net.ipv6.conf.default.accept_source_route
        value: "0"
        state: present
        sysctl_file: /etc/sysctl.d/cis.conf
        reload: true
      when: cis_3_3_1_ipv6_default.rc == 0
      tags: ["remediation", "3.3.1"]

    - name: "REMEDIATION | 3.3.1 | Flush de rutas IPv6"
      ansible.builtin.command: sysctl -w net.ipv6.route.flush=1
      when: cis_3_3_1_ipv6_all.rc == 0
      changed_when: true
      tags: ["remediation", "3.3.1"]


# =============================================================================
# 3.3.8 — Ensure TCP SYN Cookies is enabled (Automated)
# CIS Controls v7: 9.2
# =============================================================================

    - name: "AUDIT | 3.3.8 | Verificar net.ipv4.tcp_syncookies = 1 (runtime)"
      ansible.builtin.command: sysctl net.ipv4.tcp_syncookies
      register: cis_3_3_8_runtime
      changed_when: false
      check_mode: false
      tags: ["audit", "3.3.8"]

    - name: "AUDIT | 3.3.8 | Verificar tcp_syncookies en archivos sysctl"
      ansible.builtin.shell: |
        grep -E 'net\.ipv4\.tcp_syncookies\s*=\s*1' \
          /etc/sysctl.conf /etc/sysctl.d/* 2>/dev/null && echo "PASS" || echo "FAIL"
      register: cis_3_3_8_file
      changed_when: false
      check_mode: false
      tags: ["audit", "3.3.8"]

    - name: "AUDIT | 3.3.8 | Validar TCP SYN Cookies habilitado"
      ansible.builtin.assert:
        that:
          - "'net.ipv4.tcp_syncookies = 1' in cis_3_3_8_runtime.stdout"
          - cis_3_3_8_file.stdout == "PASS"
        success_msg: "PASS | 3.3.8 | TCP SYN Cookies habilitado correctamente."
        fail_msg: "FAIL | 3.3.8 | TCP SYN Cookies no está habilitado. Se aplicará remediación."
      ignore_errors: true
      tags: ["audit", "3.3.8"]

    - name: "REMEDIATION | 3.3.8 | Habilitar net.ipv4.tcp_syncookies"
      ansible.posix.sysctl:
        name: net.ipv4.tcp_syncookies
        value: "1"
        state: present
        sysctl_file: /etc/sysctl.d/cis.conf
        reload: true
      tags: ["remediation", "3.3.8"]

    - name: "REMEDIATION | 3.3.8 | Flush de rutas IPv4"
      ansible.builtin.command: sysctl -w net.ipv4.route.flush=1
      changed_when: true
      tags: ["remediation", "3.3.8"]


# =============================================================================
# 3.4.5 — Ensure permissions on /etc/hosts.deny are configured (Automated)
# CIS Controls v7: 14.6
# =============================================================================

    - name: "AUDIT | 3.4.5 | Verificar permisos de /etc/hosts.deny"
      ansible.builtin.stat:
        path: /etc/hosts.deny
      register: cis_3_4_5_stat
      tags: ["audit", "3.4.5"]

    - name: "AUDIT | 3.4.5 | Validar propietario root:root y permisos 0644"
      ansible.builtin.assert:
        that:
          - cis_3_4_5_stat.stat.exists
          - cis_3_4_5_stat.stat.uid == 0
          - cis_3_4_5_stat.stat.gid == 0
          - cis_3_4_5_stat.stat.mode == "0644"
        success_msg: "PASS | 3.4.5 | Permisos de /etc/hosts.deny correctamente configurados."
        fail_msg: "FAIL | 3.4.5 | Permisos incorrectos en /etc/hosts.deny. Se aplicará remediación."
      ignore_errors: true
      tags: ["audit", "3.4.5"]

    - name: "REMEDIATION | 3.4.5 | Asignar propietario root:root a /etc/hosts.deny"
      ansible.builtin.file:
        path: /etc/hosts.deny
        owner: root
        group: root
      when: cis_3_4_5_stat.stat.exists
      tags: ["remediation", "3.4.5"]

    - name: "REMEDIATION | 3.4.5 | Establecer permisos 0644 en /etc/hosts.deny"
      ansible.builtin.file:
        path: /etc/hosts.deny
        mode: "0644"
      when: cis_3_4_5_stat.stat.exists
      tags: ["remediation", "3.4.5"]


# =============================================================================
# 5.1.1 — Ensure cron daemon is enabled (Automated)
# CIS Controls v7: 6
# =============================================================================

    - name: "AUDIT | 5.1.1 | Verificar estado del servicio crond"
      ansible.builtin.service_facts:
      tags: ["audit", "5.1.1"]

    - name: "AUDIT | 5.1.1 | Validar que crond esté habilitado y activo"
      ansible.builtin.assert:
        that:
          - ansible_facts.services['crond.service'] is defined
          - ansible_facts.services['crond.service'].state == 'running'
          - ansible_facts.services['crond.service'].status == 'enabled'
        success_msg: "PASS | 5.1.1 | crond está habilitado y en ejecución."
        fail_msg: "FAIL | 5.1.1 | crond no está habilitado o no está corriendo. Se aplicará remediación."
      ignore_errors: true
      tags: ["audit", "5.1.1"]

    - name: "REMEDIATION | 5.1.1 | Habilitar e iniciar el servicio crond"
      ansible.builtin.service:
        name: crond
        state: started
        enabled: true
      tags: ["remediation", "5.1.1"]


# =============================================================================
# 5.1.2 — Ensure permissions on /etc/crontab are configured (Automated)
# CIS Controls v7: 14.6
# =============================================================================

    - name: "AUDIT | 5.1.2 | Verificar permisos de /etc/crontab"
      ansible.builtin.stat:
        path: /etc/crontab
      register: cis_5_1_2_stat
      tags: ["audit", "5.1.2"]

    - name: "AUDIT | 5.1.2 | Validar propietario root:root y permisos 0600"
      ansible.builtin.assert:
        that:
          - cis_5_1_2_stat.stat.exists
          - cis_5_1_2_stat.stat.uid == 0
          - cis_5_1_2_stat.stat.gid == 0
          - cis_5_1_2_stat.stat.mode == "0600"
        success_msg: "PASS | 5.1.2 | Permisos de /etc/crontab correctamente configurados."
        fail_msg: "FAIL | 5.1.2 | Permisos incorrectos en /etc/crontab. Se aplicará remediación."
      ignore_errors: true
      tags: ["audit", "5.1.2"]

    - name: "REMEDIATION | 5.1.2 | Asignar propietario root:root a /etc/crontab"
      ansible.builtin.file:
        path: /etc/crontab
        owner: root
        group: root
      when: cis_5_1_2_stat.stat.exists
      tags: ["remediation", "5.1.2"]

    - name: "REMEDIATION | 5.1.2 | Establecer permisos 0600 en /etc/crontab"
      ansible.builtin.file:
        path: /etc/crontab
        mode: "0600"
      when: cis_5_1_2_stat.stat.exists
      tags: ["remediation", "5.1.2"]


# =============================================================================
# 5.2.1 — Ensure sudo is installed (Automated)
# CIS Controls v7: 4
# =============================================================================

    - name: "AUDIT | 5.2.1 | Verificar si sudo está instalado"
      ansible.builtin.command: rpm -q sudo
      register: cis_5_2_1_sudo
      changed_when: false
      check_mode: false
      failed_when: false
      tags: ["audit", "5.2.1"]

    - name: "AUDIT | 5.2.1 | Validar que sudo esté instalado"
      ansible.builtin.assert:
        that: cis_5_2_1_sudo.rc == 0
        success_msg: "PASS | 5.2.1 | sudo está instalado: {{ cis_5_2_1_sudo.stdout }}"
        fail_msg: "FAIL | 5.2.1 | sudo no está instalado. Se aplicará remediación."
      ignore_errors: true
      tags: ["audit", "5.2.1"]

    - name: "REMEDIATION | 5.2.1 | Instalar paquete sudo"
      ansible.builtin.yum:
        name: sudo
        state: present
      when: cis_5_2_1_sudo.rc != 0
      tags: ["remediation", "5.2.1"]


# =============================================================================
# 5.3.1 — Ensure permissions on /etc/ssh/sshd_config are configured (Automated)
# CIS Controls v7: 14.6
# =============================================================================

    - name: "AUDIT | 5.3.1 | Verificar permisos de /etc/ssh/sshd_config"
      ansible.builtin.stat:
        path: /etc/ssh/sshd_config
      register: cis_5_3_1_stat
      tags: ["audit", "5.3.1"]

    - name: "AUDIT | 5.3.1 | Validar propietario root:root y permisos 0600"
      ansible.builtin.assert:
        that:
          - cis_5_3_1_stat.stat.exists
          - cis_5_3_1_stat.stat.uid == 0
          - cis_5_3_1_stat.stat.gid == 0
          - cis_5_3_1_stat.stat.mode == "0600"
        success_msg: "PASS | 5.3.1 | Permisos de sshd_config correctamente configurados."
        fail_msg: "FAIL | 5.3.1 | Permisos incorrectos en /etc/ssh/sshd_config. Se aplicará remediación."
      ignore_errors: true
      tags: ["audit", "5.3.1"]

    - name: "REMEDIATION | 5.3.1 | Asignar propietario root:root a sshd_config"
      ansible.builtin.file:
        path: /etc/ssh/sshd_config
        owner: root
        group: root
        mode: "0600"
      tags: ["remediation", "5.3.1"]


# =============================================================================
# 5.3.3 — Ensure permissions on SSH public host key files are configured (Automated)
# CIS Controls v7: 14.6
# =============================================================================

    - name: "AUDIT | 5.3.3 | Buscar llaves públicas SSH en /etc/ssh"
      ansible.builtin.find:
        paths: /etc/ssh
        patterns: "ssh_host_*_key.pub"
        file_type: file
      register: cis_5_3_3_pubkeys
      tags: ["audit", "5.3.3"]

    - name: "AUDIT | 5.3.3 | Verificar permisos de cada llave pública"
      ansible.builtin.stat:
        path: "{{ item.path }}"
      register: cis_5_3_3_stat
      loop: "{{ cis_5_3_3_pubkeys.files }}"
      loop_control:
        label: "{{ item.path }}"
      tags: ["audit", "5.3.3"]

    - name: "AUDIT | 5.3.3 | Validar permisos 0644 y propietario root en llaves públicas"
      ansible.builtin.assert:
        that:
          - item.stat.uid == 0
          - item.stat.gid == 0
          - item.stat.mode == "0644"
        success_msg: "PASS | 5.3.3 | {{ item.stat.path }} — permisos correctos."
        fail_msg: "FAIL | 5.3.3 | {{ item.stat.path }} — permisos incorrectos. Se aplicará remediación."
      loop: "{{ cis_5_3_3_stat.results }}"
      loop_control:
        label: "{{ item.stat.path }}"
      ignore_errors: true
      tags: ["audit", "5.3.3"]

    - name: "REMEDIATION | 5.3.3 | Aplicar permisos 0644 y root:root en llaves públicas SSH"
      ansible.builtin.file:
        path: "{{ item.path }}"
        owner: root
        group: root
        mode: "0644"
      loop: "{{ cis_5_3_3_pubkeys.files }}"
      loop_control:
        label: "{{ item.path }}"
      tags: ["remediation", "5.3.3"]


# =============================================================================
# 5.3.8 — Ensure SSH MaxAuthTries is set to 4 or less (Automated)
# CIS Controls v7: 16.13
# =============================================================================

    - name: "AUDIT | 5.3.8 | Verificar MaxAuthTries en configuración efectiva de sshd"
      ansible.builtin.shell: |
        sshd -T -C user=root -C host="$(hostname)" \
          -C addr="$(grep $(hostname) /etc/hosts | awk '{print $1}' | head -1)" \
          2>/dev/null | grep -i maxauthtries
      register: cis_5_3_8_runtime
      changed_when: false
      check_mode: false
      tags: ["audit", "5.3.8"]

    - name: "AUDIT | 5.3.8 | Verificar ausencia de MaxAuthTries > 4 en sshd_config"
      ansible.builtin.shell: |
        grep -Ei '^\s*maxauthtries\s+([5-9]|[1-9][0-9]+)' /etc/ssh/sshd_config \
          && echo "FAIL" || echo "PASS"
      register: cis_5_3_8_file
      changed_when: false
      check_mode: false
      tags: ["audit", "5.3.8"]

    - name: "AUDIT | 5.3.8 | Validar MaxAuthTries <= 4"
      ansible.builtin.assert:
        that:
          - cis_5_3_8_runtime.stdout | regex_search('maxauthtries\s+[1-4]$')
          - cis_5_3_8_file.stdout == "PASS"
        success_msg: "PASS | 5.3.8 | MaxAuthTries configurado correctamente (<= 4)."
        fail_msg: "FAIL | 5.3.8 | MaxAuthTries supera el límite permitido. Se aplicará remediación."
      ignore_errors: true
      tags: ["audit", "5.3.8"]

    - name: "REMEDIATION | 5.3.8 | Establecer MaxAuthTries 4 en sshd_config"
      ansible.builtin.lineinfile:
        path: /etc/ssh/sshd_config
        regexp: '^\s*#?\s*MaxAuthTries'
        line: "MaxAuthTries 4"
        state: present
      notify: Restart sshd
      tags: ["remediation", "5.3.8"]


# =============================================================================
# 5.3.9 — Ensure SSH IgnoreRhosts is enabled (Automated)
# CIS Controls v7: 9.2
# =============================================================================

    - name: "AUDIT | 5.3.9 | Verificar IgnoreRhosts en configuración efectiva de sshd"
      ansible.builtin.shell: |
        sshd -T -C user=root -C host="$(hostname)" \
          -C addr="$(grep $(hostname) /etc/hosts | awk '{print $1}' | head -1)" \
          2>/dev/null | grep -i ignorerhosts
      register: cis_5_3_9_runtime
      changed_when: false
      check_mode: false
      tags: ["audit", "5.3.9"]

    - name: "AUDIT | 5.3.9 | Verificar ausencia de IgnoreRhosts no en sshd_config"
      ansible.builtin.shell: |
        grep -Ei '^\s*ignorerhosts\s+no\b' /etc/ssh/sshd_config \
          && echo "FAIL" || echo "PASS"
      register: cis_5_3_9_file
      changed_when: false
      check_mode: false
      tags: ["audit", "5.3.9"]

    - name: "AUDIT | 5.3.9 | Validar IgnoreRhosts habilitado"
      ansible.builtin.assert:
        that:
          - "'ignorerhosts yes' in cis_5_3_9_runtime.stdout"
          - cis_5_3_9_file.stdout == "PASS"
        success_msg: "PASS | 5.3.9 | IgnoreRhosts habilitado correctamente."
        fail_msg: "FAIL | 5.3.9 | IgnoreRhosts no está habilitado. Se aplicará remediación."
      ignore_errors: true
      tags: ["audit", "5.3.9"]

    - name: "REMEDIATION | 5.3.9 | Establecer IgnoreRhosts yes en sshd_config"
      ansible.builtin.lineinfile:
        path: /etc/ssh/sshd_config
        regexp: '^\s*#?\s*IgnoreRhosts'
        line: "IgnoreRhosts yes"
        state: present
      notify: Restart sshd
      tags: ["remediation", "5.3.9"]


# =============================================================================
# 5.3.12 — Ensure SSH PermitEmptyPasswords is disabled (Automated)
# CIS Controls v7: 16.3
# =============================================================================

    - name: "AUDIT | 5.3.12 | Verificar PermitEmptyPasswords en configuración efectiva"
      ansible.builtin.shell: |
        sshd -T -C user=root -C host="$(hostname)" \
          -C addr="$(grep $(hostname) /etc/hosts | awk '{print $1}' | head -1)" \
          2>/dev/null | grep -i permitemptypasswords
      register: cis_5_3_12_runtime
      changed_when: false
      check_mode: false
      tags: ["audit", "5.3.12"]

    - name: "AUDIT | 5.3.12 | Verificar ausencia de PermitEmptyPasswords yes en sshd_config"
      ansible.builtin.shell: |
        grep -Ei '^\s*PermitEmptyPasswords\s+yes' /etc/ssh/sshd_config \
          && echo "FAIL" || echo "PASS"
      register: cis_5_3_12_file
      changed_when: false
      check_mode: false
      tags: ["audit", "5.3.12"]

    - name: "AUDIT | 5.3.12 | Validar PermitEmptyPasswords deshabilitado"
      ansible.builtin.assert:
        that:
          - "'permitemptypasswords no' in cis_5_3_12_runtime.stdout"
          - cis_5_3_12_file.stdout == "PASS"
        success_msg: "PASS | 5.3.12 | PermitEmptyPasswords correctamente deshabilitado."
        fail_msg: "FAIL | 5.3.12 | PermitEmptyPasswords habilitado. Se aplicará remediación."
      ignore_errors: true
      tags: ["audit", "5.3.12"]

    - name: "REMEDIATION | 5.3.12 | Establecer PermitEmptyPasswords no en sshd_config"
      ansible.builtin.lineinfile:
        path: /etc/ssh/sshd_config
        regexp: '^\s*#?\s*PermitEmptyPasswords'
        line: "PermitEmptyPasswords no"
        state: present
      notify: Restart sshd
      tags: ["remediation", "5.3.12"]


# =============================================================================
# 5.3.14 — Ensure only strong Ciphers are used (Automated)
# CIS Controls v7: 14.4
# =============================================================================

    - name: "AUDIT | 5.3.14 | Verificar ausencia de cifrados débiles en configuración efectiva"
      ansible.builtin.shell: |
        sshd -T -C user=root -C host="$(hostname)" \
          -C addr="$(grep $(hostname) /etc/hosts | awk '{print $1}' | head -1)" \
          2>/dev/null | grep -Ei 'ciphers' | \
          grep -Ei '(3des-cbc|aes128-cbc|aes192-cbc|aes256-cbc|arcfour|arcfour128|arcfour256|blowfish-cbc|cast128-cbc|rijndael-cbc)' \
          && echo "FAIL" || echo "PASS"
      register: cis_5_3_14_runtime
      changed_when: false
      check_mode: false
      tags: ["audit", "5.3.14"]

    - name: "AUDIT | 5.3.14 | Verificar ausencia de cifrados débiles en sshd_config"
      ansible.builtin.shell: |
        grep -Ei '^\s*ciphers\s+([^#]+,)?(3des-cbc|aes128-cbc|aes192-cbc|aes256-cbc|arcfour|arcfour128|arcfour256|blowfish-cbc|cast128-cbc|rijndael-cbc)' \
          /etc/ssh/sshd_config && echo "FAIL" || echo "PASS"
      register: cis_5_3_14_file
      changed_when: false
      check_mode: false
      tags: ["audit", "5.3.14"]

    - name: "AUDIT | 5.3.14 | Validar uso exclusivo de cifrados fuertes"
      ansible.builtin.assert:
        that:
          - cis_5_3_14_runtime.stdout == "PASS"
          - cis_5_3_14_file.stdout == "PASS"
        success_msg: "PASS | 5.3.14 | Solo cifrados fuertes habilitados en SSH."
        fail_msg: "FAIL | 5.3.14 | Cifrados débiles detectados. Se aplicará remediación."
      ignore_errors: true
      tags: ["audit", "5.3.14"]

    - name: "REMEDIATION | 5.3.14 | Configurar solo cifrados fuertes (FIPS 140-2 compliant)"
      ansible.builtin.lineinfile:
        path: /etc/ssh/sshd_config
        regexp: '^\s*#?\s*Ciphers'
        line: "Ciphers aes256-ctr,aes192-ctr,aes128-ctr"
        state: present
      notify: Restart sshd
      tags: ["remediation", "5.3.14"]


# =============================================================================
# 5.4.1 — Ensure password creation requirements are configured (Automated)
# CIS Controls v7: 4.4
# =============================================================================

    - name: "AUDIT | 5.4.1 | Verificar pam_cracklib en /etc/pam.d/password-auth"
      ansible.builtin.shell: |
        grep -E 'pam_cracklib\.so' /etc/pam.d/password-auth 2>/dev/null \
          && echo "FOUND" || echo "MISSING"
      register: cis_5_4_1_pwauth
      changed_when: false
      check_mode: false
      tags: ["audit", "5.4.1"]

    - name: "AUDIT | 5.4.1 | Verificar pam_cracklib en /etc/pam.d/system-auth"
      ansible.builtin.shell: |
        grep -E 'pam_cracklib\.so' /etc/pam.d/system-auth 2>/dev/null \
          && echo "FOUND" || echo "MISSING"
      register: cis_5_4_1_sysauth
      changed_when: false
      check_mode: false
      tags: ["audit", "5.4.1"]

    - name: "AUDIT | 5.4.1 | Verificar minlen >= 14 en password-auth"
      ansible.builtin.shell: |
        grep -E 'pam_cracklib\.so' /etc/pam.d/password-auth 2>/dev/null | \
          grep -E 'minlen=([1-9][4-9]|[2-9][0-9]|[1-9][0-9]{2,})' \
          && echo "PASS" || echo "FAIL"
      register: cis_5_4_1_minlen
      changed_when: false
      check_mode: false
      tags: ["audit", "5.4.1"]

    - name: "AUDIT | 5.4.1 | Validar requisitos de contraseña"
      ansible.builtin.assert:
        that:
          - cis_5_4_1_pwauth.stdout == "FOUND"
          - cis_5_4_1_sysauth.stdout == "FOUND"
          - cis_5_4_1_minlen.stdout == "PASS"
        success_msg: "PASS | 5.4.1 | Requisitos de creación de contraseña correctamente configurados."
        fail_msg: "FAIL | 5.4.1 | pam_cracklib no configurado o minlen < 14. Se aplicará remediación."
      ignore_errors: true
      tags: ["audit", "5.4.1"]

    - name: "REMEDIATION | 5.4.1 | Configurar pam_cracklib en /etc/pam.d/password-auth"
      ansible.builtin.lineinfile:
        path: /etc/pam.d/password-auth
        regexp: '^\s*password\s+(requisite|required)\s+pam_cracklib\.so'
        line: "password requisite pam_cracklib.so try_first_pass retry=3 minlen=14 dcredit=-1 ucredit=-1 ocredit=-1 lcredit=-1"
        state: present
      tags: ["remediation", "5.4.1"]

    - name: "REMEDIATION | 5.4.1 | Configurar pam_cracklib en /etc/pam.d/system-auth"
      ansible.builtin.lineinfile:
        path: /etc/pam.d/system-auth
        regexp: '^\s*password\s+(requisite|required)\s+pam_cracklib\.so'
        line: "password requisite pam_cracklib.so try_first_pass retry=3 minlen=14 dcredit=-1 ucredit=-1 ocredit=-1 lcredit=-1"
        state: present
      tags: ["remediation", "5.4.1"]


# =============================================================================
# 5.5.5 — Ensure default user umask is configured (Automated)
# CIS Controls v7: 5.1, 13
# =============================================================================

    - name: "AUDIT | 5.5.5 | Verificar ausencia de umask permisivo en archivos de perfil"
      ansible.builtin.shell: |
        grep -Ev '^\s*umask\s+(0[0-7][2-7]7|[0-7][2-7]7|u=(r?|w?|x?)(r?|w?|x?)(r?|w?|x?),g=(r?x?|x?r?),o=)\s*(\s*#.*)?$' \
          /etc/profile /etc/profile.d/*.sh /etc/bashrc 2>/dev/null \
          | grep -E '(^|^[^#]*)umask' && echo "FAIL" || echo "PASS"
      register: cis_5_5_5_permissive
      changed_when: false
      check_mode: false
      tags: ["audit", "5.5.5"]

    - name: "AUDIT | 5.5.5 | Verificar que exista umask restrictivo configurado"
      ansible.builtin.shell: |
        grep -E '^\s*umask\s+(0[0-7][2-7]7|[0-7][2-7]7|u=(r?|w?|x?)(r?|w?|x?)(r?|w?|x?),g=(r?x?|x?r?),o=)\s*(\s*#.*)?$' \
          /etc/profile /etc/profile.d/*.sh /etc/bashrc 2>/dev/null \
          && echo "PASS" || echo "FAIL"
      register: cis_5_5_5_restrictive
      changed_when: false
      check_mode: false
      tags: ["audit", "5.5.5"]

    - name: "AUDIT | 5.5.5 | Validar umask por defecto >= 027"
      ansible.builtin.assert:
        that:
          - cis_5_5_5_permissive.stdout == "PASS"
          - cis_5_5_5_restrictive.stdout == "PASS"
        success_msg: "PASS | 5.5.5 | umask por defecto correctamente configurado (027 o más restrictivo)."
        fail_msg: "FAIL | 5.5.5 | umask permisivo detectado o no configurado. Se aplicará remediación."
      ignore_errors: true
      tags: ["audit", "5.5.5"]

    - name: "REMEDIATION | 5.5.5 | Configurar umask 027 en /etc/profile.d/cis_umask.sh"
      ansible.builtin.copy:
        dest: /etc/profile.d/cis_umask.sh
        owner: root
        group: root
        mode: "0644"
        content: |
          # CIS Benchmark 5.5.5 — Default umask
          umask 027
      tags: ["remediation", "5.5.5"]


# =============================================================================
# 5.3.1 — Ensure permissions on /etc/ssh/sshd_config are configured (Automated)
# CIS Controls v7: 14.6
# =============================================================================

    - name: "AUDIT | 5.3.1 | Verificar permisos de /etc/ssh/sshd_config"
      ansible.builtin.stat:
        path: /etc/ssh/sshd_config
      register: cis_5_3_1_stat
      tags: ["audit", "5.3.1"]

    - name: "AUDIT | 5.3.1 | Validar propietario root:root y permisos 0600"
      ansible.builtin.assert:
        that:
          - cis_5_3_1_stat.stat.exists
          - cis_5_3_1_stat.stat.uid == 0
          - cis_5_3_1_stat.stat.gid == 0
          - cis_5_3_1_stat.stat.mode == "0600"
        success_msg: "PASS | 5.3.1 | Permisos de /etc/ssh/sshd_config correctamente configurados."
        fail_msg: "FAIL | 5.3.1 | Permisos incorrectos en /etc/ssh/sshd_config. Se aplicará remediación."
      ignore_errors: true
      tags: ["audit", "5.3.1"]

    - name: "REMEDIATION | 5.3.1 | Asignar propietario root:root a sshd_config"
      ansible.builtin.file:
        path: /etc/ssh/sshd_config
        owner: root
        group: root
        mode: "0600"
      tags: ["remediation", "5.3.1"]


# =============================================================================
# 5.3.3 — Ensure permissions on SSH public host key files are configured (Automated)
# CIS Controls v7: 14.6
# =============================================================================

    - name: "AUDIT | 5.3.3 | Buscar llaves públicas SSH del host"
      ansible.builtin.find:
        paths: /etc/ssh
        patterns: "ssh_host_*_key.pub"
        file_type: file
      register: cis_5_3_3_pubkeys
      tags: ["audit", "5.3.3"]

    - name: "AUDIT | 5.3.3 | Verificar permisos de cada llave pública"
      ansible.builtin.stat:
        path: "{{ item.path }}"
      register: cis_5_3_3_stats
      loop: "{{ cis_5_3_3_pubkeys.files }}"
      loop_control:
        label: "{{ item.path }}"
      tags: ["audit", "5.3.3"]

    - name: "AUDIT | 5.3.3 | Validar permisos 0644 y propietario root en llaves públicas"
      ansible.builtin.assert:
        that:
          - item.stat.uid == 0
          - item.stat.gid == 0
          - item.stat.mode == "0644"
        success_msg: "PASS | 5.3.3 | {{ item.stat.path }} — permisos correctos."
        fail_msg: "FAIL | 5.3.3 | {{ item.stat.path }} — permisos incorrectos."
      loop: "{{ cis_5_3_3_stats.results }}"
      loop_control:
        label: "{{ item.stat.path }}"
      ignore_errors: true
      tags: ["audit", "5.3.3"]

    - name: "REMEDIATION | 5.3.3 | Establecer permisos 0644 y root:root en llaves públicas"
      ansible.builtin.file:
        path: "{{ item.path }}"
        owner: root
        group: root
        mode: "0644"
      loop: "{{ cis_5_3_3_pubkeys.files }}"
      loop_control:
        label: "{{ item.path }}"
      tags: ["remediation", "5.3.3"]


# =============================================================================
# 5.3.8 — Ensure SSH MaxAuthTries is set to 4 or less (Automated)
# CIS Controls v7: 16.13
# =============================================================================

    - name: "AUDIT | 5.3.8 | Verificar MaxAuthTries en configuración activa de sshd"
      ansible.builtin.shell: |
        sshd -T -C user=root -C host="$(hostname)" \
          -C addr="$(grep $(hostname) /etc/hosts | awk '{print $1}')" \
          | grep maxauthtries
      register: cis_5_3_8_runtime
      changed_when: false
      check_mode: false
      tags: ["audit", "5.3.8"]

    - name: "AUDIT | 5.3.8 | Verificar ausencia de MaxAuthTries >= 5 en sshd_config"
      ansible.builtin.shell: |
        grep -Ei '^\s*maxauthtries\s+([5-9]|[1-9][0-9]+)' /etc/ssh/sshd_config \
          && echo "FAIL" || echo "PASS"
      register: cis_5_3_8_file
      changed_when: false
      check_mode: false
      tags: ["audit", "5.3.8"]

    - name: "AUDIT | 5.3.8 | Validar MaxAuthTries <= 4"
      ansible.builtin.assert:
        that:
          - cis_5_3_8_file.stdout == "PASS"
          - cis_5_3_8_runtime.stdout is regex('maxauthtries\s+[1-4]$')
        success_msg: "PASS | 5.3.8 | SSH MaxAuthTries configurado correctamente (<= 4)."
        fail_msg: "FAIL | 5.3.8 | SSH MaxAuthTries excede el valor permitido. Se aplicará remediación."
      ignore_errors: true
      tags: ["audit", "5.3.8"]

    - name: "REMEDIATION | 5.3.8 | Establecer MaxAuthTries 4 en sshd_config"
      ansible.builtin.lineinfile:
        path: /etc/ssh/sshd_config
        regexp: '^\s*MaxAuthTries'
        line: "MaxAuthTries 4"
        state: present
      notify: Restart sshd
      tags: ["remediation", "5.3.8"]


# =============================================================================
# 5.3.9 — Ensure SSH IgnoreRhosts is enabled (Automated)
# CIS Controls v7: 9.2
# =============================================================================

    - name: "AUDIT | 5.3.9 | Verificar IgnoreRhosts en configuración activa de sshd"
      ansible.builtin.shell: |
        sshd -T -C user=root -C host="$(hostname)" \
          -C addr="$(grep $(hostname) /etc/hosts | awk '{print $1}')" \
          | grep ignorerhosts
      register: cis_5_3_9_runtime
      changed_when: false
      check_mode: false
      tags: ["audit", "5.3.9"]

    - name: "AUDIT | 5.3.9 | Verificar ausencia de IgnoreRhosts no en sshd_config"
      ansible.builtin.shell: |
        grep -Ei '^\s*ignorerhosts\s+no\b' /etc/ssh/sshd_config \
          && echo "FAIL" || echo "PASS"
      register: cis_5_3_9_file
      changed_when: false
      check_mode: false
      tags: ["audit", "5.3.9"]

    - name: "AUDIT | 5.3.9 | Validar IgnoreRhosts habilitado"
      ansible.builtin.assert:
        that:
          - "'ignorerhosts yes' in cis_5_3_9_runtime.stdout"
          - cis_5_3_9_file.stdout == "PASS"
        success_msg: "PASS | 5.3.9 | SSH IgnoreRhosts habilitado correctamente."
        fail_msg: "FAIL | 5.3.9 | SSH IgnoreRhosts no está habilitado. Se aplicará remediación."
      ignore_errors: true
      tags: ["audit", "5.3.9"]

    - name: "REMEDIATION | 5.3.9 | Establecer IgnoreRhosts yes en sshd_config"
      ansible.builtin.lineinfile:
        path: /etc/ssh/sshd_config
        regexp: '^\s*IgnoreRhosts'
        line: "IgnoreRhosts yes"
        state: present
      notify: Restart sshd
      tags: ["remediation", "5.3.9"]


# =============================================================================
# 5.3.12 — Ensure SSH PermitEmptyPasswords is disabled (Automated)
# CIS Controls v7: 16.3
# =============================================================================

    - name: "AUDIT | 5.3.12 | Verificar PermitEmptyPasswords en configuración activa"
      ansible.builtin.shell: |
        sshd -T -C user=root -C host="$(hostname)" \
          -C addr="$(grep $(hostname) /etc/hosts | awk '{print $1}')" \
          | grep permitemptypasswords
      register: cis_5_3_12_runtime
      changed_when: false
      check_mode: false
      tags: ["audit", "5.3.12"]

    - name: "AUDIT | 5.3.12 | Verificar ausencia de PermitEmptyPasswords yes en sshd_config"
      ansible.builtin.shell: |
        grep -Ei '^\s*PermitEmptyPasswords\s+yes' /etc/ssh/sshd_config \
          && echo "FAIL" || echo "PASS"
      register: cis_5_3_12_file
      changed_when: false
      check_mode: false
      tags: ["audit", "5.3.12"]

    - name: "AUDIT | 5.3.12 | Validar PermitEmptyPasswords deshabilitado"
      ansible.builtin.assert:
        that:
          - "'permitemptypasswords no' in cis_5_3_12_runtime.stdout"
          - cis_5_3_12_file.stdout == "PASS"
        success_msg: "PASS | 5.3.12 | SSH PermitEmptyPasswords deshabilitado correctamente."
        fail_msg: "FAIL | 5.3.12 | SSH permite contraseñas vacías. Se aplicará remediación."
      ignore_errors: true
      tags: ["audit", "5.3.12"]

    - name: "REMEDIATION | 5.3.12 | Establecer PermitEmptyPasswords no en sshd_config"
      ansible.builtin.lineinfile:
        path: /etc/ssh/sshd_config
        regexp: '^\s*PermitEmptyPasswords'
        line: "PermitEmptyPasswords no"
        state: present
      notify: Restart sshd
      tags: ["remediation", "5.3.12"]


# =============================================================================
# 5.3.14 — Ensure only strong Ciphers are used (Automated)
# CIS Controls v7: 14.4
# =============================================================================

    - name: "AUDIT | 5.3.14 | Verificar ausencia de cifrados débiles en sshd activo"
      ansible.builtin.shell: |
        sshd -T -C user=root -C host="$(hostname)" \
          -C addr="$(grep $(hostname) /etc/hosts | awk '{print $1}')" \
          | grep -Ei 'ciphers\s+([^#]+,)?(3des-cbc|aes128-cbc|aes192-cbc|aes256-cbc|arcfour|arcfour128|arcfour256|blowfish-cbc|cast128-cbc|rijndael-cbc@lysator.liu.se)' \
          && echo "FAIL" || echo "PASS"
      register: cis_5_3_14_runtime
      changed_when: false
      check_mode: false
      tags: ["audit", "5.3.14"]

    - name: "AUDIT | 5.3.14 | Verificar ausencia de cifrados débiles en sshd_config"
      ansible.builtin.shell: |
        grep -Ei 'ciphers\s+([^#]+,)?(3des-cbc|aes128-cbc|aes192-cbc|aes256-cbc|arcfour|arcfour128|arcfour256|blowfish-cbc|cast128-cbc|rijndael-cbc@lysator.liu.se)' \
          /etc/ssh/sshd_config && echo "FAIL" || echo "PASS"
      register: cis_5_3_14_file
      changed_when: false
      check_mode: false
      tags: ["audit", "5.3.14"]

    - name: "AUDIT | 5.3.14 | Validar que solo se usen cifrados fuertes"
      ansible.builtin.assert:
        that:
          - cis_5_3_14_runtime.stdout == "PASS"
          - cis_5_3_14_file.stdout == "PASS"
        success_msg: "PASS | 5.3.14 | Solo cifrados fuertes configurados en SSH."
        fail_msg: "FAIL | 5.3.14 | Cifrados débiles detectados en SSH. Se aplicará remediación."
      ignore_errors: true
      tags: ["audit", "5.3.14"]

    - name: "REMEDIATION | 5.3.14 | Configurar solo cifrados fuertes (FIPS 140-2) en sshd_config"
      ansible.builtin.lineinfile:
        path: /etc/ssh/sshd_config
        regexp: '^\s*Ciphers'
        line: "Ciphers aes256-ctr,aes192-ctr,aes128-ctr"
        state: present
      notify: Restart sshd
      tags: ["remediation", "5.3.14"]


# =============================================================================
# 5.4.1 — Ensure password creation requirements are configured (Automated)
# CIS Controls v7: 4.4
# =============================================================================

    - name: "AUDIT | 5.4.1 | Verificar pam_cracklib en /etc/pam.d/password-auth"
      ansible.builtin.shell: |
        grep pam_cracklib.so /etc/pam.d/password-auth | \
          grep -E 'minlen=1[4-9]|minlen=[2-9][0-9]' && echo "PASS" || echo "FAIL"
      register: cis_5_4_1_pwauth
      changed_when: false
      check_mode: false
      tags: ["audit", "5.4.1"]

    - name: "AUDIT | 5.4.1 | Verificar pam_cracklib en /etc/pam.d/system-auth"
      ansible.builtin.shell: |
        grep pam_cracklib.so /etc/pam.d/system-auth | \
          grep -E 'minlen=1[4-9]|minlen=[2-9][0-9]' && echo "PASS" || echo "FAIL"
      register: cis_5_4_1_sysauth
      changed_when: false
      check_mode: false
      tags: ["audit", "5.4.1"]

    - name: "AUDIT | 5.4.1 | Validar requisitos de complejidad de contraseña"
      ansible.builtin.assert:
        that:
          - cis_5_4_1_pwauth.stdout == "PASS"
          - cis_5_4_1_sysauth.stdout == "PASS"
        success_msg: "PASS | 5.4.1 | Requisitos de contraseña configurados correctamente (minlen>=14)."
        fail_msg: "FAIL | 5.4.1 | Requisitos de contraseña insuficientes. Se aplicará remediación."
      ignore_errors: true
      tags: ["audit", "5.4.1"]

    - name: "REMEDIATION | 5.4.1 | Configurar pam_cracklib en /etc/pam.d/password-auth"
      ansible.builtin.lineinfile:
        path: /etc/pam.d/password-auth
        regexp: '^\s*password\s+requisite\s+pam_cracklib.so'
        line: "password requisite pam_cracklib.so try_first_pass retry=3 minlen=14 dcredit=-1 ucredit=-1 ocredit=-1 lcredit=-1"
        state: present
      tags: ["remediation", "5.4.1"]

    - name: "REMEDIATION | 5.4.1 | Configurar pam_cracklib en /etc/pam.d/system-auth"
      ansible.builtin.lineinfile:
        path: /etc/pam.d/system-auth
        regexp: '^\s*password\s+requisite\s+pam_cracklib.so'
        line: "password requisite pam_cracklib.so try_first_pass retry=3 minlen=14 dcredit=-1 ucredit=-1 ocredit=-1 lcredit=-1"
        state: present
      tags: ["remediation", "5.4.1"]


# =============================================================================
# 5.5.5 — Ensure default user umask is configured (Automated)
# CIS Controls v7: 5.1, 13
# =============================================================================

    - name: "AUDIT | 5.5.5 | Verificar ausencia de umask permisivo en archivos de perfil"
      ansible.builtin.shell: |
        grep -Ev '^\s*umask\s+\s*(0[0-7][2-7]7|[0-7][2-7]7|u=(r?|w?|x?)(r?|w?|x?)(r?|w?|x?),g=(r?x?|x?r?),o=)\s*(\s*#.*)?$' \
          /etc/profile /etc/profile.d/*.sh /etc/bashrc 2>/dev/null \
          | grep -E '(^|^[^#]*)umask' && echo "FAIL" || echo "PASS"
      register: cis_5_5_5_permissive
      changed_when: false
      check_mode: false
      tags: ["audit", "5.5.5"]

    - name: "AUDIT | 5.5.5 | Verificar que exista umask 027 o más restrictivo definido"
      ansible.builtin.shell: |
        grep -E '^\s*umask\s+\s*(0[0-7][2-7]7|[0-7][2-7]7|u=(r?|w?|x?)(r?|w?|x?)(r?|w?|x?),g=(r?x?|x?r?),o=)\s*(\s*#.*)?$' \
          /etc/profile /etc/profile.d/*.sh /etc/bashrc 2>/dev/null \
          && echo "PASS" || echo "FAIL"
      register: cis_5_5_5_defined
      changed_when: false
      check_mode: false
      tags: ["audit", "5.5.5"]

    - name: "AUDIT | 5.5.5 | Validar umask predeterminado seguro"
      ansible.builtin.assert:
        that:
          - cis_5_5_5_permissive.stdout == "PASS"
          - cis_5_5_5_defined.stdout == "PASS"
        success_msg: "PASS | 5.5.5 | umask predeterminado configurado correctamente (027 o más restrictivo)."
        fail_msg: "FAIL | 5.5.5 | umask inseguro o no definido. Se aplicará remediación."
      ignore_errors: true
      tags: ["audit", "5.5.5"]

    - name: "REMEDIATION | 5.5.5 | Establecer umask 027 en /etc/profile.d/cis_umask.sh"
      ansible.builtin.copy:
        dest: /etc/profile.d/cis_umask.sh
        owner: root
        group: root
        mode: "0644"
        content: |
          # CIS Benchmark 5.5.5 — Default umask 027
          umask 027
      tags: ["remediation", "5.5.5"]


# =============================================================================
# 5.7 — Ensure access to the su command is restricted (Automated)
# CIS Controls v7: 4
# =============================================================================

    - name: "AUDIT | 5.7 | Verificar pam_wheel.so en /etc/pam.d/su"
      ansible.builtin.shell: |
        grep -E '^\s*auth\s+required\s+pam_wheel.so\s+use_uid' /etc/pam.d/su \
          && echo "PASS" || echo "FAIL"
      register: cis_5_7_pam
      changed_when: false
      check_mode: false
      tags: ["audit", "5.7"]

    - name: "AUDIT | 5.7 | Mostrar miembros actuales del grupo wheel"
      ansible.builtin.command: grep wheel /etc/group
      register: cis_5_7_wheel
      changed_when: false
      check_mode: false
      failed_when: false
      tags: ["audit", "5.7"]

    - name: "AUDIT | 5.7 | Validar restricción de su mediante pam_wheel"
      ansible.builtin.assert:
        that: cis_5_7_pam.stdout == "PASS"
        success_msg: "PASS | 5.7 | Acceso a su restringido al grupo wheel correctamente."
        fail_msg: "FAIL | 5.7 | pam_wheel.so no está configurado en /etc/pam.d/su. Se aplicará remediación."
      ignore_errors: true
      tags: ["audit", "5.7"]

    - name: "REMEDIATION | 5.7 | Habilitar pam_wheel en /etc/pam.d/su"
      ansible.builtin.lineinfile:
        path: /etc/pam.d/su
        regexp: '^\s*#?\s*auth\s+required\s+pam_wheel.so'
        line: "auth required pam_wheel.so use_uid"
        state: present
      tags: ["remediation", "5.7"]


# =============================================================================
# 6.1.2 — Ensure permissions on /etc/passwd are configured (Automated)
# CIS Controls v7: 16.4
# =============================================================================

    - name: "AUDIT | 6.1.2 | Verificar permisos de /etc/passwd"
      ansible.builtin.stat:
        path: /etc/passwd
      register: cis_6_1_2_stat
      tags: ["audit", "6.1.2"]

    - name: "AUDIT | 6.1.2 | Validar propietario root:root y permisos 0644"
      ansible.builtin.assert:
        that:
          - cis_6_1_2_stat.stat.uid == 0
          - cis_6_1_2_stat.stat.gid == 0
          - cis_6_1_2_stat.stat.mode == "0644"
        success_msg: "PASS | 6.1.2 | Permisos de /etc/passwd correctamente configurados."
        fail_msg: "FAIL | 6.1.2 | Permisos incorrectos en /etc/passwd. Se aplicará remediación."
      ignore_errors: true
      tags: ["audit", "6.1.2"]

    - name: "REMEDIATION | 6.1.2 | Asignar propietario root:root y permisos 0644 a /etc/passwd"
      ansible.builtin.file:
        path: /etc/passwd
        owner: root
        group: root
        mode: "0644"
      tags: ["remediation", "6.1.2"]


# =============================================================================
# 6.1.6 — Ensure permissions on /etc/shadow are configured (Automated)
# CIS Controls v7: 16.4
# =============================================================================

    - name: "AUDIT | 6.1.6 | Verificar permisos de /etc/shadow"
      ansible.builtin.stat:
        path: /etc/shadow
      register: cis_6_1_6_stat
      tags: ["audit", "6.1.6"]

    - name: "AUDIT | 6.1.6 | Validar propietario root:root y permisos 0000"
      ansible.builtin.assert:
        that:
          - cis_6_1_6_stat.stat.uid == 0
          - cis_6_1_6_stat.stat.gid == 0
          - cis_6_1_6_stat.stat.mode == "0000"
        success_msg: "PASS | 6.1.6 | Permisos de /etc/shadow correctamente configurados (0000)."
        fail_msg: "FAIL | 6.1.6 | Permisos incorrectos en /etc/shadow. Se aplicará remediación."
      ignore_errors: true
      tags: ["audit", "6.1.6"]

    - name: "REMEDIATION | 6.1.6 | Asignar propietario root:root y permisos 0000 a /etc/shadow"
      ansible.builtin.file:
        path: /etc/shadow
        owner: root
        group: root
        mode: "0000"
      tags: ["remediation", "6.1.6"]


# =============================================================================
# 6.2.1 — Ensure accounts in /etc/passwd use shadowed passwords (Automated)
# CIS Controls v7: 16.4
# =============================================================================

    - name: "AUDIT | 6.2.1 | Detectar cuentas sin contraseña shadow en /etc/passwd"
      ansible.builtin.shell: |
        awk -F: '($2 != "x") { print $1 }' /etc/passwd
      register: cis_6_2_1_unshadowed
      changed_when: false
      check_mode: false
      tags: ["audit", "6.2.1"]

    - name: "AUDIT | 6.2.1 | Validar que todas las cuentas usen shadow passwords"
      ansible.builtin.assert:
        that: cis_6_2_1_unshadowed.stdout | length == 0
        success_msg: "PASS | 6.2.1 | Todas las cuentas usan contraseñas shadow correctamente."
        fail_msg: "FAIL | 6.2.1 | Cuentas sin shadow detectadas: {{ cis_6_2_1_unshadowed.stdout_lines }}. Se aplicará remediación."
      ignore_errors: true
      tags: ["audit", "6.2.1"]

    - name: "REMEDIATION | 6.2.1 | Migrar cuentas sin shadow a usar campo 'x' en /etc/passwd"
      ansible.builtin.shell: |
        sed -e 's/^\([a-zA-Z0-9_]*\):[^:]*:/\1:x:/' -i /etc/passwd
      when: cis_6_2_1_unshadowed.stdout | length > 0
      changed_when: true
      tags: ["remediation", "6.2.1"]


# =============================================================================
# 6.2.7 — Ensure root PATH Integrity (Automated)
# CIS Controls v7: 5.1
# =============================================================================

    - name: "AUDIT | 6.2.7 | Verificar integridad del PATH de root"
      ansible.builtin.shell: |
        issues=""
        if echo "$PATH" | grep -q "::" ; then
          issues="${issues}Empty directory (::) in PATH\n"
        fi
        if echo "$PATH" | grep -q ":$" ; then
          issues="${issues}Trailing colon in PATH\n"
        fi
        for x in $(echo "$PATH" | tr ":" " "); do
          if [ -d "$x" ]; then
            result=$(ls -ldH "$x" | awk '
              $9 == "."             { print "PATH contains current working directory (.)" }
              $3 != "root"          { print $9 " is not owned by root" }
              substr($1,6,1) != "-" { print $9 " is group writable" }
              substr($1,9,1) != "-" { print $9 " is world writable" }
            ')
            [ -n "$result" ] && issues="${issues}${result}\n"
          else
            issues="${issues}${x} is not a directory\n"
          fi
        done
        if [ -z "$issues" ]; then
          echo "PASS"
        else
          printf "%b" "$issues"
        fi
      register: cis_6_2_7_path
      changed_when: false
      check_mode: false
      become: true
      become_user: root
      tags: ["audit", "6.2.7"]

    - name: "AUDIT | 6.2.7 | Mostrar resultado de integridad del PATH de root"
      ansible.builtin.debug:
        msg: "{{ cis_6_2_7_path.stdout_lines }}"
      tags: ["audit", "6.2.7"]

    - name: "AUDIT | 6.2.7 | Validar PATH de root íntegro"
      ansible.builtin.assert:
        that: cis_6_2_7_path.stdout == "PASS"
        success_msg: "PASS | 6.2.7 | PATH de root es seguro e íntegro."
        fail_msg: "FAIL | 6.2.7 | Problemas detectados en PATH de root. Revisión manual requerida."
      ignore_errors: true
      tags: ["audit", "6.2.7"]


# =============================================================================
# REPORT — Reporte consolidado de cumplimiento
# =============================================================================

    - name: "REPORT | Generar reporte consolidado CIS"
      ansible.builtin.copy:
        dest: "{{ report_path }}"
        mode: "0644"
        content: |
          ================================================================
          CIS BENCHMARK — COMPLIANCE REPORT
          ================================================================
          Host      : {{ inventory_hostname }}
          OS        : {{ ansible_distribution }} {{ ansible_distribution_version }}
          Kernel    : {{ ansible_kernel }}
          Fecha     : {{ ansible_date_time.iso8601 }}
          ================================================================

          CONTROLES EVALUADOS (29 total):
            [1.2.1] Package Manager Repositories
            [1.2.3] GPG Keys Configuration
            [1.4.1] Bootloader Config Permissions
            [1.4.3] Single User Mode Authentication
            [1.5.1] Core Dumps Restricted
            [1.5.3] ASLR Enabled
            [1.5.4] Prelink Disabled
            [1.7.1] Message of the Day (motd)
            [1.7.6] Permissions on /etc/issue.net
            [3.2.1] IP Forwarding Disabled
            [3.3.1] Source Routed Packets Not Accepted
            [3.3.8] TCP SYN Cookies Enabled
            [3.4.5] Permissions on /etc/hosts.deny
            [5.1.1] Cron Daemon Enabled
            [5.1.2] Permissions on /etc/crontab
            [5.2.1] sudo Installed
            [5.3.1] Permissions on /etc/ssh/sshd_config
            [5.3.3] Permissions on SSH Public Host Keys
            [5.3.8] SSH MaxAuthTries <= 4
            [5.3.9] SSH IgnoreRhosts Enabled
            [5.3.12] SSH PermitEmptyPasswords Disabled
            [5.3.14] SSH Strong Ciphers Only
            [5.4.1] Password Creation Requirements (pam_cracklib)
            [5.5.5] Default User umask >= 027
            [5.7]   su Access Restricted to wheel
            [6.1.2] Permissions on /etc/passwd
            [6.1.6] Permissions on /etc/shadow
            [6.2.1] Accounts Use Shadowed Passwords
            [6.2.7] root PATH Integrity

          ----------------------------------------------------------------
          DETALLE:

          1.2.1 Repos activos:
          {{ cis_1_2_1_repos.stdout | default('N/A') }}

          1.2.3 GPG Keys:
          {{ cis_1_2_3_gpg.stdout | default('N/A') }}

          1.5.1 suid_dumpable         : {{ cis_1_5_1_sysctl.stdout | default('N/A') }}
          1.5.3 ASLR                  : {{ cis_1_5_3_aslr.stdout | default('N/A') }}
          1.5.4 prelink               : {{ 'NOT INSTALLED' if cis_1_5_4_prelink.rc != 0 else 'INSTALLED (remediado)' }}
          1.7.1 motd OS info check    : {{ cis_1_7_1_check.stdout | default('N/A') }}
          1.7.6 /etc/issue.net mode   : {{ cis_1_7_6_stat.stat.mode | default('N/A') }}
          3.2.1 IPv4 forwarding       : {{ cis_3_2_1_ipv4_fwd.stdout | default('N/A') }}
          3.3.1 src_route IPv4 all    : {{ cis_3_3_1_ipv4_all.stdout | default('N/A') }}
          3.3.1 src_route IPv4 def    : {{ cis_3_3_1_ipv4_default.stdout | default('N/A') }}
          3.3.8 tcp_syncookies        : {{ cis_3_3_8_runtime.stdout | default('N/A') }}
          3.4.5 /etc/hosts.deny       : {{ cis_3_4_5_stat.stat.mode | default('N/A') }}
          5.1.1 crond status          : {{ ansible_facts.services['crond.service'].state | default('N/A') }}
          5.1.2 /etc/crontab mode     : {{ cis_5_1_2_stat.stat.mode | default('N/A') }}
          5.2.1 sudo                  : {{ cis_5_2_1_sudo.stdout | default('NOT INSTALLED') }}
          5.3.1 sshd_config mode      : {{ cis_5_3_1_stat.stat.mode | default('N/A') }}
          5.3.8 MaxAuthTries          : {{ cis_5_3_8_runtime.stdout | default('N/A') }}
          5.3.9 IgnoreRhosts          : {{ cis_5_3_9_runtime.stdout | default('N/A') }}
          5.3.12 PermitEmptyPasswords : {{ cis_5_3_12_runtime.stdout | default('N/A') }}
          5.3.14 Weak ciphers check   : {{ cis_5_3_14_runtime.stdout | default('N/A') }}
          5.4.1 pam_cracklib pwauth   : {{ cis_5_4_1_pwauth.stdout | default('N/A') }}
          5.5.5 umask definido        : {{ cis_5_5_5_defined.stdout | default('N/A') }}
          5.7   pam_wheel su          : {{ cis_5_7_pam.stdout | default('N/A') }}
          5.7   wheel members         : {{ cis_5_7_wheel.stdout | default('N/A') }}
          6.1.2 /etc/passwd mode      : {{ cis_6_1_2_stat.stat.mode | default('N/A') }}
          6.1.6 /etc/shadow mode      : {{ cis_6_1_6_stat.stat.mode | default('N/A') }}
          6.2.1 unshadowed accounts   : {{ cis_6_2_1_unshadowed.stdout | default('NONE (OK)') or 'NONE (OK)' }}
          6.2.7 root PATH integrity   : {{ cis_6_2_7_path.stdout_lines | join(' | ') | default('N/A') }}
          ================================================================
      tags: ["report"]

    - name: "REPORT | Confirmar ubicación del reporte"
      ansible.builtin.debug:
        msg: "Reporte de cumplimiento generado en: {{ report_path }}"
      tags: ["report"]

  handlers:

    - name: Restart sshd
      ansible.builtin.service:
        name: sshd
        state: restarted