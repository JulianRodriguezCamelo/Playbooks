---

#Playbook Oracle Solaris 11 Benchmark v1.1.0
- name: CIS 2.1 Disable Local-only Graphical Login Enviroment 
  hosts: all
  become: yes
  gather_facts: yes

  tasks:
    - name: Check if GDM Service exists 
      shell: svcs svc:/application/graphical-login/gdm:default
      register: gmd_check  
      failed_when: false
      changed_when: false

    - name: Get current state of GDM Service 
      shell: svcs -Ho state svc:/application/graphical-login/gdm:default
      register: gdm_state 
      failed_when: false
      changed_when: false
      when: gdm_check.rc == 0

    - name: Disable GDM graphical login service
      shell: svcs -Ho state svc:/application/graphical-login/gdm:default
      when:
        - gdm_check.rc == 0 
        - gdm_state.stdout != "disabled"
      register: disable_result
  
    - name: Verify GDM service is disable
      shell: svcs -Ho state svc:/application/graphical-login/gdm:default
      register: verify_gdm
      failed_when: verify_gdm.stdout != "disabled"
      changed_when: false
      when: gdm_check.rc == 0

    - name: Display compliance status
      debug:
        msg: >
          {% if gdm_check.rc != 0 %}
          GDM service not installed - COMPLIANT
          {% elif verify_gdm.stdout == "disabled" %}
          GDM service successfully disabled - COMPLIANT
          {% else %}
          WARNING: GDM service state is {{ verify_gdm.stdout }} - NOT COMPLIANT
          {% endif %}

    - name: CIS 2.2 - Check if sendmail service exists 
      shell: svcs svc:/network/smtp:sendmail 
      register: sendmail_check 
      failed_when: false
      changed_when: false 
      tags: 
        - cis_2.2
        - sendmail 

    - name: CIS 2.2 - Get current sendmail local_only setting 
      shell: svcprop -p config/local_only svc:/network/smtp:sendmail
      register: sendmail_local_only
      failed_when: false
      changed_when: false
      when: sendmail_check.rc == 0 
      tags: 
        - cis_2.2 
        - sendmail

    - name: CIS 2.2 - Configure sendmail for local-only mode
      shell: |
        svccfg -s svc:/network/smtp:sendmail setprop config/local_only=true
        svcadm refresh svc:/network/smtp:sendmail
        svcadm restart svc:/network/smtp:sendmail
      when:
        - sendmail_check.rc == 0
        - sendmail_local_only.stdout != "true"
      register: sendmail_config_result
      tags:
        - cis_2.2
        - sendmail

  - name: CIS 2.2 - Wait for sendmail to restart
    pause:
      seconds: 5
    when: sendmail_config_result is changed
    tags:
      - cis_2.2
      - sendmail

  - name: CIS 2.2 - Verify sendmail is listening only on localhost
    shell: netstat -an | grep LIST | grep ":25[[:space:]]"
    register: sendmail_netstat
    failed_when: false
    changed_when: false
    when: sendmail_check.rc == 0
    tags:
      - cis_2.2
      - sendmail

   - name: CIS 2.2 - Validate sendmail localhost binding
     assert:
       that:
         - "'127.0.0.1:25' in sendmail_netstat.stdout"
         - "'0.0.0.0:25' not in sendmail_netstat.stdout or sendmail_netstat.stdout == ''"
       fail_msg: "Sendmail is NOT configured for local-only mode - NOT COMPLIANT"
       success_msg: "Sendmail is correctly configured for local-only mode - COMPLIANT"
     when: 
       - sendmail_check.rc == 0
       - sendmail_netstat.stdout != ""
     tags:
       - cis_2.2
       - sendmail

    - name: CIS 2.2 - Display sendmail compliance status
      debug:
        msg: >
         {% if sendmail_check.rc != 0 %}
         Sendmail service not installed - COMPLIANT
         {% elif '127.0.0.1:25' in sendmail_netstat.stdout %}
         Sendmail configured for local-only mode - COMPLIANT
         {% else %}
          WARNING: Sendmail may not be in local-only mode - VERIFY MANUALLY
         {% endif %}
      tags:
        - cis_2.2
        - sendmail



   - name: CIS 2.3 - Check if keyserv service exists
      shell: svcs svc:/network/rpc/keyserv
      register: keyserv_check
      failed_when: false
      changed_when: false
      tags:
        - cis_2.3
        - rpc

    - name: CIS 2.3 - Get current state of keyserv service
      shell: svcs -Ho state svc:/network/rpc/keyserv
      register: keyserv_state
      failed_when: false
      changed_when: false
      when: keyserv_check.rc == 0
      tags:
        - cis_2.3
        - rpc

    - name: CIS 2.3 - Disable keyserv service
      shell: svcadm disable svc:/network/rpc/keyserv
      when:
        - keyserv_check.rc == 0
        - keyserv_state.stdout != "disabled"
      tags:
        - cis_2.3
        - rpc

    - name: CIS 2.3 - Verify keyserv is disabled
      shell: svcs -Ho state svc:/network/rpc/keyserv
      register: verify_keyserv
      failed_when: verify_keyserv.stdout != "disabled"
      changed_when: false
      when: keyserv_check.rc == 0
      tags:
        - cis_2.3
        - rpc


    - name: CIS 2.4 - Check NIS server services
      shell: svcs {{ item }}
      register: nis_server_check
      failed_when: false
      changed_when: false
      loop:
        - svc:/network/nis/server
        - svc:/network/nis/domain
      tags:
        - cis_2.4
        - nis

    - name: CIS 2.4 - Get state of NIS server services
      shell: svcs -Ho state {{ item.item }}
      register: nis_server_state
      failed_when: false
      changed_when: false
      when: item.rc == 0
      loop: "{{ nis_server_check.results }}"
      tags:
        - cis_2.4
        - nis

    - name: CIS 2.4 - Disable NIS server services
      shell: svcadm disable {{ item.item.item }}
      when:
        - item.item.rc == 0
        - item.stdout != "disabled"
      loop: "{{ nis_server_state.results }}"
      tags:
        - cis_2.4
        - nis

    - name: CIS 2.4 - Verify NIS server services are disabled
      shell: svcs -Ho state {{ item }}
      register: verify_nis_server
      failed_when: verify_nis_server.stdout != "disabled"
      changed_when: false
      when: nis_server_check.results[index].rc == 0
      loop:
        - svc:/network/nis/server
        - svc:/network/nis/domain
      loop_control:
        index_var: index
      tags:
        - cis_2.4
        - nis

    - name: CIS 2.5 - Check NIS client services
      shell: svcs {{ item }}
      register: nis_client_check
      failed_when: false
      changed_when: false
      loop:
        - svc:/network/nis/client
        - svc:/network/nis/domain
      tags:
        - cis_2.5
        - nis

    - name: CIS 2.5 - Get state of NIS client services
      shell: svcs -Ho state {{ item.item }}
      register: nis_client_state
      failed_when: false
      changed_when: false
      when: item.rc == 0
      loop: "{{ nis_client_check.results }}"
      tags:
        - cis_2.5
        - nis

    - name: CIS 2.5 - Disable NIS client services
      shell: svcadm disable {{ item.item.item }}
      when:
        - item.item.rc == 0
        - item.stdout != "disabled"
      loop: "{{ nis_client_state.results }}"
      tags:
        - cis_2.5
        - nis

    - name: CIS 2.5 - Verify NIS client services are disabled
      shell: svcs -Ho state {{ item }}
      register: verify_nis_client
      failed_when: verify_nis_client.stdout != "disabled"
      changed_when: false
      when: nis_client_check.results[index].rc == 0
      loop:
        - svc:/network/nis/client
        - svc:/network/nis/domain
      loop_control:
        index_var: index
      tags:
        - cis_2.5
        - nis

    - name: CIS 2.6 - Check if ktkt_warn service exists
      shell: svcs svc:/network/security/ktkt_warn
      register: ktkt_warn_check
      failed_when: false
      changed_when: false
      tags:
        - cis_2.6
        - kerberos

    - name: CIS 2.6 - Get current state of ktkt_warn service
      shell: svcs -Ho state svc:/network/security/ktkt_warn
      register: ktkt_warn_state
      failed_when: false
      changed_when: false
      when: ktkt_warn_check.rc == 0
      tags:
        - cis_2.6
        - kerberos

    - name: CIS 2.6 - Disable ktkt_warn service
      shell: svcadm disable svc:/network/security/ktkt_warn
      when:
        - ktkt_warn_check.rc == 0
        - ktkt_warn_state.stdout != "disabled"
      tags:
        - cis_2.6
        - kerberos

    - name: CIS 2.6 - Verify ktkt_warn is disabled
      shell: svcs -Ho state svc:/network/security/ktkt_warn
      register: verify_ktkt_warn
      failed_when: verify_ktkt_warn.stdout != "disabled"
      changed_when: false
      when: ktkt_warn_check.rc == 0
      tags:
        - cis_2.6
        - kerberos

    - name: CIS 2.7 - Check if GSS service exists
      shell: svcs svc:/network/rpc/gss
      register: gss_check
      failed_when: false
      changed_when: false
      tags:
        - cis_2.7
        - gss

    - name: CIS 2.7 - Get current state of GSS service
      shell: svcs -Ho state svc:/network/rpc/gss
      register: gss_state
      failed_when: false
      changed_when: false
      when: gss_check.rc == 0
      tags:
        - cis_2.7
        - gss

    - name: CIS 2.7 - Disable GSS service
      shell: svcadm disable svc:/network/rpc/gss
      when:
        - gss_check.rc == 0
        - gss_state.stdout != "disabled"
      tags:
        - cis_2.7
        - gss

    - name: CIS 2.7 - Verify GSS is disabled
      shell: svcs -Ho state svc:/network/rpc/gss
      register: verify_gss
      failed_when: verify_gss.stdout != "disabled"
      changed_when: false
      when: gss_check.rc == 0
      tags:
        - cis_2.7
        - gss

    - name: CIS 2.8 - Check removable volume manager services
      shell: svcs {{ item }}
      register: rmvol_check
      failed_when: false
      changed_when: false
      loop:
        - svc:/system/filesystem/rmvolmgr
        - svc:/network/rpc/smserver
      tags:
        - cis_2.8
        - removable_media

    - name: CIS 2.8 - Get state of removable volume manager services
      shell: svcs -Ho state {{ item.item }}
      register: rmvol_state
      failed_when: false
      changed_when: false
      when: item.rc == 0
      loop: "{{ rmvol_check.results }}"
      tags:
        - cis_2.8
        - removable_media

    - name: CIS 2.8 - Disable removable volume manager services
      shell: svcadm disable {{ item.item.item }}
      when:
        - item.item.rc == 0
        - item.stdout != "disabled"
      loop: "{{ rmvol_state.results }}"
      tags:
        - cis_2.8
        - removable_media

    - name: CIS 2.8 - Verify removable volume manager services are disabled
      shell: svcs -Ho state {{ item }}
      register: verify_rmvol
      failed_when: verify_rmvol.stdout != "disabled"
      changed_when: false
      when: rmvol_check.results[index].rc == 0
      loop:
        - svc:/system/filesystem/rmvolmgr
        - svc:/network/rpc/smserver
      loop_control:
        index_var: index
      tags:
        - cis_2.8
        - removable_media

    - name: CIS 2.9 - Disable automount Service (Scored)
      shell: svcs svc:/system/filesystem/autofs
      register: autofs_check
      failed_when: false
      changed_when: false 
      tags:
        - cis_2.9 
        - automount

    - name: CIS 2.9 - Get current state of autofs service
      shell: svcs -Ho state svc:/system/filesystem/autofs
      register: autofs_state
      failed_when: false
      changed_when: false
      when: autofs_check.rc == 0 
      tags:
        - cis_2.9
        - automount

    - name: CIS 2.9 - Disable autofs service 
      shell: svcadm disable svc:/system/filesystem/autofs
      when:
        - autofs_check.rc == 0
        - autofs_state.stdout != "disabled"
      tags:
        - cis_2.9
        - automount

    - name: CIS 2.9 - Verify autofs is disabled 
      shell: svcs -Ho state svc:/system/filesystem/autofs
      register: verify_autofs
      failed_when: verify_autofs.stdout != "disabled"
      changed_when: false
      when: autofs_check.rc == 0
      tags: 
        - cis_2.9
        - automount 

    - name: CIS 2.10 - Check if apache service exists 
      shell: svcs svc:/network/http:apache22
      register: apache_check
      failed_when: false
      changed_when: false
      tags:
        - cis_2.10
        - apache
        - webserver

    - name: CIS 2.10 - Get current state of apache service 
      shell: svcs -Ho state svc:/network/http:apache22
      register: apache_state
      changed_when: false
      when: apache_check.rc == 0
      tags:
        - cis_2.10
        - apache 
        - webserver

    - name: CIS 2.10 - Disable apache service 
      shell: svcadm disable svc:/network/http:apache22
      when:
        - apache_check.rc == 0
        - apache_state.stdout != "disabled"
      tags:
        - cis_2.10
        - apache 
        - webserver  

    - name: CIS 2.10 - Verify Apache is disabled
      shell: svcs -Ho state svc:/network/http:apache22
      register: verify_apache
      failed_when: verify_apache.stdout != "disabled"
      changed_when: false
      when: apache_check.rc == 0
      tags:
        - cis_2.10
        - apache
        - webserver

    - name: CIS 2.13 - Check if Telnet service exists
      shell: svcs svc:/network/telnet
      register: telnet_check
      failed_when: false
      changed_when: false
      tags:
        - cis_2.13
        - telnet
        - insecure_protocols

    - name: CIS 2.13 - Get current state of Telnet service
      shell: svcs -Ho state svc:/network/telnet
      register: telnet_state
      failed_when: false
      changed_when: false
      when: telnet_check.rc == 0
      tags:
        - cis_2.13
        - telnet
        - insecure_protocols

    - name: CIS 2.13 - Disable Telnet service
      shell: svcadm disable svc:/network/telnet
      when:
        - telnet_check.rc == 0
        - telnet_state.stdout != "disabled"
      register: telnet_disable_result
      tags:
        - cis_2.13
        - telnet
        - insecure_protocols

    - name: CIS 2.13 - Verify Telnet is disabled
      shell: svcs -Ho state svc:/network/telnet
      register: verify_telnet
      failed_when: verify_telnet.stdout != "disabled"
      changed_when: false
      when: telnet_check.rc == 0
      tags:
        - cis_2.13
        - telnet
        - insecure_protocols

    - name: CIS 2.13 - Display Telnet security warning
      debug:
        msg:
          - "WARNING: Telnet transmits data in CLEAR TEXT (unencrypted)"
          - "This includes usernames and passwords!"
          - "Use SSH instead for secure remote access"
          - "Status: {% if telnet_check.rc != 0 %}Not Installed (SECURE){% elif verify_telnet.stdout == 'disabled' %}Disabled (SECURE){% else %}ENABLED - SECURITY RISK!{% endif %}"
      when: telnet_check.rc == 0
      tags:
        - cis_2.13
        - telnet
        - insecure_protocols
   
   - name: CIS 3.1 - Create /var/cores directory if not exists 
     file: 
       path: /var/cores
       state: directory
       mode: '0700'
       owner: root
       group: sys 
     tags:
       - cis_3.1 
       - core_dumps

    - name: CIS 3.1 - Check current coreadm configuration
      shell: coreadm | grep "global core file pattern"
      register: coreadm_check
     failed_when: false
     changed_when: false
     tags:
       - cis_3.1
       - core_dumps

   - name: CIS 3.1 - Configure core dump settings
     shell: | 
       coreadm -g /var/cores/core_%n_%f_%u_%g_%t_%p \
       -e log -e global -e global-setid \
       -d process -d proc-setid
     when: "'/var/cores/core_%n_%f_%u_%g_%t_%p' not in coreadm_check.stdout"
     tags:
       - cis_3.1
       - core_dumps

   - name: CIS 3.1 - Verify coreadm configuration
      shell: coreadm
      register: verify_coreadm
      changed_when: false
      tags:
        - cis_3.1
        - core_dumps

   - name: CIS 3.1 - verify / var/ cores permissions 
     shell: ls -ls /var/cores
     register: verify_cores_perms
     changed_when: false
     tags:
       - cis_3.1
       - core_dumps

    - name: CIS 3.2 - Check if stack protection is configured in /etc/system
      shell: grep "^set noexec_user_stack.*=1" /etc/system
      register: stack_protection_check
     failed_when: false
     changed_when: false
     tags:
       - cis_3.2
       - stack_protection 

  - name: CIS 3.2 - Enable stack protection in /etc/system
      blockinfile:
        path: /etc/system
        marker: "# {mark} ANSIBLE MANAGED - CIS 3.2 Stack Protection"
        block: |
          set noexec_user_stack=1
          set noexec_user_stack_log=1
        create: yes
      when: stack_protection_check.rc != 0
      register: stack_protection_config
      tags:
        - cis_3.2
        - stack_protection

   - name: CIS 3.2 - Verify stack protection on running system
     shell: echo "noexec_user_stack/D" | mdb -k
     register: verify_stack_protection
     failed_when: false
     changed_when: false
     tags:
       - cis_3.2
       - stack_protection

   - name: CIS 3.2 - Display stack protection warning if reboot needed
     debug:
       msg: "WARNING: Stack protection configured but requires system REBOOT to take effect!"
     when: 
       - stack_protection_config is changed
       - "'noexec_user_stack: 1' not in verify_stack_protection.stdout"
     tags:
       - cis_3.2
       - stack_protection

    - name: CIS 3.3 - Check TCP_STRONG_ISS in /etc/default/inetinit
      shell: grep "^TCP_STRONG_ISS=" /etc/default/inetinit
      register: tcp_strong_iss_file
      failed_when: false
      changed_when: false
      tags:
        - cis_3.3
        - tcp_hardening

    - name: CIS 3.3 - Configure TCP_STRONG_ISS in /etc/default/inetinit
      lineinfile:
        path: /etc/default/inetinit
        regexp: '^TCP_STRONG_ISS='
        line: 'TCP_STRONG_ISS=2'
        create: yes
      when: tcp_strong_iss_file.rc != 0 or 'TCP_STRONG_ISS=2' not in tcp_strong_iss_file.stdout
      tags:
        - cis_3.3
        - tcp_hardening

    - name: CIS 3.3 - Set TCP strong ISS on running system
      shell: ipadm set-prop -p _strong_iss=2 tcp
      register: tcp_strong_iss_runtime
      failed_when: false
      changed_when: tcp_strong_iss_runtime.rc == 0
      tags:
        - cis_3.3
        - tcp_hardening

    - name: CIS 3.3 - Verify TCP strong ISS setting
      shell: ipadm show-prop -p _strong_iss -co current tcp
      register: verify_tcp_strong_iss
      changed_when: false
      tags:
        - cis_3.3
        - tcp_hardening

   - name: CIS 3.4 - Disable IPv4 source packet forwarding
      shell: ipadm set-prop -p _forward_src_routed=0 ipv4
      register: ipv4_forward_src
      failed_when: false
      changed_when: ipv4_forward_src.rc == 0
      tags:
        - cis_3.4
        - network_hardening

    - name: CIS 3.4 - Disable IPv6 source packet forwarding
      shell: ipadm set-prop -p _forward_src_routed=0 ipv6
      register: ipv6_forward_src
      failed_when: false
      changed_when: ipv6_forward_src.rc == 0
      tags:
        - cis_3.4
        - network_hardening

    - name: CIS 3.4 - Verify IPv4 source routing disabled (current)
      shell: ipadm show-prop -p _forward_src_routed -co current ipv4
      register: verify_ipv4_forward_current
      changed_when: false
      tags:
        - cis_3.4
        - network_hardening

    - name: CIS 3.4 - Verify IPv4 source routing disabled (persistent)
      shell: ipadm show-prop -p _forward_src_routed -co persistent ipv4
      register: verify_ipv4_forward_persist
      changed_when: false
      tags:
        - cis_3.4
        - network_hardening

    - name: CIS 3.4 - Verify IPv6 source routing disabled (current)
      shell: ipadm show-prop -p _forward_src_routed -co current ipv6
      register: verify_ipv6_forward_current
      changed_when: false
      tags:
        - cis_3.4
        - network_hardening

    - name: CIS 3.4 - Verify IPv6 source routing disabled (persistent)
      shell: ipadm show-prop -p _forward_src_routed -co persistent ipv6
      register: verify_ipv6_forward_persist
      changed_when: false
      tags:
        - cis_3.4
        - network_hardening

    - name: CIS 3.5 - Disable directed broadcast forwarding
      shell: ipadm set-prop -p _forward_directed_broadcasts=0 ip
      register: directed_broadcast
      failed_when: false
      changed_when: directed_broadcast.rc == 0
      tags:
        - cis_3.5
        - network_hardening

    - name: CIS 3.5 - Verify directed broadcast disabled (current)
      shell: ipadm show-prop -p _forward_directed_broadcasts -co current ip
      register: verify_broadcast_current
      changed_when: false
      tags:
        - cis_3.5
        - network_hardening

    - name: CIS 3.5 - Verify directed broadcast disabled (persistent)
      shell: ipadm show-prop -p _forward_directed_broadcasts -co persistent ip
      register: verify_broadcast_persist
      changed_when: false
      tags:
        - cis_3.5
        - network_hardening

    - name: CIS 3.6 - Disable Response to ICMP Timestamp Requests (Scored)
      shell: ipadm set-prop -p _respond_to_timestamp=0 ip
      register: icmp_timestamp
      failed_when: false
      changed_when: icmp_timestamp.rc == 0
      tags:
        - cis_3.6 
        - network_hardening

    - name: CIS 3.6 - Verify icmp timestamp response disabled (current)
      shell: ipadm show-prop -p _respond_to_timestamp -co current ip
      register: verify_icmp_timestamp_current
      changed_when: false
      tags:
        - cis_3.6
        - network_hardening

   - name: CIS 3.6 - Verify ICMP timestamp response disabled (persistent)
      shell: ipadm show-prop -p _respond_to_timestamp -co persistent ip
      register: verify_icmp_timestamp_persist
      changed_when: false
      tags:
        - cis_3.6
        - network_hardening

   - name: CIS 3.11 - Ignore ICMP Redirect Messages(Scored)
     shell: ipadm set-prop -p _ignore_redirect=1 ipv4
     register: ipv4_ignore_redirect
     failed_when: false
     changed_when: ipv4_ignore_redirect.rc == 0
     tags:
       - cis_3.11
       - network_hardening
    
    - name: CIS 3.11 - Ignore ICMP Redirect Messages for IPv6
      shell: ipadm set-prop -p _ignore_redirect=1 ipv6
      register: ipv6_ignore_redirect
      failed_when: false
      changed_when: ipv6_ignore_redirect.rc == 0
      tags:
        - cis_3.11
        - network_hardening

    - name: CIS 3.11 - Verify IPv4 ignore redirect (current)
      shell: ipadm show-prop -p _ignore_redirect -co current ipv4
      register: verify_ipv4_redirect_current
      changed_when: false
      tags:
        - cis_3.11
        - network_hardening

   - name: CIS 3.11 - Verify IPv4 ignore redirect (persistent)
     shell: ipadm show-prop -p _ignore_redirect -co persistent ipv4
     register: verify_ipv4_redirect_persist
     changed_when: false
     tags: 
       - cis_3.11
       - network_hardening
  
    - name: CIS 3.11 - Verify IPv6 ignore redirect (current)
      shell: ipadm show-prop -p _ignore_redirect -co current ipv6
     register: verify_ipv6_redirect_current
     changed_when: false
     tags:
       - cis_3.11
       - network_hardening

   - name: CIS 3.11 - Verify IPv6 ignore redirect(persistent)
     shell: ipadm show-prop -p _ignore_redirect -co persistent ipv6
     register: verify_ipv6_redirect_persist
     changed_when: false
     tags:
       - cis_3.11
       - network_hardening

   - name: CIS 3.13 - Disable ICMP Redirect Messages for IPv4 
     shell: ipadm set-prop -p _send_redirects=0 ipv4
     register: ipv4_send_redirects
     failed_when: false
     changed_when: ipv4_send_redirects.rc == 0
     tags:
       - cis_3.13
       - network_hardening

   - name: CIS 3.13 - Disable ICMP Redirect Messages for IPv6
     shell: ipadm set-prop -p _send_redirects=0 ipv6 
     register: ipv6_send_redirects
     failed_when: false
     changed_when: ipv6_send_redirects.rc == 0
     tags: 
       - cis_3.13
       - network_hardening

   - name: CIS 3.13 - Verify IPv4 send redirects disabled (current)
     shell: ipadm show-prop -p _send_redirects -co current ipv4
     register: verify_ipv4_send_redirects_current
     changed_when: false
     tags:
       - cis_3.13
       - network_hardening

   
   - name: CIS 3.13 - Verify IPv6 send redirects disabled (current)
     shell: ipadm show-prop -p _send_redirects -co current ipv6
     register: verify_ipv6_send_redirects_current
     changed_when: false
     tags:
       - cis_3.13
       - network_hardening
  
   - name: CIS 3.13 - Verify IPv6 send redirects disabled (persistent)
     shell: ipadm show-prop -p _send_redirects -co persistent ipv6
     register: verify_ipv6_send_redirects_persist
     changed_when: false
     tags:
       - cis_3.13
       - network_hardening

  - name: CIS 3.14 - Disable TCP Reverse IP Source Routing (Scored)
      shell: ipadm set-prop -p _rev_src_routes=0 tcp
      register: tcp_rev_src_routes
      failed_when: false
      changed_when: tcp_rev_src_routes.rc == 0
      tags:
        - cis_3.14
        - network_hardening

    - name: CIS 3.14 - Verify TCP reverse source routing disabled (current)
      shell: ipadm show-prop -p _rev_src_routes -co current tcp
      register: verify_tcp_rev_src_current
      changed_when: false
      tags:
        - cis_3.14
        - network_hardening

    - name: CIS 3.14 - Verify TCP reverse source routing disabled (persistent)
      shell: ipadm show-prop -p _rev_src_routes -co persistent tcp
      register: verify_tcp_rev_src_persist
      changed_when: false
      tags:
        - cis_3.14
        - network_hardening

    - name: CIS 3.17 - Disable Network Routing (Scored) - IPv4
      shell: routeadm -d ipv4-forwarding -d ipv4-routing
       register: ipv4_routing
       failed_when: false
       changed_when: ipv4_routing.rc == 0
       tags:
         - cis_3.17
         - network_hardening

    - name: CIS 3.17 - Disable Network Routing - IPv6
      shell: routeadm -d ipv6-forwarding -d ipv6-routing
      register: ipv6_routing
      failed_when: false
      changed_when: ipv6_routing.rc == 0
      tags:
        - cis_3.17
        - network_hardening

    - name: CIS 3.17 - Verify IPv4 routing disabled (current)
      shell: |
        routeadm -p | egrep "^ipv4-routing |^ipv4-forwarding " | awk '{printf("%s %s\n", $1, $NF); }'
      register: verify_ipv4_routing_current
      changed_when: false
      tags:
        - cis_3.17
        - network_hardening

    - name: CIS 3.17 - Verify IPv4 routing disabled (persistent)
      shell: |
        routeadm -p | egrep "^ipv4-routing |^ipv4-forwarding " | awk '{printf("%s %s\n", $1, $2); }'
      register: verify_ipv4_routing_persist
      changed_when: false
      tags:
        - cis_3.17
        - network_hardening

    - name: CIS 3.17 - Verify IPv6 routing disabled (current)
      shell: |
        routeadm -p | egrep "^ipv6-routing |^ipv6-forwarding " | awk '{printf("%s %s\n", $1, $NF); }'
      register: verify_ipv6_routing_current
      changed_when: false
      tags:
        - cis_3.17
        - network_hardening

    - name: CIS 3.17 - Verify IPv6 routing disabled (persistent)
      shell: |
        routeadm -p | egrep "^ipv6-routing |^ipv6-forwarding " | awk '{printf("%s %s\n", $1, $2); }'
      register: verify_ipv6_routing_persist
      changed_when: false
      tags:
        - cis_3.17
        - network_hardening

    - name: CIS 4.1 - Check if CIS Audit Class exists
      shell: grep ":CIS Solaris Benchmark" /etc/security/audit_class
      register: cis_audit_class_check
      failed_when: false
      changed_when: false
      tags:
        - cis_4.1
        - audit

    - name: CIS 4.1 - Create CIS Audit Class (Scored)
      lineinfile:
        path: /etc/security/audit_class
        line: '0x0100000000000000:cis:CIS Solaris Benchmark'
        insertbefore: EOF
        state: present
      when: cis_audit_class_check.rc != 0
      tags:
        - cis_4.1
        - audit

    - name: CIS 4.1 - Verify CIS Audit Class creation
      shell: grep ":CIS Solaris Benchmark" /etc/security/audit_class
      register: verify_cis_audit_class
      changed_when: false
      tags:
        - cis_4.1
        - audit

    - name: CIS 4.2 - Enable Auditing of Incoming Network Connections (Scored)
      lineinfile:
        path: /etc/security/audit_event
        regexp: '^({{ item }}:.*):(.*)$'
        line: '\1:cis,\2'
        backrefs: yes
      loop:
        - AUE_ACCEPT
        - AUE_CONNECT
        - AUE_SOCKACCEPT
        - AUE_SOCKCONNECT
        - AUE_inetd_connect
      tags:
        - cis_4.2
        - audit

    - name: CIS 4.2 - Verify network connection auditing
      shell: grep "cis" /etc/security/audit_event | awk -F: '{ print $2 }' | grep -E '^(AUE_ACCEPT|AUE_CONNECT|AUE_SOCKACCEPT|AUE_SOCKCONNECT|AUE_inetd_connect)$'
      register: verify_network_audit
      changed_when: false
      failed_when: false
      tags:
        - cis_4.2
        - audit

    - name: CIS 4.3 - Enable Auditing of File Metadata Modification Events (Scored)
      lineinfile:
        path: /etc/security/audit_event
        regexp: '^({{ item }}:.*):(.*)$'
        line: '\1:cis,\2'
        backrefs: yes
      loop:
        - AUE_CHMOD
        - AUE_CHOWN
        - AUE_FCHOWN
        - AUE_FCHMOD
        - AUE_LCHOWN
        - AUE_ACLSET
        - AUE_FACLSET
      tags:
        - cis_4.3
        - audit

    - name: CIS 4.3 - Verify file metadata auditing
      shell: grep "cis" /etc/security/audit_event | awk -F: '{ print $2 }' | grep -E '^(AUE_CHMOD|AUE_CHOWN|AUE_FCHOWN|AUE_FCHMOD|AUE_LCHOWN|AUE_ACLSET|AUE_FACLSET)$'
      register: verify_metadata_audit
      changed_when: false
      failed_when: false
      tags:
        - cis_4.3
        - audit

    - name: CIS 4.4 - Enable Auditing of Process and Privilege Events (Scored)
      lineinfile:
        path: /etc/security/audit_event
        regexp: '^({{ item }}:.*):(.*)$'
        line: '\1:cis,\2'
        backrefs: yes
      loop:
        - AUE_CHROOT
        - AUE_SETREUID
        - AUE_SETREGID
        - AUE_FCHROOT
        - AUE_PFEXEC
        - AUE_SETUID
        - AUE_NICE
        - AUE_SETGID
        - AUE_PRIOCNTLSYS
        - AUE_SETEGID
        - AUE_SETEUID
        - AUE_SETPPRIV
        - AUE_SETSID
        - AUE_SETPGID
      tags:
        - cis_4.4
        - audit

    - name: CIS 4.4 - Verify process and privilege auditing
      shell: grep "cis" /etc/security/audit_event | awk -F: '{ print $2 }' | grep -E '^(AUE_CHROOT|AUE_SETREUID|AUE_SETREGID|AUE_FCHROOT|AUE_PFEXEC|AUE_SETUID|AUE_NICE|AUE_SETGID|AUE_PRIOCNTLSYS|AUE_SETEGID|AUE_SETEUID|AUE_SETPPRIV|AUE_SETSID|AUE_SETPGID)$'
      register: verify_privilege_audit
      changed_when: false
      failed_when: false
      tags:
        - cis_4.4
        - audit

  - name: CIS 4.5 - Configure Solaris Auditing (Scored) - Set audit configuration
    shell: auditconfig -conf
    register: audit_conf
    failed_when: false
    changed_when: audit_conf.rc == 0
    tags:
      - cis_4.5
      - audit

  - name: CIS 4.5 - Set audit flags
    shell: auditconfig -setflags lo,ad,ft,ex,cis
    register: audit_flags
    failed_when: false
    changed_when: audit_flags.rc == 0
    tags:
      - cis_4.5
      - audit

  - name: CIS 4.5 - Set non-attributable audit flags
    shell: auditconfig -setnaflags lo
    register: audit_naflags
    failed_when: false
    changed_when: audit_naflags.rc == 0
    tags:
      - cis_4.5
      - audit

  - name: CIS 4.5 - Set audit policies
    shell: auditconfig -setpolicy cnt,argv,zonename
    register: audit_policy
    failed_when: false
    changed_when: audit_policy.rc == 0
    tags:
      - cis_4.5
      - audit

  - name: CIS 4.5 - Configure audit binfile plugin
    shell: auditconfig -setplugin audit_binfile active p_minfree=1
    register: audit_plugin
    failed_when: false
    changed_when: audit_plugin.rc == 0
    tags:
      - cis_4.5
      - audit

  - name: CIS 4.5 - Refresh audit service
    shell: audit -s
    register: audit_refresh
    failed_when: false
    changed_when: audit_refresh.rc == 0
    tags:
      - cis_4.5
      - audit

  - name: CIS 4.5 - Set root audit flags
    shell: rolemod -K audit_flags=lo,ad,ft,ex,cis:no root
    register: root_audit_flags
    failed_when: false
    changed_when: root_audit_flags.rc == 0
    tags:
      - cis_4.5
      - audit

  - name: CIS 4.5 - Add hourly audit log rotation to root crontab
    cron:
      name: "Audit log rotation"
      user: root
      minute: "0"
      job: "/usr/sbin/audit -n"
      state: present
    tags:
      - cis_4.5
      - audit

  - name: CIS 4.5 - Set /var/audit ownership
    file:
      path: /var/audit
      owner: root
      group: root
      mode: '0750'
      state: directory
    tags:
      - cis_4.5
      - audit

  - name: CIS 4.5 - Verify audit condition
    shell: auditconfig -getcond
    register: verify_audit_cond
    changed_when: false
    tags:
      - cis_4.5
      - audit

  - name: CIS 4.5 - Verify audit policies
    shell: auditconfig -getpolicy
    register: verify_audit_policy
    changed_when: false
    tags:
      - cis_4.5
      - audit

  - name: CIS 4.5 - Verify audit flags
    shell: auditconfig -getflags
    register: verify_audit_flags
    changed_when: false
    tags:
      - cis_4.5
      - audit

  - name: CIS 6.3 - Disable X11 Forwarding for SSH (Scored)
    lineinfile:
      path: /etc/ssh/sshd_config
      regexp: '^X11Forwarding'
      line: 'X11Forwarding no'
      state: present
      notify: restart ssh
    tags:
      - cis_6.3
      - ssh_hardening

  - name: CIS 6.3 - Verify X11 Forwarding is disabled
    shell: grep "^X11Forwarding" /etc/ssh/sshd_config
    register: verify_x11_forwarding
    changed_when: false
    failed_when: false
    tags:
      - cis_6.3
      - ssh_hardening

  - name: CIS 6.4 - Limit Consecutive Login Attempts for SSH (Scored)
    lineinfile:
      path: /etc/ssh/sshd_config
      regexp: '^MaxAuthTries'
      line: 'MaxAuthTries 3'
      state: present
      notify: restart ssh
    tags:
      - cis_6.4
      - ssh_hardening

  - name: CIS 6.4 - Verify MaxAuthTries setting
    shell: grep "^MaxAuthTries" /etc/ssh/sshd_config
    register: verify_max_auth_tries
    changed_when: false
    failed_when: false
    tags:
      - cis_6.4
      - ssh_hardening

  - name: CIS 6.5 - Disable Rhost-based Authentication for SSH (Scored)
    lineinfile:
      path: /etc/ssh/sshd_config
      regexp: '^IgnoreRhosts'
      line: 'IgnoreRhosts yes'
      state: present
    notify: restart ssh
    tags:
      - cis_6.5
      - ssh_hardening

  - name: CIS 6.5 - Verify IgnoreRhosts setting
    shell: grep "^IgnoreRhosts" /etc/ssh/sshd_config
    register: verify_ignore_rhosts
    changed_when: false
    failed_when: false
    tags:
      - cis_6.5
      - ssh_hardening

  - name: CIS 6.6 - Disable root login for SSH (Scored)
    lineinfile:
      path: /etc/ssh/sshd_config
      regexp: '^PermitRootLogin'
      line: 'PermitRootLogin no'
      state: present
    notify: restart ssh
    tags:
      - cis_6.6
      - ssh_hardening

  - name: CIS 6.6 - Verify PermitRootLogin setting
    shell: grep "^PermitRootLogin" /etc/ssh/sshd_config
    register: verify_permit_root_login
    changed_when: false
    failed_when: false
    tags:
      - cis_6.6
      - ssh_hardening

  - name: CIS 6.7 - Blocking Authentication Using Empty/Null Passwords for SSH (Scored)
    lineinfile:
      path: /etc/ssh/sshd_config
      regexp: '^PermitEmptyPasswords'
      line: 'PermitEmptyPasswords no'
      state: present
    notify: restart ssh
    tags:
      - cis_6.7
      - ssh_hardening

  - name: CIS 6.7 - Verify PermitEmptyPasswords setting
    shell: grep "^PermitEmptyPasswords" /etc/ssh/sshd_config
    register: verify_permit_empty_passwords
    changed_when: false
    failed_when: false
    tags:
      - cis_6.7
      - ssh_hardening

  - name: CIS 6.8 - Backup pam.conf before modifications
    copy:
      src: /etc/pam.conf
      dest: /etc/pam.conf.pre-CIS
      remote_src: yes
      force: no
    tags:
      - cis_6.8
      - pam_hardening

  - name: CIS 6.8 - Disable Host-based Authentication for Login-based Services (Scored)
    replace:
      path: /etc/pam.conf
      regexp: '^(.*pam_rhosts_auth.*)$'
      replace: '#\1'
    tags:
      - cis_6.8
      - pam_hardening

  - name: CIS 6.8 - Verify pam_rhosts_auth is disabled
    shell: grep "^#" /etc/pam.conf | grep "pam_rhosts_auth"
    register: verify_rhosts_auth
    changed_when: false
    failed_when: false
    tags:
      - cis_6.8
      - pam_hardening

  - name: CIS 6.10 - Check current SLEEPTIME setting
    shell: grep "^SLEEPTIME=" /etc/default/login
    register: sleeptime_check
    failed_when: false
    changed_when: false
    tags:
      - cis_6.10
      - login_hardening 

  - name: CIS 6.10 - Set Deplay between Failed Login Attempts to 4 (Scored)
    lineinfile:
      path: /etc/default/login
      regexp: '^SLEEPTIME='
      line: '^SLEEPTIME=4'
      state: present
    when: sleeptime_check.rc != 0 or 'SLEEPTIME=4' not in sleeptime_check.stdout
    tags:
      - cis_6.10
      - login_hardening
    
  - name: CIS 6.10 - Verify SLEEPTIME setting
    shell: grep "^SLEEPTIME=" /etc/default/login
    register: verify_sleeptime
    changed_when: false
    tags:
      - cis_6.10
      - login_hardening

  - name: CIS 6.13 - Backup cron.deny if exists 
    shell: | 
      if [ -f /etc/cron.d/cron.deny ]; then
        mv /etc/cron.d/cron.deny /etc/cron.d/cron.deny.cis
      fi 
    args: 
      create: /etc/cron.d/cron.deny.cis
    tags:
      - cis_6.13
      - cron_hardening
  
  - name: CIS 6.13 - Create cron.allow with root only
    copy:
      content: "root\n"
      dest: /etc/cron.d/cron.allow
      owner: root
      group: root
      mode: '0400'
    tags:
      - cis_6.13
      - cron_hardening

    - name: CIS 6.13 - Create Empty at.allow
      copy:
        content: ""
      dest: /etc/cron.d/at.allow
      owner: root
      group: root
      mode: '0400'
    tags:
      - cis_6.13
      - cron_hardening

    - name: CIS 6.13 - Verify cron.deny does not exist
      stat: 
        path: /etc/cron.d/cron.deny
     register: cron_deny_stat
     tags:
       - cis_6.13
       - cron_hardening

   - name: CIS 6.13 - Verify at.deny does not exist
      stat:
        path: /etc/cron.d/at.deny
      register: at_deny_stat
      tags:
        - cis_6.13
        - cron_hardening

    - name: CIS 6.13 - Verify cron.allow content
      shell: cat /etc/cron.d/cron.allow
      register: verify_cron_allow
      changed_when: false
      tags:
        - cis_6.13
        - cron_hardening

    - name: CIS 6.13 - Verify at.allow is empty
      shell: wc -l /etc/cron.d/at.allow | awk '{ print $1 }'
      register: verify_at_allow
      changed_when: false
      tags:
        - cis_6.13
        - cron_hardening
  
     - name: CIS 6.14 - Check current CONSOLE setting
      shell: grep "^CONSOLE=" /etc/default/login
      register: console_check
      failed_when: false
      changed_when: false
      tags:
        - cis_6.14
        - login_hardening
  
    - name: CIS 6.14 - Restrict root Login to system console 
      lineinfile:
        path: /etc/default/login
        regexp: '^CONSOLE='
        line: 'CONSOLE=/dev/console'
      when: console_check.rc != 0 or 'CONSOLE=/dev/console' not in console_check.stdout
      tags:
        - cis_6.14
        - login_hardening

    - name: CIS 6.14 - Verify console setting 
      shell: grep "^CONSOLE=/dev/console" /etc/default/login
      register: verify_console
      changed_when: false
      tags:
        - cis_6.14
        - login_hardening

    - name: CIS 6.15 - Check current RETRIES setting in login
      shell: grep "^RETRIES=" /etc/default/login
      register: retries_check
      failed_when: false
      changed_when: false
      tags:
        - cis_6.15
        - login_hardening

    - name: CIS 6.15 - Set Retry Limit for Account Lockout (Scored) - RETRIES
      lineinfile:
        path: /etc/default/login
        regexp: '^RETRIES='
        line: 'RETRIES=3'
        state: present
      when: retries_check.rc != 0 or 'RETRIES=3' not in retries_check.stdout
      tags:
        - cis_6.15
        - login_hardening

    - name: CIS 6.15 - Check current LOCK_AFTER_RETRIES setting
      shell: grep "^LOCK_AFTER_RETRIES=" /etc/security/policy.conf
      register: lock_after_retries_check
      failed_when: false
      changed_when: false
      tags:
        - cis_6.15
        - login_hardening

    - name: CIS 6.15 - Set LOCK_AFTER_RETRIES in policy.conf
      lineinfile:
        path: /etc/security/policy.conf
        regexp: '^LOCK_AFTER_RETRIES='
        line: 'LOCK_AFTER_RETRIES=YES'
        state: present
      when: lock_after_retries_check.rc != 0 or 'LOCK_AFTER_RETRIES=YES' not in lock_after_retries_check.stdout
      notify: restart name-service-cache
      tags:
        - cis_6.15
        - login_hardening

    - name: CIS 6.15 - Verify RETRIES setting
      shell: grep "^RETRIES=" /etc/default/login
      register: verify_retries
      changed_when: false
      tags:
        - cis_6.15
        - login_hardening

    - name: CIS 6.15 - Verify LOCK_AFTER_RETRIES setting
      shell: grep "^LOCK_AFTER_RETRIES=" /etc/security/policy.conf
      register: verify_lock_after_retries
      changed_when: false
      tags:
        - cis_6.15
        - login_hardening

    - name: CIS 6.15 - Verify root lock_after_retries exemption
      shell: userattr lock_after_retries root
      register: verify_root_lock_exemption
      changed_when: false
      failed_when: false
      tags:
        - cis_6.15
        - login_hardening

    - name: CIS 7.1 - Set Password Expiration Parameters on Activike 
      shell: |
        logins -ox | \
        awk -F: '($1 == "root" || $8 == "LK" || $8 == "NL") \
        { next } ; \
        { $cmd = "passwd" } ;\
        ($11 != 91) { $cmd = $cmd " -x 91" } \
        ($10 < 7) { $cmd = $cmd " -n 7" } \
        ($12 < 28) { $cmd = $cmd " -w 28" } \
        ($cmd != "passwd") { print $cmd " " $1 }' \
        > /etc/CISupd_accounts
      register: password_expiration_script
      changed_when: false
      tags:
        - cis_7.1
        - password_policy
  
   - name: CIS 7.1 - Check if accounts need password expiration updates
      stat:
        path: /etc/CISupd_accounts
      register: update_accounts_file
      tags:
        - cis_7.1
        - password_policy

    - name: CIS 7.1 - Apply password expiration to existing accounts
      shell: /sbin/sh /etc/CISupd_accounts
      when: update_accounts_file.stat.exists and update_accounts_file.stat.size > 0
      register: apply_password_expiration
      tags:
        - cis_7.1
        - password_policy

    - name: CIS 7.1 - Remove temporary update script
      file:
        path: /etc/CISupd_accounts
        state: absent
      tags:
        - cis_7.1
        - password_policy

    - name: CIS 7.1 - Backup /etc/default/passwd
      copy:
        src: /etc/default/passwd
        dest: /etc/default/passwd.pre-CIS
        remote_src: yes
        force: no
      tags:
        - cis_7.1
        - password_policy

    - name: CIS 7.1 - Set default password expiration parameters - MAXWEEKS
      lineinfile:
        path: /etc/default/passwd
        regexp: '^MAXWEEKS='
        line: 'MAXWEEKS=13'
        state: present
      tags:
        - cis_7.1
        - password_policy
    
  - name: CIS 7.1 - Set default password expiration parameters - MINWEEKS
      lineinfile:
        path: /etc/default/passwd
        regexp: '^MINWEEKS='
        line: 'MINWEEKS=1'
        state: present
      tags:
        - cis_7.1
        - password_policy

    - name: CIS 7.1 - Set default password expiration parameters - WARNWEEKS
      lineinfile:
        path: /etc/default/passwd
        regexp: '^WARNWEEKS='
        line: 'WARNWEEKS=4'
        state: present
      tags:
        - cis_7.1
        - password_policy

    - name: CIS 7.1 - Verify password expiration on active accounts
      shell: |
        logins -ox | \
        awk -F: '( $1 != "root" && $8 != "LK" && $8 != "NL" && \
        ( $10 != "7" || $11 != "91" || $12 != "28" )) { print }'
      register: verify_password_expiration
      changed_when: false
      failed_when: false
      tags:
        - cis_7.1
        - password_policy

    - name: CIS 7.1 - Verify WEEKS parameters
      shell: grep "WEEKS=" /etc/default/passwd | sort -u
      register: verify_weeks_params
      changed_when: false
      tags:
        - cis_7.1
        - password_policy

    - name: CIS 7.2 - Set Strong Password Creation Policies (Scored) - PASSLENGTH
      lineinfile:
        path: /etc/default/passwd
        regexp: '^PASSLENGTH='
        line: 'PASSLENGTH=8'
        state: present
      tags:
        - cis_7.2
        - password_policy

    - name: CIS 7.2 - Set NAMECHECK
      lineinfile:
        path: /etc/default/passwd
        regexp: '^NAMECHECK='
        line: 'NAMECHECK=YES'
        state: present
      tags:
        - cis_7.2
        - password_policy

    - name: CIS 7.2 - Set HISTORY
      lineinfile:
        path: /etc/default/passwd
        regexp: '^HISTORY='
        line: 'HISTORY=10'
        state: present
      tags:
        - cis_7.2
        - password_policy

    - name: CIS 7.2 - Set MINDIFF
      lineinfile:
        path: /etc/default/passwd
        regexp: '^MINDIFF='
        line: 'MINDIFF=3'
        state: present
      tags:
        - cis_7.2
        - password_policy

    - name: CIS 7.2 - Set MINALPHA
      lineinfile:
        path: /etc/default/passwd
        regexp: '^MINALPHA='
        line: 'MINALPHA=2'
        state: present
      tags:
        - cis_7.2
        - password_policy

    - name: CIS 7.2 - Set MINUPPER
      lineinfile:
        path: /etc/default/passwd
        regexp: '^MINUPPER='
        line: 'MINUPPER=1'
        state: present
      tags:
        - cis_7.2
        - password_policy

    - name: CIS 7.2 - Set MINLOWER
      lineinfile:
        path: /etc/default/passwd
        regexp: '^MINLOWER='
        line: 'MINLOWER=1'
        state: present
      tags:
        - cis_7.2
        - password_policy

    - name: CIS 7.2 - Set MINNONALPHA
      lineinfile:
        path: /etc/default/passwd
        regexp: '^MINNONALPHA='
        line: 'MINNONALPHA=1'
        state: present
      tags:
        - cis_7.2
        - password_policy

    - name: CIS 7.2 - Set MAXREPEATS
      lineinfile:
        path: /etc/default/passwd
        regexp: '^MAXREPEATS='
        line: 'MAXREPEATS=0'
        state: present
      tags:
        - cis_7.2
        - password_policy

    - name: CIS 7.2 - Set WHITESPACE
      lineinfile:
        path: /etc/default/passwd
        regexp: '^WHITESPACE='
        line: 'WHITESPACE=YES'
        state: present
      tags:
        - cis_7.2
        - password_policy

    - name: CIS 7.2 - Set DICTIONDBDIR
      lineinfile:
        path: /etc/default/passwd
        regexp: '^DICTIONDBDIR='
        line: 'DICTIONDBDIR=/var/passwd'
        state: present
      tags:
        - cis_7.2
        - password_policy

    - name: CIS 7.2 - Set DICTIONLIST
      lineinfile:
        path: /etc/default/passwd
        regexp: '^DICTIONLIST='
        line: 'DICTIONLIST=/usr/share/lib/dict/words'
        state: present
      tags:
        - cis_7.2
        - password_policy

    - name: CIS 7.2 - Verify PASSLENGTH setting
      shell: grep "^PASSLENGTH=" /etc/default/passwd
      register: verify_passlength
      changed_when: false
      failed_when: false
      tags:
        - cis_7.2
        - password_policy

    - name: CIS 7.2 - Verify NAMECHECK setting
      shell: grep "^NAMECHECK=" /etc/default/passwd
      register: verify_namecheck
      changed_when: false
      failed_when: false
      tags:
        - cis_7.2
        - password_policy

    - name: CIS 7.2 - Verify HISTORY setting
      shell: grep "^HISTORY=" /etc/default/passwd
      register: verify_history
      changed_when: false
      failed_when: false
      tags:
        - cis_7.2
        - password_policy

    - name: CIS 7.2 - Verify MINDIFF setting
      shell: grep "^MINDIFF=" /etc/default/passwd
      register: verify_mindiff
      changed_when: false
      failed_when: false
      tags:
        - cis_7.2
        - password_policy

    - name: CIS 7.2 - Verify MINALPHA setting
      shell: grep "^MINALPHA=" /etc/default/passwd
      register: verify_minalpha
      changed_when: false
      failed_when: false
      tags:
        - cis_7.2
        - password_policy

    - name: CIS 7.2 - Verify MINUPPER setting
      shell: grep "^MINUPPER=" /etc/default/passwd
      register: verify_minupper
      changed_when: false
      failed_when: false
      tags:
        - cis_7.2
        - password_policy

    - name: CIS 7.2 - Verify MINLOWER setting
      shell: grep "^MINLOWER=" /etc/default/passwd
      register: verify_minlower
      changed_when: false
      failed_when: false
      tags:
        - cis_7.2
        - password_policy

    - name: CIS 7.2 - Verify MINNONALPHA setting
      shell: grep "^MINNONALPHA=" /etc/default/passwd
      register: verify_minnonalpha
      changed_when: false
      failed_when: false
      tags:
        - cis_7.2
        - password_policy

    - name: CIS 7.2 - Verify MAXREPEATS setting
      shell: grep "^MAXREPEATS=" /etc/default/passwd
      register: verify_maxrepeats
      changed_when: false
      failed_when: false
      tags:
        - cis_7.2
        - password_policy

    - name: CIS 7.2 - Verify WHITESPACE setting
      shell: grep "^WHITESPACE=" /etc/default/passwd
      register: verify_whitespace
      changed_when: false
      failed_when: false
      tags:
        - cis_7.2
        - password_policy

    - name: CIS 7.2 - Verify DICTIONDBDIR setting
      shell: grep "^DICTIONDBDIR=" /etc/default/passwd
      register: verify_dictiondbdir
      changed_when: false
      failed_when: false
      tags:
        - cis_7.2
        - password_policy

    - name: CIS 7.2 - Verify DICTIONLIST setting
      shell: grep "^DICTIONLIST=" /etc/default/passwd
      register: verify_dictionlist
      changed_when: false
      failed_when: false
      tags:
        - cis_7.2
        - password_policy

  - name: CIS 7.6 - Lock Inactive User Accounts (Scored) - Set default for new accounts
      shell: useradd -D -f 35
      register: useradd_inactive
      failed_when: false
      changed_when: useradd_inactive.rc == 0
      tags:
        - cis_7.6
        - password_policy

  - name: CIS 7.6 - Get list of user accounts (excluding system and locked accounts)
    shell: |
      logins -ox | awk -F: '($1 != "root" && $8 != "LK" && $8 != "NL" && $8 != "NP") { print $1 }'
    register: user_accounts_list
    changed_when: false
    tags:
      - cis_7.6
      - password_policy

  - name: CIS 7.6 - Set inactive period for existing user accounts
    shell: usermod -f 35 {{ item }}
    loop: "{{ user_accounts_list.stdout_lines }}"
    when: user_accounts_list.stdout_lines | length > 0
    register: usermod_inactive
    failed_when: false
    changed_when: usermod_inactive.rc == 0
    tags:
      - cis_7.6
      - password_policy

  - name: CIS 7.6 - Get list of role accounts
    shell: |
      logins -ox | awk -F: '($8 == "NP") { print $1 }'
    register: role_accounts_list
    changed_when: false
    failed_when: false
    tags:
      - cis_7.6
      - password_policy

  - name: CIS 7.6 - Set inactive period for role accounts
    shell: rolemod -f 35 {{ item }}
    loop: "{{ role_accounts_list.stdout_lines }}"
    when: role_accounts_list.stdout_lines | length > 0
    register: rolemod_inactive
    failed_when: false
    changed_when: rolemod_inactive.rc == 0
    tags:
      - cis_7.6
      - password_policy

  - name: CIS 7.6 - Verify default inactive setting for new accounts
    shell: useradd -D | xargs -n 1 | grep inactive | awk -F= '{ print $2 }'
    register: verify_useradd_inactive
    changed_when: false
    tags:
      - cis_7.6
      - password_policy

  - name: CIS 7.6 - Display default inactive setting
    debug:
      msg: "Default inactive period for new accounts: {{ verify_useradd_inactive.stdout }}"
    when: verify_useradd_inactive.stdout is defined
    tags:
      - cis_7.6
      - password_policy

  - name: CIS 7.6 - Verify inactive setting on user accounts
    shell: |
      logins -ox | awk -F: '($1 != "root" && $8 != "LK" && $8 != "NL" && $13 != "35") { print $1, $13 }'
    register: verify_user_inactive
    changed_when: false
    failed_when: false
    tags:
      - cis_7.6
      - password_policy

  - name: CIS 7.6 - Display accounts with incorrect inactive setting
    debug:
      msg: "WARNING: The following accounts do not have inactive period set to 35: {{ verify_user_inactive.stdout_lines }}"
    when: verify_user_inactive.stdout | length > 0
    tags:
      - cis_7.6
      - password_policy

    - name: CIS 8.1 - Create Warnings for Standard Login Services (Scored) - Set /etc/motd
      copy:
        content: "Authorized users only. All activity may be monitored and reported.\n"
        dest: /etc/motd
        owner: root
        group: sys
        mode: '0644'
      tags:
        - cis_8.13
        - login_banner

    - name: CIS 8.1 - Set /etc/issue banner
      copy:
        content: "Authorized users only. All activity may be monitored and reported.\n"
        dest: /etc/issue
        owner: root
        group: root
        mode: '0644'
      tags:
        - cis_8.1
        - login_banner

    - name: CIS 8.1 - Verify /etc/motd content
      shell: cat /etc/motd
      register: verify_motd
      changed_when: false
      tags:
        - cis_8.1
        - login_banner

    - name: CIS 8.1 - Verify /etc/motd permissions
      stat:
        path: /etc/motd
      register: verify_motd_perms
      tags:
        - cis_8.1
        - login_banner

    - name: CIS 8.1 - Display /etc/motd verification
      debug:
        msg:
          - "Content: {{ verify_motd.stdout }}"
          - "Owner: {{ verify_motd_perms.stat.pw_name }}"
          - "Group: {{ verify_motd_perms.stat.gr_name }}"
          - "Mode: {{ verify_motd_perms.stat.mode }}"
      when: verify_motd_perms.stat.exists
      tags:
        - cis_8.1
        - login_banner

    - name: CIS 8.1 - Verify /etc/issue content
      shell: cat /etc/issue
      register: verify_issue
      changed_when: false
      tags:
        - cis_8.1
        - login_banner

    - name: CIS 8.1 - Verify /etc/issue permissions
      stat:
        path: /etc/issue
      register: verify_issue_perms
      tags:
        - cis_8.1
        - login_banner

    - name: CIS 8.1 - Display /etc/issue verification
      debug:
        msg:
          - "Content: {{ verify_issue.stdout }}"
          - "Owner: {{ verify_issue_perms.stat.pw_name }}"
          - "Group: {{ verify_issue_perms.stat.gr_name }}"
          - "Mode: {{ verify_issue_perms.stat.mode }}"
      when: verify_issue_perms.stat.exists
      tags:
        - cis_8.1
        - login_banner

  
    - name: CIS 8.2 - Enable a Warning Banner for the SSH Service (Scored)
      lineinfile:
        path: /etc/ssh/sshd_config
        regexp: '^#?Banner'
        line: 'Banner /etc/issue'
        state: present
      notify: restart ssh
      tags:
        - cis_8.2
        - ssh_hardening

    - name: CIS 8.2 - Verify SSH Banner setting
      shell: grep "^Banner" /etc/ssh/sshd_config
      register: verify_ssh_banner
      changed_when: false
      failed_when: false
      tags:
        - cis_8.2
        - ssh_hardening

    - name: CIS 8.2 - Display SSH Banner verification
      debug:
        msg: "SSH Banner setting: {{ verify_ssh_banner.stdout }}"
      when: verify_ssh_banner.stdout is defined and verify_ssh_banner.stdout | length > 0
      tags:
        - cis_8.2
        - ssh_hardening

    - name: CIS 8.4 - Check if ProFTPD is installed
      stat:
        path: /etc/proftpd.conf
      register: proftpd_conf
      tags:
        - cis_8.4
        - ftp_hardening

    - name: CIS 8.4 - Check if FTP service exists
      shell: svcs -a | grep -i ftp
      register: ftp_service_check
      changed_when: false
      failed_when: false
      tags:
        - cis_8.4
        - ftp_hardening

    - name: CIS 8.4 - Check if DisplayConnect already exists
      shell: grep "^DisplayConnect" /etc/proftpd.conf
      register: displayconnect_check
      changed_when: false
      failed_when: false
      when: proftpd_conf.stat.exists
      tags:
        - cis_8.4
        - ftp_hardening

    - name: CIS 8.4 - Enable a Warning Banner for the FTP service (Scored)
      lineinfile:
        path: /etc/proftpd.conf
        regexp: '^DisplayConnect'
        line: 'DisplayConnect /etc/issue'
        state: present
      when: proftpd_conf.stat.exists
      notify: restart ftp
      tags:
        - cis_8.4
        - ftp_hardening

    - name: CIS 8.4 - Verify DisplayConnect setting
      shell: grep "DisplayConnect" /etc/proftpd.conf
      register: verify_displayconnect
      changed_when: false
      failed_when: false
      when: proftpd_conf.stat.exists
      tags:
        - cis_8.4
        - ftp_hardening

    - name: CIS 8.4 - Display FTP Banner verification
      debug:
        msg: "FTP Banner setting: {{ verify_displayconnect.stdout }}"
      when: 
        - proftpd_conf.stat.exists
        - verify_displayconnect.stdout is defined 
        - verify_displayconnect.stdout | length > 0
      tags:
        - cis_8.4
        - ftp_hardening

    - name: CIS 8.4 - Display warning if ProFTPD not installed
      debug:
        msg: "WARNING: ProFTPD configuration file not found. FTP service may not be installed."
      when: not proftpd_conf.stat.exists
      tags:
        - cis_8.4
        - ftp_hardening

    - name: CIS 9.3 - Verify System Account Default Passwords (Scored) - Check locked accounts
      shell: |
        for user in aiuser dhcpserv dladm ftp gdm netadm netcfg \
        noaccess nobody nobody4 openldap pkg5srv svctag unknown \
        webservd xvm; do
          if id "$user" &>/dev/null; then
            stat=$(passwd -s ${user} 2>/dev/null | awk '{ print $2 }')
            if [ "${stat}" != "LK" ]; then
              echo "Account ${user} is not locked."
            fi
          fi
        done
      register: check_locked_accounts
      changed_when: false
      failed_when: false
      tags:
        - cis_9.3
        - account_security

    - name: CIS 9.3 - Lock system accounts that should be locked
      shell: |
        for user in aiuser dhcpserv dladm ftp gdm netadm netcfg \
        noaccess nobody nobody4 openldap pkg5srv svctag unknown \
        webservd xvm; do
          if id "$user" &>/dev/null; then
            stat=$(passwd -s ${user} 2>/dev/null | awk '{ print $2 }')
            if [ "${stat}" != "LK" ]; then
              passwd -d ${user} 2>/dev/null
              passwd -l ${user} 2>/dev/null
              echo "Locked account: ${user}"
            fi
          fi
        done
      register: lock_system_accounts
      changed_when: lock_system_accounts.stdout | length > 0
      tags:
        - cis_9.3
        - account_security

    - name: CIS 9.3 - Check non-login accounts
      shell: |
        for user in adm bin daemon lp mysql nuucp postgres smmsp \
        sys upnp uucp zfssnap; do
          if id "$user" &>/dev/null; then
            stat=$(passwd -s ${user} 2>/dev/null | awk '{ print $2 }')
            if [ "${stat}" != "NL" ]; then
              echo "Account ${user} is not non-login."
            fi
          fi
        done
      register: check_nonlogin_accounts
      changed_when: false
      failed_when: false
      tags:
        - cis_9.3
        - account_security

    - name: CIS 9.3 - Set system accounts to non-login
      shell: |
        for user in adm bin daemon lp mysql nuucp postgres smmsp \
        sys upnp uucp zfssnap; do
          if id "$user" &>/dev/null; then
            stat=$(passwd -s ${user} 2>/dev/null | awk '{ print $2 }')
            if [ "${stat}" != "NL" ]; then
              passwd -d ${user} 2>/dev/null
              passwd -N ${user} 2>/dev/null
              echo "Set to non-login: ${user}"
            fi
          fi
        done
      register: set_nonlogin_accounts
      changed_when: set_nonlogin_accounts.stdout | length > 0
      tags:
        - cis_9.3
        - account_security

    - name: CIS 9.3 - Display locked accounts status
      debug:
        msg: "{{ check_locked_accounts.stdout_lines }}"
      when: check_locked_accounts.stdout | length > 0
      tags:
        - cis_9.3
        - account_security

    - name: CIS 9.3 - Display non-login accounts status
      debug:
        msg: "{{ check_nonlogin_accounts.stdout_lines }}"
      when: check_nonlogin_accounts.stdout | length > 0
      tags:
        - cis_9.3
        - account_security

    - name: CIS 9.4 - Ensure Password Fields are Not Empty (Scored)
      shell: logins -p
      register: empty_password_accounts
      changed_when: false
      failed_when: false
      tags:
        - cis_9.4
        - account_security

    - name: CIS 9.4 - Display accounts with empty passwords
      debug:
        msg: "WARNING: The following accounts have empty passwords: {{ empty_password_accounts.stdout_lines }}"
      when: empty_password_accounts.stdout | length > 0
      tags:
        - cis_9.4
        - account_security

    - name: CIS 9.4 - Lock accounts with empty passwords
      shell: |
        logins -p | while read account; do
          username=$(echo $account | awk '{print $1}')
          if [ ! -z "$username" ]; then
            passwd -l ${username}
            echo "Locked account with empty password: ${username}"
          fi
        done
      register: lock_empty_password_accounts
      when: empty_password_accounts.stdout | length > 0
      changed_when: lock_empty_password_accounts.stdout | length > 0
      tags:
        - cis_9.4
        - account_security

    - name: CIS 9.5 - Verify No UID 0 Accounts Exist Other than root (Scored)
      shell: logins -o | awk -F: '($2 == 0) { print $1 }'
      register: uid_zero_accounts
      changed_when: false
      tags:
        - cis_9.5
        - account_security

    - name: CIS 9.5 - Display UID 0 accounts
      debug:
        msg: "UID 0 accounts found: {{ uid_zero_accounts.stdout_lines }}"
      tags:
        - cis_9.5
        - account_security

    - name: CIS 9.5 - Verify only root has UID 0
      assert:
        that:
          - uid_zero_accounts.stdout_lines | length == 1
          - uid_zero_accounts.stdout_lines[0] == "root"
        fail_msg: "WARNING: Multiple UID 0 accounts found: {{ uid_zero_accounts.stdout_lines }}. Only 'root' should have UID 0."
        success_msg: "OK: Only root has UID 0"
      tags:
        - cis_9.5
        - account_security

    - name: CIS 9.6 - Ensure root PATH Integrity (Scored) - Check for empty directory
      shell: |
        if [ "$(echo $PATH | grep :: )" != "" ]; then
          echo "Empty Directory in PATH (::)"
        fi
      register: check_empty_path
      changed_when: false
      failed_when: false
      become: yes
      become_user: root
      tags:
        - cis_9.6
        - account_security

    - name: CIS 9.6 - Check for trailing colon in PATH
      shell: |
        if [ "$(echo $PATH | grep :$)" != "" ]; then
          echo "Trailing : in PATH"
        fi
      register: check_trailing_colon
      changed_when: false
      failed_when: false
      become: yes
      become_user: root
      tags:
        - cis_9.6
        - account_security

    - name: CIS 9.6 - Check PATH for current directory and permissions
      shell: |
        p=$(echo $PATH | sed -e 's/::/:/' -e 's/:$//' -e 's/:/ /g')
        set -- $p
        while [ "$1" != "" ]; do
          if [ "$1" = "." ]; then
            echo "PATH contains ."
            shift
            continue
          fi
          if [ -d $1 ]; then
            dirperm=$(ls -ld $1 | cut -f1 -d" ")
            if [ $(echo $dirperm | cut -c6) != "-" ]; then
              echo "Group Write permission set on directory $1"
            fi
            if [ $(echo $dirperm | cut -c9) != "-" ]; then
              echo "Other Write permission set on directory $1"
            fi
          fi
          shift
        done
      register: check_path_integrity
      changed_when: false
      failed_when: false
      become: yes
      become_user: root
      tags:
        - cis_9.6
        - account_security

    - name: CIS 9.6 - Display PATH integrity issues
      debug:
        msg: 
          - "Empty directory check: {{ check_empty_path.stdout | default('OK - No empty directories') }}"
          - "Trailing colon check: {{ check_trailing_colon.stdout | default('OK - No trailing colon') }}"
          - "PATH integrity check: {{ check_path_integrity.stdout_lines | default(['OK - No issues found']) }}"
      tags:
        - cis_9.6
        - account_security

    - name: CIS 9.6 - Warning if PATH issues found
      debug:
        msg: "WARNING: root PATH integrity issues detected. Review and fix manually."
      when: 
        - check_empty_path.stdout | length > 0 or 
          check_trailing_colon.stdout | length > 0 or 
          check_path_integrity.stdout | length > 0
      tags:
        - cis_9.6
        - account_security
  
    - name: CIS 9.15 - Check for Duplicate UIDs
      shell: logins -d 
      register: duplicate_uids
     changed_when: false
     failed_when: false
     tags:
       - cis_9.15
       - account_security

    - name: CIS 9.15 - Display duplicate UIDs 
      debug:
        msg: "WARNING Duplicate UIDs found: {{ duplicate_uids.stdout_lines }}"
      when: duplicate_uids.stdout | length > 0
      tags:
        - cis_9.15
        - account_security
   
   - name:  CIS 9.15 - Verify no duplicate UIDs
     assert:
       that:
         - duplicate_uids.stdout | length == 0
       fail_msg: "Fail duplicate detected "
       succes_msg: "OK: No duplicate UIDs found" 
     ignore_errors: yes
     tags:
       - cis_9.15
       - account_security
  
    - name: CIS 9.15 - Generate report for duplicate UIDs
      copy:
        content: |
          CIS 9.15 - Duplicate UID Report
          ================================
          Date: {{ ansible_date_time.iso8601 }}
          Host: {{ ansible_hostname }}
          
          {% if duplicate_uids.stdout | length > 0 %}
          DUPLICATE UIDs FOUND - MANUAL REMEDIATION REQUIRED:
          {{ duplicate_uids.stdout }}
          
          ACTION REQUIRED:
          1. Review the accounts listed above that share UIDs
          2. Coordinate with account owners to determine appropriate action
          3. Assign unique UIDs to each account as per site policy
          4. Update /etc/passwd manually or use usermod command
          {% else %}
          STATUS: PASS - No duplicate UIDs detected
          {% endif %}
        dest: /var/tmp/cis_9.15_duplicate_uid_report.txt
      when: duplicate_uids.stdout | length > 0
      tags:
        - cis_9.15
        - account_security


    - name: CIS 9.24 - Find Un-owned Files and Directories
      shell: |
        find / \( -fstype nfs -o -fstype cachefs -o -fstype autofs \
        -o -fstype ctfs -o -fstype mntfs -o -fstype objfs \
        -o -fstype proc \) -prune -o \( -nouser -o -nogroup \) -print 2>/dev/null
      register: unowned_files
      changed_when: false
      failed_when: false
      async: 3600
      poll: 30
      tags:
        - cis_9.24
        - file_permissions 
        - long_running

    - name: CIS 9.24 - Display Un-owned files
      debug:
        msg: "{{ unowned_files.stdout_lines[:50] }}"
      when: unowned_files.stdout | length > 0
      tags:
        - cis_9.24
        - file_permissions

    - name: CIS 9.24 - Verify no Un-owned files 
      assert:
        that:
          - unowned_files.stdout | length == 0
        fail_msg: "FAIL: {{ unowned_files.stdout_lines | length }} un-owned files/directories found. Manual review required."  
        success_msg: "OK: No un-owned files or directories found"
      ignore_errors: yes
    tags:
      - cis_9.24
      - file_permissions

    - name: CIS 9.24 - Warning message for un-owned files
      debug:
        msg: 
          - "WARNING: Un-owned files/directories detected!"
          - "A detailed report has been generated at /var/tmp/cis_9.24_unowned_files_report.txt"
          - "Total items found: {{ unowned_files.stdout_lines | length }}"
          - "First 10 items displayed above. See report for complete list."
      when: unowned_files.stdout | length > 0
      tags:
        - cis_9.24
        - file_permissions

  handlers:
    - name: restart ssh
      service:
        name: svc:/network/ssh
        state: restarted

    - name: restart name-service-cache
      shell: svcadm restart svc:/system/name-service/cache

    - name: restart ftp
      shell: svcadm restart ftp
      ignore_errors: yes